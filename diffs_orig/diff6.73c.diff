--- 6.73b.j	2012-01-28 15:40:09.000000000 +0100
+++ 6.73c.j	2012-01-28 15:37:55.000000000 +0100
@@ -491,11 +491,10 @@
 sound gg_snd_SpellStealTarget=null
 sound gg_snd_AcolyteMining=null
 sound gg_snd_DestroyerMissile=null
 sound gg_snd_SpiritTouch=null
 sound gg_snd_FlameStrikeTargetWaveNonLoop101=null
-sound gg_snd_RainOfFireTarget2=null
 trigger gg_trg_Lib_Init=null
 trigger gg_trg_HLC=null
 trigger gg_trg_Multiboard_Functions=null
 trigger gg_trg_Tracker_Index=null
 trigger gg_trg_Global_Functions=null
@@ -4786,10 +4785,11 @@
 constant integer abilityid_starbeam=1093812807
 constant string starbeam_fx="war3mapImported\\DivineWrathTarget.mdx"
 unit starbeam_source
 integer starbeam_count
 integer starbeam_level
+sound starbeam_sound=null
 constant integer abilityid_amp=1093812820
 constant string amp_fx="Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl"
 constant string amp_fx_initial="war3mapImported\\FarseerMissile_Purple_2.mdx"
 constant integer amp_slow1=1093814582
 constant integer amp_slow2=1093814581
@@ -5495,13 +5495,10 @@
 call SetSoundDuration(gg_snd_SpiritTouch,2043)
 call SetSoundChannel(gg_snd_SpiritTouch,11)
 set gg_snd_FlameStrikeTargetWaveNonLoop101=CreateSound("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeTargetWaveNonLoop1.wav",false,true,true,10,10,"SpellsEAX")
 call SetSoundParamsFromLabel(gg_snd_FlameStrikeTargetWaveNonLoop101,"FlameStrikeTarget")
 call SetSoundDuration(gg_snd_FlameStrikeTargetWaveNonLoop101,1927)
-set gg_snd_RainOfFireTarget2=CreateSound("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget2.wav",false,true,true,10,10,"SpellsEAX")
-call SetSoundParamsFromLabel(gg_snd_RainOfFireTarget2,"StarfallTarget")
-call SetSoundDuration(gg_snd_RainOfFireTarget2,3000)
 endfunction
 function CreateBuildingsForPlayer0 takes nothing returns nothing
 local player p=Player(0)
 local unit u
 local integer unitID
@@ -12710,11 +12707,11 @@
 set HeroTips_5[i]="Items like Bloodstone or Aghanim's Scepter will allow Leshrac to use his spells more liberally and survive in the midst of battle."
 set i=i+1
 set HeroID[101]=1160786504
 set DummyID[101]=1747993410
 set HeroName[101]=1848658764
-set HeroIcon[101]="ReplaceableTextures\\CommandButtons\\BTNEredarWarlockPurple.blp"
+set HeroIcon[101]="ReplaceableTextures\\CommandButtons\\BTNArchimonde.blp"
 call RegisterVictoryAnimation(HeroID[101],"stand 3")
 call RegisterHeroScale(HeroID[101],1.25,DummyID[101])
 set HeroTips_1[i]=""
 set HeroTips_2[i]=""
 set HeroTips_3[i]=""
@@ -13402,14 +13399,20 @@
 set udg_NotSpells[67]=1093752645
 set udg_NotSpells[68]=1093752642
 set udg_NotSpells[69]=1093815111
 set udg_NotSpellsMax=68
 endfunction
-function InitTrig_Misc takes nothing returns nothing
+function RegisterMiscShit takes nothing returns boolean
 call MiscInit()
 call MiscInit2()
 call ItemAbilities_Init()
+return false
+endfunction
+function InitTrig_Misc takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterTimerEvent(t,0.01,false)
+call TriggerAddCondition(t,Condition(function RegisterMiscShit))
 endfunction
 function Trig_Map_Info_Actions takes nothing returns nothing
 call CreateQuestBJ(bj_QUESTTYPE_REQ_DISCOVERED,"TRIGSTR_50004","TRIGSTR_50005","ReplaceableTextures\\CommandButtons\\BTNSpy.blp")
 call CreateQuestBJ(bj_QUESTTYPE_REQ_DISCOVERED,"TRIGSTR_50006","TRIGSTR_50007","ReplaceableTextures\\CommandButtons\\BTNTome.blp")
 call CreateQuestBJ(bj_QUESTTYPE_REQ_DISCOVERED,"TRIGSTR_50008","TRIGSTR_50009","ReplaceableTextures\\CommandButtons\\BTNAmbush.blp")
@@ -16107,18 +16110,16 @@
 set RealKillHero=KillHero
 if IsUnitType(RealKillHero,UNIT_TYPE_HERO)==false then
 set RealKillHero=udg_Hero[GetPlayerId(GetOwningPlayer(RealKillHero))]
 endif
 if x>2 and GetUnitTypeId(RealKillHero)!=1429221446 and nohat_setting[GetPlayerId(GetOwningPlayer(RealKillHero))]==0 then
-call UnitAddAbility2(RealKillHero,1093815114)
 endif
 set RealDeadHero=DeadHero
 if IsUnitType(RealDeadHero,UNIT_TYPE_HERO)==false then
 set RealDeadHero=udg_Hero[GetPlayerId(GetOwningPlayer(RealDeadHero))]
 endif
 if suicide==false and EnemyDeath==true then
-call UnitRemoveAbility(RealDeadHero,1093815114)
 endif
 if x>2 and suicide==false then
 if x==3 then
 call PlaySoundEx(gg_snd_KillingSpree)
 set KillStreakText=" "+GetObjectName(MSG_IS_ON_A)+" |c0000ff40"+GetObjectName(MSG_KILLING_SPREE)+"|r"+GetObjectName(MSG_EXCLAMATION)
@@ -16287,30 +16288,10 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Deathtrigger_Condition))
 call TriggerAddAction(t,function Deathtrigger_Action)
 set gg_trg_Deathtrigger=t
 endfunction
-function ImageEnters_Main takes nothing returns boolean
-local unit Image=GetSummonedUnit()
-local integer x
-if IsUnitIllusion(Image)==true then
-set x=udg_Killsinarow[GetPlayerId(GetOwningPlayer(Image))]
-if x>2 and nohat_setting[GetPlayerId(GetOwningPlayer(Image))]==0 then
-call UnitAddAbility2(Image,1093815114)
-else
-call UnitRemoveAbility(Image,1093815114)
-endif
-endif
-set Image=null
-return false
-endfunction
-function InitTrig_Image_Enters takes nothing returns nothing
-local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
-call TriggerAddCondition(t,Condition(function ImageEnters_Main))
-set t=null
-endfunction
 function FirstBlood takes nothing returns nothing
 local trigger t=GetTriggeringTrigger()
 local player KillPlayer=GetOwningPlayer(GetKillingUnit())
 local player DeadPlayer=GetOwningPlayer(GetTriggerUnit())
 local string msg
@@ -16658,13 +16639,16 @@
 endif
 set i=i+1
 if Remaining==0 then
 call LeaderboardDisplay(courierdeath_lb[id],false)
 else
+if IsDead(udg_Hero[id])==false then
+call PlayerSetLeaderboard(Player(id),courierdeath_lb[id])
 call LeaderboardDisplay(courierdeath_lb[id],true)
 call LeaderboardSetLabel(courierdeath_lb[id],"    "+GetObjectName(1848659034)+" "+I2S(Remaining))
 endif
+endif
 endloop
 if Remaining==2 then
 call SetUnitPosition(Courier,x,y)
 endif
 if Remaining==0 then
@@ -35099,18 +35083,20 @@
 loop
 exitwhen i>5
 set p=udg_SentPlayers[i]
 set time=R2I(TimerGetRemaining(udg_PTimer[GetPlayerId(p)]))
 if time>0 and DBool[GetPlayerId(p)]and DM_ND==false and udg_GameOver==false then
+call PlayerSetLeaderboard(p,DBoard[GetPlayerId(p)])
 call LeaderboardDisplay(DBoard[GetPlayerId(p)],true)
 call LeaderboardSetLabel(DBoard[GetPlayerId(p)],"   "+GetObjectName(MSG_RESPAWN_IN)+" "+I2S(time)+" "+GetObjectName(MSG_SECONDS))
 else
 call LeaderboardDisplay(DBoard[GetPlayerId(p)],false)
 endif
 set p=udg_ScourgePlayers[i]
 set time=R2I(TimerGetRemaining(udg_PTimer[GetPlayerId(p)]))
 if time>0 and DBool[GetPlayerId(p)]and DM_ND==false and udg_GameOver==false then
+call PlayerSetLeaderboard(p,DBoard[GetPlayerId(p)])
 call LeaderboardDisplay(DBoard[GetPlayerId(p)],true)
 call LeaderboardSetLabel(DBoard[GetPlayerId(p)],"   "+GetObjectName(MSG_RESPAWN_IN)+" "+I2S(time)+" "+GetObjectName(MSG_SECONDS))
 else
 call LeaderboardDisplay(DBoard[GetPlayerId(p)],false)
 endif
@@ -35842,11 +35828,11 @@
 call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10,GetObjectName(MSG_COMMAND_MUSIC)+" ")
 call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10,"off, random, nightelf1, nightelf2, nightelf3, human1, human2, human3, orc1, orc2, orc3, undead1, undead2, undead3, other1, other2, other3, other4, other5, other6, other7, other8, other9, special")
 endif
 endif
 endfunction
-function InitTrig_Music takes nothing returns nothing
+function Music_Load takes nothing returns boolean
 set Music_Max=Music_Max+1
 set Music_Options[Music_Max]=gg_snd_NightElf1
 set Music_Max=Music_Max+1
 set Music_Options[Music_Max]=gg_snd_NightElf2
 set Music_Max=Music_Max+1
@@ -35887,10 +35873,16 @@
 set Music_Options[Music_Max]=gg_snd_Other8
 set Music_Max=Music_Max+1
 set Music_Options[Music_Max]=gg_snd_Other9
 set Music_Max=Music_Max+1
 set Music_Options[Music_Max]=gg_snd_Special
+return false
+endfunction
+function InitTrig_Music takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterTimerEvent(t,0.01,false)
+call TriggerAddCondition(t,Condition(function Music_Load))
 endfunction
 function Water_ForPlayer takes player p,integer r,integer g,integer b,integer a returns nothing
 if GetLocalPlayer()==p then
 call SetWaterBaseColor(r,g,b,a)
 endif
@@ -56436,11 +56428,11 @@
 call SetUnitScale(Tiny,0.5+0.25*Level,0.5+0.25*Level,0.5+0.25*Level)
 endif
 endfunction
 function Grow_AdjustImages takes nothing returns boolean
 local integer Level
-if IsUnitIllusion(GetTriggerUnit())and GetUnitTypeId(GetTriggerUnit())==1432580716 then
+if IsUnitIllusion(GetTriggerUnit())and(GetUnitTypeId(GetTriggerUnit())==1432580716 or GetUnitTypeId(GetTriggerUnit())==1429221720)then
 set Level=GetUnitAbilityLevel((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(298))),abilityid_grow)
 call SetUnitScale(GetTriggerUnit(),0.5+0.25*Level,0.5+0.25*Level,0.5+0.25*Level)
 endif
 return false
 endfunction
@@ -64696,26 +64688,35 @@
 call UnitAddItem(Kobold2,CreateItem((Item_Real[indexid_ironboots_disabled]),0,0))
 endif
 if Kobold3!=null then
 call UnitAddItem(Kobold3,CreateItem((Item_Real[indexid_ironboots_disabled]),0,0))
 endif
+if Kobold4!=null then
+call UnitAddItem(Kobold4,CreateItem((Item_Real[indexid_ironboots_disabled]),0,0))
+endif
 elseif Item8 then
 call UnitAddItem(Kobold1,CreateItem((Item_Real[indexid_ironboots]),0,0))
 if Kobold2!=null then
 call UnitAddItem(Kobold2,CreateItem((Item_Real[indexid_ironboots]),0,0))
 endif
 if Kobold3!=null then
 call UnitAddItem(Kobold3,CreateItem((Item_Real[indexid_ironboots]),0,0))
 endif
+if Kobold4!=null then
+call UnitAddItem(Kobold4,CreateItem((Item_Real[indexid_ironboots]),0,0))
+endif
 elseif Item7 then
 call UnitAddItem(Kobold1,CreateItem((Item_Real[indexid_arcaneboots]),0,0))
 if Kobold2!=null then
 call UnitAddItem(Kobold2,CreateItem((Item_Real[indexid_arcaneboots]),0,0))
 endif
 if Kobold3!=null then
 call UnitAddItem(Kobold3,CreateItem((Item_Real[indexid_arcaneboots]),0,0))
 endif
+if Kobold4!=null then
+call UnitAddItem(Kobold4,CreateItem((Item_Real[indexid_arcaneboots]),0,0))
+endif
 elseif Item6 then
 call UnitAddItem(Kobold1,CreateItem((Item_Real[indexid_phaseboots]),0,0))
 if Kobold2!=null then
 call UnitAddItem(Kobold2,CreateItem((Item_Real[indexid_phaseboots]),0,0))
 endif
@@ -80918,10 +80919,14 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function FireBarrier_Main))
 set t=null
 endfunction
+function SlightOfFist_RemoveHex takes unit Source returns nothing
+call UnitRemoveAbility(Source,1112500344)
+call UnitRemoveAbility(Source,1110454344)
+endfunction
 function SlightOfFist_ClearASBonus takes unit Source returns nothing
 call UnitRemoveAbility(Source,slightoffist_bonus_as)
 call UnitRemoveAbility(Source,slightoffist_bonus_buffid_as)
 endfunction
 function SlightOfFist_ClearDMGBonus takes unit Source returns nothing
@@ -80994,17 +80999,21 @@
 set found=true
 endif
 endloop
 call SetUnitPathing(Source,false)
 call SetUnitInvulnerable(Source,true)
+call RemoveAllEnsnare(Source)
 if found==false or((LoadInteger(hash_main,(GetHandleId((Source))),((4319))))==HERO_STATE_ON)==true then
 call SaveInteger(hash_main,(GetHandleId((Source))),((4318)),(HERO_STATE_OFF))
 call SlightOfFist_ClearASBonus(Source)
 call UnitRemoveAbility(Source,slightoffist_creepreduction)
 call SlightOfFist_ClearDMGBonus(Source)
+call RemoveAllEnsnare(Source)
+call SlightOfFist_RemoveHex(Source)
 call UnitAddAbility(Source,slightoffist_transform_out)
 call UnitRemoveAbility(Source,slightoffist_transform_out)
+call RemoveAllEnsnare(Source)
 if((LoadInteger(hash_main,(GetHandleId((Source))),((4319))))==HERO_STATE_ON)==false then
 call SetUnitX(Source,SourceX)
 call SetUnitY(Source,SourceY)
 endif
 call SetUnitVertexColor(Source,255,255,255,255)
@@ -81043,10 +81052,11 @@
 call FogModifierStart(fog)
 call SaveInteger(hash_main,(GetHandleId((Source))),((4318)),(HERO_STATE_ON))
 set tt_unit1=Source
 call GroupEnumUnitsInRange(g,x,y,150+100*Level+25,Condition(function GenericCondition_EnemyUnitsExNoInvisWithAncient))
 call RemoveAllEnsnare(Source)
+call SlightOfFist_RemoveHex(Source)
 call UnitAddAbility(Source,slightoffist_transform_in)
 call UnitRemoveAbility(Source,slightoffist_transform_in)
 call SetUnitVertexColor(Source,255,255,255,125)
 call SetUnitPathing(Source,false)
 call SetUnitInvulnerable(Source,true)
@@ -81521,10 +81531,21 @@
 set t=null
 set Source=null
 set Remnant=null
 return false
 endfunction
+function FireRemnant_RestoreMana takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+150)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+set Source=null
+return false
+endfunction
 function FireRemnant_Activate takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local trigger t
 local integer Cache=GetHandleId(Source)
 local integer TotalRemnants=(LoadInteger(hash_main,(Cache),(746)))
@@ -81553,11 +81574,15 @@
 call SaveReal(hash_main,(Cache),(44),((FireRemnant_CalculateSpeed(Source,Remnant))*1.0))
 call SaveReal(hash_main,(Cache),(6),((GetUnitX(Remnant))*1.0))
 call SaveReal(hash_main,(Cache),(7),((GetUnitY(Remnant))*1.0))
 call SaveInteger(hash_main,(Cache),(34),(1))
 else
-call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+100)
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.0,false)
+call TriggerAddCondition(t,Condition(function FireRemnant_RestoreMana))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 endif
 set t=null
 set Source=null
 set Remnant=null
 endfunction
@@ -82396,11 +82421,11 @@
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Attacker=GetAttacker()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_momentofcourage)
 local integer id
 if Source==GetTriggerUnit()and GetRandomInt(1,100)<=(14+2*Level)and((LoadInteger(hash_main,(GetHandleId((Source))),((4316))))==HERO_STATE_ON)==false and IsUnitAlly(Source,GetOwningPlayer(Attacker))==false then
-call AddHeroState(Source,4316,0.75)
+call AddHeroState(Source,4316,0.9)
 if Level==1 then
 set id=momentofcourage_bonus_1
 elseif Level==2 then
 set id=momentofcourage_bonus_2
 elseif Level==3 then
@@ -82816,11 +82841,11 @@
 local unit Source=GetTriggerUnit()
 local real x=GetSpellTargetX()
 local real y=GetSpellTargetY()
 local string s=starbeam_fx
 local location l=GetSpellTargetLoc()
-call PlaySoundAtPointBJ(gg_snd_RainOfFireTarget2,100,l,0)
+call PlaySoundAtPointBJ(starbeam_sound,100,l,0)
 call RemoveLocation(l)
 call TriggerRegisterTimerEvent(t,0.1,true)
 call TriggerAddCondition(t,Condition(function Starbeam_Loop))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(6),((x)*1.0))
@@ -82838,10 +82863,13 @@
 function Register_Starbeam takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Starbeam_Main))
 set t=null
+set starbeam_sound=CreateSound("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget2.wav",false,true,true,10,10,"SpellsEAX")
+call SetSoundParamsFromLabel(starbeam_sound,"StarfallTarget")
+call SetSoundDuration(starbeam_sound,3000)
 endfunction
 function Amp_RemoveSlow takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
@@ -83885,13 +83913,15 @@
 call SetUnitAbilityLevel(Caster,chakram_slow,Level)
 call IssueTargetOrder(Caster,"slow",Target)
 set Caster=null
 endfunction
 function Chakram_DamageOverTime takes nothing returns nothing
+if udg_GameOver==false then
 call DamageTarget(chakram_source,GetEnumUnit(),DAMAGE_PURE,(25+25*chakram_level)*0.5)
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
 call Chakram_SetSlow(chakram_source,GetEnumUnit())
+endif
 endfunction
 function Chakram_DamageOnce takes nothing returns nothing
 if IsUnitInGroup(GetEnumUnit(),chakram_group)==false then
 call GroupAddUnit(chakram_group,GetEnumUnit())
 call DamageTarget(chakram_source,GetEnumUnit(),DAMAGE_PURE,60+40*chakram_level)
@@ -83974,11 +84004,11 @@
 set chakram_level=GetUnitAbilityLevel(Source,abilityid_chakram)
 set g=GetAvailableGroup()
 call GroupEnumUnitsInRange(g,x,y,chakram_dps_aoe+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function Chakram_DamageOverTime)
 call KillGroup(g)
-set manacost=(10+10*chakram_level)/2
+set manacost=(15+5*chakram_level)/2
 if GetUnitState(Source,UNIT_STATE_MANA)<manacost or DistanceBetweenUnits(Source,Projectile)>2000 then
 call SaveInteger(hash_main,(Cache),(33),(2))
 call GroupClear(AlreadyHit)
 call UnitRemoveAbility(Source,abilityid_chakram_return)
 call UnitRemoveAbility(Source,1114663271)
@@ -84861,11 +84891,10 @@
 call InitTrig_Reliable_Gold()
 call InitTrig_Ban_Dev_Hero()
 call InitTrig_Track_Dying_Creeps()
 call InitTrig_CustomHeroRevive()
 call InitTrig_Deathtrigger()
-call InitTrig_Image_Enters()
 call InitTrig_First_Blood()
 call InitTrig_RoshanDies()
 call InitTrig_AntiDeny()
 call InitTrig_Chicken_Dies()
 call InitTrig_Item_Definitions()
