--- 74c.j	2012-11-25 22:05:45.000000000 +0100
+++ 76c.j	2012-11-25 22:06:23.000000000 +0100
@@ -811,10 +811,11 @@
 trigger gg_trg_MI=null
 trigger gg_trg_FR=null
 trigger gg_trg_ER=null
 trigger gg_trg_ZM=null
 trigger gg_trg_CP=null
+trigger gg_trg_TT=null
 trigger gg_trg_timer1=null
 trigger gg_trg_timer2=null
 trigger gg_trg_timer3=null
 trigger gg_trg_timer4=null
 trigger gg_trg_timer5=null
@@ -2106,10 +2107,12 @@
 integer Bonus_Count_XP
 integer Bonus_Count_Gold
 unit aegisholder=null
 boolean AegisMSG_Disabled=true
 integer roshan_upgradelevel=1
+integer roshan_respawn=600
+integer aegis_reclaim=360
 trigger t_UpgradeRoshan
 integer RoshanUpgrade=0
 leaderboard array courierdeath_lb
 boolean array courierdeath_active
 integer array Item_Dummy
@@ -2245,10 +2248,11 @@
 integer indexid_blackkingbar09
 integer indexid_blackkingbar08
 integer indexid_blackkingbar07
 integer indexid_blackkingbar06
 integer indexid_blackkingbar05
+integer indexid_blackkingbar04
 integer indexid_aegis
 integer indexid_mantastyle
 integer indexid_mantastyleranged
 integer indexid_lotharsedge
 integer indexid_dagonlevel1
@@ -2306,10 +2310,11 @@
 integer indexid_phoenixblade
 integer indexid_medallionofcourage
 integer indexid_veilofdiscord
 integer indexid_prudence
 integer indexid_annihilator
+integer indexid_shadowamulet
 integer indexid_recipe_headdressofrejuvenation
 integer indexid_recipe_nathrezimbuckler
 integer indexid_recipe_bootsoftravel
 integer indexid_recipe_powertreads
 integer indexid_recipe_handofmidas
@@ -2360,10 +2365,11 @@
 integer indexid_recipe_veilofdiscord
 integer indexid_recipe_orchidmalevolence
 integer indexid_recipe_bladeofthereaper
 integer indexid_recipe_ironboots
 integer indexid_recipe_prudence
+integer indexid_recipe_cripplingstaff
 constant integer powerup_haste=1227894838
 constant integer powerup_regeneration=1227894840
 constant integer powerup_invisibility=1227894858
 constant integer powerup_doubledamage=1227894859
 constant integer powerup_illusion=1227894839
@@ -2563,11 +2569,12 @@
 constant integer sange_buffid=1110454857
 constant integer sange_fx=1093809731
 constant integer abilityid_craniumbasher=1093744436
 constant integer itemid_euls=1919248946
 constant integer abilityid_eulsmovement=1093686832
-constant real armlet_drain=37
+constant integer armlet_hpregen=1093685333
+constant real armlet_drain=40
 constant integer powerup_linkensphere=1227901005
 constant integer buffid_linkensphere=1110458953
 constant integer abilityid_linkenpshere=1093746994
 constant integer abilityid_emptybottle=1093683254
 constant integer abilityid_summoncourier=1093681718
@@ -2644,25 +2651,28 @@
 constant integer unitid_necrounit2=1848651847
 constant integer unitid_necrounit3=1848651851
 constant integer unitid_necrounit4=1848651850
 constant integer unitid_necrounit5=1848651841
 constant integer unitid_necrounit6=1848651830
+integer necromarker_id
 constant integer abilityid_satanic=1093748304
 constant integer abilityid_satanicbonus=1093747534
 constant integer abilityid_helmofthedominator=1094935400
 integer abilityid_bkbitem10=1093742918
 integer abilityid_bkbitem09=1093742917
 integer abilityid_bkbitem08=1093686067
 integer abilityid_bkbitem07=1093742916
 integer abilityid_bkbitem06=1093742919
 integer abilityid_bkbitem05=1093742920
+integer abilityid_bkbitem04=1093815369
 integer abilityid_bkbavatar10=1093742914
 integer abilityid_bkbavatar09=1093742913
 integer abilityid_bkbavatar08=1093686066
 integer abilityid_bkbavatar07=1093742905
 integer abilityid_bkbavatar06=1093742915
 integer abilityid_bkbavatar05=1093742904
+integer abilityid_bkbavatar04=1093815368
 integer abilityid_bkbimmunity=1093682777
 constant integer abilityid_mekansm=1093681995
 constant integer abilityid_pipeofinsight=1093748055
 constant integer MSG_PipeOfInsight_STACK=1848652365
 constant integer pipeofinsight_barrier=1093748054
@@ -2691,10 +2701,11 @@
 constant integer abilityif_fortify_scourge=1093743693
 constant integer abilityid_fortify_armor=1093744466
 constant integer abilityid_fortify_magic=1093809222
 boolean fortify_sent_disabled=false
 boolean fortify_scourge_disabled=false
+constant real fortify_duration=5
 constant integer abilityid_phaseboots=1093743191
 constant integer abilityid_blademail=1093743959
 boolean blademail_flag=false
 constant integer abilityid_forcestaff=1093744973
 constant integer abilityid_ghostpotion=1093747011
@@ -2736,10 +2747,14 @@
 constant integer cripplingstaff_miss_buffid=1110459989
 constant integer cripplingstaff_slow=1093813571
 constant integer cripplingstaff_slow_buffid=1110459957
 constant real cripplingstaff_duration=4
 constant integer abilityid_tranquilboots=1093815089
+constant integer shadowamulet_buffid1=1110460214
+constant integer shadowamulet_buffid2=1110460216
+constant real shadowamulet_fadetime=2.6
+constant string shadowamulet_castfx="Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl"
 constant integer abilityid_corruptor=1093753420
 constant integer abilityid_corruptor_ranged=1093753421
 constant integer unitid_corruptor=1848659021
 constant integer unitid_corruptor_ranged=1848659022
 constant integer abilityid_medallion_of_courage=1093753417
@@ -2907,13 +2922,13 @@
 constant integer ModeCM_Ban1Duration=40
 constant integer ModeCM_Pick1Duration=50
 constant integer ModeCM_Ban2Duration=50
 constant integer ModeCM_Pick2Duration=50
 constant integer ModeCM_BankDuration=90
-constant integer ModeCM_Ban1Max=3
+constant integer ModeCM_Ban1Max=2
 constant integer ModeCM_Pick1Max=3
-constant integer ModeCM_Ban2Max=2
+constant integer ModeCM_Ban2Max=3
 constant integer ModeCM_Pick2Max=2
 constant string ModeCM_Color1="|c006699CC"
 constant string ModeCM_Color2="|c00ff0303"
 constant string ModeCM_Color3="|c00555555"
 multiboard CMBoard
@@ -2957,11 +2972,11 @@
 real RD_TextX_Scourge
 real RD_TextY_Scourge
 constant integer RD_Shadow=1747990089
 unit array RD_ShadowUnits
 integer ShadowUnitsMax=0
-constant integer RD_COUNT=20
+constant integer RD_COUNT=22
 trigger RD_Sell
 unit array ModeRD_Selectors1
 unit array ModeRD_Selectors2
 boolean ModeRD_Cap=false
 trigger CD_Trigger_Sell
@@ -3125,10 +3140,20 @@
 image CP2_Sentinel_Text_b
 image CP3_Sentinel_Text_a
 image CP3_Sentinel_Text_b
 image array CP_Image_a
 image array CP_Image_b
+boolean udg_ModeTT=false
+real array TT_LastTag
+unit array TT_HeroA
+unit array TT_HeroB
+integer array TT_PreviousGold
+integer array TT_GoldBank
+trigger tt_t_tracker=CreateTrigger()
+boolean array TT_DisableTracker
+constant integer tt_tagcooldown=180
+player tt_itemplayer
 constant integer abilityid_torrent=1093743414
 constant integer torrent_toss=1093743447
 constant integer torrent_slow=1093742924
 constant integer abilityid_watersword=1093743444
 constant integer watersword_damage=1093742927
@@ -3197,10 +3222,20 @@
 constant integer buffid_windwalk=1110455864
 integer quillcache
 constant integer abilityid_doubleedge=1093677132
 constant string doubleedge_fx_cast="war3mapImported\\DoubleEdgeCaster.mdx"
 constant string doubleedge_fx_impact="war3mapImported\\DoubleEdgeTarget.mdx"
+unit doubleedge_source
+real doubleedge_damage
+constant integer abilityid_stampede=1093816118
+constant integer stampede_haste=1093816116
+constant integer stampede_haste_buffid=1110460226
+unit stampede_source
+unit stampede_daamgesource
+integer stampede_level
+constant real stampede_duration=3.75
+constant integer abilityid_testoffath_allied=1093815619
 constant integer abilityid_penitence=1093684045
 constant integer label_dispelable=1093743175
 constant integer abilityid_holypersuasion=1093810260
 constant integer abilityid_holypersuasion_helper=1093678649
 constant integer abilityid_rocketflare=1093687862
@@ -3228,10 +3263,11 @@
 constant integer abilityid_freezingfield_slow=1093742676
 unit freezingfield_source
 integer freezingfield_damage
 constant integer abilityid_crystalnova=1093748025
 constant integer crystalnova_nuke=1093677380
+constant integer abilityid_brillianceaura=1095262562
 constant integer abilityid_staticremnant=1093743696
 constant integer unitid_staticremnant=1747990342
 unit staticremnant_source
 real staticremnant_damage
 constant integer abilityid_overload=1093685591
@@ -3322,10 +3358,15 @@
 constant integer liquidfire_fx=1093748291
 constant string liquidfire_fx_target="Abilities\\Spells\\Other\\BreathOfFire\\BreathOfFireDamage.mdl"
 constant string liquidfire_fx_cast="Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl"
 unit liquidfire_source
 integer liquidfire_level
+constant integer abilityid_icepath=1093685046
+constant integer icepath_stun=1093685062
+group icepath_alreadyhit
+unit icepath_source
+real icepath_stunduration
 constant integer abilityid_dualbreath=1093685047
 constant integer abilityid_dualbreathfrost=1093685058
 constant integer abilityid_dualbreathfire=1093685059
 constant integer abilityid_dualbreathfrosteffect=1093685057
 constant integer abilityid_omnislash=1093684529
@@ -3482,32 +3523,33 @@
 unit sentinel_closest
 unit sentinel_hero
 real sentinel_x
 real sentinel_y
 real sentinel_d
-constant integer abilityid_livingarmor=1093809231
-constant integer abilityid_livingarmor_aura_hp=1093809229
-constant integer abilityid_livingarmor_aura_hp_structure=1093809459
-constant integer abilityid_livingarmor_aura_hp_global=1093810224
-constant integer abilityid_livingarmor_aura_hp_structure_global=1093810225
-constant integer abilityid_livingarmor_aura_armor=1093809230
-constant integer abilityid_livingarmor_aura_armor_structure=1093809460
-constant integer abilityid_livingarmor_aura_armor_global=1093810009
-constant integer abilityid_livingarmor_aura_armor_structure_global=1093810010
-constant integer abilityid_livingarmor_fx=1093810483
+constant integer abilityid_livingarmor=1093815628
+constant integer livingarmor_damageblock_1=1093815640
+constant integer livingarmor_damageblock_2=1093815641
+constant integer livingarmor_damageblock_3=1093815639
+constant integer livingarmor_damageblock_4=1093815638
+constant integer livingarmor_buffid=1110460213
 constant integer abilityid_leechseed=1093809742
 constant string leechseed_fx="war3mapImported\\LeechSeed.MDX"
 constant string leechseed_pulse="Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl"
 constant integer unitid_leechseed=1747993656
 constant integer unitid_leechseed_projectile=1747993657
 constant integer leechseed_slow=1093809971
 constant integer leechseed_slow_buffid=1110459724
 unit leechseed_source
 unit leechseed_target
 real leechseed_amount
-constant integer abilityid_lastword=1093684547
+constant integer abilityid_lastword=1093815892
 integer array LastWord_Stolen
+constant integer lastword_visual=1093815893
+constant integer lastword_visual_buffid=1110455638
+constant string lastword_fx="war3mapImported\\LastWordDebuff_6.mdx"
+constant string lastword_fx_end_natural="war3mapImported\\LastWordDamageDuration.mdx"
+constant string lastword_fx_end_forced="war3mapImported\\LastWordDamageSpell.mdx"
 constant integer abilityid_glaivesofwisdom=1093684314
 constant integer buffid_glaivesofwisdom=1110455640
 constant integer abilityid_curseofthesilent=1093743692
 unit curseofthesilent_source
 constant integer curseofthesilent_icon=1093750867
@@ -3540,10 +3582,11 @@
 constant integer unitid_stormbolt=1747990353
 constant integer stormbolt_stun=1093685850
 constant string stormbolt_fx="Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl"
 constant string stormbolt_fx_attach="origin"
 unit stormbolt_caster
+integer stormbolt_level
 constant integer abilityid_rabid_1=1093748038
 constant integer abilityid_rabid_2=1093748037
 constant integer abilityid_rabid_3=1093748040
 constant integer abilityid_rabid_4=1093748041
 constant integer abilityid_rabid_5=1093748039
@@ -3582,11 +3625,12 @@
 constant integer unitid_ancestralcharge=1747990357
 constant integer ancestralcharge_banish=1093746999
 constant integer unitid_ancestralchargefx=1697657410
 constant integer ancestralcharge_movement=1093748537
 constant string ancestralcharge_fx="Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl"
-constant integer abilityid_ancestralcharge_end=1093808458
+constant integer abilityid_ancestralcharge_end=1093815881
+constant integer abilityid_image_echostomp=1093815371
 group ancestralcharge_group
 unit ancestralcharge_source
 real ancestralcharge_damage
 integer ancestralcharge_level
 integer ancestralcharge_attackbonus
@@ -3638,11 +3682,11 @@
 unit whirlingaxes_source
 unit whirlingaxes_caster
 unit whirlingaxes_axe
 group whirlingaxes_group
 integer whirlingaxes_level
-constant integer abilityid_overpower=1093750324
+constant integer abilityid_overpower=1093750841
 constant integer overpower_speed=1093750323
 constant integer overpower_fx=1093750326
 constant integer overpower_icon=1093750327
 constant integer overpower_icon_buff=1110459208
 constant integer abilityid_enrage=1093684291
@@ -3659,10 +3703,11 @@
 constant integer abilityid_magicmissle=1093677633
 constant integer abilityid_wardentrapactivate=1093685841
 constant integer abilityid_wardentrapslow=1093685845
 constant integer unitid_wardentrap=1697657392
 constant integer abilityid_wardentrapburn=1093686071
+integer wardentrapslow_level
 constant integer abilityid_vorpalblade=1093685839
 constant integer upgradeid_vorpalblade=1382379618
 constant integer abilityid_refraction=1093748033
 constant integer abilityid_refractionpreventionbuff=1093685838
 constant integer abilityid_refractionbonusdamagebuff=1093685837
@@ -3732,18 +3777,24 @@
 constant integer abilityid_cullingblade=1093682482
 constant integer abilityid_cullingblade_upgrade=1093750098
 constant integer cullingblade_haste=1093814595
 constant integer cullingblade_buffid=1110459990
 constant integer abilityid_nightmare=1093678169
+constant integer abilityid_nightmare_helper=1093816121
 constant integer buffid_nightmare=1110454854
 constant integer abilityid_fiendsgrip=1093677649
 constant integer abilityid_fiendsgripupgrade=1093747769
-constant integer abilityid_enfeeble=1093678166
-constant integer enfeeble_1=1093808689
-constant integer enfeeble_2=1093808691
-constant integer enfeeble_3=1093808692
-constant integer enfeeble_4=1093808690
+constant integer abilityid_enfeeble=1093816137
+constant integer enfeeble_1=1093816135
+constant integer enfeeble_1_real=1093816132
+constant integer enfeeble_2=1093816129
+constant integer enfeeble_2_real=1093816133
+constant integer enfeeble_3=1093816134
+constant integer enfeeble_3_real=1093816131
+constant integer enfeeble_4=1093816136
+constant integer enfeeble_4_real=1093816130
+constant integer enfeeble_buffid=1110460229
 constant integer abilityid_stickynapalm=1093748044
 integer array stickynapalm_slow_1
 integer array stickynapalm_slow_2
 integer array stickynapalm_slow_3
 integer array stickynapalm_slow_4
@@ -3961,11 +4012,11 @@
 trigger dividedwestand_t
 trigger DoubleTroubleTrigger
 integer dividedwestand_count=0
 boolean dividedwestand_usedscepter=false
 constant integer abilityid_splitearth=1093678679
-constant integer abilityid_diabolicedict=1093808212
+constant integer abilityid_diabolicedict=1093677877
 constant integer abilityid_pulsenova=1093808454
 constant integer abilityid_pulsenovaupgraded=1093808455
 constant integer abilityid_pulsenova_disabled=1093808456
 constant string pulsenova_fx="Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl"
 unit pulsenova_source
@@ -4047,25 +4098,28 @@
 constant integer abilityid_feast=1093686099
 constant integer abilityid_heartstopper=1093677390
 constant integer buffid_heartstopper=1110456372
 unit heartstopper_source
 integer heartstopper_level
+constant integer abilityid_sadist=1093678640
+constant integer buffid_sadist=1110454866
 integer abilityid_deathpulse=1093678422
 constant integer abilityid_reapersscythe=1093678647
 constant integer abilityid_reapersscythe_upgrade=1093679184
 constant string reapersscythe_fx="Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl"
+boolean reaperscythe_hit=false
 constant integer abilityid_nerubimpale=1093687351
 constant integer abilityid_manaburn=1093748789
 constant integer abilityid_watchersuicide=1093748808
 constant integer scarab_silence=1093748551
 unit scarab_caster
 constant integer abilityid_spikedcarapace=1093815119
-constant integer abilityid_necromastry=1093681746
-constant integer abilityid_necromastryhelper=1093682001
 constant string shadowraze_fx="Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl"
 constant integer abilityid_requiemofsouls=1093810506
 constant integer abilityid_requiemofsouls_upgrade=1093750096
+constant integer abilityid_necromastry=1093681746
+constant integer abilityid_necromastryhelper=1093682001
 constant integer abilityid_fear=1093679171
 constant integer unitid_fear=1966092617
 constant integer abilityid_stiflingknife=1093687629
 constant integer abilityid_stiflingknifeslow=1093687628
 constant integer unitid_stiflingknife=1747988784
@@ -4078,17 +4132,19 @@
 constant integer abilityid_cagehelper=1093685833
 constant real settings_cageduration=7
 constant real settings_cageradius=300
 unit cage_source
 constant integer abilityid_portal=1093685808
+constant integer abilityid_portal_disabled=1093815618
 constant integer abilityid_expulsion=1093810232
 constant integer abilityid_expulsion_aura=1093810227
 real expulsion_amount
 unit expulsion_source
-constant integer abilityid_firestorm=1093809743
+constant integer abilityid_firestorm=1093677385
 constant integer abilityid_firestormhelper=1093809744
 constant integer abilityid_firestormhelper2=1093809714
+real firestorm_amount
 constant integer abilityid_demonicclutch=1093809233
 constant integer demonicclutch_slow_1=1093809242
 constant integer demonicclutch_slow_2=1093809456
 constant integer demonicclutch_slow_3=1093809240
 constant integer demonicclutch_slow_4=1093809457
@@ -4119,10 +4175,14 @@
 constant integer corpsecollector_icon_9=1093809739
 constant integer corpsecollector_icon_10=1093809732
 constant string corpsecollector_fx_fire="war3mapImported\\CorpseFire.mdx"
 unit corpsecollector_source
 real corpsecollector_damage
+constant integer abilityid_summonshade=1093815350
+constant integer unitid_summonshade=1966092633
+unit summonshade_source
+constant integer abilityid_diffusionaura=1095328612
 constant integer abilityid_fleshheap=1093678660
 constant integer unitid_pudge_suicide=1747993154
 constant string pudge_suicide_fx="Objects\\Spawnmodels\\Undead\\UndeadBlood\\UndeadBloodAbomination.mdl"
 constant integer abilityid_hook=1093678665
 constant integer abilityid_hookministun=1093685338
@@ -4152,10 +4212,11 @@
 real eyeofthestorm_damage
 unit eyeofthestorm_source
 unit eyeofthestrom_bestunit
 real eyeofthestrom_besthp
 integer eyeofthestorm_cache
+constant real eyeofthestorm_tickrate=0.05
 constant integer abilityid_burrowstrike=1093678671
 constant integer abilityid_epicenter=1093678674
 constant integer abilityid_epicenterupgrade=1093747252
 constant integer abilityid_epicentereffect=1093744450
 constant string epicenter_fx_1="war3mapImported\\EpiPulse_1_4.mdx"
@@ -4201,22 +4262,23 @@
 constant integer zeal_regen_2=1093809977
 constant integer zeal_regen_3=1093809975
 constant integer zeal_regen_4=1093809976
 constant integer abilityid_sunder=1093678929
 constant integer abilityid_sundercaster=1093678930
-constant integer abilityid_reflection=1093809985
+constant integer abilityid_reflection=1093815130
 constant integer reflection_slow_1=1093809752
 constant integer reflection_slow_2=1093809750
 constant integer reflection_slow_3=1093809753
 constant integer reflection_slow_4=1093809751
 constant integer reflection_slow_buffid=1110459722
 constant integer reflection_image=1093809227
 constant integer reflection_image_buffid=1110459726
 constant string reflection_fx="war3mapImported\\BlackChakraExplosion.mdx"
-constant integer abilityid_metamorph=1093751369
+constant integer abilityid_metamorph=1093815128
 constant integer metamorph_image=1093679185
 constant integer metamorph_buffid=1110459721
+constant integer metamorph_in=1093815129
 constant integer abilityid_soulsteal=1093750856
 constant integer abilityid_soulsteal_dummy=1093678156
 constant integer abilityid_soulsteal_secondary=1093751361
 constant integer unitid_soulsteal=1966092615
 constant integer abilityid_krakenshell=1093678149
@@ -4232,10 +4294,11 @@
 unit shadowwave_source
 constant integer abilityid_weave=1093742673
 constant integer abilityid_weaveupgrade=1093747778
 constant integer WEAVE_POSITIVE=1
 constant integer WEAVE_NEGATIVE=2
+constant real weave_interval=1.0
 constant integer abilityid_shallowgrave=1093742668
 constant integer buff_shallowgrave=1093808457
 constant integer buff_shallowgrave_id=1110456132
 constant integer abilityid_venomousgale=1093744435
 constant integer abilityid_venomousgale_slow=1093744462
@@ -4256,10 +4319,11 @@
 constant integer corrosiveskin_1=1093808983
 constant integer corrosiveskin_2=1093808981
 constant integer corrosiveskin_3=1093808982
 constant integer corrosiveskin_4=1093808984
 constant integer corrosiveskin_buffid=1110459713
+constant real corrosiveskin_duration=4
 constant integer abilityid_viperstrike=1093679152
 constant integer abilityid_viperstrike_ugprade=1093752154
 constant integer buffid_shadowstrike=1111847784
 constant integer buffid_shadowstrike2=1110458705
 constant integer abilityid_gravekeeperscloak=1093686872
@@ -4435,10 +4499,12 @@
 constant integer abilityid_shackle=1093677136
 constant integer abilityid_dash=1093751370
 constant integer abilityid_dash_helper=1093808206
 constant string dash_fx="war3mapImported\\FireBlast.mdx"
 constant integer dash_disarm=1096971630
+constant integer dash_slow=1093816119
+constant integer dash_slow_buffid=1110460227
 group dash_alreadydamaged
 integer dash_level
 unit dash_source
 constant integer dash_width=500
 constant integer dash_length=1400
@@ -4474,31 +4540,40 @@
 constant integer sweepingflame_projectileid=1747993665
 constant integer abilityid_sunray=1093753177
 constant integer abilityid_sunray_off=1093753395
 constant integer abilityid_sunray_movement=1093808181
 constant string sunray_fx="war3mapImported\\FireRayTarget.mdx"
-constant real sunray_maxdistance=1150
+constant real sunray_maxdistance=1600
 constant real sunray_offset_x=20
 constant real sunray_offset_y=20
 constant real sunray_offset_z=20
 constant integer sunray_maim_1=1093753396
 constant integer sunray_maim_2=1093753409
 constant integer sunray_maim_3=1093753410
 constant integer sunray_maim_4=1093753401
 constant integer buffid_sunray=1110459478
+constant real sunray_max_duration=6.0
 integer sunray_level
 unit sunray_source
 group sunray_group
-real sunray_damage
+real sunray_damage1
+real sunray_damage2
 constant integer abilityid_firespirits=1093753176
 constant integer abilityid_firespirits_helper=1093753394
 constant integer abilityid_firespirits_slow=1093808469
+constant integer firespirits_disarm=1093815352
 constant integer unitid_firespirits=1747993429
 constant string firespirits_fx="war3mapImported\\Firaga_2.mdx"
 unit firespirits_source
 unit firespirits_caster
 real firespirits_damage
+constant integer abilityid_overheat=1093815345
+constant string overheat_fx="Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl"
+constant integer overheat_disarm=1093815352
+group overheat_alreadydamaged
+integer overheat_level
+unit overheat_source
 constant integer abilityid_shadowpoison=1093751604
 constant integer abilityid_shadowpoison_explode=1093751609
 constant integer unitid_shadowpoison=1747993394
 constant string shadowpoison_fx="war3mapImported\\shamanyouranus-ShadowyMissile.mdl"
 unit shadowpoison_source
@@ -4750,10 +4825,11 @@
 constant integer wrath_magicbonus_1=1093812787
 constant integer wrath_magicbonus_2=1093812784
 constant integer wrath_magicbonus_3=1093812785
 constant integer wrath_magicbonus_4=1093812786
 constant integer abilityid_blackjack=1093812788
+group blackjack_alreadyhit
 constant integer abilityid_miasma=1093812789
 constant integer miasma_reveal_orderid=852625
 constant integer miasma_reveal=1093812791
 constant integer abilityid_brotherhood=1093814066
 constant integer brotherhood_fx=1093814607
@@ -4854,32 +4930,49 @@
 constant integer unitid_chakram=1747993683
 constant integer chakram_slow=1093813334
 group chakram_group
 unit chakram_source
 integer chakram_level
-constant integer abilityid_breeze=1093813582
-constant integer unitid_breeze=1747993688
-constant integer breeze_slow_1=1093813580
-constant integer breeze_slow_2=1093813579
-constant integer breeze_slow_3=1093813578
-constant integer breeze_slow_4=1093813581
-constant integer breeze_slow_buffid=1110459958
-unit breeze_source
-unit breeze_projectile
-group breeze_group
-constant integer abilityid_frostskin=1093813593
-constant integer frostskin_reduction_1=1093813592
-constant integer frostskin_reduction_2=1093813589
-constant integer frostskin_reduction_3=1093813590
-constant integer frostskin_reduction_4=1093813591
-constant integer frostskin_mana_1=1093813587
-constant integer frostskin_mana_2=1093813586
-constant integer frostskin_mana_3=1093813585
-constant integer frostskin_mana_4=1093813588
-constant integer abilityid_frostgiant=1093813594
-constant integer frostgiant_sourceid=1311788343
-constant integer unitid_frostgiant=1865429333
+constant integer abilityid_trap=1093815353
+constant integer trap_marker=1093815365
+constant integer trap_marker_buffid=1110460209
+constant real trap_duration=20
+integer trap_bonuscount
+unit trap_source
+integer trap_level
+constant integer abilityid_split=1093815361
+constant integer split_slow=1093815627
+constant integer split_slow_buffid=1110460212
+unit split_source
+unit split_target
+real split_time=1.35
+real split_minspeed=500
+constant integer abilityid_shield=1093815362
+constant integer shield_armor=1093815364
+constant string shield_fx="war3mapImported\\Cryofreeze5.mdx"
+constant integer abilityid_curse=1093687856
+group curse_group
+trigger curse_trigger
+unit curse_target
+unit curse_source=null
+constant string curse_fx="war3mapImported\\WintersCurse.mdx"
+constant string curse_ground_fx="war3mapImported\\WintersCurseAoE.mdx"
+constant integer abilityid_touch=1093815859
+constant integer buffid_touch=1110460215
+constant real touch_burnduration=6
+constant string touch_burnfx="effects\\BasicWaterFlash.mdx"
+constant integer abilityid_arcticsiege=1093815877
+constant integer arcticsiege_slow_1=1093815874
+constant integer arcticsiege_slow_1_real=1093815873
+constant integer arcticsiege_slow_2=1093815862
+constant integer arcticsiege_slow_2_real=1093815864
+constant integer arcticsiege_slow_3=1093815875
+constant integer arcticsiege_slow_3_real=1093815863
+constant integer arcticsiege_slow_4=1093815876
+constant integer arcticsiege_slow_4_real=1093815865
+constant integer arcticsiege_slow_buffid=1110460225
+constant real arcticsiege_duration=6
 constant integer abilityid_sonicboom=1093813812
 constant string sonicboom_impactfx="war3mapImported\\BlackDragonMissile.mdx"
 unit sonicboom_source
 integer sonicboom_level
 constant integer abilityid_windblast=1093813573
@@ -4913,10 +5006,44 @@
 constant string divineintervention_fx="Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl"
 constant integer divineintervention_doom=1093813847
 constant integer divineintervention_disableattack=1096971630
 constant integer abilityid_chill=1093813583
 constant integer chill_silence=1093813584
+constant integer abilityid_lightningseeker=1093815372
+constant integer lightningseeker_unitid=1747993927
+constant real lightningseeker_duration=50
+constant integer abilityid_magneticfield=1093815373
+constant integer magneticfield_evasion1=1093815609
+constant integer magneticfield_evasion2=1093815617
+constant integer magneticfield_evasion3=1093815374
+constant integer magneticfield_evasion4=1093815608
+constant integer magneticfield_evasion1_basic=1093815888
+constant integer magneticfield_evasion2_basic=1093815891
+constant integer magneticfield_evasion3_basic=1093815890
+constant integer magneticfield_evasion4_basic=1093815889
+constant real magneticfield_duration=5
+constant string magneticfield_fx="war3mapImported\\MagneticField04.mdl"
+constant integer unitid_magneticfield=1747993928
+integer magneticfield_level
+integer magneticfield_desiredbuff
+constant integer abilityid_nuralshock=1093815601
+constant integer nuralshock_slow_1=1093815383
+constant integer nuralshock_slow_2=1093815385
+constant integer nuralshock_slow_1_buffid=1110460210
+constant integer nuralshock_slow_2_buffid=1110460211
+constant real nuralshock_duration=6
+constant string nuralshock_fx="war3mapImported\\Flux3.mdx"
+constant integer abilityid_tempestdouble=1093815600
+constant integer unitid_tempestdouble=1311788365
+constant string tempestdouble_fx="Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl"
+constant integer abilityid_marksmanship=1093686851
+constant integer abilityid_marksmanship_double=1093815896
+constant integer abilityid_trueshotaura=1093816114
+constant integer abilityid_trueshotaura_aura=1093815897
+constant integer abilityid_trueshotaura_aura_creeps_global=1093816115
+constant integer TRUESHOT_CREEPS_GLOBAL_ON=1
+constant integer TRUESHOT_CREEPS_GLOBAL_OFF=2
 endglobals
 function InitGlobals takes nothing returns nothing
 local integer i=0
 set i=0
 loop
@@ -6289,17 +6416,54 @@
 if id==IntelligenceHero[x]then
 return HEROTYPE_INT
 endif
 set x=x+1
 endloop
-if id==1164277357 or id==1160786518 or id==1160786519 or id==1160786517 or id==1311781442 or id==1311781175 or id==1211119684 or id==1211119683 or id==1211119668 or id==1211119682 or id==1311781171 or id==1311781172 or id==1311781173 or id==1160786511 then
+if id==1164277357 or id==1160786518 or id==1160786519 or id==1160786517 or id==1311781442 or id==1311781175 or id==1211119684 or id==1211119683 or id==1211119668 or id==1211119682 or id==1311781171 or id==1311781172 or id==1311781173 or id==1160786511 or id==1311788365 then
+return HEROTYPE_AGI
+endif
+if id==1311781192 or id==1311781204 or id==1311781194 or id==1211117637 or id==1211117639 or id==1211117638 or id==1211119433 or id==1160786229 or id==1211122513 or id==1211122995 or id==1211122996 or id==1211122997 or id==1429221720 then
+return HEROTYPE_STR
+endif
+if id==1211119192 or id==1211119193 or id==1211119191 or id==1211122243 or id==1328558391 or id==1311788354 or id==1311788355 or id==1311788367 or id==1311788353 then
+return HEROTYPE_INT
+endif
+return 0
+endfunction
+function GetHeroTypeById takes integer id returns integer
+local integer x
+set x=1
+loop
+exitwhen x>AgilityHeroCount
+if id==AgilityHero[x]then
+return HEROTYPE_AGI
+endif
+set x=x+1
+endloop
+set x=1
+loop
+exitwhen x>StrengthHeroCount
+if id==StrengthHero[x]then
+return HEROTYPE_STR
+endif
+set x=x+1
+endloop
+set x=1
+loop
+exitwhen x>IntelligenceHeroCount
+if id==IntelligenceHero[x]then
+return HEROTYPE_INT
+endif
+set x=x+1
+endloop
+if id==1164277357 or id==1160786518 or id==1160786519 or id==1160786517 or id==1311781442 or id==1311781175 or id==1211119684 or id==1211119683 or id==1211119668 or id==1211119682 or id==1311781171 or id==1311781172 or id==1311781173 or id==1160786511 or id==1311788365 then
 return HEROTYPE_AGI
 endif
 if id==1311781192 or id==1311781204 or id==1311781194 or id==1211117637 or id==1211117639 or id==1211117638 or id==1211119433 or id==1160786229 or id==1211122513 or id==1211122995 or id==1211122996 or id==1211122997 or id==1429221720 then
 return HEROTYPE_STR
 endif
-if id==1211119192 or id==1211119193 or id==1211119191 or id==1211122243 or id==1328558391 then
+if id==1211119192 or id==1211119193 or id==1211119191 or id==1211122243 or id==1328558391 or id==1311788354 or id==1311788355 or id==1311788367 or id==1311788353 then
 return HEROTYPE_INT
 endif
 return 0
 endfunction
 function GetPrimaryStat takes unit Hero returns integer
@@ -6626,13 +6790,10 @@
 endif
 set udg_Set[Rand]=udg_Set[udg_SetHighBound]
 set udg_SetHighBound=udg_SetHighBound-1
 return Picked
 endfunction
-function IsSilenced takes unit whichUnit returns boolean
-return GetUnitAbilityLevel(whichUnit,1110454612)>0 or GetUnitAbilityLevel(whichUnit,1112437609)>0 or GetUnitAbilityLevel(whichUnit,1110454616)>0 or GetUnitAbilityLevel(whichUnit,1112433775)>0 or GetUnitAbilityLevel(whichUnit,1110454861)>0 or GetUnitAbilityLevel(whichUnit,1114137953)>0 or GetUnitAbilityLevel(whichUnit,1110456150)>0 or GetUnitAbilityLevel(whichUnit,1110458969)>0 or GetUnitAbilityLevel(whichUnit,1110456399)>0 or GetUnitAbilityLevel(whichUnit,1110456149)>0 or GetUnitAbilityLevel(whichUnit,1110459468)>0 or GetUnitAbilityLevel(whichUnit,1110456406)>0 or GetUnitAbilityLevel(whichUnit,1110455089)>0 or GetUnitAbilityLevel(whichUnit,1110459988)>0 or GetUnitAbilityLevel(whichUnit,1110459975)>0
-endfunction
 function HexToInt_Child takes string Char returns integer
 if Char=="a"then
 return 10
 elseif Char=="b"then
 return 11
@@ -6994,11 +7155,11 @@
 set udg_Host=udg_ScourgePlayers[loopcurrent]
 endloop
 endif
 endfunction
 function IsRealHero takes unit Hero returns boolean
-return IsUnitType(Hero,UNIT_TYPE_HERO)==true and IsUnitIllusion(Hero)==false and GetUnitTypeId(Hero)!=1211117645 and GetUnitTypeId(Hero)!=1211117657 and GetUnitTypeId(Hero)!=1211119431 and GetUnitTypeId(Hero)!=1211122232
+return IsUnitType(Hero,UNIT_TYPE_HERO)==true and IsUnitIllusion(Hero)==false and GetUnitTypeId(Hero)!=1211117645 and GetUnitTypeId(Hero)!=unitid_tempestdouble and GetUnitTypeId(Hero)!=1211117657 and GetUnitTypeId(Hero)!=1211119431 and GetUnitTypeId(Hero)!=1211122232
 endfunction
 function DummyToHero takes integer i returns integer
 local integer x=0
 loop
 exitwhen x>ScourgeMax
@@ -7045,10 +7206,22 @@
 return id==unitid_gargoyle_a_1 or id==unitid_gargoyle_a_2 or id==unitid_gargoyle_a_3 or id==unitid_gargoyle_b_1 or id==unitid_gargoyle_b_2 or id==unitid_gargoyle_b_3
 endfunction
 function IsHexed takes unit u returns boolean
 return GetUnitAbilityLevel(u,1112500344)>0 or GetUnitAbilityLevel(u,1110454344)>0
 endfunction
+function PrimalSplit_IsPanda takes integer uid returns boolean
+if uid==1852862003 or uid==1852862006 or uid==1848652080 or uid==1848657754 then
+return true
+endif
+if uid==1852862002 or uid==1852862006 or uid==1848652082 or uid==1848657969 then
+return true
+endif
+if uid==1852862001 or uid==1852862004 or uid==1848652081 or uid==1848657968 then
+return true
+endif
+return false
+endfunction
 function DamageTarget takes unit Source,unit Target,integer DamageType,real Damage returns nothing
 if DamageType==0 then
 return
 endif
 if DamageType==DAMAGE_MAGICAL then
@@ -7631,14 +7804,15 @@
 local real TargetY=GetUnitY(Target)
 local real MoveRate=Speed*0.03
 local real NewAngle=AngleBetweenXY(x,y,TargetX,TargetY)
 local real NewX=x+MoveRate*Cos(NewAngle*bj_DEGTORAD)
 local real NewY=y+MoveRate*Sin(NewAngle*bj_DEGTORAD)
+local boolean IgnoreDead=(LoadBoolean(hash_main,(Cache),(698)))
 call SetUnitX(Projectile,NewX)
 call SetUnitY(Projectile,NewY)
 call SetUnitFacing(Projectile,NewAngle)
-if IsDead(Target)then
+if IsDead(Target)and IgnoreDead==false then
 call KillUnit(Projectile)
 call TI_ClearUnit(TargetIndex)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 elseif GetDist(TargetX,TargetY,NewX,NewY)<=MoveRate then
@@ -7667,10 +7841,11 @@
 call SaveReal(hash_main,(Cache),(44),((Speed)*1.0))
 call SaveInteger(hash_main,(Cache),(30),(TI_AddUnit(Target)))
 call SaveStr(hash_main,(Cache),(46),(callback))
 call SaveInteger(hash_main,(Cache),(43),(TI_AddUnit(Source)))
 call SaveUnitHandle(hash_main,(Cache),(45),(CreateUnit(GetOwningPlayer(Source),projectileid,SourceX,SourceY,SourceA)))
+call SaveBoolean(hash_main,(Cache),(698),(false))
 set tt_trig1=t
 set t=null
 return tt_trig1
 endfunction
 function MoveProjectileToXY_Move takes nothing returns boolean
@@ -8579,11 +8754,14 @@
 set i=i+1
 endloop
 return Location(x,y)
 endfunction
 function GenericCondition_IsDotAInvis takes unit u returns boolean
-return GetUnitAbilityLevel(u,1110455864)>0 or GetUnitAbilityLevel(u,1110456148)>0 or GetUnitAbilityLevel(u,1110456118)>0 or GetUnitAbilityLevel(u,1112504171)>0 or GetUnitAbilityLevel(u,1110455378)>0 or GetUnitAbilityLevel(u,1110458677)>0 or GetUnitAbilityLevel(u,1110454609)>0 or GetUnitAbilityLevel(u,1110454326)>0 or GetUnitAbilityLevel(u,1114205814)>0 or GetUnitAbilityLevel(u,1097886070)>0 or GetUnitAbilityLevel(u,1093677617)>0 or GetUnitAbilityLevel(u,1093684020)>0 or GetUnitAbilityLevel(u,1093687362)>0 or GetUnitAbilityLevel(u,1093687858)>0 or GetUnitAbilityLevel(u,1093748545)>0 or GetUnitAbilityLevel(u,1093748823)>0 or GetUnitAbilityLevel(u,1093748824)>0 or GetUnitAbilityLevel(u,1093677130)>0 or GetUnitAbilityLevel(u,1110456395)>0 or GetUnitAbilityLevel(u,1110456408)>0 or GetUnitAbilityLevel(u,1110455097)>0 or GetUnitAbilityLevel(u,1110454347)>0 or GetUnitAbilityLevel(u,1112041075)>0 or GetUnitAbilityLevel(u,1093743664)>0 or GetUnitAbilityLevel(u,1110454833)>0 or GetUnitAbilityLevel(u,1093687876)>0 or GetUnitAbilityLevel(u,1093684052)>0
+return GetUnitAbilityLevel(u,1110455864)>0 or GetUnitAbilityLevel(u,1110456148)>0 or GetUnitAbilityLevel(u,1110456118)>0 or GetUnitAbilityLevel(u,1112504171)>0 or GetUnitAbilityLevel(u,1110455378)>0 or GetUnitAbilityLevel(u,1110458677)>0 or GetUnitAbilityLevel(u,1110454609)>0 or GetUnitAbilityLevel(u,1110454326)>0 or GetUnitAbilityLevel(u,1114205814)>0 or GetUnitAbilityLevel(u,1097886070)>0 or GetUnitAbilityLevel(u,1093677617)>0 or GetUnitAbilityLevel(u,1093684020)>0 or GetUnitAbilityLevel(u,1093687362)>0 or GetUnitAbilityLevel(u,1093687858)>0 or GetUnitAbilityLevel(u,1093748545)>0 or GetUnitAbilityLevel(u,1093748823)>0 or GetUnitAbilityLevel(u,1093748824)>0 or GetUnitAbilityLevel(u,1093677130)>0 or GetUnitAbilityLevel(u,1110456395)>0 or GetUnitAbilityLevel(u,1110456408)>0 or GetUnitAbilityLevel(u,1110455097)>0 or GetUnitAbilityLevel(u,1110454347)>0 or GetUnitAbilityLevel(u,1112041075)>0 or GetUnitAbilityLevel(u,1093743664)>0 or GetUnitAbilityLevel(u,1110454833)>0 or GetUnitAbilityLevel(u,1093687876)>0 or GetUnitAbilityLevel(u,1093684052)>0 or GetUnitAbilityLevel(u,1110460216)>0
+endfunction
+function GenericCondition_IsInvisibleToMe takes unit u,player p returns boolean
+return GenericCondition_IsDotAInvis(u)==false or IsUnitVisible(GetFilterUnit(),p)==true
 endfunction
 function GenericCondition_IsBear takes unit whichUnit returns boolean
 local integer TypeId=GetUnitTypeId(whichUnit)
 return TypeId==1848651828 or TypeId==1848652103 or TypeId==1848652099 or TypeId==1848652088 or TypeId==1697656907 or TypeId==1697656905 or TypeId==1697656908 or TypeId==1697657162
 endfunction
@@ -8597,10 +8775,13 @@
 return(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
 endfunction
 function GenericCondition_BasicsAndStructure takes nothing returns boolean
 return GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false
 endfunction
+function GenericCondition_Structure takes nothing returns boolean
+return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==true and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false
+endfunction
 function GenericCondition_EnemyUnitsExNoImmuneNoInvisAndStructure takes nothing returns boolean
 return IsMagicImmune(GetFilterUnit())==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
 endfunction
 function GenericCondition_EnemyUnitsExNoImmuneAndStructure takes nothing returns boolean
 return IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
@@ -8669,10 +8850,16 @@
 return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and GetOwningPlayer(GetFilterUnit())!=udg_NeutralHostile
 endfunction
 function GenericCondition_EnemyUnitsAndStructureEx takes nothing returns boolean
 return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
 endfunction
+function GenericCondition_AlliedUnitsAndStructureEx takes nothing returns boolean
+return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
+endfunction
+function GenericCondition_AlliedStructureEx takes nothing returns boolean
+return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==true and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
+endfunction
 function GenericCondition_EnemyUnitsAndStructureExNoHeroes takes nothing returns boolean
 return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false
 endfunction
 function GenericCondition_EnemyUnitsAndStructureExNoImmune takes nothing returns boolean
 return IsMagicImmune(GetFilterUnit())==false and(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))
@@ -8693,10 +8880,13 @@
 return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
 endfunction
 function GenericCondition_AlliedHeroes takes nothing returns boolean
 return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
 endfunction
+function GenericCondition_MyUnits takes nothing returns boolean
+return GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
+endfunction
 function GenericCondition_AlliedHeroesAndCreeps takes nothing returns boolean
 return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true or GetOwningPlayer(GetFilterUnit())==udg_SentPlayers[0]or GetOwningPlayer(GetFilterUnit())==udg_ScourgePlayers[0])and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
 endfunction
 function GenericCondition_AlliedHeroesNoImages takes nothing returns boolean
 return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetFilterUnit())==false and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))
@@ -8766,41 +8956,51 @@
 endfunction
 function GenericCondition_ValidCorpse takes nothing returns boolean
 return GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==true and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false and GetUnitTypeId(GetFilterUnit())!=unitid_tombstone_zombie
 endfunction
 function GenericCondition_FloatingHeroes takes nothing returns boolean
-return GetUnitTypeId(GetFilterUnit())==1211117637 or GetUnitTypeId(GetFilterUnit())==1211117639 or GetUnitTypeId(GetFilterUnit())==1211117638 or GetUnitTypeId(GetFilterUnit())==1160786000 or GetUnitTypeId(GetFilterUnit())==1311780930 or GetUnitTypeId(GetFilterUnit())==1430468144 or GetUnitTypeId(GetFilterUnit())==1162032951 or GetUnitTypeId(GetFilterUnit())==1429221456 or GetUnitTypeId(GetFilterUnit())==1160786510 or GetUnitTypeId(GetFilterUnit())==1160786511 or GetUnitTypeId(GetFilterUnit())==1328558390 or GetUnitTypeId(GetFilterUnit())==1328558391 or GetUnitTypeId(GetFilterUnit())==1160786502 or GetUnitTypeId(GetFilterUnit())==1211122767
+return GetUnitTypeId(GetFilterUnit())==1211117637 or GetUnitTypeId(GetFilterUnit())==1211117639 or GetUnitTypeId(GetFilterUnit())==1211117638 or GetUnitTypeId(GetFilterUnit())==1160786000 or GetUnitTypeId(GetFilterUnit())==1311780930 or GetUnitTypeId(GetFilterUnit())==1430468144 or GetUnitTypeId(GetFilterUnit())==1162032951 or GetUnitTypeId(GetFilterUnit())==1429221456 or GetUnitTypeId(GetFilterUnit())==1160786510 or GetUnitTypeId(GetFilterUnit())==1160786511 or GetUnitTypeId(GetFilterUnit())==1328558390 or GetUnitTypeId(GetFilterUnit())==1328558391 or GetUnitTypeId(GetFilterUnit())==1160786502 or GetUnitTypeId(GetFilterUnit())==1211122767 or GetUnitTypeId(GetFilterUnit())==1311788343 or GetUnitTypeId(GetFilterUnit())==1311788354 or GetUnitTypeId(GetFilterUnit())==1311788355 or GetUnitTypeId(GetFilterUnit())==1311788367 or GetUnitTypeId(GetFilterUnit())==1311788353
 endfunction
 function GenericCondition_EnemyTowers takes nothing returns boolean
 return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))==true and GetTowerLevel(GetFilterUnit())>0
 endfunction
 function Stun_GetLevel takes real Duration returns integer
 if Duration>=4.00 then
-return 19
+return 24
 elseif Duration>=3.75 then
-return 18
+return 23
 elseif Duration>=3.5 then
-return 17
+return 22
 elseif Duration>=3.25 then
-return 16
+return 21
 elseif Duration>=3 then
-return 15
+return 20
+elseif Duration>=2.8 then
+return 19
 elseif Duration>=2.75 then
-return 14
+return 18
+elseif Duration>=2.6 then
+return 17
 elseif Duration>=2.5 then
-return 13
+return 16
+elseif Duration>=2.4 then
+return 15
 elseif Duration>=2.25 then
-return 12
+return 14
+elseif Duration>=2.2 then
+return 13
 elseif Duration>=2 then
-return 11
+return 12
 elseif Duration>=1.8 then
-return 10
+return 11
 elseif Duration>=1.75 then
-return 9
+return 10
 elseif Duration>=1.65 then
-return 8
+return 9
 elseif Duration>=1.5 then
+return 8
+elseif Duration>=1.4 then
 return 7
 elseif Duration>=1.25 then
 return 6
 elseif Duration>=1.2 then
 return 5
@@ -12818,11 +13018,35 @@
 set HeroTips_2[i]="Chaos Bolt is a disable that switches between average and extremely powerful, the sooner you have max out this spell, the better."
 set HeroTips_3[i]="His high natural movement speed (325 - the highest in the game) and Blink Strike make him very difficult for opponents to outrun or chase him."
 set HeroTips_4[i]="If you Blink Strike and then use Chaos Bolt, you can spend more time hitting opponents and less time waiting for his slow casting animation. "
 set HeroTips_5[i]="Make Nessaj and Phantasm stronger by buying Strength items like Armlet of Mordiggan (when activated) and Heart of Tarrasque."
 set i=i+1
-set ScourgeMax=108
+set HeroID[109]=1311788343
+set DummyID[109]=1747993687
+set HeroName[109]=1848659256
+set HeroIcon[109]="ReplaceableTextures\\CommandButtons\\BTNFrostWyrm.blp"
+call RegisterVictoryAnimation(HeroID[109],"stand victory")
+call RegisterHeroScale(HeroID[109],0.9,DummyID[109])
+set HeroTips_1[i]=""
+set HeroTips_2[i]=""
+set HeroTips_3[i]=""
+set HeroTips_4[i]=""
+set HeroTips_5[i]=""
+set i=i+1
+set HeroID[110]=1311788363
+set DummyID[110]=1747993926
+set HeroName[110]=1848659276
+set HeroIcon[110]="ReplaceableTextures\\CommandButtons\\BTNGnollWarden.blp"
+call RegisterVictoryAnimation(HeroID[110],"stand victory")
+call RegisterHeroScale(HeroID[110],1.1,DummyID[110])
+set HeroTips_1[i]=""
+set HeroTips_2[i]=""
+set HeroTips_3[i]=""
+set HeroTips_4[i]=""
+set HeroTips_5[i]=""
+set i=i+1
+set ScourgeMax=110
 set AgilityHero[1]=1315074670
 set AgilityHero[2]=1164207469
 set AgilityHero[3]=1311781174
 set AgilityHero[4]=1315070563
 set AgilityHero[5]=1315007329
@@ -12853,11 +13077,12 @@
 set AgilityHero[30]=1211117641
 set AgilityHero[31]=1160786265
 set AgilityHero[32]=1211119409
 set AgilityHero[33]=1160786510
 set AgilityHero[34]=1311788336
-set AgilityHeroCount=34
+set AgilityHero[35]=1311788363
+set AgilityHeroCount=35
 set StrengthHero[1]=1315988077
 set StrengthHero[2]=1215063922
 set StrengthHero[3]=1214345830
 set StrengthHero[4]=1211117616
 set StrengthHero[5]=1211117617
@@ -12929,11 +13154,12 @@
 set IntelligenceHero[34]=HeroID[97]
 set IntelligenceHero[35]=1160786504
 set IntelligenceHero[36]=1160786506
 set IntelligenceHero[37]=1160786520
 set IntelligenceHero[38]=1211122767
-set IntelligenceHeroCount=38
+set IntelligenceHero[39]=1311788343
+set IntelligenceHeroCount=39
 set RangeHero[1]=1332898670
 set RangeHero[2]=1164799855
 set RangeHero[3]=1164799603
 set RangeHero[4]=1211117620
 set RangeHero[5]=1214931305
@@ -12986,11 +13212,13 @@
 set RangeHero[52]=1160786510
 set RangeHero[53]=1160786506
 set RangeHero[54]=1160786502
 set RangeHero[55]=1160786520
 set RangeHero[56]=1211122767
-set RangeHeroCount=56
+set RangeHero[57]=1311788363
+set RangeHero[58]=1311788343
+set RangeHeroCount=58
 set MeleeHero[1]=1215130471
 set MeleeHero[2]=1211117646
 set MeleeHero[3]=1164207469
 set MeleeHero[4]=1315070563
 set MeleeHero[5]=1315007329
@@ -13132,10 +13360,13 @@
 set t=null
 endfunction
 function InitTrig_Tavern takes nothing returns nothing
 call Tavern_Initialize()
 endfunction
+function IsGlobalHeroDummy takes integer id returns boolean
+return id==1211117642 or id==1311788365
+endfunction
 function IsItemAbility takes integer id returns boolean
 local integer i=0
 loop
 exitwhen i>ItemAbilities_Max
 if ItemAbilities[i]==id then
@@ -13292,11 +13523,11 @@
 set ItemAbilities[ItemAbilities_Max]=1093815095
 set ItemAbilities_Max=ItemAbilities_Max+1
 set ItemAbilities[ItemAbilities_Max]=1093815089
 endfunction
 function IsGlobalSpellIgnore takes integer id returns boolean
-return id==abilityid_pulsenova or id==abilityid_pulsenovaupgraded or id==abilityid_pulsenova_disabled or id==abilityid_shadowpoison_explode or id==abilityid_oscillation_in or id==abilityid_oscillation_out or id==abilityid_shadowpoison_explode or id==1093678667 or id==1093752391 or id==abilityid_overcharge or id==1093752646 or id==1093686328 or id==1093686327 or id==abilityid_dash_helper or id==abilityid_firespirits_helper or id==abilityid_sunray_off or id==abilityid_sunray_movement or id==1093743681 or id==1093809721 or id==1093815111 or id==1093808458 or id==1093810008 or id==1093810265 or id==1093809221 or id==1093753416 or id==1093752655 or id==1093748305 or id==1093686341 or id==1093814863 or id==1093813848 or id==1093684560 or id==1093815109 or id==1093815112 or id==1093815097 or id==1093814860
+return id==abilityid_pulsenova or id==abilityid_pulsenovaupgraded or id==abilityid_pulsenova_disabled or id==abilityid_shadowpoison_explode or id==abilityid_oscillation_in or id==abilityid_oscillation_out or id==abilityid_shadowpoison_explode or id==1093678667 or id==1093752391 or id==abilityid_overcharge or id==1093752646 or id==1093686328 or id==1093686327 or id==abilityid_dash_helper or id==abilityid_firespirits_helper or id==abilityid_sunray_off or id==abilityid_sunray_movement or id==1093743681 or id==1093809721 or id==1093815111 or id==abilityid_ancestralcharge_end or id==1093810008 or id==1093810265 or id==1093809221 or id==1093753416 or id==1093752655 or id==1093748305 or id==1093686341 or id==1093814863 or id==1093813848 or id==1093684560 or id==1093815109 or id==1093815112 or id==1093815097 or id==1093814860 or id==1093815857 or id==1093815618 or id==abilityid_trueshotaura or id==abilityid_nightmare_helper
 endfunction
 function MiscInit2 takes nothing returns nothing
 set AbusableSpells_Max=AbusableSpells_Max+1
 set AbusableSpells[AbusableSpells_Max]=1093683254
 set AbusableSpells_Max=AbusableSpells_Max+1
@@ -13411,11 +13642,12 @@
 set udg_NotSpells[65]=1093751361
 set udg_NotSpells[66]=1093751126
 set udg_NotSpells[67]=1093752645
 set udg_NotSpells[68]=1093752642
 set udg_NotSpells[69]=1093815111
-set udg_NotSpellsMax=68
+set udg_NotSpells[70]=1093815859
+set udg_NotSpellsMax=70
 endfunction
 function RegisterMiscShit takes nothing returns boolean
 call MiscInit()
 call MiscInit2()
 call ItemAbilities_Init()
@@ -13439,11 +13671,11 @@
 call TriggerRegisterTimerEventSingle(gg_trg_Map_Info,0.01)
 call TriggerAddAction(gg_trg_Map_Info,function Trig_Map_Info_Actions)
 endfunction
 function ObserverMode_Learned takes nothing returns boolean
 local string s
-if IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!=1211117642 then
+if IsUnitIllusion(GetTriggerUnit())==false and IsGlobalHeroDummy(GetUnitTypeId(GetTriggerUnit()))==false then
 set s=GetUnitName(GetTriggerUnit())+" "+GetObjectName(MSG_OBS_LEARNED)+" "+GetAbilityName(GetLearnedSkill())+" ("+GetObjectName(MSG_OBS_LEARNED_LEVEL)+" "+I2S(GetUnitAbilityLevel(GetTriggerUnit(),GetLearnedSkill()))+")"
 call DisplayTimedTextToPlayer(udg_Observer1,0,0,3,s)
 call DisplayTimedTextToPlayer(udg_Observer2,0,0,3,s)
 endif
 return false
@@ -13927,11 +14159,11 @@
 call ExecuteFunc("RegisterCall_of_the_Wild")
 call ExecuteFunc("Register_HawkInvis")
 elseif(PointValue==38)then
 call ExecuteFunc("Register_DualBreath")
 call ExecuteFunc("Register_LiquidFire")
-call ExecuteFunc("RegisterIce_Path")
+call ExecuteFunc("Register_IcePath")
 call ExecuteFunc("Register_Macropyre")
 elseif(PointValue==32)then
 call ExecuteFunc("Register_Track")
 call ExecuteFunc("Register_Jinada")
 call ExecuteFunc("Register_Windwalk")
@@ -13941,16 +14173,18 @@
 call ExecuteFunc("RegisterBristleback")
 call ExecuteFunc("RegisterQuillSpray")
 elseif(PointValue==31)then
 call ExecuteFunc("Register_DoubleEdge")
 call ExecuteFunc("Return")
+call ExecuteFunc("Register_Stampede")
 elseif(PointValue==24)then
 call ExecuteFunc("Register_Penitence")
 call ExecuteFunc("HandOfGod")
 call ExecuteFunc("Persuasion")
 call ExecuteFunc("TestOfFaith")
 elseif(PointValue==5)then
+call ExecuteFunc("Register_BrillianceAura")
 call ExecuteFunc("Register_CrystalNova")
 call ExecuteFunc("Register_FreezingField")
 elseif(PointValue==8)then
 call ExecuteFunc("Register_EchoSlam")
 call ExecuteFunc("Register_Fissure")
@@ -14134,11 +14368,11 @@
 elseif(PointValue==61)then
 call ExecuteFunc("Register_Splitshot")
 call ExecuteFunc("Register_MysticSnake")
 call ExecuteFunc("Register_StoneGaze")
 elseif(PointValue==76)then
-call ExecuteFunc("Sadist")
+call ExecuteFunc("Register_Sadist")
 call ExecuteFunc("Register_DeathPulse")
 call ExecuteFunc("Register_ReapersScythe")
 call ExecuteFunc("Register_Heartstopper")
 elseif(PointValue==80)then
 call ExecuteFunc("RegisterNecromastry")
@@ -14271,10 +14505,12 @@
 call ExecuteFunc("Register_Expulsion")
 call ExecuteFunc("Register_Cage")
 call ExecuteFunc("Register_Firestorm")
 call ExecuteFunc("Register_DemonicClutch")
 call ExecuteFunc("Register_CorpseCollector")
+call ExecuteFunc("Register_SummonShade")
+call ExecuteFunc("Register_DiffusionAura")
 elseif PointValue==92 then
 call ExecuteFunc("Register_Decay")
 call ExecuteFunc("Register_Tombstone")
 call ExecuteFunc("Register_SoulRip")
 call ExecuteFunc("Register_FleshGolem")
@@ -14364,10 +14600,11 @@
 call ExecuteFunc("Register_Scream")
 elseif PointValue==28 then
 call ExecuteFunc("Register_Shackle")
 elseif PointValue==51 then
 call ExecuteFunc("Register_Dash")
+call ExecuteFunc("Register_Overheat")
 call ExecuteFunc("Register_PhoenixTears")
 call ExecuteFunc("Register_Firespirits")
 call ExecuteFunc("Register_Sunray")
 call ExecuteFunc("Register_SweepingFlame")
 call ExecuteFunc("Register_Supernova")
@@ -14425,10 +14662,26 @@
 elseif PointValue==57 then
 call ExecuteFunc("Register_WhirlingDeath")
 call ExecuteFunc("Register_TimberChain")
 call ExecuteFunc("Register_ReactiveArmor")
 call ExecuteFunc("Register_Chakram")
+elseif PointValue==109 then
+call ExecuteFunc("Register_Shield")
+call ExecuteFunc("Register_Curse")
+call ExecuteFunc("Register_Split")
+call ExecuteFunc("Register_Trap")
+call ExecuteFunc("Register_Touch")
+call ExecuteFunc("Register_ArcticSiege")
+elseif PointValue==110 then
+call ExecuteFunc("Register_LightningSeeker")
+call ExecuteFunc("Register_MagneticField")
+call ExecuteFunc("Register_NuralShock")
+call ExecuteFunc("Register_TempestDouble")
+call ExecuteFunc("Register_Blackjack")
+elseif PointValue==35 then
+call ExecuteFunc("Register_TrueshotAura")
+call ExecuteFunc("Register_Marksmanship")
 endif
 endfunction
 function AnnouncePlayerGotHero takes player whichPlayer,string message returns nothing
 if IsPlayerInForce(GetLocalPlayer(),GetPlayersEnemies(whichPlayer))then
 call DisplayTimedTextToPlayer(GetLocalPlayer(),0,udg_TextY,40,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r "+message)
@@ -14445,11 +14698,11 @@
 call DestroyFogModifier(CreateFogModifierRadius(udg_ScourgePlayers[0],FOG_OF_WAR_MASKED,CD_CENTERX,CD_CENTERY,700,false,false))
 set t=null
 return false
 endfunction
 function IsRealHero2 takes unit u returns boolean
-return GetUnitTypeId(u)!=1211117645 and GetUnitTypeId(u)!=1211119431 and GetUnitTypeId(u)!=1211117657 and GetUnitTypeId(u)!=1211117642 and GetUnitTypeId(u)!=1211122232
+return GetUnitTypeId(u)!=1211117645 and GetUnitTypeId(u)!=unitid_tempestdouble and GetUnitTypeId(u)!=1211119431 and GetUnitTypeId(u)!=1211117657 and GetUnitTypeId(u)!=1211117642 and GetUnitTypeId(u)!=1211122232
 endfunction
 function HeroEnters_Conditions takes nothing returns boolean
 return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetTriggerUnit())==false and HaveSavedBoolean(hash_main,GetHandleId(GetTriggerUnit()),85)==false and IsRealHero2(GetTriggerUnit())
 endfunction
 function ModeAP_FindSelectors takes nothing returns boolean
@@ -14565,16 +14818,20 @@
 set udg_HasHero[GetPlayerId(PlayerVar)]=true
 if(not udg_ModeRV or udg_ModeRVHelper)then
 if udg_ModeRD==false and udg_ModeCD==false then
 call PanCameraToTimedForPlayer(PlayerVar,x,y,0)
 endif
+if GetUnitTypeId(UnitVar)!=unitid_tempestdouble then
 call ClearSelectionForPlayer(PlayerVar)
+endif
 call SelectUnitAddForPlayer(UnitVar,PlayerVar)
 endif
 call SetUnitX(UnitVar,x)
 call SetUnitY(UnitVar,y)
+if GetUnitTypeId(UnitVar)!=unitid_tempestdouble then
 set udg_Hero[GetPlayerId(PlayerVar)]=UnitVar
+endif
 call Traffic_GenericData(PlayerVar,"9",GetUnitTypeId(UnitVar))
 if udg_ModeRV and udg_ModeRVHelper==false then
 call TechAllForPlayer(RVPlayer)
 else
 call TechAllForPlayer(PlayerVar)
@@ -14607,10 +14864,11 @@
 else
 call RemoveHero(udg_PreviousHero[GetPlayerId(GetOwningPlayer(UnitVar))])
 endif
 endif
 endif
+if PlayerVar!=udg_SentPlayers[0]and PlayerVar!=udg_ScourgePlayers[0]then
 if udg_ModeRV then
 if TimerGetElapsed(udg_GameTimer)>60 then
 call AnnouncePlayerGotHero(PlayerVar,GetObjectName(MSG_AUTOMATICALLY_ASSIGNED)+" "+GetUnitName(UnitVar))
 elseif udg_RandomOnce[GetPlayerId(RVPlayer)]==true then
 call AnnouncePlayerGotHero(PlayerVar,GetString_GivenBy(UnitVar,RVPlayer))
@@ -14625,10 +14883,11 @@
 call AnnouncePlayerGotHero(PlayerVar,GetObjectName(MSG_ANNOUNCE_HASRANDOMED)+" "+GetUnitName(UnitVar)+".")
 else
 call AnnouncePlayerGotHero(PlayerVar,GetObjectName(MSG_ANNOUNCE_HASCHOSEN)+" "+GetUnitName(UnitVar)+".")
 endif
 endif
+endif
 if udg_OneHero then
 if udg_ModeRV then
 call RemoveAPUnits(RVPlayer)
 else
 call RemoveAPUnits(PlayerVar)
@@ -14749,13 +15008,13 @@
 exitwhen(i>13)
 set CTimer[i]=CreateTimer()
 set i=i+1
 endloop
 set hash_abilities=InitHashtable()
-call SaveInteger(hash_abilities,(abilityid_ghostship),(1),(90))
-call SaveInteger(hash_abilities,(abilityid_ghostship),(2),(80))
-call SaveInteger(hash_abilities,(abilityid_ghostship),(3),(70))
+call SaveInteger(hash_abilities,(abilityid_ghostship),(1),(60))
+call SaveInteger(hash_abilities,(abilityid_ghostship),(2),(50))
+call SaveInteger(hash_abilities,(abilityid_ghostship),(3),(40))
 call SaveInteger(hash_abilities,(abilityid_primalroar),(1),(80))
 call SaveInteger(hash_abilities,(abilityid_primalroar),(2),(75))
 call SaveInteger(hash_abilities,(abilityid_primalroar),(3),(70))
 call SaveInteger(hash_abilities,(abilityid_primalroar_upgrade),(1),(45))
 call SaveInteger(hash_abilities,(abilityid_primalroar_upgrade),(2),(45))
@@ -14779,34 +15038,34 @@
 call SaveInteger(hash_abilities,(abilityid_godstrength),(2),(80))
 call SaveInteger(hash_abilities,(abilityid_godstrength),(3),(80))
 call SaveInteger(hash_abilities,(abilityid_earthsplitter),(1),(100))
 call SaveInteger(hash_abilities,(abilityid_earthsplitter),(2),(100))
 call SaveInteger(hash_abilities,(abilityid_earthsplitter),(3),(100))
-call SaveInteger(hash_abilities,(abilityid_overgrowth),(1),(115))
-call SaveInteger(hash_abilities,(abilityid_overgrowth),(2),(105))
-call SaveInteger(hash_abilities,(abilityid_overgrowth),(3),(95))
+call SaveInteger(hash_abilities,(abilityid_overgrowth),(1),(80))
+call SaveInteger(hash_abilities,(abilityid_overgrowth),(2),(80))
+call SaveInteger(hash_abilities,(abilityid_overgrowth),(3),(80))
 call SaveInteger(hash_abilities,(1095656306),(1),(45))
 call SaveInteger(hash_abilities,(1095656306),(2),(45))
 call SaveInteger(hash_abilities,(1095656306),(3),(45))
 call SaveInteger(hash_abilities,(abilityid_hookshot),(1),(70))
 call SaveInteger(hash_abilities,(abilityid_hookshot),(2),(55))
 call SaveInteger(hash_abilities,(abilityid_hookshot),(3),(40))
-call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(1),(15))
-call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(2),(15))
-call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(3),(15))
+call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(1),(12))
+call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(2),(12))
+call SaveInteger(hash_abilities,(abilityid_hookshotupgrade),(3),(12))
 call SaveInteger(hash_abilities,(1093677895),(1),(115))
 call SaveInteger(hash_abilities,(1093677895),(2),(115))
 call SaveInteger(hash_abilities,(1093677895),(3),(115))
 call SaveInteger(hash_abilities,(abilityid_reversepolarity),(1),(120))
 call SaveInteger(hash_abilities,(abilityid_reversepolarity),(2),(110))
 call SaveInteger(hash_abilities,(abilityid_reversepolarity),(3),(100))
 call SaveInteger(hash_abilities,(abilityid_souleater),(1),(45))
 call SaveInteger(hash_abilities,(abilityid_souleater),(2),(30))
 call SaveInteger(hash_abilities,(abilityid_souleater),(3),(15))
-call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(1),(24))
-call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(2),(16))
-call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(3),(8))
+call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(1),(4))
+call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(2),(4))
+call SaveInteger(hash_abilities,(abilityid_souleaterupgrade),(3),(4))
 call SaveInteger(hash_abilities,(abilityid_epicenter),(1),(140))
 call SaveInteger(hash_abilities,(abilityid_epicenter),(2),(120))
 call SaveInteger(hash_abilities,(abilityid_epicenter),(3),(100))
 call SaveInteger(hash_abilities,(abilityid_epicenterupgrade),(1),(120))
 call SaveInteger(hash_abilities,(abilityid_epicenterupgrade),(2),(100))
@@ -14980,12 +15239,12 @@
 call SaveInteger(hash_abilities,(1093686072),(2),(85))
 call SaveInteger(hash_abilities,(1093686072),(3),(85))
 call SaveInteger(hash_abilities,(1093751120),(1),(85))
 call SaveInteger(hash_abilities,(1093751120),(2),(85))
 call SaveInteger(hash_abilities,(1093751120),(3),(85))
-call SaveInteger(hash_abilities,(1093684308),(1),(120))
-call SaveInteger(hash_abilities,(1093684308),(2),(120))
+call SaveInteger(hash_abilities,(1093684308),(1),(140))
+call SaveInteger(hash_abilities,(1093684308),(2),(130))
 call SaveInteger(hash_abilities,(1093684308),(3),(120))
 call SaveInteger(hash_abilities,(1093747539),(1),(30))
 call SaveInteger(hash_abilities,(1093747539),(2),(30))
 call SaveInteger(hash_abilities,(1093747539),(3),(30))
 call SaveInteger(hash_abilities,(1093742932),(1),(80))
@@ -14995,25 +15254,25 @@
 call SaveInteger(hash_abilities,(1093752632),(2),(75))
 call SaveInteger(hash_abilities,(1093752632),(3),(60))
 call SaveInteger(hash_abilities,(1093752633),(1),(90))
 call SaveInteger(hash_abilities,(1093752633),(2),(75))
 call SaveInteger(hash_abilities,(1093752633),(3),(60))
-call SaveInteger(hash_abilities,(1093810503),(1),(120))
-call SaveInteger(hash_abilities,(1093810503),(2),(120))
-call SaveInteger(hash_abilities,(1093810503),(3),(120))
-call SaveInteger(hash_abilities,(1093810504),(1),(120))
-call SaveInteger(hash_abilities,(1093810504),(2),(120))
-call SaveInteger(hash_abilities,(1093810504),(3),(120))
-call SaveInteger(hash_abilities,(1093684275),(1),(160))
-call SaveInteger(hash_abilities,(1093684275),(2),(160))
-call SaveInteger(hash_abilities,(1093684275),(3),(160))
-call SaveInteger(hash_abilities,(1093677392),(1),(120))
-call SaveInteger(hash_abilities,(1093677392),(2),(90))
-call SaveInteger(hash_abilities,(1093677392),(3),(55))
-call SaveInteger(hash_abilities,(1093679450),(1),(120))
-call SaveInteger(hash_abilities,(1093679450),(2),(90))
-call SaveInteger(hash_abilities,(1093679450),(3),(55))
+call SaveInteger(hash_abilities,(1093810503),(1),(90))
+call SaveInteger(hash_abilities,(1093810503),(2),(90))
+call SaveInteger(hash_abilities,(1093810503),(3),(90))
+call SaveInteger(hash_abilities,(1093810504),(1),(90))
+call SaveInteger(hash_abilities,(1093810504),(2),(90))
+call SaveInteger(hash_abilities,(1093810504),(3),(90))
+call SaveInteger(hash_abilities,(1093684275),(1),(140))
+call SaveInteger(hash_abilities,(1093684275),(2),(140))
+call SaveInteger(hash_abilities,(1093684275),(3),(140))
+call SaveInteger(hash_abilities,(1093677392),(1),(70))
+call SaveInteger(hash_abilities,(1093677392),(2),(60))
+call SaveInteger(hash_abilities,(1093677392),(3),(50))
+call SaveInteger(hash_abilities,(1093679450),(1),(70))
+call SaveInteger(hash_abilities,(1093679450),(2),(60))
+call SaveInteger(hash_abilities,(1093679450),(3),(50))
 call SaveInteger(hash_abilities,(1093743184),(1),(60))
 call SaveInteger(hash_abilities,(1093743184),(2),(60))
 call SaveInteger(hash_abilities,(1093743184),(3),(60))
 call SaveInteger(hash_abilities,(1093747766),(1),(15))
 call SaveInteger(hash_abilities,(1093747766),(2),(15))
@@ -15054,16 +15313,16 @@
 call SaveInteger(hash_abilities,(1093685045),(2),(60))
 call SaveInteger(hash_abilities,(1093685045),(3),(60))
 call SaveInteger(hash_abilities,(1093747249),(1),(60))
 call SaveInteger(hash_abilities,(1093747249),(2),(60))
 call SaveInteger(hash_abilities,(1093747249),(3),(60))
-call SaveInteger(hash_abilities,(1093684820),(1),(90))
-call SaveInteger(hash_abilities,(1093684820),(2),(90))
-call SaveInteger(hash_abilities,(1093684820),(3),(90))
-call SaveInteger(hash_abilities,(1093684824),(1),(90))
-call SaveInteger(hash_abilities,(1093684824),(2),(90))
-call SaveInteger(hash_abilities,(1093684824),(3),(90))
+call SaveInteger(hash_abilities,(1093684820),(1),(80))
+call SaveInteger(hash_abilities,(1093684820),(2),(80))
+call SaveInteger(hash_abilities,(1093684820),(3),(80))
+call SaveInteger(hash_abilities,(1093684824),(1),(80))
+call SaveInteger(hash_abilities,(1093684824),(2),(80))
+call SaveInteger(hash_abilities,(1093684824),(3),(80))
 call SaveInteger(hash_abilities,(1093677649),(1),(100))
 call SaveInteger(hash_abilities,(1093677649),(2),(100))
 call SaveInteger(hash_abilities,(1093677649),(3),(100))
 call SaveInteger(hash_abilities,(1093747769),(1),(100))
 call SaveInteger(hash_abilities,(1093747769),(2),(100))
@@ -15084,16 +15343,16 @@
 call SaveInteger(hash_abilities,(1093678157),(2),(100))
 call SaveInteger(hash_abilities,(1093678157),(3),(100))
 call SaveInteger(hash_abilities,(1093678158),(1),(100))
 call SaveInteger(hash_abilities,(1093678158),(2),(100))
 call SaveInteger(hash_abilities,(1093678158),(3),(100))
-call SaveInteger(hash_abilities,(1093679413),(1),(150))
-call SaveInteger(hash_abilities,(1093679413),(2),(90))
-call SaveInteger(hash_abilities,(1093679413),(3),(55))
-call SaveInteger(hash_abilities,(1093679447),(1),(150))
-call SaveInteger(hash_abilities,(1093679447),(2),(90))
-call SaveInteger(hash_abilities,(1093679447),(3),(50))
+call SaveInteger(hash_abilities,(1093679413),(1),(160))
+call SaveInteger(hash_abilities,(1093679413),(2),(100))
+call SaveInteger(hash_abilities,(1093679413),(3),(40))
+call SaveInteger(hash_abilities,(1093679447),(1),(160))
+call SaveInteger(hash_abilities,(1093679447),(2),(100))
+call SaveInteger(hash_abilities,(1093679447),(3),(40))
 call SaveInteger(hash_abilities,(1093747288),(1),(200))
 call SaveInteger(hash_abilities,(1093747288),(2),(190))
 call SaveInteger(hash_abilities,(1093747288),(3),(180))
 call SaveInteger(hash_abilities,(1093678420),(1),(145))
 call SaveInteger(hash_abilities,(1093678420),(2),(115))
@@ -15159,10 +15418,19 @@
 call SaveInteger(hash_abilities,(1093813065),(2),(50))
 call SaveInteger(hash_abilities,(1093813065),(3),(50))
 call SaveInteger(hash_abilities,(1093813557),(1),(8))
 call SaveInteger(hash_abilities,(1093813557),(2),(8))
 call SaveInteger(hash_abilities,(1093813557),(3),(8))
+call SaveInteger(hash_abilities,(1093815600),(1),(65))
+call SaveInteger(hash_abilities,(1093815600),(2),(60))
+call SaveInteger(hash_abilities,(1093815600),(3),(55))
+call SaveInteger(hash_abilities,(1093687856),(1),(90))
+call SaveInteger(hash_abilities,(1093687856),(2),(80))
+call SaveInteger(hash_abilities,(1093687856),(3),(70))
+call SaveInteger(hash_abilities,(1093816118),(1),(120))
+call SaveInteger(hash_abilities,(1093816118),(2),(90))
+call SaveInteger(hash_abilities,(1093816118),(3),(60))
 endfunction
 function ReliableGold_Main takes nothing returns boolean
 local player p
 local integer i
 local integer id
@@ -15612,19 +15880,30 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterTimerEvent(t,0.5,true)
 call TriggerAddCondition(t,Condition(function CustomHeroRevive_Iterate))
 set t=null
 endfunction
+function ModeTT_FixGold takes unit DeadHero,integer GoldPenalty returns nothing
+local unit OtherHero=(LoadUnitHandle(hash_main,(GetHandleId(DeadHero)),(788)))
+local integer OtherBank=(LoadInteger(hash_main,(GetHandleId(OtherHero)),(787)))
+call SaveInteger(hash_main,(GetHandleId(OtherHero)),(787),(IMaxBJ(OtherBank-GoldPenalty,0)))
+set OtherHero=null
+endfunction
 function Techies_FixXP takes unit Techies,unit Dying returns nothing
 if DistanceBetweenUnits(Techies,Dying)>1200 or(IsDead(Techies)and GetUnitTypeId(Techies)==1211117643)then
 call AddHeroXP(Techies,GetHeroXPBounty(Dying),true)
 endif
 endfunction
+function Bloodstone_IncrementChanges takes nothing returns nothing
+if FindItemOfType(GetEnumUnit(),Item_Real[indexid_bloodstone])!=null then
+call SetItemCharges(FindItemOfType(GetEnumUnit(),Item_Real[indexid_bloodstone]),GetItemCharges(FindItemOfType(GetEnumUnit(),Item_Real[indexid_bloodstone]))+1)
+endif
+endfunction
 function Bloodstone_FindNearbyHeroes takes nothing returns boolean
 if(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetFilterUnit())==false then
 if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(bloodstone_tempdeadhero))and FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone])!=null then
-call SetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone]),GetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone]))+1)
+return true
 endif
 endif
 return false
 endfunction
 function StaffOfHealing_FindNearbyHeroes takes nothing returns boolean
@@ -15655,14 +15934,18 @@
 call SetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[indexid_ancientjangoo]),charges)
 endif
 endif
 return false
 endfunction
-function Bloodstone_HeroDied takes unit u returns nothing
+function Bloodstone_HeroDied takes unit u,unit Killer returns nothing
 local group g=GetAvailableGroup()
 set bloodstone_tempdeadhero=u
 call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1625,Condition(function Bloodstone_FindNearbyHeroes))
+if IsUnitAlly(u,GetOwningPlayer(Killer))==false then
+call GroupAddUnit(g,Killer)
+endif
+call ForGroup(g,function Bloodstone_IncrementChanges)
 call KillGroup(g)
 set g=null
 endfunction
 function BladeOfTheReaper_Image_AI takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
@@ -15870,31 +16153,31 @@
 local group GroupVar=GetAvailableGroup()
 call GroupEnumUnitsInRect(GroupVar,GetPlayableMapRect(),CondVar)
 call KillGroup(GroupVar)
 endfunction
 function Deathtrigger_Condition takes nothing returns boolean
-if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true then
+if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and GetUnitTypeId(GetTriggerUnit())!=unitid_tempestdouble then
 if GetUnitTypeId(GetTriggerUnit())==1211117642 and Deathtrigger_KoboldHasAegis(GetTriggerUnit())then
 return false
 endif
 return true
 endif
 return false
 endfunction
-function Deathtrigger_IsSuicide takes player DeadPlayer,player KillPlayer returns boolean
-return GetKillingUnit()==null or(IsSent(DeadPlayer)and IsSent(KillPlayer))or(IsScourge(DeadPlayer)and IsScourge(KillPlayer))
+function Deathtrigger_IsSuicide takes player DeadPlayer,player KillPlayer,unit KillHero returns boolean
+return KillHero==null or GetKillingUnit()==null or(IsSent(DeadPlayer)and IsSent(KillPlayer))or(IsScourge(DeadPlayer)and IsScourge(KillPlayer))
 endfunction
 function GiveBonusXPGold_Count takes nothing returns nothing
-if(GetUnitTypeId((GetEnumUnit()))==1211117642)==false then
+if IsGlobalHeroDummy(GetUnitTypeId(GetEnumUnit()))==false then
 set Bonus_Count_XP=Bonus_Count_XP+1
 if GetOwningPlayer(GetKillingUnit())!=GetOwningPlayer(GetEnumUnit())then
 set Bonus_Count_Gold=Bonus_Count_Gold+1
 endif
 endif
 endfunction
 function GiveBonusXPGold_Give takes nothing returns nothing
-if(GetUnitTypeId((GetEnumUnit()))==1211117642)==false then
+if(GetUnitTypeId((GetEnumUnit()))==1211117642)==false and IsGlobalHeroDummy(GetUnitTypeId(GetFilterUnit()))==false then
 call AddHeroXP(GetEnumUnit(),bonusgoldxp_xp,true)
 set Bonus_XP[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=Bonus_XP[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+bonusgoldxp_xp
 if GetOwningPlayer(GetKillingUnit())!=GetOwningPlayer(GetEnumUnit())then
 set Bonus_Gold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=Bonus_Gold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+bonusgoldxp_gold
 set ReliableGold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=ReliableGold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+bonusgoldxp_gold
@@ -15905,11 +16188,11 @@
 function GiveBonusXPGold takes nothing returns boolean
 local integer Level
 local integer BonusXP=0
 local integer BonusGold=0
 local group g
-if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetTriggerUnit())==false and(GetUnitTypeId((GetTriggerUnit()))==1211117642)==false then
+if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetTriggerUnit())==false and(GetUnitTypeId((GetTriggerUnit()))==1211117642)==false and IsGlobalHeroDummy(GetUnitTypeId(GetTriggerUnit()))==false then
 set Level=GetHeroLevel(GetTriggerUnit())
 set bonusgoldxp_xp=0
 set bonusgoldxp_gold=0
 set g=GetAvailableGroup()
 set Bonus_Count_XP=0
@@ -15926,13 +16209,13 @@
 set BonusXP=6*Level+15
 elseif Bonus_Count_XP==5 then
 set BonusXP=5*Level+10
 endif
 if Bonus_Count_Gold==1 then
-set BonusGold=9*Level+95
+set BonusGold=12*Level+125
 elseif Bonus_Count_Gold==2 then
-set BonusGold=8*Level+20
+set BonusGold=10*Level+40
 elseif Bonus_Count_Gold==3 then
 set BonusGold=6*Level
 elseif Bonus_Count_Gold==4 then
 set BonusGold=6*Level
 elseif Bonus_Count_Gold==5 then
@@ -15979,21 +16262,26 @@
 local integer id
 local integer CurrentGold=GetPlayerState(DeadPlayer,PLAYER_STATE_RESOURCE_GOLD)
 local integer UnreliableGold=CurrentGold-ReliableGold[GetPlayerId(DeadPlayer)]
 local unit RealKillHero
 local unit RealDeadHero
+local boolean PreventBuyback=reaperscythe_hit
 call GiveBonusXPGold()
 if KillHero==null and GetUnitTypeId(DeadHero)==1315988077 then
 set KillHero=primalsplit_killer
 set KillPlayer=GetOwningPlayer(KillHero)
 endif
+if IsPlayerAlly(KillPlayer,DeadPlayer)==true and((LoadInteger(hash_main,(GetHandleId((KillHero))),((4328))))==HERO_STATE_ON)==true and curse_source!=null then
+set KillHero=curse_source
+set KillPlayer=GetOwningPlayer(KillHero)
+endif
 set AssistCount=Assist_GetCount(DeadHero,KillHero)
 if KillHero!=null then
 set id=GetUnitTypeId(KillHero)
 call Techies_FixXP(udg_Hero[GetPlayerId(GetOwningPlayer(KillHero))],DeadHero)
 endif
-if Deathtrigger_IsSuicide(DeadPlayer,KillPlayer)==false and AssistCount==1 and IsRealPlayer(KillPlayer)==false and KillPlayer!=udg_NeutralHostile then
+if Deathtrigger_IsSuicide(DeadPlayer,KillPlayer,KillHero)==false and AssistCount==1 and IsRealPlayer(KillPlayer)==false and KillPlayer!=udg_NeutralHostile then
 call Assist_GetPlayers(DeadHero,KillHero)
 set KillPlayer=AssistPlayers[1]
 set KillHero=udg_Hero[GetPlayerId(KillPlayer)]
 endif
 if IsSent(GetOwningPlayer(DeadHero))then
@@ -16161,11 +16449,11 @@
 call PlaySoundEx(gg_snd_HolyShit)
 set KillStreakText=" "+GetObjectName(MSG_IS)+" |c00ff8000"+GetObjectName(MSG_BEYOND_GODLIKE)+"|r. "+GetObjectName(MSG_SOMEONE_KILL_HIM)+GetObjectName(MSG_EXCLAMATION3)
 endif
 endif
 if suicide==false then
-set GoldReward=GoldReward+100+GetHeroLevel(DeadHero)*5+100
+set GoldReward=GoldReward+100+GetHeroLevel(DeadHero)*9+100
 set DeadPlayerString=udg_Colors[GetPlayerId(DeadPlayer)]+(PlayerNames[GetPlayerId((DeadPlayer))])+"|r"
 set KillPlayerString=udg_Colors[GetPlayerId(KillPlayer)]+(PlayerNames[GetPlayerId((KillPlayer))])+"|r"
 set GoldText="|c00FFDC00"+I2S(GoldReward)+"|r"
 if KillPlayer==udg_SentPlayers[0]or KillPlayer==udg_ScourgePlayers[0]then
 if AssistCount==0 then
@@ -16214,16 +16502,17 @@
 endif
 endif
 if GoldPenalty>UnreliableGold then
 set GoldPenalty=UnreliableGold
 endif
-call Bloodstone_HeroDied(DeadHero)
+call Bloodstone_HeroDied(DeadHero,RealKillHero)
 call StaffOfHealing_HeroDied(DeadHero)
 call BladeOfTheReaper_HeroDied(DeadHero)
 if QuickRevive==false then
 set GoldLost[GetPlayerId(DeadPlayer)]=GoldLost[GetPlayerId(DeadPlayer)]+GoldPenalty
 call TakeGoldWithAnimation(DeadHero,GoldPenalty)
+call ModeTT_FixGold(DeadHero,GoldPenalty)
 endif
 call SaveInteger(hash_main,(400+GetPlayerId(KillPlayer)),(450+GetPlayerId(DeadPlayer)),((LoadInteger(hash_main,(400+GetPlayerId(KillPlayer)),(450+GetPlayerId(DeadPlayer))))+1))
 call SaveInteger(hash_main,(400+GetPlayerId(DeadPlayer)),(500+GetPlayerId(KillPlayer)),((LoadInteger(hash_main,(400+GetPlayerId(DeadPlayer)),(500+GetPlayerId(KillPlayer))))+1))
 call StartTimerBJ(udg_KillTimer[GetPlayerId(KillPlayer)],false,18)
 if suicide==false and KillPlayer!=udg_SentPlayers[0]and KillPlayer!=udg_ScourgePlayers[0]and KillPlayer!=udg_NeutralHostile then
@@ -16390,18 +16679,18 @@
 set t=null
 endfunction
 function RoshanTimer_Iterate takes nothing returns boolean
 local item Item
 local integer Count=GetTriggerEvalCount(GetTriggeringTrigger())
-if Count==600 then
+if Count==aegis_reclaim then
 call CleanTrigger(GetTriggeringTrigger())
 endif
-if Count==420 or Count==540 then
+if Count==aegis_reclaim-180 or Count==aegis_reclaim-60 then
 if aegisholder!=null then
 set Item=FindItemOfType(aegisholder,Item_Real[indexid_aegis])
 if Item!=null then
-if Count==420 then
+if Count==aegis_reclaim-180 then
 if IsSent(GetOwningPlayer(aegisholder))then
 call DisplayTimedTextToForceEx(udg_ForceSent,15,GetObjectName(MSG_ROSHAN_RECLAIM)+" |c00ff0303"+GetObjectName(MSG_ROSHAN_MSG1)+"|r")
 else
 call DisplayTimedTextToForceEx(udg_ForceScourge,15,GetObjectName(MSG_ROSHAN_RECLAIM)+" |c00ff0303"+GetObjectName(MSG_ROSHAN_MSG1)+"|r")
 endif
@@ -16474,11 +16763,11 @@
 endfunction
 function Roshan_Respawn takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local location PointVar
 local real scale
-if GetTriggerEvalCount(t)==600 or force_roshan_respawn then
+if GetTriggerEvalCount(t)==roshan_respawn or force_roshan_respawn then
 set force_roshan_respawn=false
 set PointVar=GetRectCenter(gg_rct_Roshan)
 call Roshan_RemoveOtherAegis()
 set RoshanUpgrade=RoshanUpgrade+1
 set udg_Roshan=CreateUnitAtLoc(Player(PLAYER_NEUTRAL_AGGRESSIVE),1848651852,PointVar,bj_UNIT_FACING)
@@ -16493,10 +16782,12 @@
 call UnitAddAbility(udg_Roshan,1093685558)
 call UnitAddItem(udg_Roshan,CreateItem(Item_Real[indexid_cheese],0,0))
 endif
 call UnitAddItem(udg_Roshan,CreateItem(Item_Real[indexid_aegis],0,0))
 call CleanTrigger(t)
+elseif GetTriggerEvalCount(t)==aegis_reclaim then
+call Roshan_RemoveOtherAegis()
 endif
 set t=null
 return false
 endfunction
 function Trig_RoshanDies_Actions takes nothing returns nothing
@@ -17362,10 +17653,18 @@
 set Item_Mute[Item_Max]=1227901515
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNGreenStaff.blp"
 set Item_Cooldown[Item_Max]=30
 set indexid_ghostscepter=Item_Max
 set Item_Max=Item_Max+1
+set Item_Dummy[Item_Max]=1227903033
+set Item_Real[Item_Max]=1227903042
+set Item_Unit[Item_Max]=1747993929
+set Item_Mute[Item_Max]=1227903041
+set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNPendantOfMana.blp"
+set Item_Cooldown[Item_Max]=0
+set indexid_shadowamulet=Item_Max
+set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227902273
 set Item_Real[Item_Max]=1227902265
 set Item_Unit[Item_Max]=1747993421
 set Item_Mute[Item_Max]=1227902274
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp"
@@ -17684,11 +17983,11 @@
 set Item_Dummy[Item_Max]=1227896917
 set Item_Real[Item_Max]=1227896916
 set Item_Unit[Item_Max]=0
 set Item_Mute[Item_Max]=1227895348
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNINV_Helmet_13.blp"
-set Item_Cooldown[Item_Max]=300
+set Item_Cooldown[Item_Max]=60
 set indexid_helmofthedominator=Item_Max
 set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227896919
 set Item_Real[Item_Max]=1227896918
 set Item_Unit[Item_Max]=0
@@ -17807,10 +18106,18 @@
 set Item_Mute[Item_Max]=1227900737
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNRodOfNecromancy.blp"
 set Item_Cooldown[Item_Max]=55
 set indexid_blackkingbar05=Item_Max
 set Item_Max=Item_Max+1
+set Item_Dummy[Item_Max]=1227903030
+set Item_Real[Item_Max]=1227903032
+set Item_Unit[Item_Max]=0
+set Item_Mute[Item_Max]=1227903031
+set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNRodOfNecromancy.blp"
+set Item_Cooldown[Item_Max]=50
+set indexid_blackkingbar04=Item_Max
+set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227899224
 set Item_Real[Item_Max]=1227899223
 set Item_Unit[Item_Max]=0
 set Item_Mute[Item_Max]=0
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNArcaniteArmor.blp"
@@ -18314,11 +18621,11 @@
 set Item_Dummy[Item_Max]=1227902797
 set Item_Real[Item_Max]=1227902796
 set Item_Unit[Item_Max]=0
 set Item_Mute[Item_Max]=1227902798
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNWitchDoctorMaster.blp"
-set Item_Cooldown[Item_Max]=20
+set Item_Cooldown[Item_Max]=16
 set indexid_cripplingstaff=Item_Max
 set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227902800
 set Item_Real[Item_Max]=1227902799
 set Item_Unit[Item_Max]=0
@@ -18569,11 +18876,11 @@
 set Item_Cooldown[Item_Max]=0
 set indexid_recipe_mantastyle=Item_Max
 set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227896641
 set Item_Real[Item_Max]=1227896666
-set Item_Unit[Item_Max]=1747989303
+set Item_Unit[Item_Max]=0
 set Item_Mute[Item_Max]=1227900229
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
 set Item_Cooldown[Item_Max]=0
 set indexid_recipe_lotharsedge=Item_Max
 set Item_Max=Item_Max+1
@@ -18763,10 +19070,18 @@
 set Item_Mute[Item_Max]=1227900997
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
 set Item_Cooldown[Item_Max]=0
 set indexid_recipe_forcestaff=Item_Max
 set Item_Max=Item_Max+1
+set Item_Dummy[Item_Max]=1227903044
+set Item_Real[Item_Max]=1227903045
+set Item_Unit[Item_Max]=0
+set Item_Mute[Item_Max]=1227903046
+set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
+set Item_Cooldown[Item_Max]=0
+set indexid_recipe_cripplingstaff=Item_Max
+set Item_Max=Item_Max+1
 set Item_Dummy[Item_Max]=1227901016
 set Item_Real[Item_Max]=1227901018
 set Item_Unit[Item_Max]=1747990360
 set Item_Mute[Item_Max]=1227901017
 set Item_Icon[Item_Max]="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
@@ -19129,13 +19444,12 @@
 set Recipe_Component_1[Recipe_Max]=indexid_yasha
 set Recipe_Component_2[Recipe_Max]=indexid_ultimateorb
 set Recipe_Component_3[Recipe_Max]=indexid_recipe_mantastyle
 set Recipe_Result[Recipe_Max]=indexid_mantastyleranged
 set Recipe_Max=Recipe_Max+1
-set Recipe_Component_1[Recipe_Max]=indexid_quarterstaff
-set Recipe_Component_2[Recipe_Max]=indexid_claymore
-set Recipe_Component_3[Recipe_Max]=indexid_recipe_lotharsedge
+set Recipe_Component_1[Recipe_Max]=indexid_claymore
+set Recipe_Component_2[Recipe_Max]=indexid_shadowamulet
 set Recipe_Result[Recipe_Max]=indexid_lotharsedge
 set Recipe_Max=Recipe_Max+1
 set Recipe_Component_1[Recipe_Max]=indexid_staffofwizardry
 set Recipe_Component_2[Recipe_Max]=indexid_nulltalisman
 set Recipe_Component_3[Recipe_Max]=indexid_recipe_dagon
@@ -19324,12 +19638,12 @@
 set Recipe_Component_3[Recipe_Max]=indexid_ironwoodbranch
 set Recipe_Component_4[Recipe_Max]=indexid_ironwoodbranch
 set Recipe_Component_5[Recipe_Max]=indexid_recipe_magicwand
 set Recipe_Result[Recipe_Max]=indexid_magicwand
 set Recipe_Max=Recipe_Max+1
-set Recipe_Component_1[Recipe_Max]=indexid_quarterstaff
-set Recipe_Component_2[Recipe_Max]=indexid_staffofwizardry
+set Recipe_Component_1[Recipe_Max]=indexid_staffofwizardry
+set Recipe_Component_2[Recipe_Max]=indexid_ringofregeneration
 set Recipe_Component_3[Recipe_Max]=indexid_recipe_forcestaff
 set Recipe_Result[Recipe_Max]=indexid_forcestaff
 set Recipe_Max=Recipe_Max+1
 set Recipe_Component_1[Recipe_Max]=indexid_hoodofdefiance
 set Recipe_Component_2[Recipe_Max]=indexid_headdressofrejuvenation
@@ -19845,19 +20159,19 @@
 endif
 call IssuePointOrder(Source,"move",x,y)
 endfunction
 function DeliverItems_Search takes nothing returns nothing
 local item Item=GetEnumItem()
-if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==deliveritems_player and deliveritems_count==0 then
+if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==deliveritems_player and deliveritems_count==0 and IsItemVisible(Item)==true then
 set deliveritems_count=deliveritems_count+1
 call UnitAddItem(deliveritems_source,Item)
 endif
 set Item=null
 endfunction
 function DeliverItems_GiveBack takes nothing returns nothing
 local item Item=GetEnumItem()
-if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==deliveritems_player then
+if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==deliveritems_player and IsItemVisible(Item)==true then
 call UnitAddItem(deliveritems_courier,Item)
 endif
 set Item=null
 endfunction
 function DeliverItems_Giving takes nothing returns boolean
@@ -20044,11 +20358,11 @@
 function CollectItems_Pickup takes nothing returns nothing
 local item Item=GetEnumItem()
 local unit u=pickupallitems_unit
 local player p=GetOwningPlayer(u)
 local integer id=GetPlayerId(p)
-if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p then
+if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p and IsItemVisible(Item)==true then
 call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
 call UnitAddItem(collectitems_courier,Item)
 endif
 set Item=null
 set u=null
@@ -20739,10 +21053,13 @@
 set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
 endif
 endfunction
 function UnitItem_RestrictBuying takes unit store,unit buyer returns boolean
 local integer indexId
+if GetUnitTypeId(buyer)==unitid_tempestdouble then
+return true
+endif
 if(store==ScourgeBuilding_ShopGraveyard or store==ScourgeBuilding_ShopGateway)and IsUnitAlly(buyer,udg_ScourgePlayers[0])then
 return false
 elseif(store==SentinelBuilding_ShopChimaera or store==SentinelBuilding_ShopCache)and IsUnitAlly(buyer,udg_SentPlayers[0])then
 return false
 endif
@@ -21346,10 +21663,24 @@
 if CourierFakedItems_IsFlagged(ItemToIndex(Item))or CourierFakedItems_IsFlaggedSecondary(ItemToMuteId(Item))then
 return CourierFakedItems(Hero,Item)
 endif
 return false
 endfunction
+function ModeTT_ItemHack_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local integer id=(LoadInteger(hash_main,(Cache),(34)))
+set TT_DisableTracker[id]=false
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+return false
+endfunction
+function ModeTT_ItemHack takes unit u returns nothing
+local integer id=GetPlayerId(GetOwningPlayer(u))
+set TT_DisableTracker[id]=true
+endfunction
 function ManipulateItem_Delayed takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Unit=(LoadUnitHandle(hash_main,(Cache),(26)))
 local integer EventType=(LoadInteger(hash_main,(Cache),(97)))
@@ -21552,11 +21883,11 @@
 local integer Cache
 local integer scepter_indexid
 local integer scepter_abilityid
 local integer id
 set id=GetPlayerId(GetOwningPlayer(Unit))
-if(IsUnitType(Unit,UNIT_TYPE_HERO)==true or IsSpiritBear(Unit))and IsUnitIllusion(Unit)==false then
+if(IsUnitType(Unit,UNIT_TYPE_HERO)==true or IsSpiritBear(Unit))and IsUnitIllusion(Unit)==false and GetUnitTypeId(Unit)!=1311788365 then
 if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
 if GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_javelin]then
 set TotalCount_Javelin=TotalCount_Javelin+1
 set HasItem_Javelin[id]=HasItem_Javelin[id]+1
 elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_kelensdagger]then
@@ -21590,11 +21921,11 @@
 endif
 elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
 if GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_javelin]then
 set HasItem_Javelin[id]=HasItem_Javelin[id]-1
 set TotalCount_Javelin=TotalCount_Javelin-1
-elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_kelensdagger]then
+elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_kelensdagger]and GetUnitTypeId(Unit)!=1311788365 then
 set HasItem_Dagger[id]=HasItem_Dagger[id]-1
 set TotalCount_Dagger=TotalCount_Dagger-1
 elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_ironboots]then
 set HasItem_IronBoots[id]=HasItem_IronBoots[id]-1
 set TotalCount_IronBoots=TotalCount_IronBoots-1
@@ -21605,11 +21936,11 @@
 set TotalCount_CraniumBasher=TotalCount_CraniumBasher-1
 set HasItem_CraniumBasher[id]=HasItem_CraniumBasher[id]-1
 if HasItem_CraniumBasher[id]<1 or FindItemOfTypeEx(Unit,Item_Real[indexid_craniumbasher],GetManipulatedItem())==null or FindItemOfTypeEx(Unit,Item_Real[indexid_annihilator],GetManipulatedItem())==null then
 call UnitRemoveAbility(Unit,abilityid_craniumbasher)
 endif
-elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_heartoftarrasque]then
+elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_heartoftarrasque]and GetUnitTypeId(Unit)!=1311788365 then
 set HasItem_Heart[id]=HasItem_Heart[id]-1
 set TotalCount_Heart=TotalCount_Heart-1
 elseif GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_linkenssphere]or GetItemTypeId(GetManipulatedItem())==Item_Mute[indexid_linkenssphere]then
 set TotalCount_LinkenSphere=IMaxBJ(TotalCount_LinkenSphere-1,0)
 set HasItem_LinkenSphere[id]=IMaxBJ(HasItem_LinkenSphere[id]-1,0)
@@ -21627,10 +21958,13 @@
 if GetUnitTypeId(Unit)==1215130471 then
 set tt_unit1=Unit
 call ExecuteFunc("Aghanim_Fireblast_Remove")
 endif
 endif
+if udg_ModeTT==true then
+call ModeTT_ItemHack(Unit)
+endif
 elseif GetItemTypeId(GetManipulatedItem())!=1227894853 and GetItemTypeId(GetManipulatedItem())!=1227895373 then
 set Item=GetManipulatedItem()
 if IsUnitIllusion(Unit)or GetItemUserData(Item)==-2 then
 set Item=null
 set Unit=null
@@ -21849,11 +22183,11 @@
 endfunction
 function ItemTraffic_Main takes nothing returns boolean
 local unit Hero=GetTriggerUnit()
 local item Item=GetManipulatedItem()
 local integer id=GetItemTypeId(Item)
-if Item==null or IsUnitIllusion(Hero)==true or IsUnitType(Hero,UNIT_TYPE_HERO)==false or GetUnitTypeId(Hero)==1211117642 or GetItemTypeId(Item)==1227894853 or GetItemTypeId(Item)==1227895373 then
+if Item==null or IsUnitIllusion(Hero)==true or IsUnitType(Hero,UNIT_TYPE_HERO)==false or IsGlobalHeroDummy(GetUnitTypeId(Hero))or GetItemTypeId(Item)==1227894853 or GetItemTypeId(Item)==1227895373 then
 set Hero=null
 set Item=null
 return false
 endif
 if(GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM and GetItemType(Item)!=ITEM_TYPE_PURCHASABLE)or GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
@@ -22153,10 +22487,19 @@
 call SetItemPlayer(newItem,tt_player1,false)
 call SetItemUserData(newItem,1)
 set newItem=CreateItem(Item_Dummy[indexid_ringofbasilius],x,y)
 call SetItemPlayer(newItem,tt_player1,false)
 call SetItemUserData(newItem,1)
+elseif indexId==indexid_annihilator then
+set tt_player1=GetItemPlayer(Item)
+call RemoveItem(Item)
+set newItem=CreateItem(Item_Dummy[indexid_sacredrelic],x,y)
+call SetItemPlayer(newItem,tt_player1,false)
+call SetItemUserData(newItem,1)
+set newItem=CreateItem(Item_Dummy[indexid_craniumbasher],x,y)
+call SetItemPlayer(newItem,tt_player1,false)
+call SetItemUserData(newItem,1)
 endif
 set i=i+1
 endloop
 call EnableTrigger(t_manipulateitem)
 set u=null
@@ -22212,11 +22555,11 @@
 endfunction
 function Bloodstone_ItemCondition takes nothing returns boolean
 return GetItemTypeId(GetManipulatedItem())==Item_Real[indexid_bloodstone]and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true
 endfunction
 function Bloodstone_Condition takes nothing returns boolean
-return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and GetUnitTypeId(GetTriggerUnit())!=1211117642 and FindItemOfType(GetTriggerUnit(),Item_Real[indexid_bloodstone])!=null
+return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsGlobalHeroDummy(GetUnitTypeId(GetFilterUnit()))==false and FindItemOfType(GetTriggerUnit(),Item_Real[indexid_bloodstone])!=null
 endfunction
 function Bloodstone_WhichToHeal takes nothing returns boolean
 return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)!=1 and GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>1
 endfunction
 function Bloodstone_Heal takes nothing returns nothing
@@ -22363,11 +22706,11 @@
 function PickupAllItems_Pickup takes nothing returns nothing
 local item Item=GetEnumItem()
 local unit u=pickupallitems_unit
 local player p=GetOwningPlayer(u)
 local integer id=GetPlayerId(p)
-if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p then
+if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p and IsItemVisible(Item)==true then
 call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
 call UnitAddItem(COP[id],Item)
 endif
 set Item=null
 set u=null
@@ -22450,11 +22793,11 @@
 local integer Cache=GetHandleId(Source)
 local integer i=0
 local real Time=(TimerGetElapsed(udg_GameTimer))
 local real Buffer=10
 loop
-exitwhen i>3
+exitwhen i>2
 if(LoadReal(hash_main,(Cache),(730+i)))<Time-Buffer then
 return false
 endif
 set i=i+1
 endloop
@@ -22463,11 +22806,11 @@
 function IronBoots_DamageTracker takes unit Source returns nothing
 local integer Cache=GetHandleId(Source)
 local integer LastUsedIndex=(LoadInteger(hash_main,(Cache),(729)))
 call SaveReal(hash_main,(Cache),(730+LastUsedIndex),(((TimerGetElapsed(udg_GameTimer)))*1.0))
 set LastUsedIndex=LastUsedIndex+1
-if LastUsedIndex==4 then
+if LastUsedIndex==3 then
 set LastUsedIndex=0
 endif
 call SaveInteger(hash_main,(Cache),(729),(LastUsedIndex))
 endfunction
 function IronBoots_Update takes unit Hero returns nothing
@@ -22512,11 +22855,11 @@
 local boolean DisableHeart=false
 local real time=4
 if IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER)==false then
 set time=6
 endif
-if BlinkDamaged_Time[GetPlayerId(GetOwningPlayer(Hero))]+time>(TimerGetElapsed(udg_GameTimer))then
+if(LoadReal(hash_main,(GetHandleId(Hero)),(785)))+time>(TimerGetElapsed(udg_GameTimer))then
 set DisableHeart=true
 endif
 loop
 exitwhen i>5
 set Heart=UnitItemInSlot(Hero,i)
@@ -22545,11 +22888,11 @@
 set Heart=null
 endfunction
 function BlinkDagger_Damaged takes nothing returns nothing
 if GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and(IsRealPlayer(GetOwningPlayer(GetEventDamageSource()))or GetUnitTypeId(GetEventDamageSource())==1848651852)then
 if safedamage_urn[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]==false then
-set BlinkDamaged_Time[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=(TimerGetElapsed(udg_GameTimer))
+call SaveReal(hash_main,(GetHandleId(GetTriggerUnit())),(785),(((TimerGetElapsed(udg_GameTimer)))*1.0))
 if GetEventDamage()>20 then
 call IronBoots_DamageTracker(GetTriggerUnit())
 endif
 endif
 endif
@@ -22557,11 +22900,11 @@
 function BlinkDagger_Update takes unit Hero returns nothing
 local integer i=0
 local item Dagger
 local integer indexId
 local boolean DisableDagger=false
-if BlinkDamaged_Time[GetPlayerId(GetOwningPlayer(Hero))]+3>(TimerGetElapsed(udg_GameTimer))then
+if(LoadReal(hash_main,(GetHandleId(Hero)),(785)))+3>(TimerGetElapsed(udg_GameTimer))then
 set DisableDagger=true
 endif
 loop
 exitwhen i>5
 set Dagger=UnitItemInSlot(Hero,i)
@@ -22587,41 +22930,48 @@
 set i=i+1
 endloop
 set Hero=null
 set Dagger=null
 endfunction
-function BlinkDagger_Main takes nothing returns boolean
-local integer i=1
-local unit Hero
-local integer id
-if TotalCount_Dagger>0 or TotalCount_Heart>0 or TotalCount_IronBoots>0 then
-loop
-exitwhen i>5
-set id=GetPlayerId(udg_SentPlayers[i])
-set Hero=udg_Hero[id]
+function BlinkDagger_Main_Helper takes nothing returns nothing
+local unit Hero=GetEnumUnit()
+local integer id=GetPlayerId(GetOwningPlayer(Hero))
 if HasItem_Dagger[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
 call BlinkDagger_Update(Hero)
 endif
 if HasItem_Heart[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
 call Heart_Update(Hero)
 endif
 if HasItem_IronBoots[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
 call IronBoots_Update(Hero)
 endif
+set Hero=null
+endfunction
+function BlinkDagger_CollectHeroes takes nothing returns boolean
+return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and GetUnitTypeId(GetFilterUnit())!=1211117642 and GetUnitTypeId(GetFilterUnit())!=1211122232
+endfunction
+function BlinkDagger_Main takes nothing returns boolean
+local integer i=1
+local unit Hero
+local integer id
+local group g
+if TotalCount_Dagger>0 or TotalCount_Heart>0 or TotalCount_IronBoots>0 then
+set g=GetAvailableGroup()
+call GroupEnumUnitsInRange(g,0,0,9999,Condition(function BlinkDagger_CollectHeroes))
+loop
+exitwhen i>5
+set id=GetPlayerId(udg_SentPlayers[i])
+set Hero=udg_Hero[id]
+call GroupAddUnit(g,Hero)
 set id=GetPlayerId(udg_ScourgePlayers[i])
 set Hero=udg_Hero[id]
-if HasItem_Dagger[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
-call BlinkDagger_Update(Hero)
-endif
-if HasItem_Heart[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
-call Heart_Update(Hero)
-endif
-if HasItem_IronBoots[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
-call IronBoots_Update(Hero)
-endif
+call GroupAddUnit(g,Hero)
 set i=i+1
 endloop
+call ForGroup(g,function BlinkDagger_Main_Helper)
+call KillGroup(g)
+set g=null
 endif
 set Hero=null
 return false
 endfunction
 function InitTrig_Blink_Dagger takes nothing returns nothing
@@ -23013,33 +23363,33 @@
 endfunction
 function Armlet takes nothing returns nothing
 local unit Hero=GetTriggerUnit()
 if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
 if ItemToIndex(GetManipulatedItem())==indexid_armletofmordiggianoff then
-call UnitRemoveAbility(Hero,1093682520)
+call UnitRemoveAbility(Hero,armlet_hpregen)
 endif
 if ItemToIndex(GetManipulatedItem())==indexid_satanic then
 call UnitRemoveAbility(Hero,1093747287)
 endif
 if ItemToIndex(GetManipulatedItem())==indexid_armletofmordiggianon then
-call UnitRemoveAbility(Hero,1093682520)
+call UnitRemoveAbility(Hero,armlet_hpregen)
 call UnitRemoveAbility(Hero,1093686339)
 call UnitRemoveAbility(Hero,1093686603)
 endif
 endif
 if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
 if ItemToIndex(GetManipulatedItem())==indexid_armletofmordiggianoff then
-call UnitAddAbility(Hero,1093682520)
-call UnitMakeAbilityPermanent(Hero,true,1093682520)
+call UnitAddAbility(Hero,armlet_hpregen)
+call UnitMakeAbilityPermanent(Hero,true,armlet_hpregen)
 endif
 if ItemToIndex(GetManipulatedItem())==indexid_satanic then
 call UnitAddAbility(Hero,1093747287)
 call UnitMakeAbilityPermanent(Hero,true,1093747287)
 endif
 if ItemToIndex(GetManipulatedItem())==indexid_armletofmordiggianon then
-call UnitAddAbility(Hero,1093682520)
-call UnitMakeAbilityPermanent(Hero,true,1093682520)
+call UnitAddAbility(Hero,armlet_hpregen)
+call UnitMakeAbilityPermanent(Hero,true,armlet_hpregen)
 call UnitAddAbility(Hero,1093686339)
 call UnitMakeAbilityPermanent(Hero,true,1093686339)
 call UnitAddAbility(Hero,1093686603)
 call UnitMakeAbilityPermanent(Hero,true,1093686603)
 endif
@@ -23084,10 +23434,11 @@
 call TriggerRegisterTimerEvent(t,1,true)
 call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DROP_ITEM)
 call TriggerAddCondition(t,Condition(function ArmletDrain_Execute))
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
 call SaveItemHandle(hash_main,(Cache),(96),(GetManipulatedItem()))
+call TriggerEvaluate(t)
 set t=null
 set Hero=null
 endfunction
 function ArmletDrain_Main takes nothing returns boolean
 if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and ItemToIndex(GetManipulatedItem())==indexid_armletofmordiggianon then
@@ -24601,22 +24952,56 @@
 if GetSpellAbilityId()==abilityid_bootsoftravel then
 call BootsOfTravel()
 endif
 endfunction
 function NecronomiconLimit_Remove takes nothing returns nothing
+if necromarker_id==(LoadInteger(hash_main,(GetHandleId(GetEnumUnit())),(784)))then
 call KillUnit(GetEnumUnit())
+endif
 endfunction
 function NecronomiconLimit_Find takes nothing returns boolean
 local integer i=GetUnitTypeId(GetFilterUnit())
 return i==unitid_necrounit1 or i==unitid_necrounit2 or i==unitid_necrounit3 or i==unitid_necrounit4 or i==unitid_necrounit5 or i==unitid_necrounit6
 endfunction
 function NecronomiconLimit takes nothing returns nothing
-local group g=GetAvailableGroup()
+local unit Source=GetTriggerUnit()
+local unit Necro1
+local unit Necro2
+local integer id1
+local integer id2
+local group g=GetAvailableGroup()
+local real a=GetUnitFacing(Source)*bj_DEGTORAD
+local real x1=GetUnitX(Source)+50*Cos(a)
+local real y1=GetUnitY(Source)+50*Sin(a)
+local real x2=GetUnitX(Source)+50*Cos(a)
+local real y2=GetUnitY(Source)+50*Sin(a)
+if GetSpellAbilityId()==abilityid_necronomicon1 then
+set id1=unitid_necrounit1
+set id2=unitid_necrounit4
+elseif GetSpellAbilityId()==abilityid_necronomicon2 then
+set id1=unitid_necrounit2
+set id2=unitid_necrounit5
+elseif GetSpellAbilityId()==abilityid_necronomicon3 then
+set id1=unitid_necrounit3
+set id2=unitid_necrounit6
+endif
+set necromarker_id=GetUnitTypeId(Source)
 call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function NecronomiconLimit_Find))
 call ForGroup(g,function NecronomiconLimit_Remove)
 call KillGroup(g)
+set Necro1=CreateUnit(GetOwningPlayer(Source),id1,x1,y1,GetUnitFacing(Source))
+call SaveInteger(hash_main,(GetHandleId(Necro1)),(784),(necromarker_id))
+call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",Necro1,"origin"))
+call UnitApplyTimedLife(Necro1,1112820806,35)
+set Necro2=CreateUnit(GetOwningPlayer(Source),id2,x2,y2,GetUnitFacing(Source))
+call SaveInteger(hash_main,(GetHandleId(Necro2)),(784),(necromarker_id))
+call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",Necro2,"origin"))
+call UnitApplyTimedLife(Necro2,1112820806,35)
 set g=null
+set Necro1=null
+set Necro2=null
+set Source=null
 endfunction
 function NecronomiconLimit_Main takes nothing returns nothing
 if GetSpellAbilityId()==abilityid_necronomicon1 or GetSpellAbilityId()==abilityid_necronomicon2 or GetSpellAbilityId()==abilityid_necronomicon3 then
 call NecronomiconLimit()
 endif
@@ -24625,13 +25010,25 @@
 if GetSpellAbilityId()==abilityid_satanic then
 call TimedLifeUnitEffect("Abilities\\Spells\\Items\\VampiricPotion\\VampPotionCaster.mdl",GetTriggerUnit(),"origin",3.5)
 call AddTimedAbility(GetTriggerUnit(),abilityid_satanicbonus,1,3.5)
 endif
 endfunction
+function HelmOfTheDominator_Find takes nothing returns boolean
+return((LoadInteger(hash_main,(GetHandleId((GetFilterUnit()))),((4323))))==HERO_STATE_ON)
+endfunction
 function HelmOfTheDominator takes nothing returns nothing
+local group g
+local unit u
 if GetSpellAbilityId()==abilityid_helmofthedominator then
-call UnitApplyTimedLife(GetSpellTargetUnit(),1112820806,1200)
+set g=GetAvailableGroup()
+call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function HelmOfTheDominator_Find))
+set u=FirstOfGroup(g)
+call KillGroup(g)
+if u!=null then
+call KillUnit(u)
+endif
+call SaveInteger(hash_main,(GetHandleId((GetSpellTargetUnit()))),((4323)),(HERO_STATE_ON))
 call UnitAddAbility(GetSpellTargetUnit(),1097167976)
 call UnitAddAbility(GetSpellTargetUnit(),1094939243)
 call SetUnitMaxMana(GetSpellTargetUnit())
 endif
 endfunction
@@ -24652,10 +25049,13 @@
 return abilityid_bkbavatar06
 endif
 if i==abilityid_bkbitem05 then
 return abilityid_bkbavatar05
 endif
+if i==abilityid_bkbitem04 then
+return abilityid_bkbavatar04
+endif
 return 0
 endfunction
 function BKB_GetDuration takes integer i returns integer
 if i==abilityid_bkbitem10 then
 return 10
@@ -24673,10 +25073,13 @@
 return 6
 endif
 if i==abilityid_bkbitem05 then
 return 5
 endif
+if i==abilityid_bkbitem04 then
+return 4
+endif
 return 0
 endfunction
 function BKB_FixVisual takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
@@ -24792,11 +25195,11 @@
 set amp_allow=false
 if Damage>0 then
 call TextTagOnUnitEx("+"+I2S(R2I(Damage)),1,Target,0.023,255,0,0,216)
 endif
 elseif GetEventDamage()>1 then
-call SaveReal(hash_main,(Cache),(20),((Damage+GetEventDamage()*0.25)*1.0))
+call SaveReal(hash_main,(Cache),(20),((Damage+GetEventDamage()*0.3)*1.0))
 endif
 set t=null
 set Source=null
 set Target=null
 return false
@@ -25133,11 +25536,11 @@
 set s="effects\\GlyphScourge.mdx"
 endif
 call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(s,Tower,"origin")))
 call SaveUnitHandle(hash_main,(Cache),(134),(Tower))
 call TriggerRegisterUnitEvent(t,Tower,EVENT_UNIT_DEATH)
-call TriggerRegisterTimerEvent(t,4,false)
+call TriggerRegisterTimerEvent(t,fortify_duration,false)
 call TriggerAddCondition(t,Condition(function FortifyBuildings_Finish))
 set t=null
 set Tower=null
 endfunction
 function FortifyBuildings_DisableRest takes unit cop,player p returns nothing
@@ -25250,11 +25653,11 @@
 function Blademail takes nothing returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=GetTriggerUnit()
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
-call TriggerRegisterTimerEvent(t,4,false)
+call TriggerRegisterTimerEvent(t,4.5,false)
 call TriggerAddCondition(t,Condition(function Blademail_Damaged))
 call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\SpikeBarrier\\SpikeBarrier.mdl",Source,"chest")))
 set t=null
 set Source=null
 endfunction
@@ -25269,16 +25672,16 @@
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local real a=(LoadReal(hash_main,(Cache),(137)))
 local real d=(LoadReal(hash_main,(Cache),(138)))
 local real x=SafeX(GetUnitX(Target)+d/10*Cos(a*bj_DEGTORAD))
 local real y=SafeY(GetUnitY(Target)+d/10*Sin(a*bj_DEGTORAD))
-if GetTriggerEvalCount(t)==11 or GetTriggerEventId()==EVENT_UNIT_DEATH then
+if GetTriggerEvalCount(t)==11 or GetTriggerEventId()==EVENT_UNIT_DEATH or((LoadInteger(hash_main,(GetHandleId((Target))),((4260))))==HERO_STATE_ON)==true then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x,y))
-if((LoadInteger(hash_main,(GetHandleId((Target))),((4306))))==HERO_STATE_ON)==false and GetUnitAbilityLevel(Target,buffid_blackhole)==0 then
+if((LoadInteger(hash_main,(GetHandleId((Target))),((4306))))==HERO_STATE_ON)==false and((LoadInteger(hash_main,(GetHandleId((Target))),((4324))))==HERO_STATE_ON)==false and GetUnitAbilityLevel(Target,buffid_blackhole)==0 then
 call KillTrees(x,y,150)
 call SetUnitX(Target,x)
 call SetUnitY(Target,y)
 endif
 endif
@@ -25378,11 +25781,13 @@
 local integer Cache=GetHandleId(GetTriggeringTrigger())
 local unit Source=tt_unit1
 local unit Target=tt_unit2
 local real Damage=(LoadReal(hash_main,(Cache),(20)))
 local trigger t
-if Source!=Target then
+if IsPlayerAlly(GetOwningPlayer(Target),GetOwningPlayer(Source))==true and Source!=Target then
+call EtherBlast_Add(Target)
+elseif Source!=Target then
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call SetPlayerAbilityAvailable(GetOwningPlayer(Target),etherblast_ms,false)
 call UnitAddAbility(Target,etherblast_ms)
 call UnitMakeAbilityPermanent(Target,true,etherblast_ms)
@@ -25403,17 +25808,26 @@
 function EtherBlast takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local trigger t2=CreateProjectileToUnit(Source,Target,1747993171,"EtherBlast_Process",1000)
 local integer Cache2=GetHandleId(t2)
-call SaveReal(hash_main,(Cache2),(20),((GetHeroAgi(Source,true)*2.0+75)*1.0))
+local integer Type=GetHeroType(Source)
+local real Attribute
+if Type==HEROTYPE_AGI then
+set Attribute=GetHeroAgi(Source,true)
+elseif Type==HEROTYPE_STR then
+set Attribute=GetHeroStr(Source,true)
+elseif Type==HEROTYPE_INT then
+set Attribute=GetHeroInt(Source,true)
+endif
+call SaveReal(hash_main,(Cache2),(20),((Attribute*2.0+75)*1.0))
 set Source=null
 set Target=null
 set t2=null
 endfunction
 function EtherBlast_Main takes nothing returns nothing
-if GetSpellAbilityId()==abilityid_etherblast and(GetSpellTargetUnit()==GetTriggerUnit()or IsBlocked(GetSpellTargetUnit())==false)then
+if GetSpellAbilityId()==abilityid_etherblast and(IsPlayerAlly(GetOwningPlayer(GetSpellTargetUnit()),GetOwningPlayer(GetTriggerUnit()))==true or IsBlocked(GetSpellTargetUnit())==false)then
 call EtherBlast()
 endif
 endfunction
 function GhostPotion_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
@@ -25707,12 +26121,16 @@
 endfunction
 function IsFakeHeroBuilding takes unit u returns boolean
 local integer unitid=GetUnitTypeId(u)
 return unitid==1211122232 or unitid==1848657482 or unitid==1848657481 or unitid==1848657462 or unitid==1848657480 or unitid==1966092371
 endfunction
+function IsSmokeException takes unit u returns boolean
+local integer id=GetUnitTypeId(u)
+return PrimalSplit_IsPanda(id)
+endfunction
 function SmokeOfDeceit_Find takes nothing returns boolean
-return IsUnitEnemy(GetFilterUnit(),smokeofdeceit_player)and IsDead(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true or IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==true)and IsFakeHeroBuilding(GetFilterUnit())==false
+return IsUnitEnemy(GetFilterUnit(),smokeofdeceit_player)and IsDead(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true or IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==true or IsSmokeException(GetFilterUnit()))and IsFakeHeroBuilding(GetFilterUnit())==false
 endfunction
 function SmokeOfDeceit_IsNearby takes unit Source returns boolean
 local group g=GetAvailableGroup()
 local boolean found
 set smokeofdeceit_player=GetOwningPlayer(Source)
@@ -25829,11 +26247,11 @@
 function VeilOfDiscord takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local group g=GetAvailableGroup()
 local real x=GetSpellTargetX()
 local real y=GetSpellTargetY()
-call GroupEnumUnitsInRange(g,x,y,525,Condition(function GenericCondition_EnemyUnits))
+call GroupEnumUnitsInRange(g,x,y,575,Condition(function GenericCondition_EnemyUnits))
 call ForGroup(g,function VeilOfDiscord_Hit)
 call KillGroup(g)
 call DestroyEffect(AddSpecialEffect(veilofdiscord_fx,x,y))
 set Source=null
 set g=null
@@ -25943,10 +26361,88 @@
 function TranquilBoots_Main takes nothing returns nothing
 if GetSpellAbilityId()==abilityid_tranquilboots then
 call TranquilBoots()
 endif
 endfunction
+function ShadowAmulet_Check takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local real x=(LoadReal(hash_main,(Cache),(6)))
+local real y=(LoadReal(hash_main,(Cache),(7)))
+local unit Caster
+if GetUnitX(Source)!=x or GetUnitY(Source)!=y or(GetUnitAbilityLevel(Source,shadowamulet_buffid2)==0 and GetTriggerEvalCount(t)>R2I(shadowamulet_fadetime/.05))then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call SaveInteger(hash_main,(GetHandleId((Source))),((4330)),(HERO_STATE_OFF))
+call UnitRemoveAbility(Source,shadowamulet_buffid1)
+call UnitRemoveAbility(Source,shadowamulet_buffid2)
+elseif GetTriggerEvalCount(t)==R2I(shadowamulet_fadetime/.05)then
+set Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Source),GetUnitY(Source),0)
+call UnitAddAbility(Caster,1093815861)
+call IssueTargetOrder(Caster,"invisibility",Source)
+call SaveInteger(hash_main,(GetHandleId((Source))),((4330)),(HERO_STATE_OFF))
+set Caster=null
+endif
+set t=null
+set Source=null
+return false
+endfunction
+function ShadowAmulet_InitialCheck takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local real x=(LoadReal(hash_main,(Cache),(6)))
+local real y=(LoadReal(hash_main,(Cache),(7)))
+local integer OtherCache=(LoadInteger(hash_main,(Cache),(375)))
+local integer id=GetUnitCurrentOrder(Source)
+if GetUnitX(Source)!=x or GetUnitY(Source)!=y then
+call IssueImmediateOrder(Source,"holdposition")
+call SaveReal(hash_main,(OtherCache),(6),((GetUnitX(Source))*1.0))
+call SaveReal(hash_main,(OtherCache),(7),((GetUnitY(Source))*1.0))
+elseif id==0 or id==851973 or id==851983 or id==851971 then
+call IssueImmediateOrder(Source,"holdposition")
+endif
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+set Source=null
+return false
+endfunction
+function ShadowAmulet takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local trigger t2=CreateTrigger()
+local integer Cache2=GetHandleId(t2)
+local string fxpath=shadowamulet_castfx
+if GetLocalPlayer()!=GetOwningPlayer(Source)then
+set fxpath=""
+endif
+call SaveInteger(hash_main,(GetHandleId((Source))),((4330)),(HERO_STATE_ON))
+call DestroyEffect(AddSpecialEffectTarget(fxpath,Source,"chest"))
+call DestroyEffect(AddSpecialEffectTarget(fxpath,Source,"hand left"))
+call DestroyEffect(AddSpecialEffectTarget(fxpath,Source,"hand right"))
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerAddCondition(t,Condition(function ShadowAmulet_Check))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveReal(hash_main,(Cache),(6),((GetUnitX(Source))*1.0))
+call SaveReal(hash_main,(Cache),(7),((GetUnitY(Source))*1.0))
+call TriggerRegisterTimerEvent(t2,0.01,false)
+call TriggerAddCondition(t2,Condition(function ShadowAmulet_InitialCheck))
+call SaveUnitHandle(hash_main,(Cache2),(2),(Source))
+call SaveReal(hash_main,(Cache2),(6),((GetUnitX(Source))*1.0))
+call SaveReal(hash_main,(Cache2),(7),((GetUnitY(Source))*1.0))
+call SaveInteger(hash_main,(Cache2),(375),(Cache))
+set Source=null
+set t=null
+endfunction
+function ShadowAmulet_Main takes nothing returns nothing
+if GetSpellAbilityId()==1093815857 and((LoadInteger(hash_main,(GetHandleId((GetTriggerUnit()))),((4330))))==HERO_STATE_ON)==false then
+call ShadowAmulet()
+endif
+endfunction
 function Prudence takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 local integer Level=2
@@ -26236,10 +26732,11 @@
 call CripplingStaff_Main()
 call BladeOfTheReaper_Main()
 call Dagon_Main()
 call TranquilBoots_Main()
 call Prudence_Main()
+call ShadowAmulet_Main()
 if GetSpellAbilityId()==1093815095 and IsBlocked(GetSpellTargetUnit())==false then
 call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LevelerStunFX.mdx",GetSpellTargetUnit(),"head"))
 endif
 return false
 endfunction
@@ -32061,13 +32558,14 @@
 endfunction
 function RestrictHeroes takes nothing returns nothing
 call TechHeroForAll(1160786502)
 call TechHeroForAll(1311780946)
 call TechHeroForAll(1311788336)
-call TechHeroForAll(1160786738)
 call TechHeroForAll(1160786507)
-call TechHeroForAll(1211122767)
+call TechHeroForAll(1311788343)
+call TechHeroForAll(1311788363)
+call TechHeroForAll(1211117616)
 endfunction
 function KillCourier_Sent takes nothing returns nothing
 if IsCourier(GetEnumUnit())and IsUnitAlly(GetEnumUnit(),udg_SentPlayers[0])==false and GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)>0.5 then
 call UnitRemoveAbility(GetEnumUnit(),1110456392)
 call DamageTarget(SentinelBuilding_Well,GetEnumUnit(),DAMAGE_PHYSICAL,500)
@@ -32295,14 +32793,14 @@
 endfunction
 function AntiTK_Creep takes nothing returns boolean
 return AntiTK_Percent(50)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false and(IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false or GetUnitTypeId(GetTriggerUnit())==1700946284 or GetUnitTypeId(GetTriggerUnit())==1697657398 or GetUnitTypeId(GetTriggerUnit())==1970107511 or GetUnitTypeId(GetTriggerUnit())==1966092370)
 endfunction
 function AntiTK_Exception takes nothing returns boolean
-return GetUnitTypeId(GetTriggerUnit())==1966092371 or GetUnitTypeId(GetTriggerUnit())==1865429334
+return GetUnitTypeId(GetTriggerUnit())==1966092371 or GetUnitTypeId(GetTriggerUnit())==1865429334 or((LoadInteger(hash_main,(GetHandleId((GetAttacker()))),((4328))))==HERO_STATE_ON)==true
 endfunction
 function AntiTK_Main takes nothing returns nothing
-if not((AntiTK_Percent(10)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==true and GetUnitTypeId(GetTriggerUnit())!=1702129516 and GetUnitTypeId(GetTriggerUnit())!=1970172012)or(AntiTK_Percent(25)and(GetUnitAbilityLevel(GetTriggerUnit(),1112433775)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1111847784)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110454321)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110458705)>0 or GetUnitAbilityLevel(GetTriggerUnit(),buffid_shadowword_damage)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455620)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455629)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455630)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455631)>0))or(AntiTK_Percent(50)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false and(IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false or GetUnitTypeId(GetTriggerUnit())==1700946284 or GetUnitTypeId(GetTriggerUnit())==1697657398 or GetUnitTypeId(GetTriggerUnit())==1970107511 or GetUnitTypeId(GetTriggerUnit())==1966092370))or(GetUnitTypeId(GetTriggerUnit())==1966092371 or GetUnitTypeId(GetTriggerUnit())==1865429334))then
+if not((AntiTK_Percent(10)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==true and GetUnitTypeId(GetTriggerUnit())!=1702129516 and GetUnitTypeId(GetTriggerUnit())!=1970172012)or(AntiTK_Percent(25)and(GetUnitAbilityLevel(GetTriggerUnit(),1112433775)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1111847784)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110454321)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110458705)>0 or GetUnitAbilityLevel(GetTriggerUnit(),buffid_shadowword_damage)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455620)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455629)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455630)>0 or GetUnitAbilityLevel(GetTriggerUnit(),1110455631)>0))or(AntiTK_Percent(50)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false and(IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false or GetUnitTypeId(GetTriggerUnit())==1700946284 or GetUnitTypeId(GetTriggerUnit())==1697657398 or GetUnitTypeId(GetTriggerUnit())==1970107511 or GetUnitTypeId(GetTriggerUnit())==1966092370))or(GetUnitTypeId(GetTriggerUnit())==1966092371 or GetUnitTypeId(GetTriggerUnit())==1865429334 or((LoadInteger(hash_main,(GetHandleId((GetAttacker()))),((4328))))==HERO_STATE_ON)==true))then
 call IssueImmediateOrder(GetAttacker(),"stop")
 endif
 endfunction
 function AntiTK takes nothing returns boolean
 if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetAttacker()))then
@@ -32392,10 +32890,13 @@
 call TriggerAddCondition(t,Condition(function ShieldLeaver_Unfreeze))
 set t=null
 set Hero=null
 endfunction
 function ShieldLeaver takes nothing returns boolean
+if udg_ModeTT==true then
+return false
+endif
 if GetSpellAbilityId()==abilityid_shieldleaverfreeze and(GetPlayerSlotState(GetOwningPlayer((GetSpellTargetUnit())))==PLAYER_SLOT_STATE_LEFT)and((LoadInteger(hash_main,(GetHandleId((GetSpellTargetUnit()))),((4259))))==HERO_STATE_ON)==false then
 call ShieldLeaver_Freeze()
 elseif(GetSpellAbilityId()==abilityid_shieldleaverunfreeze or GetSpellAbilityId()==abilityid_shieldleaverfreeze)and(GetPlayerSlotState(GetOwningPlayer((GetSpellTargetUnit())))==PLAYER_SLOT_STATE_LEFT)==false then
 call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName(MSG_TARGET_LEAVERS))
 endif
@@ -33481,13 +33982,15 @@
 local integer order_id=GetIssuedOrderId()
 local integer AttackIndex
 if IsUnitType(Target,UNIT_TYPE_HERO)==true and IsUnitIllusion(Target)==false and(order_id==851983 or order_id==851971)and IsUnitEnemy(Target,GetOwningPlayer(Hero))and IsUnitVisible(Hero,GetOwningPlayer(Target))then
 set AttackIndex=(LoadInteger(hash_main,(GetHandleId(Target)),(143)))
 if HeroAI_Attackers[AttackIndex]==null or HeroAI_Attackers[AttackIndex]==Target or IsDead(HeroAI_Attackers[AttackIndex])then
+if AttackIndex!=0 then
 call HeroAI_Defend(Target,Hero)
 endif
 endif
+endif
 set Hero=null
 set Target=null
 return false
 endfunction
 function HeroAI_Attacked_Main takes nothing returns boolean
@@ -33496,13 +33999,15 @@
 local integer order_id=GetIssuedOrderId()
 local integer AttackIndex
 if IsCreep(Hero)==false then
 set AttackIndex=(LoadInteger(hash_main,(GetHandleId(Target)),(143)))
 if HeroAI_Attackers[AttackIndex]==null or HeroAI_Attackers[AttackIndex]==Target or IsDead(HeroAI_Attackers[AttackIndex])then
+if AttackIndex!=0 then
 call HeroAI_Defend(Target,Hero)
 endif
 endif
+endif
 set Hero=null
 set Target=null
 return false
 endfunction
 function HeroAI_Create takes unit Hero returns nothing
@@ -36779,12 +37284,29 @@
 if udg_Elapsed15==false and switch_enabled and GetTriggerPlayer()==udg_Host then
 set switch_enabled=false
 call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,GetObjectName(MSG_SWITCH_15))
 endif
 endfunction
+function CommandSleep_Main takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+set t=null
+return false
+endfunction
 function Command_Sleep takes nothing returns nothing
-call SetUnitAnimation(udg_Hero[GetPlayerId(GetTriggerPlayer())],"sleep")
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=udg_Hero[GetPlayerId(GetTriggerPlayer())]
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\Sleep\\SleepTarget.mdl",Source,"overhead")))
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_TARGET_ORDER)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_POINT_ORDER)
+call TriggerAddCondition(t,Condition(function CommandSleep_Main))
+call SetUnitAnimation(Source,"sleep")
+set t=null
+set Source=null
 endfunction
 function Command_Calm takes nothing returns nothing
 call SetUnitAnimationByIndex(udg_Hero[GetPlayerId(GetTriggerPlayer())],23)
 endfunction
 function Command_NoHat takes nothing returns nothing
@@ -37277,10 +37799,11 @@
 local boolean CD
 local boolean RS
 local boolean CP
 local boolean ZM
 local boolean UB
+local boolean TT
 set LongModeArray[1]="allpick"
 set ShortModeArray[1]="ap"
 set LongModeArray[2]="allrandom"
 set ShortModeArray[2]="ar"
 set LongModeArray[3]="leaguemode"
@@ -37361,11 +37884,13 @@
 set ShortModeArray[40]="zm"
 set LongModeArray[41]="capturepoint"
 set ShortModeArray[41]="cp"
 set LongModeArray[42]="unban"
 set ShortModeArray[42]="ub"
-set NumModes=42
+set LongModeArray[43]="tagteam"
+set ShortModeArray[43]="tt"
+set NumModes=43
 set x=-1
 loop
 exitwhen x==Length-1
 set x=x+1
 set y=x
@@ -37452,14 +37977,15 @@
 set RS=GameModeArray[38]
 set SO=GameModeArray[39]
 set ZM=GameModeArray[40]
 set CP=GameModeArray[41]
 set UB=GameModeArray[42]
+set TT=GameModeArray[43]
 if ChatString!=""or IsGameCommand(ModeString)then
 return
 endif
-if(AR and(CM or AP or TR or LM or MR or RV or RD or CD or SD))or(AP and(TR or MR))or(TR and(LM or MR))or(LM and MR)or(MM and SH)then
+if(AR and(CM or AP or TR or LM or MR or RV or RD or CD or SD or TT))or(AP and(TR or MR))or(TR and(LM or MR))or(LM and MR)or(MM and SH)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
 if(AA and(AI or AS or DM))or(AS and(AI or DM))or(AI and DM)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
@@ -37467,47 +37993,51 @@
 endif
 if(RO and(MO or DM))or(MO and DM)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if RV and(CM or AR or TR or MR or LM or DM or SH)then
+if RV and(CM or AR or TR or MR or LM or DM or SH or TT)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if(DM and(CM or TR or LM or MR or SH or RV or RD or CD or SD))or(MM and DM)or(SH and DM)then
+if(DM and(CM or TR or LM or MR or SH or RV or RD or CD or SD or TT))or(MM and DM)or(SH and DM)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_DM))
 return
 endif
-if LM and(CM or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or XL or MO or RO)then
+if LM and(TT or CM or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or XL or MO or RO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_LM))
 return
 endif
-if XL and(CM or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or LM or RO or MO)then
+if XL and(TT or CM or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or LM or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_XL))
 return
 endif
-if CM and(SP or XL or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or LM or MO or RO)then
+if CM and(TT or SP or XL or AP or RD or CD or AR or SD or MM or TR or DM or MR or AA or AI or AS or ID or NP or SC or EM or DU or SH or RV or OM or NB or NM or NT or LM or MO or RO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_XL))
 return
 endif
-if RD and(CD or CM or AP or LM or AR or SD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
+if RD and(TT or CD or CM or AP or LM or AR or SD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
+call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
+return
+endif
+if CD and(TT or RD or CM or AP or LM or AR or SD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if CD and(RD or CM or AP or LM or AR or SD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
+if MR and(TT or CM or AP or LM or AR or SD or MM or TR or DM or AA or AI or AS or SH or RV or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if MR and(CM or AP or LM or AR or SD or MM or TR or DM or AA or AI or AS or SH or RV or RO or MO)then
+if SD and(TT or CM or AP or LM or AR or RD or CD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if SD and(CM or AP or LM or AR or RD or CD or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
+if VR and(TT or CM or LM or RD or CD or SD or AR or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
-if VR and(CM or LM or RD or CD or SD or AR or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
+if TT and(SO or VR or CM or LM or RD or CD or SD or AR or MM or TR or DM or MR or AA or AI or AS or SH or RV or RO or MO)then
 call Error(udg_Host,GetObjectName(MSG_INVALID_MODE))
 return
 endif
 if MM and CountRealPlayersInForce(udg_ForceSent)!=CountRealPlayersInForce(udg_ForceScourge)then
 call Error(udg_Host,GetObjectName(MSG_MM_EVEN))
@@ -37523,11 +38053,11 @@
 endif
 if LM and not(IsPlayer(udg_SentPlayers[1])and IsPlayer(udg_SentPlayers[2])and IsPlayer(udg_SentPlayers[3])and IsPlayer(udg_SentPlayers[4])and IsPlayer(udg_SentPlayers[5])and IsPlayer(udg_ScourgePlayers[1])and IsPlayer(udg_ScourgePlayers[2])and IsPlayer(udg_ScourgePlayers[3])and IsPlayer(udg_ScourgePlayers[4])and IsPlayer(udg_ScourgePlayers[5]))then
 endif
 if XL and not(IsPlayer(udg_SentPlayers[1])and IsPlayer(udg_SentPlayers[2])and IsPlayer(udg_SentPlayers[3])and IsPlayer(udg_SentPlayers[4])and IsPlayer(udg_SentPlayers[5])and IsPlayer(udg_ScourgePlayers[1])and IsPlayer(udg_ScourgePlayers[2])and IsPlayer(udg_ScourgePlayers[3])and IsPlayer(udg_ScourgePlayers[4])and IsPlayer(udg_ScourgePlayers[5]))then
 endif
-if ZM or CP or FR or CM or AP or AR or LM or MM or TR or DM or MR or SP or AA or AI or AS or ID or NP or SC or DU or EM or SH or VR or RV or RD or CD or OM or NB or NM or NT or NS or NR or XL or SD or PM or OI or MI or MO or RO or ER or RS or SO then
+if TT or ZM or CP or FR or CM or AP or AR or LM or MM or TR or DM or MR or SP or AA or AI or AS or ID or NP or SC or DU or EM or SH or VR or RV or RD or CD or OM or NB or NM or NT or NS or NR or XL or SD or PM or OI or MI or MO or RO or ER or RS or SO then
 call DisableTrigger(t_gamemode)
 else
 return
 endif
 if CM==false then
@@ -37570,14 +38100,19 @@
 set udg_MultiboardMode=GetObjectName(1848658229)
 elseif SD then
 set udg_MultiboardMode=GetObjectName(1848658228)
 elseif CM then
 set udg_MultiboardMode=GetObjectName(1848658247)
+elseif TT then
+set udg_MultiboardMode=GetObjectName(1848659280)
 endif
 if CM then
 call AddModeString(GetObjectName(1848658251))
 endif
+if TT then
+call AddModeString(GetObjectName(1848659281))
+endif
 if LM then
 call AddModeString(GetObjectName(1848658227))
 endif
 if XL then
 call AddModeString(GetObjectName(1848658226))
@@ -37747,10 +38282,11 @@
 call ExecuteOnTrue("ModeFR",FR)
 call ExecuteOnTrue("ModeER",ER)
 call ExecuteOnTrue("ModeCD",CD)
 call ExecuteOnTrue("ModeZM",ZM)
 call ExecuteOnTrue("ModeCP",CP)
+call ExecuteOnTrue("ModeTT",TT)
 set ModeCreated=true
 call SetTime(0,0,false)
 if udg_ModeCM==false and udg_ModeCD==false then
 call ModePicked()
 endif
@@ -39833,37 +40369,33 @@
 loop
 exitwhen i>RD_COUNT
 set Rand=GiveRandomHeroNumber(true,true)
 if Rigged1 then
 set Rigged1=false
-set Rand=50
+set Rand=91
 elseif Rigged2 then
 set Rigged2=false
 set Rand=51
 elseif Rigged3 then
 set Rigged3=false
-set Rand=104
+set Rand=99
 elseif Rigged4 then
 set Rigged4=false
+if GetRandomInt(1,2)==1 then
+set Rand=104
+else
 set Rand=65
+endif
 elseif Rigged5 then
 set Rigged5=false
-set Rand=49
+set Rand=109
 elseif Rigged6 then
 set Rigged6=false
-if GetRandomInt(1,2)==1 then
-set Rand=16
-else
-set Rand=86
-endif
+set Rand=15
 elseif Rigged7 then
 set Rigged7=false
-if GetRandomInt(1,2)==1 then
-set Rand=73
-else
-set Rand=83
-endif
+set Rand=110
 elseif Rigged8 then
 set Rigged8=false
 elseif Rigged9 then
 set Rigged9=false
 endif
@@ -43770,134 +44302,542 @@
 endif
 endfunction
 function ModeCP takes nothing returns nothing
 set udg_ModeCP=true
 endfunction
-function Trig_timer1_Actions takes nothing returns nothing
-set udg_KillInt[1]=0
-endfunction
-function InitTrig_timer1 takes nothing returns nothing
-set gg_trg_timer1=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer1,udg_KillTimer[1])
-call TriggerAddAction(gg_trg_timer1,function Trig_timer1_Actions)
-endfunction
-function Trig_timer2_Actions takes nothing returns nothing
-set udg_KillInt[2]=0
-endfunction
-function InitTrig_timer2 takes nothing returns nothing
-set gg_trg_timer2=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer2,udg_KillTimer[2])
-call TriggerAddAction(gg_trg_timer2,function Trig_timer2_Actions)
-endfunction
-function Trig_timer3_Actions takes nothing returns nothing
-set udg_KillInt[3]=0
-endfunction
-function InitTrig_timer3 takes nothing returns nothing
-set gg_trg_timer3=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer3,udg_KillTimer[3])
-call TriggerAddAction(gg_trg_timer3,function Trig_timer3_Actions)
+function ModeTT_ProcessItems takes nothing returns nothing
+local integer indexId=GetIndex(GetEnumItem())
+if GetWidgetLife(GetEnumItem())>0 and GetItemPlayer(GetEnumItem())==tt_itemplayer and indexId!=indexid_aegis and indexId!=indexid_divinerapier and indexId!=indexid_divinerapierfree and indexId!=indexid_gemoftruesight and indexId!=indexid_gemoftruesightcourier then
+if IsItemVisible(GetEnumItem())then
+call SetItemVisible(GetEnumItem(),false)
+else
+call SetItemVisible(GetEnumItem(),true)
+endif
+endif
 endfunction
-function Trig_timer4_Actions takes nothing returns nothing
-set udg_KillInt[4]=0
+function ModeTT_DropItems takes nothing returns nothing
+local player p=tt_itemplayer
+local region r=CreateRegion()
+local unit u=GetEnumUnit()
+local integer indexId
+local integer i=0
+local item Item
+local integer id
+local real x
+local real y
+if IsSent(p)then
+call RegionAddRect(r,gg_rct_Recreate1)
+set x=GetRectCenterX(gg_rct_Recreate1)
+set y=GetRectCenterY(gg_rct_Recreate1)
+else
+call RegionAddRect(r,gg_rct_Recreate2)
+set x=GetRectCenterX(gg_rct_Recreate2)
+set y=GetRectCenterY(gg_rct_Recreate2)
+endif
+loop
+exitwhen i>5
+set Item=UnitItemInSlot(u,i)
+set indexId=GetIndex(Item)
+if GetItemPlayer(Item)==tt_itemplayer and indexId!=indexid_aegis and indexId!=indexid_divinerapier and indexId!=indexid_divinerapierfree and indexId!=indexid_gemoftruesight and indexId!=indexid_gemoftruesightcourier then
+call UnitRemoveItemFromSlot(u,i)
+set id=GetPlayerId(GetItemPlayer(Item))
+call SetItemPosition(Item,x,y)
+endif
+set i=i+1
+endloop
+call RemoveRegion(r)
+set u=null
+set r=null
 endfunction
-function InitTrig_timer4 takes nothing returns nothing
-set gg_trg_timer4=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer4,udg_KillTimer[4])
-call TriggerAddAction(gg_trg_timer4,function Trig_timer4_Actions)
+function ModeTT_SearchItems takes nothing returns boolean
+return(GetUnitTypeId(GetFilterUnit())==1852010352 or IsCourier(GetFilterUnit())or(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and GetOwningPlayer(GetFilterUnit())!=tt_itemplayer and GetOwningPlayer(GetFilterUnit())!=udg_SentPlayers[0]and GetOwningPlayer(GetFilterUnit())!=udg_ScourgePlayers[0]))and IsUnitAlly(GetFilterUnit(),tt_itemplayer)==true
 endfunction
-function Trig_timer5_Actions takes nothing returns nothing
-set udg_KillInt[5]=0
+function ModeTT_DropAllItems takes player p returns nothing
+local integer i=0
+local item Item
+local integer id=GetPlayerId(p)
+local group g=GetAvailableGroup()
+set tt_itemplayer=p
+call GroupEnumUnitsInRange(g,0,0,99999,Condition(function ModeTT_SearchItems))
+call ForGroup(g,function ModeTT_DropItems)
+call KillGroup(g)
 endfunction
-function InitTrig_timer5 takes nothing returns nothing
-set gg_trg_timer5=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer5,udg_KillTimer[5])
-call TriggerAddAction(gg_trg_timer5,function Trig_timer5_Actions)
+function ModeTT_ToggleItemStates takes player p returns nothing
+set tt_itemplayer=p
+call EnumItemsInRectBJ(bj_mapInitialPlayableArea,function ModeTT_ProcessItems)
+endfunction
+function ModeTT_RespawnHero takes unit u returns nothing
+local unit DeadHero=u
+local player DeadPlayer=GetOwningPlayer(u)
+local location RespawnLoc
+if IsScourge(DeadPlayer)then
+set RespawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
+else
+set RespawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
+endif
+if udg_GameOver==false and IsDead(DeadHero)then
+call ReviveCamera(DeadHero,DeadPlayer,GetLocationX(RespawnLoc),GetLocationY(RespawnLoc),true)
+if Deathtrigger_IsKobold(DeadHero)==false or GetUnitAbilityLevel(DeadHero,1093684567)==0 then
+call ReviveHeroLoc(DeadHero,RespawnLoc,true)
+else
+call Deathtrigger_ReviveKobold(DeadHero,RespawnLoc)
+endif
+endif
+call RemoveLocation(RespawnLoc)
+set DeadHero=null
+set DeadPlayer=null
+set RespawnLoc=null
 endfunction
-function Trig_timer7_Actions takes nothing returns nothing
-set udg_KillInt[7]=0
+function ModeTT_SyncHeroes takes unit HeroA,unit HeroB returns nothing
+local player p=GetOwningPlayer(HeroB)
+local integer id=GetPlayerId(p)
+call SetHeroXP(HeroB,GetHeroXP(HeroA),true)
+call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,(LoadInteger(hash_main,(GetHandleId(HeroB)),(787)))+TT_GoldBank[id])
+set TT_PreviousGold[id]=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
+set TT_GoldBank[id]=0
 endfunction
-function InitTrig_timer7 takes nothing returns nothing
-set gg_trg_timer7=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer7,udg_KillTimer[7])
-call TriggerAddAction(gg_trg_timer7,function Trig_timer7_Actions)
+function ModeTT_CompareTypes takes integer id,unit Original returns boolean
+return GetHeroTypeById(HeroID[id])!=GetHeroType(Original)
 endfunction
-function Trig_timer8_Actions takes nothing returns nothing
-set udg_KillInt[8]=0
+function GetHeroDefaultColors_R takes unit u returns integer
+return 255
 endfunction
-function InitTrig_timer8 takes nothing returns nothing
-set gg_trg_timer8=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer8,udg_KillTimer[8])
-call TriggerAddAction(gg_trg_timer8,function Trig_timer8_Actions)
+function GetHeroDefaultColors_G takes unit u returns integer
+return 255
 endfunction
-function Trig_timer9_Actions takes nothing returns nothing
-set udg_KillInt[9]=0
+function GetHeroDefaultColors_B takes unit u returns integer
+return 255
 endfunction
-function InitTrig_timer9 takes nothing returns nothing
-set gg_trg_timer9=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer9,udg_KillTimer[9])
-call TriggerAddAction(gg_trg_timer9,function Trig_timer9_Actions)
+function ModeTT_DisableHero takes unit u,integer id,player p returns nothing
+local player p1=GetOwningPlayer(u)
+local player p2
+local integer i
+local item TempItem
+if IsSent(GetOwningPlayer(u))then
+set p2=udg_SentPlayers[0]
+else
+set p2=udg_ScourgePlayers[0]
+endif
+call SaveInteger(hash_main,(GetHandleId(u)),(787),(GetPlayerState(GetOwningPlayer(u),PLAYER_STATE_RESOURCE_GOLD)))
+call SaveBoolean(hash_main,(GetHandleId(u)),(140),(false))
+call SaveInteger(hash_main,(GetHandleId((u))),((4259)),(HERO_STATE_ON))
+call UnitAddAbility(u,1093678162)
+call SetUnitInvulnerable2(u,true)
+call PauseUnit(u,true)
+call SetUnitVertexColor(u,GetHeroDefaultColors_R(u),GetHeroDefaultColors_G(u),GetHeroDefaultColors_B(u),150)
+call SelectUnitRemoveForPlayer(u,GetOwningPlayer(u))
+call SetUnitOwner(u,p2,false)
+call SetUnitPathing(u,false)
+call SetUnitX(u,GetUnitX(COP[id]))
+call SetUnitY(u,GetUnitY(COP[id]))
+set i=0
+loop
+exitwhen i>5
+if UnitItemInSlot(u,i)==null then
+set TempItem=CreateItem(1227895373,GetUnitX(u),GetUnitY(u))
+call UnitAddItem(u,TempItem)
+endif
+set i=i+1
+endloop
+set p1=null
+set p2=null
 endfunction
-function Trig_timer10_Actions takes nothing returns nothing
-set udg_KillInt[10]=0
+function ModeTT_EnableHero takes unit u,integer id,player p returns nothing
+local integer i
+set udg_Hero[id]=u
+call SaveBoolean(hash_main,(GetHandleId(u)),(140),(false))
+call SaveInteger(hash_main,(GetHandleId((u))),((4259)),(HERO_STATE_OFF))
+call UnitRemoveAbility(u,1093678162)
+call SetUnitInvulnerable2(u,false)
+call PauseUnit(u,false)
+call SetUnitVertexColor(u,GetHeroDefaultColors_R(u),GetHeroDefaultColors_G(u),GetHeroDefaultColors_B(u),255)
+call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
+call SetUnitOwner(u,p,false)
+call SetUnitPathing(u,true)
+if IsSent(Player(id))==true then
+call SetUnitPosition(u,GetRectCenterX(gg_rct_Hero_Creation_NE),GetRectCenterY(gg_rct_Hero_Creation_NE))
+else
+call SetUnitPosition(u,GetRectCenterX(gg_rct_Hero_Creation_UD),GetRectCenterY(gg_rct_Hero_Creation_UD))
+endif
+set i=0
+loop
+exitwhen i>5
+if GetItemTypeId(UnitItemInSlot(u,i))==1227895373 then
+call DestroyItem(UnitItemInSlot(u,i))
+endif
+set i=i+1
+endloop
 endfunction
-function InitTrig_timer10 takes nothing returns nothing
-set gg_trg_timer10=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer10,udg_KillTimer[10])
-call TriggerAddAction(gg_trg_timer10,function Trig_timer10_Actions)
+function ModeTT_AreHeroesInFountain takes integer id returns boolean
+local region r=CreateRegion()
+local boolean result=false
+if IsSent(Player(id))==true then
+call RegionAddRect(r,gg_rct_SpawnSent)
+else
+call RegionAddRect(r,gg_rct_SpawnUD)
+endif
+if IsUnitInRegion(r,TT_HeroA[id])and IsUnitInRegion(r,TT_HeroB[id])then
+set result=true
+endif
+call RemoveRegion(r)
+return result or IsDead(TT_HeroA[id])or IsDead(TT_HeroB[id])
 endfunction
-function Trig_timer11_Actions takes nothing returns nothing
-set udg_KillInt[11]=0
+function ModeTT_RequestSwap_Logic takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local integer id=(LoadInteger(hash_main,(Cache),(34)))
+local integer Stage=GetTriggerEvalCount(t)
+local player p=Player(id)
+if Stage==1 then
+call ModeTT_DropAllItems(p)
+elseif Stage==2 then
+call ModeTT_ToggleItemStates(p)
+elseif Stage==3 then
+if udg_Hero[id]==TT_HeroA[id]then
+call ModeTT_RespawnHero(TT_HeroA[id])
+call ModeTT_DisableHero(TT_HeroA[id],id,p)
+call ModeTT_EnableHero(TT_HeroB[id],id,p)
+call ModeTT_SyncHeroes(TT_HeroA[id],TT_HeroB[id])
+else
+call ModeTT_RespawnHero(TT_HeroB[id])
+call ModeTT_DisableHero(TT_HeroB[id],id,p)
+call ModeTT_EnableHero(TT_HeroA[id],id,p)
+call ModeTT_SyncHeroes(TT_HeroB[id],TT_HeroA[id])
+endif
+else
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+return false
 endfunction
-function InitTrig_timer11 takes nothing returns nothing
-set gg_trg_timer11=CreateTrigger()
-call TriggerRegisterTimerExpireEventBJ(gg_trg_timer11,udg_KillTimer[11])
-call TriggerAddAction(gg_trg_timer11,function Trig_timer11_Actions)
+function ModeTT_RequestSwap takes nothing returns boolean
+local integer id=GetPlayerId(GetTriggerPlayer())
+local real CurrentTime=(TimerGetElapsed(udg_GameTimer))
+local trigger t
+local integer Cache
+if(CurrentTime-TT_LastTag[id])<tt_tagcooldown then
+call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10,GetObjectName(1848659282)+": "+I2S(R2I(tt_tagcooldown-(CurrentTime-TT_LastTag[id]))))
+elseif ModeTT_AreHeroesInFountain(id)==false then
+call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10,GetObjectName(1848659283))
+else
+set TT_LastTag[id]=CurrentTime
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.2,true)
+call TriggerAddCondition(t,Condition(function ModeTT_RequestSwap_Logic))
+call SaveInteger(hash_main,(Cache),(34),(id))
+set t=null
+endif
+return false
 endfunction
-function StartingReplayData takes nothing returns nothing
+function ModeTT_MonitorGold takes nothing returns boolean
 local integer i=1
-local string id
+local integer id
+local integer Delta
+local integer CurrentGold
 local player p
 loop
 exitwhen i>5
 set p=udg_SentPlayers[i]
-set id=I2S(GetPlayerId(p))
-call StoreInteger(ResultsCache,id,"id",i)
+set id=GetPlayerId(p)
+set CurrentGold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
+if TT_PreviousGold[id]<CurrentGold and TT_DisableTracker[id]==false then
+set TT_GoldBank[id]=TT_GoldBank[id]+CurrentGold-TT_PreviousGold[id]
+endif
+set TT_PreviousGold[id]=CurrentGold
+if TT_DisableTracker[id]==true then
+set TT_DisableTracker[id]=false
+endif
 set p=udg_ScourgePlayers[i]
-set id=I2S(GetPlayerId(p))
-call StoreInteger(ResultsCache,id,"id",i+5)
-if GetLocalPlayer()==udg_Host then
-call SyncStoredInteger(ResultsCache,I2S(GetPlayerId(udg_SentPlayers[i])),"id")
-call SyncStoredInteger(ResultsCache,I2S(GetPlayerId(udg_ScourgePlayers[i])),"id")
+set id=GetPlayerId(p)
+set CurrentGold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
+if TT_PreviousGold[id]<CurrentGold and TT_DisableTracker[id]==false then
+set TT_GoldBank[id]=TT_GoldBank[id]+CurrentGold-TT_PreviousGold[id]
+endif
+set TT_PreviousGold[id]=CurrentGold
+if TT_DisableTracker[id]==true then
+set TT_DisableTracker[id]=false
 endif
 set i=i+1
 endloop
-endfunction
-function Sec15_Second takes nothing returns boolean
-if udg_ModeNormal then
-call HideHeroes_NormalMode()
-call DisplayTimedTextToForceEx(GetPlayersAll(),20.00,udg_Colors[GetPlayerId(udg_Host)]+(PlayerNames[GetPlayerId((udg_Host))])+"|r"+" "+GetObjectName(MSG_DEFAULTED_NORMAL))
-call DisplayTimedTextToForceEx(GetPlayersAll(),20.00," ")
-set ModeCreated=true
-call ModePicked()
-call DOnOff_Main()
-call Trig_display_leaderboard_Actions()
-call CreateObsBoard()
-call UpdateCSBoard()
-endif
-call StartingReplayData()
-call CleanTrigger(GetTriggeringTrigger())
-return false
-endfunction
-function Sec15_First takes nothing returns boolean
-set udg_Elapsed15=true
-call CleanTrigger(GetTriggeringTrigger())
 return false
 endfunction
-function InitTrig_Sec15 takes nothing returns nothing
-local trigger t=CreateTrigger()
-call TriggerRegisterTimerEvent(t,14,false)
-call TriggerAddCondition(t,Condition(function Sec15_First))
+function ModeTT_AssignHeroes takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local integer Index=(LoadInteger(hash_main,(Cache),(55)))
+local player p
+local integer Rand
+local location SpawnSent=GetRectCenter(gg_rct_Hero_Creation_NE)
+local location SpawnScourge=GetRectCenter(gg_rct_Hero_Creation_UD)
+local integer id
+if Index<6 then
+set p=udg_SentPlayers[Index]
+set id=GetPlayerId(p)
+elseif Index<11 then
+set p=udg_ScourgePlayers[Index-5]
+set id=GetPlayerId(p)
+endif
+if Index>10 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call TriggerRegisterTimerEvent(tt_t_tracker,0.1,true)
+call TriggerAddCondition(tt_t_tracker,Condition(function ModeTT_MonitorGold))
+elseif Index<6 then
+call SaveInteger(hash_main,(Cache),(55),(Index+1))
+set udg_Hero[GetPlayerId(p)]=null
+if IsPlayer(p)then
+loop
+exitwhen udg_Hero[GetPlayerId(p)]!=null
+set Rand=GetSetElement()
+if udg_HeroFlags[Rand]==false then
+if not udg_ModeDU then
+set udg_HeroFlags[Rand]=true
+endif
+set udg_Hero[id]=CreateUnitAtLoc(p,HeroID[Rand],SpawnSent,bj_UNIT_FACING)
+set TT_HeroA[id]=udg_Hero[id]
+call ModeTT_DisableHero(udg_Hero[id],id,p)
+endif
+endloop
+endif
+elseif Index<11 then
+call SaveInteger(hash_main,(Cache),(55),(Index+1))
+set udg_Hero[GetPlayerId(p)]=null
+if IsPlayer(p)then
+loop
+exitwhen udg_Hero[id]!=null
+set Rand=GetSetElement()
+if udg_HeroFlags[Rand]==false then
+if not udg_ModeDU then
+set udg_HeroFlags[Rand]=true
+endif
+set udg_Hero[id]=CreateUnitAtLoc(p,HeroID[Rand],SpawnScourge,bj_UNIT_FACING)
+set TT_HeroA[id]=udg_Hero[id]
+call ModeTT_DisableHero(udg_Hero[id],id,p)
+endif
+endloop
+endif
+endif
+if Index<6 then
+set p=udg_SentPlayers[Index]
+elseif Index<11 then
+set p=udg_ScourgePlayers[Index-5]
+endif
+if Index<6 then
+call SaveInteger(hash_main,(Cache),(55),(Index+1))
+set udg_Hero[GetPlayerId(p)]=null
+if IsPlayer(p)then
+loop
+exitwhen udg_Hero[id]!=null
+set Rand=GetSetElement()
+if udg_HeroFlags[Rand]==false and ModeTT_CompareTypes(Rand,TT_HeroA[id])then
+if not udg_ModeDU then
+set udg_HeroFlags[Rand]=true
+endif
+set udg_Hero[id]=CreateUnitAtLoc(p,HeroID[Rand],SpawnSent,bj_UNIT_FACING)
+set TT_HeroB[id]=udg_Hero[id]
+set TT_PreviousGold[id]=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
+call ModeTT_EnableHero(udg_Hero[id],id,p)
+call SaveUnitHandle(hash_main,(GetHandleId(TT_HeroB[id])),(788),(TT_HeroA[id]))
+call SaveUnitHandle(hash_main,(GetHandleId(TT_HeroA[id])),(788),(TT_HeroB[id]))
+endif
+endloop
+endif
+elseif Index<11 then
+call SaveInteger(hash_main,(Cache),(55),(Index+1))
+set udg_Hero[id]=null
+if IsPlayer(p)then
+loop
+exitwhen udg_Hero[id]!=null
+set Rand=GetSetElement()
+if udg_HeroFlags[Rand]==false and ModeTT_CompareTypes(Rand,TT_HeroA[id])then
+if not udg_ModeDU then
+set udg_HeroFlags[Rand]=true
+endif
+set udg_Hero[id]=CreateUnitAtLoc(p,HeroID[Rand],SpawnScourge,bj_UNIT_FACING)
+set TT_HeroB[id]=udg_Hero[id]
+set TT_PreviousGold[id]=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
+call ModeTT_EnableHero(udg_Hero[id],id,p)
+call SaveUnitHandle(hash_main,(GetHandleId(TT_HeroB[id])),(788),(TT_HeroA[id]))
+call SaveUnitHandle(hash_main,(GetHandleId(TT_HeroA[id])),(788),(TT_HeroB[id]))
+endif
+endloop
+endif
+endif
+call RemoveLocation(SpawnSent)
+call RemoveLocation(SpawnScourge)
+set SpawnSent=null
+set SpawnScourge=null
+set p=null
+set t=null
+return false
+endfunction
+function ModeTT takes nothing returns nothing
+local integer i=1
+local integer id
+local real CurrentTime=(TimerGetElapsed(udg_GameTimer))
+local trigger t
+set udg_ModeTT=true
+set udg_Allow_Repick=false
+set AllowSwap=false
+call TechHeroForAll(1211117641)
+call TechHeroForAll(1328558160)
+call TechHeroForAll(1211117653)
+loop
+exitwhen i>5
+set id=GetPlayerId(udg_SentPlayers[i])
+set TT_DisableTracker[id]=false
+set TT_LastTag[id]=CurrentTime-tt_tagcooldown
+set TT_GoldBank[id]=0
+set id=GetPlayerId(udg_ScourgePlayers[i])
+set TT_DisableTracker[id]=false
+set TT_LastTag[id]=CurrentTime-tt_tagcooldown
+set TT_GoldBank[id]=0
+set i=i+1
+endloop
+set t=CreateTrigger()
+call TriggerRegisterTimerEvent(t,.5,true)
+call TriggerAddCondition(t,Condition(function ModeTT_AssignHeroes))
+call SaveInteger(hash_main,(GetHandleId(t)),(55),(1))
+set t=CreateTrigger()
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[1],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[2],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[3],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[4],"-tt",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[5],"-tt",true)
+call TriggerAddCondition(t,Condition(function ModeTT_RequestSwap))
+set t=null
+endfunction
+function Trig_timer1_Actions takes nothing returns nothing
+set udg_KillInt[1]=0
+endfunction
+function InitTrig_timer1 takes nothing returns nothing
+set gg_trg_timer1=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer1,udg_KillTimer[1])
+call TriggerAddAction(gg_trg_timer1,function Trig_timer1_Actions)
+endfunction
+function Trig_timer2_Actions takes nothing returns nothing
+set udg_KillInt[2]=0
+endfunction
+function InitTrig_timer2 takes nothing returns nothing
+set gg_trg_timer2=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer2,udg_KillTimer[2])
+call TriggerAddAction(gg_trg_timer2,function Trig_timer2_Actions)
+endfunction
+function Trig_timer3_Actions takes nothing returns nothing
+set udg_KillInt[3]=0
+endfunction
+function InitTrig_timer3 takes nothing returns nothing
+set gg_trg_timer3=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer3,udg_KillTimer[3])
+call TriggerAddAction(gg_trg_timer3,function Trig_timer3_Actions)
+endfunction
+function Trig_timer4_Actions takes nothing returns nothing
+set udg_KillInt[4]=0
+endfunction
+function InitTrig_timer4 takes nothing returns nothing
+set gg_trg_timer4=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer4,udg_KillTimer[4])
+call TriggerAddAction(gg_trg_timer4,function Trig_timer4_Actions)
+endfunction
+function Trig_timer5_Actions takes nothing returns nothing
+set udg_KillInt[5]=0
+endfunction
+function InitTrig_timer5 takes nothing returns nothing
+set gg_trg_timer5=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer5,udg_KillTimer[5])
+call TriggerAddAction(gg_trg_timer5,function Trig_timer5_Actions)
+endfunction
+function Trig_timer7_Actions takes nothing returns nothing
+set udg_KillInt[7]=0
+endfunction
+function InitTrig_timer7 takes nothing returns nothing
+set gg_trg_timer7=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer7,udg_KillTimer[7])
+call TriggerAddAction(gg_trg_timer7,function Trig_timer7_Actions)
+endfunction
+function Trig_timer8_Actions takes nothing returns nothing
+set udg_KillInt[8]=0
+endfunction
+function InitTrig_timer8 takes nothing returns nothing
+set gg_trg_timer8=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer8,udg_KillTimer[8])
+call TriggerAddAction(gg_trg_timer8,function Trig_timer8_Actions)
+endfunction
+function Trig_timer9_Actions takes nothing returns nothing
+set udg_KillInt[9]=0
+endfunction
+function InitTrig_timer9 takes nothing returns nothing
+set gg_trg_timer9=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer9,udg_KillTimer[9])
+call TriggerAddAction(gg_trg_timer9,function Trig_timer9_Actions)
+endfunction
+function Trig_timer10_Actions takes nothing returns nothing
+set udg_KillInt[10]=0
+endfunction
+function InitTrig_timer10 takes nothing returns nothing
+set gg_trg_timer10=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer10,udg_KillTimer[10])
+call TriggerAddAction(gg_trg_timer10,function Trig_timer10_Actions)
+endfunction
+function Trig_timer11_Actions takes nothing returns nothing
+set udg_KillInt[11]=0
+endfunction
+function InitTrig_timer11 takes nothing returns nothing
+set gg_trg_timer11=CreateTrigger()
+call TriggerRegisterTimerExpireEventBJ(gg_trg_timer11,udg_KillTimer[11])
+call TriggerAddAction(gg_trg_timer11,function Trig_timer11_Actions)
+endfunction
+function StartingReplayData takes nothing returns nothing
+local integer i=1
+local string id
+local player p
+loop
+exitwhen i>5
+set p=udg_SentPlayers[i]
+set id=I2S(GetPlayerId(p))
+call StoreInteger(ResultsCache,id,"id",i)
+set p=udg_ScourgePlayers[i]
+set id=I2S(GetPlayerId(p))
+call StoreInteger(ResultsCache,id,"id",i+5)
+if GetLocalPlayer()==udg_Host then
+call SyncStoredInteger(ResultsCache,I2S(GetPlayerId(udg_SentPlayers[i])),"id")
+call SyncStoredInteger(ResultsCache,I2S(GetPlayerId(udg_ScourgePlayers[i])),"id")
+endif
+set i=i+1
+endloop
+endfunction
+function Sec15_Second takes nothing returns boolean
+if udg_ModeNormal then
+call HideHeroes_NormalMode()
+call DisplayTimedTextToForceEx(GetPlayersAll(),20.00,udg_Colors[GetPlayerId(udg_Host)]+(PlayerNames[GetPlayerId((udg_Host))])+"|r"+" "+GetObjectName(MSG_DEFAULTED_NORMAL))
+call DisplayTimedTextToForceEx(GetPlayersAll(),20.00," ")
+set ModeCreated=true
+call ModePicked()
+call DOnOff_Main()
+call Trig_display_leaderboard_Actions()
+call CreateObsBoard()
+call UpdateCSBoard()
+endif
+call StartingReplayData()
+call CleanTrigger(GetTriggeringTrigger())
+return false
+endfunction
+function Sec15_First takes nothing returns boolean
+set udg_Elapsed15=true
+call CleanTrigger(GetTriggeringTrigger())
+return false
+endfunction
+function InitTrig_Sec15 takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterTimerEvent(t,14,false)
+call TriggerAddCondition(t,Condition(function Sec15_First))
 set t=CreateTrigger()
 call TriggerRegisterTimerEvent(t,15,false)
 call TriggerAddCondition(t,Condition(function Sec15_Second))
 endfunction
 function Trig_OneMinElapsed_Actions takes nothing returns nothing
@@ -44418,13 +45358,11 @@
 endfunction
 function GhostShip_Explode takes nothing returns nothing
 local unit Source=ghostship_source
 local unit Target=GetEnumUnit()
 local integer Level=ghostship_level
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
-call UnitAddAbility2(Caster,ghostship_stun)
-call IssueTargetOrder(Caster,"thunderbolt",Target)
+call Stun(Source,Target,1.4)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,200+100*Level)
 set Source=null
 set Target=null
 endfunction
 function GhostShip_Move takes nothing returns boolean
@@ -44470,11 +45408,11 @@
 call SetUnitY(Projectile2,NewY)
 endif
 if Count==150 then
 set g=GetAvailableGroup()
 set tt_unit1=Projectile
-call GroupEnumUnitsInRange(g,NewX,NewY,425,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,NewX,NewY,425+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function GhostShip_Explode)
 call KillGroup(g)
 call KillUnit(Projectile)
 call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
@@ -44556,45 +45494,34 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function GhostShip_Main))
 call PreloadAbility(ghostship_slow)
 set t=null
 endfunction
-function UnstableConcoction_Hit takes unit u,real x,real y returns nothing
-if u!=null then
-call DamageTarget(unstableconcoction_source,u,DAMAGE_PHYSICAL,unstableconcoction_damage)
-call IssueTargetOrder(unstableconcoction_caster,"thunderbolt",u)
-endif
+function UnstableConcoction_Hit takes nothing returns nothing
+call DamageTarget(unstableconcoction_source,GetEnumUnit(),DAMAGE_PHYSICAL,unstableconcoction_damage)
+call Stun(unstableconcoction_source,GetEnumUnit(),unstableconcoction_stun)
 endfunction
 function UnstableConcoction_Explode takes unit Source,unit Target,real Elapsed returns nothing
 local group g
 local integer Level=GetUnitAbilityLevel(Source,abilityid_unstableconcoction)
 local real x
 local real y
 set unstableconcoction_source=Source
-set unstableconcoction_damage=(60+70*Level)*Elapsed/unstableconcoction_maxcharge
+set unstableconcoction_damage=(80+70*Level)*Elapsed/unstableconcoction_maxcharge
 set unstableconcoction_stun=(1+0.75*Level)*Elapsed/unstableconcoction_maxcharge
 set unstableconcoction_caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 call UnitAddAbility2(unstableconcoction_caster,abilityid_genericstun)
 call SetUnitAbilityLevel(unstableconcoction_caster,abilityid_genericstun,Stun_GetLevel(unstableconcoction_stun))
 set tt_unit1=Source
-if Source==Target then
-call UnstableConcoction_Hit(Target,GetUnitX(Target),GetUnitY(Target))
-elseif GetUnitTypeId(Target)!=unitid_unstableconcoction then
-call UnstableConcoction_Hit(Target,GetUnitX(Target),GetUnitY(Target))
-else
-set x=GetUnitX(Target)
-set y=GetUnitY(Target)
 set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),200,Condition(function GenericCondition_EnemyUnitsEx))
-set Target=FirstOfGroup(g)
-call KillGroup(g)
-call UnstableConcoction_Hit(Target,x,y)
-set g=null
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),175+25,Condition(function GenericCondition_EnemyUnitsEx))
+if GetUnitTypeId(Target)!=unitid_unstableconcoction then
+call GroupAddUnit(g,Target)
 endif
-if Target!=null then
+call ForGroup(g,function UnstableConcoction_Hit)
+call KillGroup(g)
 call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",GetUnitX(Target),GetUnitY(Target)))
-endif
 endfunction
 function UnstableConcoction_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
@@ -44645,11 +45572,11 @@
 call SetTextTagColor(tt,255,0,0,255)
 call SetTextTagVelocity(tt,0,0.0355)
 call SetTextTagFadepoint(tt,0.15)
 call SetTextTagPermanent(tt,false)
 call SetTextTagLifespan(tt,0.65)
-if IsUnitVisible(Hero,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
+if IsUnitAlly(Hero,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
 call SetTextTagVisibility(tt,true)
 else
 call SetTextTagVisibility(tt,false)
 endif
 set tt=null
@@ -44688,10 +45615,11 @@
 local real Time=(TimerGetElapsed(udg_GameTimer))
 local real Remaining=unstableconcoction_maxcharge-(Time-OriginalTime)
 local real Total=RMin(Time-OriginalTime,unstableconcoction_maxcharge)
 local integer Count=(LoadInteger(hash_main,(Cache),(34)))+1
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
+call UnstableConcoction_Explode(Source,Source,unstableconcoction_maxcharge)
 if(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==0 or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==abilityid_unstableconcoction then
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_unstableconcoction,true)
 endif
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_unstableconcoction_helper,false)
 call SetUnitVertexColor(Source,255,255,255,255)
@@ -44794,17 +45722,17 @@
 local unit UnitVar=GetKillingUnit()
 local unit DeadUnit=GetTriggerUnit()
 local integer Cache=GetHandleId(UnitVar)
 local integer PreviousKills=(LoadInteger(hash_main,(Cache),(27)))
 local integer Level=GetUnitAbilityLevel(UnitVar,1093685043)
-local integer ExtraBonusGold=PreviousKills*2
-local integer TotalBonusGold=IMin(ExtraBonusGold+Level*2,26)
+local integer ExtraBonusGold=PreviousKills*Level
+local integer TotalBonusGold=IMin(ExtraBonusGold+Level*2+2,30)
 local texttag tt=CreateTextTag()
 local player p=GetOwningPlayer(UnitVar)
 local trigger t=CreateTrigger()
 set GG_Bonus[GetPlayerId(p)]=GG_Bonus[GetPlayerId(p)]+TotalBonusGold
-call TriggerRegisterTimerEvent(t,20,false)
+call TriggerRegisterTimerEvent(t,25,false)
 call TriggerAddCondition(t,Condition(function GoblinsGreed_Decrement))
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(26),(UnitVar))
 call SaveInteger(hash_main,(Cache),(27),(PreviousKills+1))
 call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,TotalBonusGold+GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
 call SetTextTagText(tt,"+"+I2S(TotalBonusGold),0.025)
@@ -44887,11 +45815,11 @@
 call PauseTimer(t)
 call FlushChildHashtable(hash_main,(Cache))
 call DestroyTimer(t)
 else
 set udg_TempUnit=Hero
-set udg_TempReal=GetUnitAbilityLevel(Hero,(1093683532))*8
+set udg_TempReal=8+GetUnitAbilityLevel(Hero,(1093683532))*6
 set CondVar=Condition(function AcidSpray_WhichUnits)
 set GroupVar=GetAvailableGroup()
 call GroupEnumUnitsInRange(GroupVar,x,y,650,CondVar)
 call ForGroup(GroupVar,function AcidSpray_DealDamage)
 call KillGroup(GroupVar)
@@ -46078,15 +47006,15 @@
 local integer WarpathLevel=(LoadInteger(hash_main,(Cache),(315)))-1
 local integer EffectiveWarpathLevel=IBound(WarpathLevel,0,5)
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(316)))
 local integer DamageBonus
 if Level==1 then
-set DamageBonus=10+EffectiveWarpathLevel*10-10
+set DamageBonus=EffectiveWarpathLevel*20
 elseif Level==2 then
-set DamageBonus=20+EffectiveWarpathLevel*15-15
+set DamageBonus=EffectiveWarpathLevel*25
 elseif Level==3 then
-set DamageBonus=30+EffectiveWarpathLevel*20-20
+set DamageBonus=EffectiveWarpathLevel*30
 endif
 if WarpathLevel==0 then
 set DamageBonus=0
 endif
 call AddDamageBonus(Hero,DamageBonus)
@@ -46112,15 +47040,15 @@
 local integer EffectiveWarpathLevel=IBound(WarpathLevel,0,5)
 local integer CasterLevel=Warpath_GetCasterLevel(Level,EffectiveWarpathLevel)
 local trigger t=CreateTrigger()
 local integer DamageBonus
 if Level==1 then
-set DamageBonus=10+EffectiveWarpathLevel*10-10
+set DamageBonus=EffectiveWarpathLevel*20
 elseif Level==2 then
-set DamageBonus=20+EffectiveWarpathLevel*15-15
+set DamageBonus=EffectiveWarpathLevel*25
 elseif Level==3 then
-set DamageBonus=30+EffectiveWarpathLevel*20-20
+set DamageBonus=EffectiveWarpathLevel*30
 endif
 call AddDamageBonus(Hero,DamageBonus)
 call SetUnitAbilityLevel(Caster,(1093682502),CasterLevel)
 call SaveInteger(hash_main,(Cache),(315),(WarpathLevel))
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(14),(Hero))
@@ -46159,11 +47087,11 @@
 return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and GetUnitAbilityLevel(GetFilterUnit(),1093678162)!=1
 endfunction
 function QuillSpray_Damage takes nothing returns nothing
 local integer TargetCache=GetHandleId(GetEnumUnit())
 local integer NumberOfQuills=(LoadInteger(hash_main,(quillcache),(TargetCache)))
-local real Damage=RMin(udg_TempReal+NumberOfQuills*30,220)
+local real Damage=RMin(udg_TempReal+NumberOfQuills*30,400)
 call UnitDamageTarget(udg_TempUnit,GetEnumUnit(),Damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
 call SaveInteger(hash_main,(quillcache),(TargetCache),(NumberOfQuills+1))
 endfunction
 function QuillSpray_RemoveCounter takes nothing returns nothing
 local integer TargetCache=GetHandleId(GetEnumUnit())
@@ -46282,11 +47210,11 @@
 set Caster=null
 endfunction
 function Bristleback_DamageStack takes unit Hero,real Damage returns nothing
 local integer Cache=GetHandleId(Hero)
 local real Stack=(LoadReal(hash_main,(Cache),(278)))
-if Stack>250 then
+if Stack+Damage>250 then
 call SaveReal(hash_main,(Cache),(278),((0)*1.0))
 call Bristleback_CastQuillSpray(Hero)
 else
 call SaveReal(hash_main,(Cache),(278),((Stack+Damage)*1.0))
 endif
@@ -46355,17 +47283,25 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
 call TriggerAddCondition(t,Condition(function Return_Conditions))
 call TriggerAddAction(t,function Return_Actions)
 endfunction
+function DoubleEdge_Hit takes nothing returns nothing
+call DamageTarget(doubleedge_source,GetEnumUnit(),DAMAGE_MAGICAL,doubleedge_damage)
+endfunction
 function DoubleEdge takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_doubleedge)
 local real selfDamage
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,100+Level*75)
-set selfDamage=100+Level*75
+local group g=GetAvailableGroup()
+set doubleedge_damage=100+Level*75
+set doubleedge_source=Source
+set tt_unit1=Source
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),190+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call ForGroup(g,function DoubleEdge_Hit)
+set selfDamage=doubleedge_damage
 if GetUnitState(Source,UNIT_STATE_LIFE)<=selfDamage*0.75 then
 set selfDamage=GetUnitState(Source,UNIT_STATE_LIFE)/0.75-10
 endif
 call DamageTarget(Source,Source,DAMAGE_MAGICAL,selfDamage)
 call DestroyEffect(AddSpecialEffect(doubleedge_fx_impact,GetUnitX(Target),GetUnitY(Target)))
@@ -46387,12 +47323,97 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
 call TriggerAddCondition(t,Condition(function DoubleEdge_Main))
 set t=null
 endfunction
+function Stampede_Hit takes nothing returns nothing
+local integer Factor
+if IsMagicImmune(GetEnumUnit())==false and((LoadInteger(hash_main,(GetHandleId((GetEnumUnit()))),((4332))))==HERO_STATE_ON)==false then
+call AddHeroState(GetEnumUnit(),4332,stampede_duration)
+set Factor=stampede_level
+call DamageTarget(stampede_daamgesource,GetEnumUnit(),DAMAGE_MAGICAL,(Factor)*GetHeroStr(stampede_source,true))
+call Stun(stampede_daamgesource,GetEnumUnit(),1.25)
+endif
+endfunction
+function Stampede_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local group g
+if GetTriggerEvalCount(t)>=R2I(20*stampede_duration)or GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(175))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(176))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call SetUnitPathing(Source,true)
+call UnitRemoveAbility(Source,stampede_haste)
+call UnitRemoveAbility(Source,stampede_haste_buffid)
+else
+set g=GetAvailableGroup()
+set tt_unit1=Source
+set stampede_source=Caster
+set stampede_daamgesource=Source
+set stampede_level=Level
+call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),105+25,Condition(function GenericCondition_EnemyUnitsEx))
+call ForGroup(g,function Stampede_Hit)
+call KillGroup(g)
+endif
+set t=null
+set Source=null
+set g=null
+return false
+endfunction
+function Stampede_Empower takes nothing returns nothing
+local unit Source=GetEnumUnit()
+local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),abilityid_stampede)
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call SetUnitPathing(Source,false)
+call UnitAddAbility2(Source,stampede_haste)
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerRegisterDeathEvent(t,Source)
+call TriggerAddCondition(t,Condition(function Stampede_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(19),(GetTriggerUnit()))
+call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveEffectHandle(hash_main,(Cache),(175),(AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",Source,"foot, left")))
+call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",Source,"foot, right")))
+set Source=null
+set t=null
+endfunction
+function Stampede takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local group g=GetAvailableGroup()
+local sound SoundVar=CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
+call StartSound(SoundVar)
+call KillSoundWhenDone(SoundVar)
+call GroupEnumUnitsInRange(g,0,0,99999,Condition(function GenericCondition_AlliedPlayerUnits))
+call ForGroup(g,function Stampede_Empower)
+call KillGroup(g)
+set Source=null
+set g=null
+set SoundVar=null
+endfunction
+function Stampede_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_stampede then
+call Stampede()
+endif
+return false
+endfunction
+function Register_Stampede takes nothing returns nothing
+local trigger t=CreateTrigger()
+call PreloadAbility(stampede_haste)
+call PreloadAbility(abilityid_genericstun)
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Stampede_Main))
+call CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
+set t=null
+endfunction
 function Trig_Preservation_Conditions takes nothing returns boolean
-return GetSpellAbilityId()==1093684310
+return GetSpellAbilityId()==1093684310 or GetSpellAbilityId()==abilityid_testoffath_allied
 endfunction
 function Perservation_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Chen=(LoadUnitHandle(hash_main,(Cache),(2)))
@@ -46462,24 +47483,34 @@
 endif
 endif
 call RemoveLocation(PointVar)
 call RemoveLocation(TargetLoc)
 endfunction
+function TestOfFaith_Learned takes nothing returns boolean
+if GetLearnedSkill()==1093684310 and IsUnitIllusion(GetTriggerUnit())==false then
+call UnitAddAbility2(GetTriggerUnit(),abilityid_testoffath_allied)
+call SetUnitAbilityLevel(GetTriggerUnit(),abilityid_testoffath_allied,GetUnitAbilityLevel(GetTriggerUnit(),1093684310))
+endif
+return false
+endfunction
 function TestOfFaith takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Trig_Preservation_Conditions))
 call TriggerAddAction(t,function Trig_Preservation_Actions)
+set t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function TestOfFaith_Learned))
 endfunction
 function Penitence_Damage takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local real ExtraDamage
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
 if GetEventDamage()>10 then
-set ExtraDamage=GetEventDamage()*0.07*Level
+set ExtraDamage=GetEventDamage()*0.08*Level
 call DisableTrigger(t)
 call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),DAMAGE_PHYSICAL,ExtraDamage)
 call EnableTrigger(t)
 endif
 else
@@ -46875,11 +47906,11 @@
 local real x=GetUnitX(Target)
 local real y=GetUnitY(Target)
 local real Rate=12
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
-local integer ShockDamage=30+30*Level
+local integer ShockDamage=40+40*Level
 if GetTriggerEvalCount(t)>21 then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call SaveInteger(hash_main,(GetHandleId((Target))),((4260)),(HERO_STATE_OFF))
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,I2R(ShockDamage))
@@ -46901,12 +47932,18 @@
 local unit Target=GetEnumUnit()
 local real x=tt_real1
 local real y=tt_real2
 local real d=tt_real3
 local real Angle=PowerCog_GetAngle(Target,x,y,d)
+local real buffer=200
+local real diff=d-DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),x,y)+buffer/2
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",Target,"chest"))
 call SaveInteger(hash_main,(GetHandleId((Target))),((4260)),(HERO_STATE_ON))
+if diff>0 then
+call SetUnitX(Target,GetUnitX(Target)+diff*Cos(Angle*bj_DEGTORAD))
+call SetUnitY(Target,GetUnitY(Target)+diff*Sin(Angle*bj_DEGTORAD))
+endif
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveReal(hash_main,(Cache),(13),((Angle)*1.0))
 call SaveInteger(hash_main,(Cache),(5),(tt_int1))
 call SaveUnitHandle(hash_main,(Cache),(2),(tt_unit1))
 call TriggerRegisterTimerEvent(t,0.04,true)
@@ -47037,11 +48074,11 @@
 function PowerCog_Iterate takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local real Duration=(LoadReal(hash_main,(Cache),(57)))
 local integer Count=GetTriggerEvalCount(t)
-if Count>R2I(Duration*10)then
+if Count>R2I(Duration*100)then
 call PowerCog_EndCogs(Cache,(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7))),(LoadBoolean(hash_main,(Cache),(155))),(LoadPlayerHandle(hash_main,(Cache),(154))))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 call PowerCog_Shock(t,(LoadUnitHandle(hash_main,(Cache),(14))),(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7))),(LoadReal(hash_main,(Cache),(138))),(LoadInteger(hash_main,(Cache),(5))))
@@ -47063,11 +48100,11 @@
 local real y1=GetUnitY(Hero)
 local real x2
 local real y2
 local real d=125
 local unit Cog
-local real Duration=2+Level
+local real Duration=4+Level
 local real BufferDuration=5
 local group g
 local rect rec
 local player enemy
 if IsSent(GetOwningPlayer(Hero))then
@@ -47118,11 +48155,11 @@
 set x2=x1+d
 set y2=y1-d
 set Cog=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
 call SetUnitPosition(Cog,x2,y2)
 call PowerCog_RegisterCog(Cog,Cache,8,enemy)
-call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerRegisterTimerEvent(t,0.01,true)
 call TriggerAddCondition(t,Condition(function PowerCog_Iterate))
 call SaveReal(hash_main,(Cache),(57),((Duration)*1.0))
 call SaveReal(hash_main,(Cache),(6),((x1)*1.0))
 call SaveReal(hash_main,(Cache),(7),((y1)*1.0))
 call SaveReal(hash_main,(Cache),(138),((d)*1.0))
@@ -47300,11 +48337,11 @@
 local location l=GetSpellTargetLoc()
 local real Angle=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetLocationX(l),GetLocationY(l))
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_hookshot)
 local integer MaxRange
 local integer MaxCount
-local boolean Scepter=false
+local boolean Scepter=true
 local trigger RetractTrigger=CreateTrigger()
 if Level==0 then
 set Level=GetUnitAbilityLevel(Hero,abilityid_hookshotupgrade)
 set Scepter=true
 endif
@@ -47359,11 +48396,11 @@
 function BatteryAssault_Iterate takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local integer Count=GetTriggerEvalCount(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
-if Count>14 or GetTriggerEventId()==EVENT_UNIT_DEATH then
+if Count>15 or GetTriggerEventId()==EVENT_UNIT_DEATH then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 call BatteryAssault_Attack(Hero)
 endif
@@ -47373,11 +48410,11 @@
 endfunction
 function BatteryAssault takes nothing returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=GetTriggerUnit()
-call TriggerRegisterTimerEvent(t,.75,true)
+call TriggerRegisterTimerEvent(t,.7,true)
 call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function BatteryAssault_Iterate))
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
 call TriggerEvaluate(t)
 set t=null
@@ -47496,11 +48533,11 @@
 function CrystalNova takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local location l=GetSpellTargetLoc()
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656899,x,y,0)
+local unit Caster=CreateUnit(GetOwningPlayer(Source),1697657656,x,y,0)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_crystalnova)
 call UnitAddAbility2(Caster,crystalnova_nuke)
 call SetUnitAbilityLevel(Caster,crystalnova_nuke,Level)
 call IssueTargetOrder(Caster,"frostnova",Caster)
 call RemoveLocation(l)
@@ -47520,10 +48557,44 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function CrystalNova_Main))
 set t=null
 endfunction
+function BrillianceAura_Think takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_brillianceaura)
+if IsDead(Source)then
+call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+0.5*Level*0.25)
+endif
+set Source=null
+set t=null
+return false
+endfunction
+function BrillianceAura takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=GetTriggerUnit()
+call TriggerRegisterTimerEvent(t,0.25,true)
+call TriggerAddCondition(t,Condition(function BrillianceAura_Think))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set t=null
+set Source=null
+endfunction
+function BrillianceAura_Main takes nothing returns boolean
+if GetLearnedSkill()==abilityid_brillianceaura and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_brillianceaura)==1 then
+call BrillianceAura()
+endif
+return false
+endfunction
+function Register_BrillianceAura takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function BrillianceAura_Main))
+set t=null
+endfunction
 function EmberDies_TakeTwo takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 call SetUnitAnimationByIndex(Source,8)
@@ -48615,11 +49686,11 @@
 return true
 endfunction
 function Trig_Midnight_Pulse_Actions takes nothing returns nothing
 local location tempa=GetUnitLoc(GetTriggerUnit())
 local location tempb=GetSpellTargetLoc()
-call CreateNUnitsAtLocFacingLocBJ(1,1697656901,GetOwningPlayer(GetTriggerUnit()),tempa,tempb)
+call CreateNUnitsAtLocFacingLocBJ(1,1697656901,GetOwningPlayer(GetTriggerUnit()),tempb,tempb)
 call ShowUnitHide(GetLastCreatedUnit())
 call UnitApplyTimedLifeBJ(8.00,1112820806,GetLastCreatedUnit())
 call UnitAddAbilityBJ(1093681714,GetLastCreatedUnit())
 call SetUnitAbilityLevelSwapped(1093681714,GetLastCreatedUnit(),GetUnitAbilityLevelSwapped(1093681713,GetTriggerUnit()))
 call IssuePointOrderLocBJ(GetLastCreatedUnit(),"deathanddecay",tempb)
@@ -48633,17 +49704,17 @@
 call TriggerAddAction(t,function Trig_Midnight_Pulse_Actions)
 endfunction
 function Malefice_Stun takes unit Source,unit Target,integer Level returns nothing
 local real Damage
 if Level==1 then
-set Damage=30
+set Damage=40
 elseif Level==2 then
 set Damage=40
 elseif Level==3 then
 set Damage=65
 else
-set Damage=80
+set Damage=65
 endif
 call Stun(Target,Target,1)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,Damage)
 endfunction
 function Malefice_Iterate takes nothing returns boolean
@@ -48788,12 +49859,16 @@
 if(y>limit)then
 return limit
 endif
 return y
 endfunction
+function Enigma_IsPrimalSplit takes unit u returns boolean
+local integer id=GetUnitTypeId(u)
+return id==1852862003 or id==1852862006 or id==1848652080 or id==1848657754 or id==1852862001 or id==1852862004 or id==1848652081 or id==1848657968 or id==1852862002 or id==1852862005 or id==1848652082 or id==1848657969
+endfunction
 function BlackHole_SuckGroupCondition takes nothing returns boolean
-return GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())==1848651861 or GetUnitTypeId(GetFilterUnit())==1848651865 or GetUnitTypeId(GetFilterUnit())==1848651866 or GetUnitTypeId(GetFilterUnit())==1848658773 or GetUnitTypeId(GetFilterUnit())==1848658774 or GetUnitTypeId(GetFilterUnit())==1848658775 or Gargolye_IsFamiliar(GetUnitTypeId(GetFilterUnit())))and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(318)))))==true
+return GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or Enigma_IsPrimalSplit(GetFilterUnit())or GenericCondition_IsBear(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())==1848651861 or GetUnitTypeId(GetFilterUnit())==1848651865 or GetUnitTypeId(GetFilterUnit())==1848651866 or GetUnitTypeId(GetFilterUnit())==1848658773 or GetUnitTypeId(GetFilterUnit())==1848658774 or GetUnitTypeId(GetFilterUnit())==1848658775 or Gargolye_IsFamiliar(GetUnitTypeId(GetFilterUnit())))and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(318)))))==true
 endfunction
 function BlackHole_SuckAction takes nothing returns nothing
 local location Point1=GetUnitLoc(GetEnumUnit())
 local location Point2=GetUnitLoc((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(318))))
 local location FinalPoint=PolarProjectionBJ(Point2,DistanceBetweenPoints(Point2,Point1)-2,AngleBetweenPoints(Point2,Point1))
@@ -48922,11 +49997,11 @@
 local unit Caster=CreateUnit(GetOwningPlayer(Hero),1697656901,x,y,0)
 call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\StaffOfPurification\\PurificationCaster.mdx",x,y))
 call UnitAddAbility2(Caster,abilityid_wanningrifthelper)
 call SetUnitAbilityLevel(Caster,abilityid_wanningrifthelper,Level)
 call IssuePointOrder(Caster,"silence",x,y)
-set tt_real1=Level*60
+set tt_real1=Level*70
 call GroupEnumUnitsInRange(g,x,y,425,Condition(function GenericCondition_EnemyUnitsWithAncients))
 call ForGroup(g,function WanningRift_Damage)
 call KillGroup(g)
 set Caster=null
 set g=null
@@ -48971,11 +50046,11 @@
 call DestroyLightning(Light)
 call TI_ClearUnit(TargetIndex)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
-call MoveLightning(Light,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
+call MoveLightning(Light,false,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
 if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))>600 then
 call DestroyLightning(Light)
 call TI_ClearUnit(TargetIndex)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
@@ -48989,11 +50064,11 @@
 return false
 endfunction
 function PrismaticPrison_BindUnits takes nothing returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-local lightning Light=AddLightning("HWPB",true,GetUnitX(dreamcoil_source),GetUnitY(dreamcoil_source),GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
+local lightning Light=AddLightning("HWPB",false,GetUnitX(dreamcoil_source),GetUnitY(dreamcoil_source),GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
 call SetLightningColor(Light,0,.7,1,1)
 call SaveLightningHandle(hash_main,(Cache),(196),(Light))
 call SaveUnitHandle(hash_main,(Cache),(2),(dreamcoil_source))
 call SaveInteger(hash_main,(Cache),(30),(TI_AddUnit(GetEnumUnit())))
 call SaveInteger(hash_main,(Cache),(5),(dreamcoil_level))
@@ -49013,26 +50088,27 @@
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
 local unit Caster=CreateUnit(GetOwningPlayer(Hero),unitid_prismaticprison,x,y,0)
 local group g=GetAvailableGroup()
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_prismaticprison)
-local real Duration=5
+local real Duration=6
 local integer Type=1
 if Level==0 then
 set Level=GetUnitAbilityLevel(Hero,abilityid_prismaticprison_upgrade)
-set Duration=7
+set Duration=8
 set Type=2
 endif
 call RemoveLocation(l)
 call SetUnitAnimation(Caster,"channel")
 call RemoveUnitTimedAndKill(Caster,Duration)
 set dreamcoil_source=Caster
 set dreamcoil_duration=Duration
 set dreamcoil_damage=Level*50+50
 set dreamcoil_level=Level
 set dreamcoil_type=Type
-call GroupEnumUnitsInRange(g,x,y,400,Condition(function GenericCondition_EnemyHeroesVisible))
+set tt_unit1=Hero
+call GroupEnumUnitsInRange(g,x,y,400,Condition(function GenericCondition_EnemyUnitsExHeroesNoDotaInvis2))
 call ForGroup(g,function PrismaticPrison_BindUnits)
 call KillGroup(g)
 set g=null
 set Caster=null
 set Hero=null
@@ -49054,20 +50130,25 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
 local integer Level
 local integer Counter
+local integer MaxCount
 if(GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER and GetIssuedOrderId()!=String2OrderIdBJ("phaseshift"))or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_UNIT_DEATH then
 call SetUnitInvulnerable(Hero,false)
 call UnitRemoveAbility(Hero,1093678162)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 set Level=(LoadInteger(hash_main,(Cache),(5)))
 set Counter=(LoadInteger(hash_main,(Cache),(28)))+1
 call SaveInteger(hash_main,(Cache),(28),(Counter))
-if Counter>3*Level or DistanceBetweenXY(GetUnitX(Hero),GetUnitY(Hero),(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7))))>125 then
+set MaxCount=3*Level
+if Level==4 then
+set MaxCount=MaxCount+1
+endif
+if Counter>MaxCount or DistanceBetweenXY(GetUnitX(Hero),GetUnitY(Hero),(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7))))>125 then
 call SetUnitInvulnerable(Hero,false)
 call UnitRemoveAbility(Hero,1093678162)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
@@ -49172,11 +50253,11 @@
 set y=GetUnitY(Caster)
 set TempGroup=GetAvailableGroup()
 set tt_group1=g
 set tt_unit1=Caster
 set tt_real1=Level*70
-call GroupEnumUnitsInRange(TempGroup,x,y,225,Condition(function GenericCondition_EnemyUnitsWithAncientsEx))
+call GroupEnumUnitsInRange(TempGroup,x,y,225+25,Condition(function GenericCondition_EnemyUnitsWithAncientsEx))
 call ForGroup(TempGroup,function IllusoryOrb_Damage)
 call KillGroup(TempGroup)
 call SetUnitX(Caster,SafeX(x+15*Cos(Angle*bj_DEGTORAD)))
 call SetUnitY(Caster,SafeY(y+15*Sin(Angle*bj_DEGTORAD)))
 endif
@@ -49607,11 +50688,11 @@
 local integer key
 local integer NumOfSpears
 local integer TargetIndex=(LoadInteger(hash_main,(Cache),(30)))
 local unit Target=TI_GetUnit(TargetIndex)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
-if GetTriggerEvalCount(t)>6 or IsDead(Target)then
+if GetTriggerEvalCount(t)>7 or IsDead(Target)then
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(31))))
 call FlushChildHashtable(hash_main,(Cache))
 set Cache2=GetHandleId(Source)
 set key=6000+GetHandleId(Target)
 set NumOfSpears=(LoadInteger(hash_main,(Cache2),(key)))
@@ -49904,12 +50985,12 @@
 local group g=GetAvailableGroup()
 local group g2=GetAvailableGroup()
 set liquidfire_level=Level
 set liquidfire_source=Source
 set tt_unit1=Source
-call GroupEnumUnitsInRange(g,x,y,200,Condition(function GenericCondition_EnemyUnitsAndStructureEx))
-call GroupEnumUnitsInRange(g2,x,y,200,Condition(function GenericCondition_EnemySiegeEx))
+call GroupEnumUnitsInRange(g,x,y,300+25,Condition(function GenericCondition_EnemyUnitsAndStructureEx))
+call GroupEnumUnitsInRange(g2,x,y,300+25,Condition(function GenericCondition_EnemySiegeEx))
 call GroupAddGroup(g2,g)
 call ForGroup(g,function LiquidFire_Register)
 call KillGroup(g)
 call KillGroup(g2)
 set t=null
@@ -50018,97 +51099,136 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
 call TriggerAddCondition(t,Condition(function LiquidFire_Main))
 set t=null
 endfunction
-function IP_RawAbil takes nothing returns integer
-return 1093685046
-endfunction
-function IP_RawStunAbil takes nothing returns integer
-return 1093685062
-endfunction
-function IceDeath_Check takes nothing returns boolean
-return((IsUnitType(GetFilterUnit(),UNIT_TYPE_MAGIC_IMMUNE)==false)and(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetDyingUnit())))and(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false)and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0))
-endfunction
-function Ice_Path_IceDeath_Cond takes nothing returns boolean
-return GetUnitTypeId(GetDyingUnit())==1697657173
+function IcePath_Hit takes nothing returns nothing
+local unit Source=icepath_source
+local unit Target=GetEnumUnit()
+local unit Dummy
+if IsUnitInGroup(Target,icepath_alreadyhit)==false then
+call GroupAddUnit(icepath_alreadyhit,Target)
+call Stun(Source,Target,icepath_stunduration)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,100)
+call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(Target),GetUnitY(Target)))
+endif
 endfunction
-function Ice_Path_IceDeath_Act takes nothing returns nothing
-local unit u=GetDyingUnit()
-local integer level=GetUnitUserData(u)
+function IcePath_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local real x0=(LoadReal(hash_main,(Cache),(6)))
+local real y0=(LoadReal(hash_main,(Cache),(7)))
+local real a=(LoadReal(hash_main,(Cache),(137)))
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Count=GetTriggerEvalCount(t)
+local real x
+local real y
 local group g
-local unit Dummy
-local unit enum
-set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),175,Condition(function IceDeath_Check))
+local integer i
+local group AlreadyHit=(LoadGroupHandle(hash_main,(Cache),(187)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_icepath)
+set i=0
 loop
-set enum=FirstOfGroup(g)
-exitwhen(enum==null)
-call GroupRemoveUnit(g,enum)
-set Dummy=CreateUnit(GetOwningPlayer(u),1697656901,GetUnitX(enum),GetUnitY(enum),0)
-call UnitAddAbility2(Dummy,(1093685062))
-call SetUnitAbilityLevel(Dummy,(1093685062),level)
-call IssueTargetOrder(Dummy,"thunderbolt",enum)
-call UnitApplyTimedLife(Dummy,1112820806,1)
-call UnitAddAbility2(Dummy,1097625443)
-endloop
+exitwhen i>10
+set x=x0+100*i*Cos(a*bj_DEGTORAD)
+set y=y0+100*i*Sin(a*bj_DEGTORAD)
+if ModuloInteger(Count,10)==0 then
+endif
+set tt_unit1=Source
+set icepath_source=Source
+set icepath_alreadyhit=AlreadyHit
+set icepath_stunduration=(0.6+0.4*Level)-(Count*0.05)
+set g=GetAvailableGroup()
+call GroupEnumUnitsInRange(g,x,y,150+25,Condition(function GenericCondition_EnemyUnitsEx))
+call ForGroup(g,function IcePath_Hit)
 call KillGroup(g)
-call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(u),GetUnitY(u)))
+set i=i+1
+endloop
+if Count==20*(0.6+0.4*Level)then
+call KillGroup(AlreadyHit)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+set t=null
+set Source=null
+set g=null
+set AlreadyHit=null
+return false
 endfunction
-function Trig_Ice_Path_Create takes nothing returns nothing
-local timer t=GetExpiredTimer()
+function IcePath_AnimateStart takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
-local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
-local integer Level=GetUnitAbilityLevel(Hero,(1093685046))
-local real x=(LoadReal(hash_main,(Cache),(321)))
-local real y=(LoadReal(hash_main,(Cache),(322)))
-local real Angle=(LoadReal(hash_main,(Cache),(323)))
-local unit Dummy
-local integer Counter=(LoadInteger(hash_main,(Cache),(324)))
-set x=x+100*Cos(Angle*bj_DEGTORAD)
-set y=y+100*Sin(Angle*bj_DEGTORAD)
-call SaveReal(hash_main,(Cache),(321),((x)*1.0))
-call SaveReal(hash_main,(Cache),(322),((y)*1.0))
-set Dummy=CreateUnit(GetOwningPlayer(Hero),1697657173,x,y,GetRandomReal(0,359))
-call UnitApplyTimedLife(Dummy,1112820806,0.5)
-call SetUnitUserData(Dummy,Level)
-call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",x,y))
-set Counter=Counter+1
-call SaveInteger(hash_main,(Cache),(324),(Counter))
-if Counter>=10 then
-call PauseTimer(t)
+local real x0=(LoadReal(hash_main,(Cache),(6)))
+local real y0=(LoadReal(hash_main,(Cache),(7)))
+local real a=(LoadReal(hash_main,(Cache),(137)))
+local integer Count=GetTriggerEvalCount(t)
+local real x=x0+100*Count*Cos(a*bj_DEGTORAD)
+local real y=y0+100*Count*Sin(a*bj_DEGTORAD)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_icepath)
+local ubersplat Splat
+local integer i
+if Count<10 then
+call SaveEffectHandle(hash_main,(Cache),(609+Count),(AddSpecialEffect("effects\\IcePath.mdx",x,y)))
+set Splat=CreateUbersplat(x,y,"IPTH",255,255,255,255,false,false)
+call SetUbersplatRenderAlways(Splat,true)
+call SaveUbersplatHandle(hash_main,(Cache),(760+Count),(Splat))
+endif
+if Count==10 then
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerAddCondition(t,Condition(function IcePath_Loop))
+call SaveReal(hash_main,(Cache),(6),((x0)*1.0))
+call SaveReal(hash_main,(Cache),(7),((y0)*1.0))
+call SaveReal(hash_main,(Cache),(137),((a)*1.0))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveGroupHandle(hash_main,(Cache),(187),(GetAvailableGroup()))
+call TriggerEvaluate(t)
+elseif Count>=(0.4+0.6+0.4*Level)/.05 then
+set i=0
+loop
+exitwhen i==10
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(609+i))))
+call DestroyUbersplat((LoadUbersplatHandle(hash_main,(Cache),(760+i))))
+set i=i+1
+endloop
 call FlushChildHashtable(hash_main,(Cache))
-call DestroyTimer(t)
+call CleanTrigger(t)
 endif
+set t=null
+set Source=null
+return false
 endfunction
-function Trig_Ice_Path_Conditions takes nothing returns boolean
-return GetSpellAbilityId()==(1093685046)
-endfunction
-function Trig_Ice_Path_Actions takes nothing returns nothing
-local timer t=CreateTimer()
-local unit Hero=GetTriggerUnit()
-local location TargetLoc=GetSpellTargetLoc()
-local location HeroLoc=GetUnitLoc(Hero)
+function IcePath takes nothing returns nothing
+local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
-call SaveReal(hash_main,(Cache),(321),((GetUnitX(Hero))*1.0))
-call SaveReal(hash_main,(Cache),(322),((GetUnitY(Hero))*1.0))
-call SaveReal(hash_main,(Cache),(323),((AngleBetweenPoints(HeroLoc,TargetLoc))*1.0))
-call SaveInteger(hash_main,(Cache),(324),(0))
-call RemoveLocation(HeroLoc)
-call RemoveLocation(TargetLoc)
-call TimerStart(t,0.05,true,function Trig_Ice_Path_Create)
+local unit Source=GetTriggerUnit()
+local real x=GetUnitX(Source)
+local real y=GetUnitY(Source)
+local real a=AngleBetweenXY(x,y,GetSpellTargetX(),GetSpellTargetY())
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerAddCondition(t,Condition(function IcePath_AnimateStart))
+call SaveReal(hash_main,(Cache),(6),((x)*1.0))
+call SaveReal(hash_main,(Cache),(7),((y)*1.0))
+call SaveReal(hash_main,(Cache),(137),((a)*1.0))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call TriggerEvaluate(t)
+set t=null
+set Source=null
+endfunction
+function IcePath_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_icepath then
+call IcePath()
+endif
+return false
 endfunction
-function RegisterIce_Path takes nothing returns nothing
-local trigger Ice_Path_IceDeath=CreateTrigger()
+function Register_IcePath takes nothing returns nothing
 local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(Ice_Path_IceDeath,EVENT_PLAYER_UNIT_DEATH)
-call TriggerAddCondition(Ice_Path_IceDeath,Condition(function Ice_Path_IceDeath_Cond))
-call TriggerAddAction(Ice_Path_IceDeath,function Ice_Path_IceDeath_Act)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
-call TriggerAddCondition(t,Condition(function Trig_Ice_Path_Conditions))
-call TriggerAddAction(t,function Trig_Ice_Path_Actions)
+call TriggerAddCondition(t,Condition(function IcePath_Main))
+set t=null
 endfunction
 function DualBreath_IsPointInTriangle takes real x1,real y1,real x2,real y2,real x3,real y3,real x,real y returns boolean
 local real calc1=(y-y1)*(x2-x1)-(x-x1)*(y2-y1)
 local real calc2=(y-y3)*(x1-x3)-(x-x3)*(y1-y3)
 local real calc3=(y-y2)*(x3-x2)-(x-x2)*(y3-y2)
@@ -50240,10 +51360,13 @@
 local real dmg=GetRandomReal(175,250)
 call SetUnitPosition(Hero,x,y)
 call SetUnitFacing(Hero,bj_RADTODEG*Atan2(GetUnitY(Target)-GetUnitY(Hero),GetUnitX(Target)-GetUnitX(Hero)))
 call SetUnitAnimation(Hero,"Attack")
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",Hero,"chest"))
+if IsRealPlayer(GetOwningPlayer(Target))==false and IsUnitType(Target,UNIT_TYPE_ANCIENT)==false then
+set dmg=99999
+endif
 call DamageTarget(Hero,Target,DAMAGE_PHYSICAL,dmg)
 call IssueTargetOrder(Hero,"attack",Target)
 endfunction
 function Omnislash_FirstTime takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
@@ -51148,11 +52271,15 @@
 call TriggerAddCondition(t,Condition(function LagunaBlade_Main))
 set t=null
 endfunction
 function LunaLearn_Main takes nothing returns boolean
 if GetLearnedSkill()==1093678129 then
+if GetUnitAbilityLevel(GetTriggerUnit(),1093678129)==4 then
+call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),1382378855,5)
+else
 call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),1382378855,GetUnitAbilityLevel(GetTriggerUnit(),1093678129))
+endif
 elseif GetLearnedSkill()==1093678642 then
 call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),1378889801,1)
 endif
 return false
 endfunction
@@ -51262,11 +52389,11 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
 local integer TargetIndex=(LoadInteger(hash_main,(Cache),(30)))
 local unit Target=TI_GetUnit(TargetIndex)
-call DamageTarget(Hero,Target,DAMAGE_MAGICAL,GetUnitAbilityLevel(Hero,abilityid_starfall)*37.5)
+call DamageTarget(Hero,Target,DAMAGE_MAGICAL,0.75*GetUnitAbilityLevel(Hero,abilityid_starfall)*75)
 call TI_ClearUnit(TargetIndex)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 set t=null
 set Hero=null
@@ -51738,11 +52865,10 @@
 call UnitDamageTarget(udg_TempUnit,GetEnumUnit(),udg_TempReal,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
 endfunction
 function Waveform_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
-local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 local unit UnitVar=(LoadUnitHandle(hash_main,(Cache),(221)))
 local real Angle=(LoadReal(hash_main,(Cache),(13)))
 local integer Remaining=(LoadInteger(hash_main,(Cache),(194)))
 local group AlreadyDamaged=(LoadGroupHandle(hash_main,(Cache),(133)))
 local real CurrentX=GetUnitX(UnitVar)
@@ -51750,37 +52876,39 @@
 local real LastX=(LoadReal(hash_main,(Cache),(23)))
 local real LastY=(LoadReal(hash_main,(Cache),(24)))
 local real NewX=LastX+1000*0.05*Cos(Angle)
 local real NewY=LastY+1000*0.05*Sin(Angle)
 local group GroupVar=GetAvailableGroup()
+local unit Dummy=(LoadUnitHandle(hash_main,(Cache),(239)))
 call SaveReal(hash_main,(Cache),(23),((NewX)*1.0))
 call SaveReal(hash_main,(Cache),(24),((NewY)*1.0))
 set udg_TempUnit=UnitVar
 set udg_TempReal=GetUnitAbilityLevel(UnitVar,1093682766)*75+25
 set udg_TempGroup=AlreadyDamaged
-call GroupEnumUnitsInRange(GroupVar,CurrentX,CurrentY,280,Condition(function Waveform_WhichToDamage))
+call GroupEnumUnitsInRange(GroupVar,CurrentX,CurrentY,200+25,Condition(function Waveform_WhichToDamage))
 call ForGroup(GroupVar,function Waveform_Damage)
 call GroupAddGroup(GroupVar,AlreadyDamaged)
 call KillGroup(GroupVar)
 set Remaining=Remaining-1
 call SaveInteger(hash_main,(Cache),(194),(Remaining))
 call SetUnitX(UnitVar,SafeX(NewX))
 call SetUnitY(UnitVar,SafeY(NewY))
-call SetUnitPosition(Caster,NewX,NewY)
+call SetUnitX(Dummy,GetUnitX(UnitVar))
+call SetUnitY(Dummy,GetUnitY(UnitVar))
+call IssueTargetOrder(Dummy,"thunderbolt",UnitVar)
 call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",CurrentX,CurrentY))
 if Remaining==0 then
-call RemoveUnit(Caster)
+call RemoveUnit(Dummy)
 call SetUnitVertexColor(UnitVar,255,255,255,255)
 call SaveBoolean(hash_main,(GetHandleId(UnitVar)),(225),(false))
 call SetUnitInvulnerable(UnitVar,false)
 call SetUnitPathing(UnitVar,true)
 call KillGroup(AlreadyDamaged)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 set UnitVar=null
-set Caster=null
 set AlreadyDamaged=null
 set GroupVar=null
 set t=null
 return false
 endfunction
@@ -51792,29 +52920,29 @@
 local real TargetX=GetLocationX(TargetLoc)
 local real TargetY=GetLocationY(TargetLoc)
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local group AlreadyDamaged=GetAvailableGroup()
-local unit Caster=CreateUnit(GetOwningPlayer(UnitVar),1865429063,SourceX,SourceY,0)
 local integer pid=GetPlayerId(GetOwningPlayer(UnitVar))
+local unit Dummy=CreateUnit(GetOwningPlayer(UnitVar),1697656901,SourceX,SourceY,0)
+call UnitAddAbility(Dummy,1093815860)
 call RemoveLocation(TargetLoc)
 if GetSpellTargetUnit()!=null then
 set TargetX=GetUnitX(GetSpellTargetUnit())
 set TargetY=GetUnitY(GetSpellTargetUnit())
 endif
 call SetUnitVertexColor(UnitVar,255,255,255,0)
 call SaveBoolean(hash_main,(GetHandleId(UnitVar)),(225),(true))
 call SetUnitInvulnerable(UnitVar,true)
 call SetUnitPathing(UnitVar,false)
-call SetUnitPathing(Caster,false)
 call SaveUnitHandle(hash_main,(Cache),(221),(UnitVar))
-call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 call SaveReal(hash_main,(Cache),(23),((SourceX)*1.0))
 call SaveReal(hash_main,(Cache),(24),((SourceY)*1.0))
 call SaveGroupHandle(hash_main,(Cache),(133),(AlreadyDamaged))
 call SaveReal(hash_main,(Cache),(13),((Atan2(TargetY-SourceY,TargetX-SourceX))*1.0))
 call SaveInteger(hash_main,(Cache),(194),(IMax(R2I(SquareRoot((TargetX-SourceX)*(TargetX-SourceX)+(TargetY-SourceY)*(TargetY-SourceY))/50),1)))
+call SaveUnitHandle(hash_main,(Cache),(239),(Dummy))
 call TriggerRegisterTimerEvent(t,0.04,true)
 call TriggerAddCondition(t,Condition(function Waveform_Move))
 call ShowUnit(UnitVar,false)
 call ShowUnit(UnitVar,true)
 call SelectUnitAddForPlayer(UnitVar,GetOwningPlayer(UnitVar))
@@ -51981,11 +53109,11 @@
 set t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
 call TriggerAddCondition(t,Condition(function Replicate_Restriction))
 set t=null
 endfunction
-function Morph_Attribute takes unit Hero,integer whichAttribute,integer rate returns nothing
+function Morph_Attribute takes unit Hero,integer whichAttribute,real rate returns nothing
 local integer CurrentAgi=GetHeroAgi(Hero,false)
 local integer CurrentStr=GetHeroStr(Hero,false)
 local real CurrentMana=GetUnitState(Hero,UNIT_STATE_MANA)
 if whichAttribute==bj_HEROSTAT_STR then
 if CurrentMana>=rate and CurrentAgi>2 and IsDead(Hero)==false then
@@ -52004,21 +53132,21 @@
 function Morph_Agility takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_morph)
-call Morph_Attribute(Hero,bj_HEROSTAT_AGI,20/Level)
+call Morph_Attribute(Hero,bj_HEROSTAT_AGI,30.0/Level)
 set t=null
 set Hero=null
 return false
 endfunction
 function Morph_Strength takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_morph)
-call Morph_Attribute(Hero,bj_HEROSTAT_STR,20/Level)
+call Morph_Attribute(Hero,bj_HEROSTAT_STR,30.0/Level)
 set t=null
 set Hero=null
 return false
 endfunction
 function Morph_Order takes nothing returns boolean
@@ -52072,13 +53200,13 @@
 call SaveTriggerHandle(hash_main,(Cache),(226),(null))
 call SaveInteger(hash_main,(Cache),(227),(GetIssuedOrderId()))
 call UnitRemoveAbility(Hero,fx_morph_agi)
 call UnitRemoveAbility(Hero,fx_morph_str)
 elseif GetIssuedOrderId()==orderid_morph_agi and LastOrder!=orderid_morphon_str and LastOrder!=orderid_morphon_str then
-call Morph_Attribute(Hero,bj_HEROSTAT_AGI,20/Level)
+call Morph_Attribute(Hero,bj_HEROSTAT_AGI,30./Level)
 elseif GetIssuedOrderId()==orderid_morph_str and LastOrder!=orderid_morphon_str and LastOrder!=orderid_morphon_str then
-call Morph_Attribute(Hero,bj_HEROSTAT_STR,20/Level)
+call Morph_Attribute(Hero,bj_HEROSTAT_STR,30./Level)
 endif
 set t=null
 set Hero=null
 set Iterate=null
 return false
@@ -52819,15 +53947,15 @@
 function SpiritLance_Damage takes player p,unit Target,integer Level,boolean Primary,boolean DealDamage returns nothing
 local real Damage=50+50*Level
 local unit Caster
 local integer abilityid
 if DealDamage then
-set Caster=CreateUnit(p,1697656901,GetUnitX(Target),GetUnitY(Target),0)
+set Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 call UnitAddAbility2(Caster,spiritlance_slow)
 call SetUnitAbilityLevel(Caster,spiritlance_slow,Level)
 call IssueTargetOrder(Caster,"cripple",Target)
-call DamageTarget(Caster,Target,DAMAGE_MAGICAL,Damage)
+call DamageTarget(udg_Hero[GetPlayerId(p)],Target,DAMAGE_MAGICAL,Damage)
 if Primary then
 call SpiritLance_CreateImage(p,Target,Level)
 endif
 endif
 call DestroyEffect(AddSpecialEffectTarget(spiritlance_fx,Target,spiritlance_fx_attach))
@@ -53465,107 +54593,65 @@
 set t=null
 endfunction
 function LivingArmor_Think takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
-local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
-local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
-local integer Level
-local player p
-if Source==null or IsDead(Source)then
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_structure)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_structure)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_structure_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_structure_global)
-else
-if(IsSent(GetOwningPlayer(Source))==true and IsSent(GetOwningPlayer(Caster))==false)or(IsSent(GetOwningPlayer(Source))==false and IsSent(GetOwningPlayer(Caster))==true)then
-if IsSent(GetOwningPlayer(Source))then
-set p=udg_SentPlayers[0]
-else
-set p=udg_ScourgePlayers[0]
-endif
-call SetUnitOwner(Caster,p,false)
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Count=(LoadInteger(hash_main,(Cache),(34)))
+if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
+if GetEventDamage()>5 then
+set Count=Count+1
+call SaveInteger(hash_main,(Cache),(34),(Count))
 endif
-set Level=GetUnitAbilityLevel(Source,abilityid_livingarmor)
-if IsDay()then
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_structure)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_structure)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_hp_global)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_armor_global)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_hp_structure_global)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_armor_structure_global)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_hp_global,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_armor_global,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_hp_structure_global,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_armor_structure_global,Level)
-else
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_armor_structure_global)
-call UnitRemoveAbility(Caster,abilityid_livingarmor_aura_hp_structure_global)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_hp)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_armor)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_hp_structure)
-call UnitAddAbility(Caster,abilityid_livingarmor_aura_armor_structure)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_hp,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_armor,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_hp_structure,Level)
-call SetUnitAbilityLevel(Caster,abilityid_livingarmor_aura_armor_structure,Level)
 endif
-call SetUnitX(Caster,GetUnitX(Source))
-call SetUnitY(Caster,GetUnitY(Source))
+if GetTriggerEventId()!=EVENT_UNIT_DAMAGED or Count>5 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call UnitRemoveAbility(Target,livingarmor_damageblock_1)
+call UnitRemoveAbility(Target,livingarmor_damageblock_2)
+call UnitRemoveAbility(Target,livingarmor_damageblock_3)
+call UnitRemoveAbility(Target,livingarmor_damageblock_4)
+call UnitRemoveAbility(Target,livingarmor_buffid)
 endif
 set t=null
-set Source=null
-set Caster=null
+set Target=null
 return false
 endfunction
 function LivingArmor takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local unit Target=GetSpellTargetUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-local unit Source=GetTriggerUnit()
-local player p
-local unit Caster
-if IsSent(GetOwningPlayer(Source))then
-set p=udg_SentPlayers[0]
-else
-set p=udg_ScourgePlayers[0]
+local integer abilid=livingarmor_damageblock_1
+local integer Level=GetUnitAbilityLevel(Source,abilityid_livingarmor)
+if Level==2 then
+set abilid=livingarmor_damageblock_2
+elseif Level==3 then
+set abilid=livingarmor_damageblock_3
+elseif Level==4 then
+set abilid=livingarmor_damageblock_4
 endif
-set Caster=CreateUnit(p,1697657174,0,0,0)
-call UnitAddAbility2(Source,abilityid_livingarmor_fx)
-call TriggerRegisterTimerEvent(t,0.1,true)
+call UnitAddAbility2(Target,abilid)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilid,false)
+call TriggerRegisterTimerEvent(t,15,false)
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
 call TriggerAddCondition(t,Condition(function LivingArmor_Think))
-call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
-call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveInteger(hash_main,(Cache),(34),(0))
 set t=null
 set Source=null
-set Caster=null
 endfunction
 function LivingArmor_Main takes nothing returns boolean
-if GetLearnedSkill()==abilityid_livingarmor and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_livingarmor)==1 and IsUnitIllusion(GetTriggerUnit())==false then
+if GetSpellAbilityId()==abilityid_livingarmor then
 call LivingArmor()
 endif
 return false
 endfunction
 function Register_LivingArmor takes nothing returns nothing
 local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function LivingArmor_Main))
-call PreloadAbility(abilityid_livingarmor_aura_hp)
-call PreloadAbility(abilityid_livingarmor_aura_hp_structure)
-call PreloadAbility(abilityid_livingarmor_aura_hp_global)
-call PreloadAbility(abilityid_livingarmor_aura_hp_structure_global)
-call PreloadAbility(abilityid_livingarmor_aura_armor)
-call PreloadAbility(abilityid_livingarmor_aura_armor_structure)
-call PreloadAbility(abilityid_livingarmor_aura_armor_global)
-call PreloadAbility(abilityid_livingarmor_aura_armor_structure_global)
 set t=null
 endfunction
 function LeechSeed_Hit takes nothing returns nothing
 local integer Cache=GetHandleId(GetTriggeringTrigger())
 local unit Source=tt_unit1
@@ -53586,17 +54672,21 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local group g
+local integer Count=(LoadInteger(hash_main,(Cache),(34)))
 if GetTriggerEventId()==EVENT_WIDGET_DEATH then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call UnitRemoveAbility(Target,leechseed_slow)
 call UnitRemoveAbility(Target,leechseed_slow_buffid)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 else
-if GetTriggerEvalCount(t)>3 then
+set Count=Count+1
+call SaveInteger(hash_main,(Cache),(34),(Count))
+if Count>3 then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call UnitRemoveAbility(Target,leechseed_slow)
 call UnitRemoveAbility(Target,leechseed_slow_buffid)
 endif
@@ -53630,10 +54720,11 @@
 call TriggerAddCondition(t,Condition(function LeechSeed_Think))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(442),(((TimerGetElapsed(udg_GameTimer)))*1.0))
 call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveInteger(hash_main,(Cache),(34),(0))
 set t=null
 set Source=null
 endfunction
 function LeechSeed takes nothing returns nothing
 local unit Source=GetTriggerUnit()
@@ -53660,37 +54751,38 @@
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local integer Level=GetUnitAbilityLevel(Source,abilityid_lastword)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
-if IsDead(Source)==false and IsDead(Target)==false then
-endif
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,100+50*Level)
 set t=null
 set Source=null
 set Target=null
 return false
 endfunction
 function LastWord_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_lastword)
+local boolean SpecialEnd=(LoadBoolean(hash_main,(Cache),(95)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
-if IsDead(Source)==false and IsDead(Target)==false then
 call UnitAddAbility2(Caster,1093684307)
 call SetUnitAbilityLevel(Caster,1093684307,Level)
 call IssueTargetOrder(Caster,"soulburn",Target)
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerAddCondition(t,Condition(function LastWord_Damage))
 call TriggerRegisterTimerEvent(t,0.01,false)
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(2),(Source))
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(17),(Target))
 call SaveInteger(hash_main,(GetHandleId(t)),(5),(Level))
+if SpecialEnd then
+call DestroyEffect(AddSpecialEffectTarget(lastword_fx_end_forced,Target,"overhead"))
 endif
 set t=null
 set Source=null
 set Target=null
 set Caster=null
@@ -53698,27 +54790,113 @@
 endfunction
 function IsAttackOrb takes integer id returns boolean
 return id==1093682265 or id==1093752642 or id==1093677622 or id==1093679446 or id==1095263841 or id==1093684314 or id==1093685582 or id==1093685065
 endfunction
 function LastWord_Cast takes nothing returns boolean
-local unit Target=GetTriggerUnit()
-local unit Source=(LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(2)))
-local trigger t
-if GetUnitAbilityLevel(GetTriggerUnit(),1110455638)>0 and GetUnitAbilityLevel(GetTriggerUnit(),1093678162)==0 and IsGlobalSpellIgnore(GetSpellAbilityId())==false and GetSpellAbilityId()!=1095328363 and GetSpellAbilityId()!=1093678426 and GetSpellAbilityId()!=1093682768 and GetSpellAbilityId()!=1093685593 and GetSpellAbilityId()!=1093678680 and GetSpellAbilityId()!=1093681489 and GetSpellAbilityId()!=abilityid_wex and GetSpellAbilityId()!=abilityid_quas and GetSpellAbilityId()!=abilityid_exort and GetSpellAbilityId()!=1093743191 and GetSpellAbilityId()!=1093678667 and GetSpellAbilityId()!=1097163124 and GetSpellAbilityId()!=1093683801 and GetSpellAbilityId()!=1093682767 and GetSpellAbilityId()!=abilityid_unstableconcoction and GetSpellAbilityId()!=abilityid_iceblast and GetSpellAbilityId()!=1093751096 and GetSpellAbilityId()!=1093751361 and GetSpellAbilityId()!=1093751126 and GetSpellAbilityId()!=abilityid_invoke and GetSpellAbilityId()!=abilityid_invokeupgrade and GetSpellAbilityId()!=abilityid_sunray and IsAttackOrb(GetSpellAbilityId())==false then
-if IsUnitEnemy(Target,GetOwningPlayer(Source))==true and IsItemAbility(GetSpellAbilityId())==false then
-if((LoadInteger(hash_main,(GetHandleId((Target))),((4305))))==HERO_STATE_ON)==false then
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local unit Caster
+local integer Level=GetUnitAbilityLevel(Source,abilityid_lastword)
+if GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call UnitRemoveAbility(Target,lastword_visual)
+call UnitRemoveAbility(Target,lastword_visual_buffid)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+elseif GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call UnitRemoveAbility(Target,lastword_visual)
+call UnitRemoveAbility(Target,lastword_visual_buffid)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
 set t=CreateTrigger()
-call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_ENDCAST)
+set Cache=GetHandleId(t)
 call TriggerAddCondition(t,Condition(function LastWord_End))
+call TriggerRegisterTimerEvent(t,0.01,false)
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(2),(Source))
 call SaveUnitHandle(hash_main,(GetHandleId(t)),(17),(Target))
-set t=null
+call SaveInteger(hash_main,(GetHandleId(t)),(5),(Level))
+call SaveBoolean(hash_main,(Cache),(95),(false))
+set Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+call UnitAddAbility2(Caster,1093815895)
+call SetUnitAbilityLevel(Caster,1093815895,Level)
+call IssueTargetOrder(Caster,"drunkenhaze",Target)
+call DestroyEffect(AddSpecialEffectTarget(lastword_fx_end_natural,Target,"overhead"))
+set Caster=null
+elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and IsItemAbility(GetSpellAbilityId())==false and IsGlobalSpellIgnore(GetSpellAbilityId())==false and GetSpellAbilityId()!=1095328363 and GetSpellAbilityId()!=1093678426 and GetSpellAbilityId()!=1093682768 and GetSpellAbilityId()!=1093685593 and GetSpellAbilityId()!=1093678680 and GetSpellAbilityId()!=1093681489 and GetSpellAbilityId()!=abilityid_wex and GetSpellAbilityId()!=abilityid_quas and GetSpellAbilityId()!=abilityid_exort and GetSpellAbilityId()!=1093743191 and GetSpellAbilityId()!=1093678667 and GetSpellAbilityId()!=1097163124 and GetSpellAbilityId()!=1093683801 and GetSpellAbilityId()!=1093682767 and GetSpellAbilityId()!=abilityid_unstableconcoction and GetSpellAbilityId()!=abilityid_iceblast and GetSpellAbilityId()!=1093751096 and GetSpellAbilityId()!=1093751361 and GetSpellAbilityId()!=1093751126 and GetSpellAbilityId()!=abilityid_invoke and GetSpellAbilityId()!=abilityid_invokeupgrade and GetSpellAbilityId()!=abilityid_sunray and IsAttackOrb(GetSpellAbilityId())==false then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call UnitRemoveAbility(Target,lastword_visual)
+call UnitRemoveAbility(Target,lastword_visual_buffid)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+if GetSpellAbilityId()==1093685846 or GetSpellAbilityId()==1093684302 then
+call TriggerRegisterTimerEvent(t,0.01,false)
+else
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_ENDCAST)
 endif
+call TriggerAddCondition(t,Condition(function LastWord_End))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveBoolean(hash_main,(Cache),(95),(true))
 endif
+set Target=null
+set Source=null
+set t=null
+return false
+endfunction
+function LastWord_Vision takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+if GetUnitAbilityLevel(Target,lastword_visual)==0 or GetTriggerEvalCount(t)>250 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call KillUnit(Caster)
+else
+call SetUnitX(Caster,GetUnitX(Target))
+call SetUnitY(Caster,GetUnitY(Target))
 endif
+set t=null
+set Caster=null
 set Target=null
+return false
+endfunction
+function LastWord takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=GetTriggerUnit()
+local unit Target=GetSpellTargetUnit()
+local unit Caster=CreateUnit(GetOwningPlayer(Source),1865429305,GetUnitX(Target),GetUnitY(Target),0)
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
+call TriggerRegisterTimerEvent(t,5,false)
+call TriggerRegisterDeathEvent(t,Target)
+call TriggerAddCondition(t,Condition(function LastWord_Cast))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call UnitAddAbility2(Target,lastword_visual)
+call UnitMakeAbilityPermanent(Target,true,1093815894)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),lastword_visual,false)
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(lastword_fx,Target,"overhead")))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.02,true)
+call TriggerAddCondition(t,Condition(function LastWord_Vision))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 set Source=null
+set Target=null
+set t=null
+endfunction
+function LastWord_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_lastword and IsBlocked(GetSpellTargetUnit())==false then
+call LastWord()
+endif
 return false
 endfunction
 function LastWord_Process takes nothing returns nothing
 local integer Cache=GetHandleId(GetTriggeringTrigger())
 local unit Source=tt_unit2
@@ -53738,46 +54916,34 @@
 function LastWord_Death takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Dying=GetTriggerUnit()
-if IsUnitType(Dying,UNIT_TYPE_HERO)==true and GetUnitTypeId(Dying)!=1211117642 and IsUnitIllusion(Dying)==false and IsUnitInRange(Source,Dying,850)and IsDead(Source)==false and IsUnitAlly(Source,GetOwningPlayer(Dying))==false then
-if Source==GetKillingUnit()then
+if IsUnitType(Dying,UNIT_TYPE_HERO)==true and IsGlobalHeroDummy(GetUnitTypeId(Dying))==false and IsUnitIllusion(Dying)==false and(IsUnitInRange(Source,Dying,900)or GetOwningPlayer(Source)==GetOwningPlayer(GetKillingUnit()))and IsDead(Source)==false and IsUnitAlly(Source,GetOwningPlayer(Dying))==false then
 set LastWord_Stolen[GetPlayerId(GetOwningPlayer(Source))]=LastWord_Stolen[GetPlayerId(GetOwningPlayer(Source))]+2
 call TextTagOnUnitEx("-2 "+GetObjectName(1848658512),3,Dying,0.023,255,0,0,230)
 call SetHeroInt(Dying,GetHeroInt(Dying,false)-2,true)
 call CreateProjectileToUnit(Dying,Source,1747993424,"LastWord_Process2",450)
-else
-set LastWord_Stolen[GetPlayerId(GetOwningPlayer(Source))]=LastWord_Stolen[GetPlayerId(GetOwningPlayer(Source))]+1
-call TextTagOnUnitEx("-1 "+GetObjectName(1848658512),3,Dying,0.023,255,0,0,230)
-call SetHeroInt(Dying,GetHeroInt(Dying,false)-1,true)
-call CreateProjectileToUnit(Dying,Source,1747993424,"LastWord_Process",450)
-endif
 endif
 set t=null
 set Source=null
 set Dying=null
 return false
 endfunction
-function LastWord takes nothing returns nothing
+function LastWord_RegisterDeath takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
-call TriggerAddCondition(t,Condition(function LastWord_Cast))
-call SaveUnitHandle(hash_main,(Cache),(2),(Source))
-set t=CreateTrigger()
-set Cache=GetHandleId(t)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function LastWord_Death))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 set Source=null
 set t=null
 endfunction
-function LastWord_Main takes nothing returns boolean
-if GetLearnedSkill()==abilityid_lastword and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_lastword)==1 then
-call LastWord()
+function LastWord_Learn takes nothing returns boolean
+if GetLearnedSkill()==abilityid_glaivesofwisdom and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_glaivesofwisdom)==1 then
+call LastWord_RegisterDeath()
 endif
 return false
 endfunction
 function Int_Command takes nothing returns boolean
 local integer Total=LastWord_Stolen[GetPlayerId(GetTriggerPlayer())]
@@ -53786,13 +54952,16 @@
 endif
 return false
 endfunction
 function Register_LastWord takes nothing returns nothing
 local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function LastWord_Main))
 set t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function LastWord_Learn))
+set t=CreateTrigger()
 call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-stats",true)
 call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-stats",true)
 call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-stats",true)
 call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-stats",true)
 call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-stats",true)
@@ -53923,16 +55092,16 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local integer Count=(LoadInteger(hash_main,(Cache),(34)))
-if GetTriggerEventId()!=EVENT_UNIT_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and Count<(4+Level)then
+if GetTriggerEventId()!=EVENT_UNIT_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and Count<(6)then
 set Count=Count+1
 call SaveInteger(hash_main,(Cache),(34),(Count))
-call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-5-5*Level)
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,10+10*Level)
-elseif Count>=(4+Level)or GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()!=abilityid_phaseboots and GetSpellAbilityId()!=1093682767 and GetSpellAbilityId()!=1093750095 and GetSpellAbilityId()!=1093747504 and GetSpellAbilityId()!=1093753417 and GetSpellAbilityId()!=1093810265 and IsGlobalSpellIgnore(GetSpellAbilityId())==false and(IsRealSpellWithItems(GetSpellAbilityId())or GetSpellAbilityId()==1093678667))then
+call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-8*Level)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,5+15*Level)
+elseif Count>=(6)or GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()!=abilityid_phaseboots and GetSpellAbilityId()!=1093682767 and GetSpellAbilityId()!=1093750095 and GetSpellAbilityId()!=1093747504 and GetSpellAbilityId()!=1093753417 and GetSpellAbilityId()!=1093810265 and IsGlobalSpellIgnore(GetSpellAbilityId())==false and(IsRealSpellWithItems(GetSpellAbilityId())or GetSpellAbilityId()==1093678667))then
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 call UnitRemoveAbility(Target,curseofthesilent_icon)
 call UnitRemoveAbility(Target,curseofthesilent_icon_buff)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
@@ -54020,11 +55189,11 @@
 local real d
 local real a
 local real x2
 local real y2
 set tt_unit1=Source
-call GroupEnumUnitsInRange(g,x,y,375,Condition(function GenericCondition_EnemyUnitsAndStructureEx))
+call GroupEnumUnitsInRange(g,x,y,360+25,Condition(function GenericCondition_EnemyUnitsAndStructureEx))
 set shrapnel_source=Source
 set shrapnel_damage=Level*12
 set shrapnel_caster=Caster
 call ForGroup(g,function Shrapnel_Hit)
 call KillGroup(g)
@@ -54035,11 +55204,11 @@
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(178))))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(179))))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(180))))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(330))))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(331))))
-if GetTriggerEvalCount(t)==8 then
+if GetTriggerEvalCount(t)==9 then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 set d=0
 set a=0
@@ -54145,10 +55314,11 @@
 local integer Cache=GetHandleId(t)
 local unit Source=GetTriggerUnit()
 local location l=GetSpellTargetLoc()
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
+call TimedReveal(GetOwningPlayer(Source),9.4,x,y,360)
 call TriggerRegisterTimerEvent(t,0.4,true)
 call TriggerAddCondition(t,Condition(function Shrapnel))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(6),((x)*1.0))
 call SaveReal(hash_main,(Cache),(7),((y)*1.0))
@@ -54373,11 +55543,11 @@
 elseif Level==3 then
 set warcry_abilityid=warcry_abilityid_3
 elseif Level==4 then
 set warcry_abilityid=warcry_abilityid_4
 endif
-call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),725,Condition(function GenericCondition_AlliedUnits))
+call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),925,Condition(function GenericCondition_AlliedUnits))
 call ForGroup(g,function Warcry_Add)
 call KillGroup(g)
 call DestroyEffect(AddSpecialEffectTarget(warcry_fx,Source,"overhead"))
 set Source=null
 set g=null
@@ -54448,18 +55618,18 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function GodStrength_Main))
 set t=null
 endfunction
 function StormBolt_Stun takes nothing returns nothing
-call IssueTargetOrder(stormbolt_caster,"thunderbolt",GetEnumUnit())
+call Stun(stormbolt_caster,GetEnumUnit(),2)
+call DamageTarget(stormbolt_caster,GetEnumUnit(),DAMAGE_MAGICAL,stormbolt_level*75+25)
 endfunction
 function StormBolt_Hit takes player p,unit Target,integer Level returns nothing
 local unit Caster=CreateUnit(p,1697656901,GetUnitX(Target),GetUnitY(Target),0)
 local integer abilityid
 local group g=GetAvailableGroup()
-call UnitAddAbility2(Caster,stormbolt_stun)
-call SetUnitAbilityLevel(Caster,stormbolt_stun,Level)
+set stormbolt_level=Level
 set tt_unit1=udg_Hero[GetPlayerId(p)]
 call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),280,Condition(function GenericCondition_EnemyUnitsEx))
 call GroupAddUnit(g,Target)
 set stormbolt_caster=Caster
 call ForGroup(g,function StormBolt_Stun)
@@ -54616,15 +55786,17 @@
 endif
 set LastHit=(LoadReal(hash_main,(Cache),(714)))
 if LastHit+3<(TimerGetElapsed(udg_GameTimer))then
 if(LoadInteger(hash_main,(Cache),(34)))==2 then
 call SaveInteger(hash_main,(Cache),(34),(1))
+call SaveInteger(hash_main,(GetHandleId((Bear))),((4327)),(HERO_STATE_OFF))
 call SetPlayerAbilityAvailable(GetOwningPlayer(Bear),1093681463,true)
 endif
 else
 if(LoadInteger(hash_main,(Cache),(34)))==1 then
 call SaveInteger(hash_main,(Cache),(34),(2))
+call SaveInteger(hash_main,(GetHandleId((Bear))),((4327)),(HERO_STATE_ON))
 call SetPlayerAbilityAvailable(GetOwningPlayer(Bear),1093681463,false)
 endif
 endif
 set t=null
 set Bear=null
@@ -54845,24 +56017,31 @@
 local boolexpr CondVar=Condition(function FindBear)
 local group GroupVar=GetAvailableGroup()
 local integer Level=GetUnitAbilityLevel(UnitVar,1093681461)
 local integer Cache=GetHandleId(PlayerVar)
 local boolean NoBear
+local unit Bear
 call GroupEnumUnitsOfPlayer(GroupVar,GetOwningPlayer(UnitVar),CondVar)
-set NoBear=CountUnitsInGroup(GroupVar)==0
-if NoBear==false then
+if CountUnitsInGroup(GroupVar)!=0 then
+set Bear=FirstOfGroup(GroupVar)
+if Bear!=null and((LoadInteger(hash_main,(GetHandleId((Bear))),((4327))))==HERO_STATE_ON)==true then
 call InterruptUnit(UnitVar)
-call Error(PlayerVar,GetObjectName(MSG_SPIRIT_HERE))
+call Error(PlayerVar,GetObjectName(1848659278))
+endif
 endif
 call KillGroup(GroupVar)
 call RemoveLocation(PointVar)
 endfunction
 function Summon takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Trig_Summon_Spirit_Bear_Conditions))
 call TriggerAddAction(t,function Trig_Summon_Spirit_Bear_Actions)
+set t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
+call TriggerAddCondition(t,Condition(function Trig_Summon_Spirit_Bear_Conditions))
+call TriggerAddAction(t,function Trig_Summon_Spirit_Bear_PreActions)
 endfunction
 function Trig_Return_Bear_Conditions takes nothing returns boolean
 return GetSpellAbilityId()==1093681463
 endfunction
 function Trig_Return_Bear_Actions takes nothing returns nothing
@@ -55066,10 +56245,11 @@
 call SaveReal(hash_main,(Cache),(6),((x)*1.0))
 call SaveReal(hash_main,(Cache),(7),((y)*1.0))
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 set u=(ancestralcharge_image[GetPlayerId(GetOwningPlayer((Source)))])
+call IssueImmediateOrder(u,"stop")
 set x=GetUnitX(u)
 set y=GetUnitY(u)
 set Caster=CreateUnit(GetOwningPlayer(Source),unitid_greatstomp,x,y,0)
 call SetUnitTimeScale(Caster,2.5)
 call UnitApplyTimedLife(Caster,1112820806,2)
@@ -55102,10 +56282,14 @@
 call SaveInteger(hash_main,(GetHandleId((Source))),((4269)),(HERO_STATE_OFF))
 call SaveBoolean(hash_main,(GetHandleId(Image)),(337),(true))
 if KillStompImage then
 call ShowUnit(Image,false)
 call KillUnit(Image)
+else
+call ShowUnit(Image,false)
+call UnitRemoveAbility(Image,1097625443)
+call ShowUnit(Image,true)
 endif
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 if KillStompImage then
@@ -55130,10 +56314,11 @@
 call UnitAddAbility2(Image,1097167980)
 call SetUnitPosition(Image,GetUnitX(Source),GetUnitY(Source))
 call SetUnitScale(Image,1.4,1.4,1.4)
 else
 set Image=(ancestralcharge_image[GetPlayerId(GetOwningPlayer((Source)))])
+call UnitAddAbility(Image,1097625443)
 endif
 call IssueImmediateOrder(Image,"stop")
 call SaveInteger(hash_main,(GetHandleId((Source))),((4269)),(HERO_STATE_ON))
 call SetUnitAnimation(Image,"spell slam")
 call QueueUnitAnimation(Image,"spell slam")
@@ -55150,13 +56335,14 @@
 function GreatStomp_Main takes nothing returns boolean
 local integer rand
 if GetSpellAbilityId()==abilityid_greatstomp then
 if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_FINISH then
 call GreatStomp()
-endif
+else
 call GreatStomp_Anim()
 endif
+endif
 return false
 endfunction
 function Register_GreatStomp takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_FINISH)
@@ -55324,19 +56510,20 @@
 local real x
 local real y
 local group g=GetAvailableGroup()
 local group AlreadyHit=GetAvailableGroup()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_earthsplitter)
+local integer MaxCount=(LoadInteger(hash_main,(Cache),(34)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 set tt_unit1=Source
 set earthsplitter_source=Source
 set earthsplitter_caster=CreateUnit(GetOwningPlayer(Source),1697656901,x0,y0,0)
 call UnitAddAbility2(earthsplitter_caster,earthsplitter_slow)
 call SetUnitAbilityLevel(earthsplitter_caster,earthsplitter_slow,Level)
 loop
-exitwhen i>11
+exitwhen i>MaxCount
 set x=x0+i*200*Cos(a0)
 set y=y0+i*200*Sin(a0)
 call TimedLifeEffect(earthsplitter_fx2,x,y,1.6)
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,x,y-250))
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,x,y))
@@ -55380,10 +56567,11 @@
 local real fy_5
 local real x
 local real y
 local ubersplat Splat
 local integer Count=GetTriggerEvalCount(t)
+local integer MaxCount=(LoadInteger(hash_main,(Cache),(34)))
 set x=x0+200*Count*Cos(a)
 set y=y0+200*Count*Sin(a)
 set Splat=CreateUbersplat(x,y,"THNE",255,255,255,255,false,false)
 call SetUbersplatRenderAlways(Splat,true)
 set fx_0=x+250*Cos(bj_DEGTORAD*(a*bj_RADTODEG-45))
@@ -55403,11 +56591,11 @@
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,fx_1,fy_1))
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,fx_2,fy_2))
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,fx_3,fy_3))
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,fx_4,fy_4))
 call DestroyEffect(AddSpecialEffect(earthsplitter_fx3,fx_5,fy_5))
-if GetTriggerEvalCount(t)>11 then
+if GetTriggerEvalCount(t)>MaxCount then
 set x0=(LoadReal(hash_main,(Cache),(282)))
 set y0=(LoadReal(hash_main,(Cache),(283)))
 set a0=(LoadReal(hash_main,(Cache),(341)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
@@ -55417,10 +56605,11 @@
 call TriggerAddCondition(t,Condition(function EarthSplitter_Implode))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(282),((x0)*1.0))
 call SaveReal(hash_main,(Cache),(283),((y0)*1.0))
 call SaveReal(hash_main,(Cache),(341),((a0)*1.0))
+call SaveInteger(hash_main,(Cache),(34),(MaxCount))
 endif
 set t=null
 set Source=null
 return false
 endfunction
@@ -55430,19 +56619,22 @@
 local unit Source=GetTriggerUnit()
 local location l=GetSpellTargetLoc()
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
 local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
+local real d=DistanceBetweenXY(x,y,GetUnitX(Source),GetUnitY(Source))
+local integer MaxCount=11
 call TriggerRegisterTimerEvent(t,0.22,true)
 call TriggerAddCondition(t,Condition(function EarthSplitter_Iterate))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(6),((GetUnitX(Source))*1.0))
 call SaveReal(hash_main,(Cache),(7),((GetUnitY(Source))*1.0))
 call SaveReal(hash_main,(Cache),(137),((a)*1.0))
 call SaveReal(hash_main,(Cache),(282),((GetUnitX(Source))*1.0))
 call SaveReal(hash_main,(Cache),(283),((GetUnitY(Source))*1.0))
 call SaveReal(hash_main,(Cache),(341),((a)*1.0))
+call SaveInteger(hash_main,(Cache),(34),(MaxCount))
 set t=null
 set Source=null
 endfunction
 function EarthSplitter_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_earthsplitter then
@@ -55454,10 +56646,30 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function EarthSplitter_Main))
 set t=null
 endfunction
+function AncestralCharge_FixShit_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+call UnitRemoveAbility(Source,abilityid_ancestralcharge_end)
+call UnitAddAbility(Source,abilityid_ancestralcharge_end)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+set Source=null
+return false
+endfunction
+function AncestralCharge_FixShit takes unit Source returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0,false)
+call TriggerAddCondition(t,Condition(function AncestralCharge_FixShit_End))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set t=null
+endfunction
 function AncestralCharge_Expire takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
@@ -55622,12 +56834,18 @@
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge,true)
 endif
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge_end,false)
 elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
 if GetSpellAbilityId()==abilityid_ancestralcharge_end then
+call IssueImmediateOrder(Image,"stop")
 call SaveBoolean(hash_main,(Cache),(249),(true))
 call SetUnitAnimationByIndex(Image,3)
+call AncestralCharge_FixShit(GetTriggerUnit())
+elseif GetSpellAbilityId()==abilityid_image_echostomp then
+if IssueImmediateOrder(Source,"charm")then
+call UnitRemoveAbility(Image,abilityid_image_echostomp)
+endif
 endif
 elseif DistanceBetweenXY(x1,y1,x2,y2)<100 then
 call AncestralCharge_Collide(Source,Image,(LoadInteger(hash_main,(Cache),(344))),(LoadInteger(hash_main,(Cache),(345))))
 call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
@@ -55635,11 +56853,13 @@
 if(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==0 or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==abilityid_ancestralcharge then
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge,true)
 endif
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge_end,false)
 elseif GetTriggerEvalCount(t)>400 or(LoadBoolean(hash_main,(Cache),(249)))==true then
+call UnitAddAbility2(Image,1097625443)
 if GetTriggerEvalCount(t)==401 and(LoadBoolean(hash_main,(Cache),(249)))==false then
+call IssueImmediateOrder(Image,"stop")
 call SetUnitAnimationByIndex(Image,3)
 endif
 set g=GetAvailableGroup()
 set ancestralcharge_level=Level
 set ancestralcharge_attackbonus=(LoadInteger(hash_main,(Cache),(344)))
@@ -55663,10 +56883,12 @@
 call SetUnitY(Image,SafeY(y3))
 call SaveReal(hash_main,(Cache),(282),((x1)*1.0))
 call SaveReal(hash_main,(Cache),(283),((y1)*1.0))
 endif
 else
+call SetUnitMoveSpeed(Image,GetUnitMoveSpeed(Source))
+call UnitRemoveAbility(Image,1097625443)
 set g=GetAvailableGroup()
 set ancestralcharge_level=Level
 set ancestralcharge_attackbonus=(LoadInteger(hash_main,(Cache),(344)))
 set ancestralcharge_movementbonus=(LoadInteger(hash_main,(Cache),(345)))
 set ancestralcharge_damage=80+40*Level
@@ -55686,24 +56908,18 @@
 if((LoadInteger(hash_main,(GetHandleId((Source))),((4269))))==HERO_STATE_ON)==false then
 if LastMoved==Time then
 set x3=GetReflectionAngle_X(x0,y0,x1,y1,x2,y2)
 set y3=GetReflectionAngle_Y(x0,y0,x1,y1,x2,y2)
 set a=Atan2(y3-y2,x3-x2)*bj_RADTODEG
-call SetUnitFacing(Image,a)
-call SetUnitX(Image,SafeX(x3))
-call SetUnitY(Image,SafeY(y3))
 call SaveReal(hash_main,(Cache),(282),((x1)*1.0))
 call SaveReal(hash_main,(Cache),(283),((y1)*1.0))
 endif
 if(LastMoved+0.3)<Time then
 call SaveInteger(hash_main,(Cache),(343),(1))
-call SetUnitAnimationByIndex(Image,2)
 elseif(LastMoved+0.3)>Time and(LoadInteger(hash_main,(Cache),(343)))==1 then
 call SaveInteger(hash_main,(Cache),(343),(2))
-call SetUnitAnimationByIndex(Image,3)
 elseif(LoadInteger(hash_main,(Cache),(343)))==3 then
-call SetUnitAnimationByIndex(Image,2)
 call SaveInteger(hash_main,(Cache),(343),(1))
 endif
 else
 call SaveInteger(hash_main,(Cache),(343),(3))
 endif
@@ -55726,28 +56942,33 @@
 local real a=Atan2(ly-y0,lx-x0)
 local real d=RMax(DistanceBetweenXY(x0,y0,lx,ly),300)
 local real x1=SafeX(x0+d*Cos(a))
 local real y1=SafeY(y0+d*Sin(a))
 local unit Image=CreateUnit(GetOwningPlayer(Source),unitid_ancestralcharge,x1,y1,(a*bj_RADTODEG)-180)
+call SetUnitMoveSpeed(Image,GetUnitMoveSpeed(Source))
 call DestroyEffect(AddSpecialEffectTarget(ancestralcharge_fx,Image,"chest"))
 if GetUnitAbilityLevel(Source,abilityid_naturalorder)>0 then
 call UnitAddAbility2(Image,naturalorder_aura)
 endif
+if GetUnitAbilityLevel(Source,abilityid_greatstomp)==0 then
+call UnitRemoveAbility(Image,abilityid_image_echostomp)
+endif
 call UnitAddAbility(Source,abilityid_ancestralcharge_end)
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge,false)
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_ancestralcharge_end,true)
 call RemoveLocation(l)
 set ancestralcharge_image[GetPlayerId(GetOwningPlayer(Source))]=Image
 call SaveInteger(hash_main,(GetHandleId((Source))),((4270)),(HERO_STATE_ON))
-call UnitAddAbility2(Image,1097625443)
+call UnitAddAbility2(Image,1098282348)
 call UnitAddAbility2(Image,1097167980)
 if(LoadBoolean(hash_main,(GetHandleId(Source)),(339)))==true then
 call TriggerEvaluate((LoadTriggerHandle(hash_main,(Cache),(338))))
 endif
 call TriggerRegisterTimerEvent(t,0.02,true)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
+call TriggerRegisterUnitEvent(t,Image,EVENT_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function AncestralCharge_Iterate))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(335),(Image))
 call SaveReal(hash_main,(Cache),(282),((x0)*1.0))
 call SaveReal(hash_main,(Cache),(283),((y0)*1.0))
@@ -56051,11 +57272,11 @@
 endif
 endif
 return false
 endfunction
 function LandMine_TripHeroes takes nothing returns boolean
-return(GetUnitTypeId(GetFilterUnit())==1211117637 or GetUnitTypeId(GetFilterUnit())==1211117639 or GetUnitTypeId(GetFilterUnit())==1211117638 or GetUnitTypeId(GetFilterUnit())==1160786000 or GetUnitTypeId(GetFilterUnit())==1311780930 or GetUnitTypeId(GetFilterUnit())==1430468144 or GetUnitTypeId(GetFilterUnit())==1162032951 or GetUnitTypeId(GetFilterUnit())==1429221456 or GetUnitTypeId(GetFilterUnit())==1160786510 or GetUnitTypeId(GetFilterUnit())==1160786511 or GetUnitTypeId(GetFilterUnit())==1328558390 or GetUnitTypeId(GetFilterUnit())==1328558391 or GetUnitTypeId(GetFilterUnit())==1160786502 or GetUnitTypeId(GetFilterUnit())==1211122767)and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
+return(GetUnitTypeId(GetFilterUnit())==1211117637 or GetUnitTypeId(GetFilterUnit())==1211117639 or GetUnitTypeId(GetFilterUnit())==1211117638 or GetUnitTypeId(GetFilterUnit())==1160786000 or GetUnitTypeId(GetFilterUnit())==1311780930 or GetUnitTypeId(GetFilterUnit())==1430468144 or GetUnitTypeId(GetFilterUnit())==1162032951 or GetUnitTypeId(GetFilterUnit())==1429221456 or GetUnitTypeId(GetFilterUnit())==1160786510 or GetUnitTypeId(GetFilterUnit())==1160786511 or GetUnitTypeId(GetFilterUnit())==1328558390 or GetUnitTypeId(GetFilterUnit())==1328558391 or GetUnitTypeId(GetFilterUnit())==1160786502 or GetUnitTypeId(GetFilterUnit())==1211122767 or GetUnitTypeId(GetFilterUnit())==1311788343 or GetUnitTypeId(GetFilterUnit())==1311788354 or GetUnitTypeId(GetFilterUnit())==1311788355 or GetUnitTypeId(GetFilterUnit())==1311788367 or GetUnitTypeId(GetFilterUnit())==1311788353)and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
 endfunction
 function LandMine_Scan takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Mine=(LoadUnitHandle(hash_main,(Cache),(347)))
@@ -56743,20 +57964,20 @@
 call TriggerAddCondition(t,Condition(function Avalanche_Main))
 set t=null
 endfunction
 function Rampage_Add takes nothing returns nothing
 if GetEnumUnit()==GetTriggerUnit()then
-call AddTimedAbilityAndRemove(GetEnumUnit(),abilityid_rampagebonus,rampage_level,rampage_duration*2,1110454338)
+call AddTimedAbilityAndRemove(GetEnumUnit(),abilityid_rampagebonus,rampage_level,rampage_duration,1110454338)
 else
 call AddTimedAbilityAndRemove(GetEnumUnit(),abilityid_rampagebonus,rampage_level,rampage_duration,1110454338)
 endif
 call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),abilityid_rampagebonus,false)
 endfunction
 function Rampage takes nothing returns nothing
 local group g=GetAvailableGroup()
 set rampage_level=GetUnitAbilityLevel(GetTriggerUnit(),abilityid_rampage)
-set rampage_duration=5
+set rampage_duration=10
 call GroupEnumUnitsInRange(g,0,0,9999,Condition(function GenericCondition_AlliedHeroesNoImages))
 call ForGroup(g,function Rampage_Add)
 call KillGroup(g)
 set g=null
 endfunction
@@ -57555,10 +58776,11 @@
 endfunction
 function WardenTrap_AddTrap takes unit u returns nothing
 local unit Hero=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
 local integer Cache=GetHandleId(Hero)
 local integer TrapMax=(LoadInteger(hash_main,(Cache),(348)))
+call SaveReal(hash_main,(GetHandleId(u)),(786),(((TimerGetElapsed(udg_GameTimer)))*1.0))
 set TrapMax=TrapMax+1
 call SaveInteger(hash_main,(Cache),(7000+TrapMax),(TI_AddUnit(u)))
 call SaveInteger(hash_main,(Cache),(348),(TrapMax))
 if ControlBool[GetPlayerId(GetOwningPlayer(Hero))]then
 call SelectUnitAddForPlayer(u,GetOwningPlayer(Hero))
@@ -57581,19 +58803,33 @@
 set trap=null
 endfunction
 function WardenTrap_SlowUnits takes nothing returns nothing
 local unit Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),1697656901,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
 call UnitAddAbility2(Caster,abilityid_wardentrapslow)
+call SetUnitAbilityLevel(Caster,abilityid_wardentrapslow,wardentrapslow_level)
 call IssueTargetOrder(Caster,"slow",GetEnumUnit())
 call UnitAddAbility2(Caster,abilityid_wardentrapburn)
 set Caster=null
 endfunction
 function WardenTrap_ActivateMain takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local real x=GetUnitX(Source)
 local real y=GetUnitY(Source)
 local group g=GetAvailableGroup()
+local real Time=(LoadReal(hash_main,(GetHandleId(Source)),(786)))
+local real Delta=(TimerGetElapsed(udg_GameTimer))-Time
+local integer Level=1
+if Delta>4 then
+set Level=5
+elseif Delta>3 then
+set Level=4
+elseif Delta>2 then
+set Level=3
+elseif Delta>1 then
+set Level=2
+endif
+set wardentrapslow_level=Level
 call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",x,y))
 call GroupEnumUnitsInRange(g,x,y,400,Condition(function GenericCondition_EnemyUnits))
 call ForGroup(g,function WardenTrap_SlowUnits)
 call KillGroup(g)
 call WardenTrap_RemoveTrap(Source)
@@ -57726,11 +58962,11 @@
 local integer Cache=GetHandleId(t)
 local integer TargetIndex=(LoadInteger(hash_main,(Cache),(30)))
 local unit Target=TI_GetUnit(TargetIndex)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
-if GetEventDamageSource()==Source and GetEventDamage()>1 then
+if GetEventDamageSource()==Source and GetEventDamage()>1 and IsUnitIllusion(Target)==false then
 call DisableTrigger(t)
 call VorpalBlade_SuccessfulAttack(Source,Target,GetEventDamage(),(LoadReal(hash_main,(Cache),(349))),(LoadReal(hash_main,(Cache),(350))))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
@@ -58489,11 +59725,11 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function FocusFire_Main))
 set t=null
 endfunction
 function ThundergodWrath_Filter takes nothing returns boolean
-return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and GetUnitTypeId(GetFilterUnit())!=1211117642 and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(thundergodwrath_source))==true
+return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsGlobalHeroDummy(GetUnitTypeId(GetFilterUnit()))==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(thundergodwrath_source))==true
 endfunction
 function ThundergodWrath_Enum takes nothing returns nothing
 local real x=GetUnitX(GetEnumUnit())
 local real y=GetUnitY(GetEnumUnit())
 local unit caster=CreateUnit(GetOwningPlayer(thundergodwrath_source),1697656880,x,y,0)
@@ -58830,23 +60066,23 @@
 function BorrowedTime_Defend takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=GetTriggerUnit()
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_borrowedtime)
-local integer Duration
+local integer Duration=2+Level
 local real Mana
 if Level==0 then
-set Level=GetUnitAbilityLevel(Hero,abilityid_borrowedtimeupgrade)+2
+set Level=GetUnitAbilityLevel(Hero,abilityid_borrowedtimeupgrade)
+set Duration=4+1*Level
 endif
-set Duration=2+Level
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED and((LoadInteger(hash_main,(GetHandleId((Hero))),((4250))))==HERO_STATE_ON)then
 call PreventDamage(Hero,GetEventDamage())
 call PreventDamage(Hero,GetEventDamage())
 elseif(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and(GetSpellAbilityId()==abilityid_borrowedtime or GetSpellAbilityId()==abilityid_borrowedtimeupgrade))or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and((LoadInteger(hash_main,(GetHandleId((Hero))),((4251))))==HERO_STATE_ON)==false and GetUnitState(Hero,UNIT_STATE_LIFE)<400)then
-call TimerStart(CTimer[GetPlayerId(GetOwningPlayer(Hero))],60,false,null)
+call TimerStart(CTimer[GetPlayerId(GetOwningPlayer(Hero))],70-10*Level,false,null)
 call AddHeroState(Hero,4250,Duration)
-call AddHeroState(Hero,4251,60)
+call AddHeroState(Hero,4251,70-10*Level)
 call UnitRemoveBuffs(Hero,false,true)
 call StickyNapalm_SetSlow(Hero,0,0)
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
 call DisableTrigger(t)
 set borrowedtime_bypass_axe=true
@@ -59226,11 +60462,11 @@
 call TriggerAddCondition(t,Condition(function BerserkersCall_Main))
 set t=null
 endfunction
 function CounterHelix_Damage takes nothing returns nothing
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
-call DamageTarget(GetTriggerUnit(),GetEnumUnit(),DAMAGE_PHYSICAL,GetUnitAbilityLevel(GetTriggerUnit(),abilityid_counterhelix)*30+70)
+call DamageTarget(GetTriggerUnit(),GetEnumUnit(),DAMAGE_PHYSICAL,GetUnitAbilityLevel(GetTriggerUnit(),abilityid_counterhelix)*35+65)
 endfunction
 function CounterHelix takes nothing returns nothing
 local group g=GetAvailableGroup()
 local unit Hero=GetTriggerUnit()
 call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),300,Condition(function GenericCondition_EnemyUnitsWithAncients))
@@ -59317,13 +60553,17 @@
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local player p=(LoadPlayerHandle(hash_main,(Cache),(54)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local unit Caster
 if GetUnitAbilityLevel(Target,buffid_nightmare)==0 then
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare_helper,false)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetTriggerUnit()==Target then
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare_helper,false)
 call UnitRemoveAbility(Target,buffid_nightmare)
 set Caster=CreateUnit(p,1697656901,GetUnitX(Target),GetUnitY(Target),0)
 call UnitAddAbility2(Caster,abilityid_nightmare)
 call SetUnitAbilityLevel(Caster,abilityid_nightmare,Level)
 call IssueTargetOrder(Caster,"sleep",GetAttacker())
@@ -59331,10 +60571,12 @@
 call CleanTrigger(t)
 elseif GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
 if GetUnitState(Target,UNIT_STATE_LIFE)>21 then
 call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)-20)
 else
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare_helper,false)
 call UnitRemoveAbility(Target,buffid_nightmare)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,50)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
@@ -59357,10 +60599,15 @@
 call SavePlayerHandle(hash_main,(Cache),(54),(GetOwningPlayer(Source)))
 call SaveInteger(hash_main,(Cache),(5),(GetUnitAbilityLevel(Source,abilityid_nightmare)))
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
 call TriggerRegisterTimerEvent(t,1,true)
 call TriggerAddCondition(t,Condition(function Nightmare_Process))
+if GetUnitAbilityLevel(Target,abilityid_nightmare)>0 then
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare,false)
+call UnitAddAbility2(Target,abilityid_nightmare_helper)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),abilityid_nightmare_helper,true)
+endif
 set damageevent_valid=true
 call DamageTarget(Source,Target,DAMAGE_PHYSICAL,0)
 set damageevent_valid=false
 set Source=null
 set Target=null
@@ -59379,17 +60626,44 @@
 call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName(MSG_DISABLE_HELP_ON))
 endif
 endif
 return false
 endfunction
+function Nightmare_Cancel_Remove takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call UnitRemoveAbility(Source,buffid_nightmare)
+call UnitRemoveAbility(Source,abilityid_nightmare_helper)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_nightmare,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_nightmare_helper,false)
+set t=null
+set Source=null
+return false
+endfunction
+function Nightmare_Cancel takes nothing returns boolean
+local trigger t
+if GetIssuedOrderId()==String2OrderIdBJ("manashieldon")and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_nightmare_helper)>0 then
+set t=CreateTrigger()
+call TriggerRegisterTimerEvent(t,0,false)
+call TriggerAddCondition(t,Condition(function Nightmare_Cancel_Remove))
+call SaveUnitHandle(hash_main,(GetHandleId(t)),(2),(GetTriggerUnit()))
+endif
+return false
+endfunction
 function Register_Nightmare takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Nightmare_Main))
 set t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
 call TriggerAddCondition(t,Condition(function Nightmare_Precast))
+set t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
+call TriggerAddCondition(t,Condition(function Nightmare_Cancel))
 set t=null
 endfunction
 function FiendsGrip_Iterate takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
@@ -59397,11 +60671,11 @@
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local real Mana
 local integer Count=6
 local fogmodifier fog=(LoadFogModifierHandle(hash_main,(Cache),(42)))
 if GetUnitAbilityLevel(Source,abilityid_fiendsgripupgrade)>0 then
-set Count=7
+set Count=8
 endif
 if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
 call FogModifierStop(fog)
 call DestroyFogModifier(fog)
 call FlushChildHashtable(hash_main,(Cache))
@@ -59463,17 +60737,19 @@
 endfunction
 function Enfeeble_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
-if GetUnitAbilityLevel(Target,1110454852)==0 or GetTriggerEventId()==EVENT_UNIT_DEATH then
+local real EndTime=(LoadReal(hash_main,(GetHandleId(Target)),(789)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
+if GetTriggerEventId()==EVENT_WIDGET_DEATH or EndTime<(TimerGetElapsed(udg_GameTimer))then
 call UnitRemoveAbility(Target,enfeeble_1)
 call UnitRemoveAbility(Target,enfeeble_2)
 call UnitRemoveAbility(Target,enfeeble_3)
 call UnitRemoveAbility(Target,enfeeble_4)
+call UnitRemoveAbility(Target,enfeeble_buffid)
 endif
 set t=null
 set Target=null
 return false
 endfunction
@@ -59482,34 +60758,47 @@
 local integer Cache=GetHandleId(t)
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_enfeeble)
 if Level==1 then
-call UnitAddAbility2(Target,enfeeble_1)
+call UnitRemoveAbility(Target,enfeeble_buffid)
 call UnitRemoveAbility(Target,enfeeble_2)
 call UnitRemoveAbility(Target,enfeeble_3)
 call UnitRemoveAbility(Target,enfeeble_4)
+call UnitAddAbility2(Target,enfeeble_1)
+call UnitMakeAbilityPermanent(Target,true,enfeeble_1_real)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),enfeeble_1,false)
 elseif Level==2 then
-call UnitAddAbility2(Target,enfeeble_2)
+call UnitRemoveAbility(Target,enfeeble_buffid)
 call UnitRemoveAbility(Target,enfeeble_1)
 call UnitRemoveAbility(Target,enfeeble_3)
 call UnitRemoveAbility(Target,enfeeble_4)
+call UnitAddAbility2(Target,enfeeble_2)
+call UnitMakeAbilityPermanent(Target,true,enfeeble_2_real)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),enfeeble_2,false)
 elseif Level==3 then
-call UnitAddAbility2(Target,enfeeble_3)
+call UnitRemoveAbility(Target,enfeeble_buffid)
 call UnitRemoveAbility(Target,enfeeble_1)
 call UnitRemoveAbility(Target,enfeeble_2)
 call UnitRemoveAbility(Target,enfeeble_4)
+call UnitAddAbility2(Target,enfeeble_3)
+call UnitMakeAbilityPermanent(Target,true,enfeeble_3_real)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),enfeeble_3,false)
 elseif Level==4 then
-call UnitAddAbility2(Target,enfeeble_4)
+call UnitRemoveAbility(Target,enfeeble_buffid)
 call UnitRemoveAbility(Target,enfeeble_1)
 call UnitRemoveAbility(Target,enfeeble_2)
 call UnitRemoveAbility(Target,enfeeble_3)
+call UnitAddAbility2(Target,enfeeble_4)
+call UnitMakeAbilityPermanent(Target,true,enfeeble_4_real)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),enfeeble_4,false)
 endif
-call TriggerRegisterTimerEvent(t,1,true)
-call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
+call TriggerRegisterTimerEvent(t,20,false)
+call TriggerRegisterDeathEvent(t,Target)
 call TriggerAddCondition(t,Condition(function Enfeeble_End))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveReal(hash_main,(GetHandleId(Target)),(789),((19.9+(TimerGetElapsed(udg_GameTimer)))*1.0))
 set t=null
 set Source=null
 set Target=null
 endfunction
 function Enfeeble_Main takes nothing returns boolean
@@ -59546,11 +60835,11 @@
 if Count>0 and GetUnitAbilityLevel(GetEventDamageSource(),abilityid_stickynapalm)>0 and(LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(2)))==GetEventDamageSource()then
 call SaveBoolean(hash_main,(Cache),(280),(true))
 if firefly_active then
 call DestroyEffect(AddSpecialEffectTarget(stickynapalm_fx_explode,Target,"chest"))
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,0.5*(5+5*GetUnitAbilityLevel(Source,abilityid_stickynapalm))*Count)
-elseif(GetEventDamage()>33 and IsUnitType(Target,UNIT_TYPE_HERO)==true)or(GetEventDamage()>40 and IsUnitType(Target,UNIT_TYPE_HERO)==false)then
+elseif(GetEventDamage()>34 and IsUnitType(Target,UNIT_TYPE_HERO)==true)or(GetEventDamage()>45 and IsUnitType(Target,UNIT_TYPE_HERO)==false)then
 call DestroyEffect(AddSpecialEffectTarget(stickynapalm_fx_explode,Target,"chest"))
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,(5+5*GetUnitAbilityLevel(Source,abilityid_stickynapalm))*Count)
 endif
 call SaveBoolean(hash_main,(Cache),(280),(false))
 endif
@@ -59940,11 +61229,11 @@
 local real LastY=(LoadReal(hash_main,(Cache),(24)))
 local integer Count=(LoadInteger(hash_main,(Cache),(34)))
 local integer i
 local real x
 local real y
-if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>300 then
+if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>360 then
 set i=0
 loop
 exitwhen i>Count
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(2700+i))))
 set i=i+1
@@ -59978,11 +61267,10 @@
 function Firefly takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 call TriggerRegisterTimerEvent(t,0.05,true)
-call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Firefly_Move))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveEffectHandle(hash_main,(Cache),(2700),(AddSpecialEffect(firefly_fx,GetUnitX(Source),GetUnitY(Source))))
 call SaveReal(hash_main,(Cache),(23),((GetUnitX(Source))*1.0))
 call SaveReal(hash_main,(Cache),(24),((GetUnitY(Source))*1.0))
@@ -60169,11 +61457,11 @@
 return false
 endfunction
 function Bloodbath_Search takes unit Source,unit Target,integer Level returns nothing
 local group g=GetAvailableGroup()
 set bloodbath_target=Target
-call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),250,Condition(function Bloodbath_Find))
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350,Condition(function Bloodbath_Find))
 call KillGroup(g)
 set bloodbath_target=null
 set g=null
 endfunction
 function Bloodbath_Main takes nothing returns boolean
@@ -60290,21 +61578,24 @@
 set Caster=null
 endif
 endif
 endfunction
 function Thirst_RemoveUnit takes nothing returns nothing
-if IsDead(thirst_source)==true or IsUnitInGroup(GetEnumUnit(),thirst_tempgroup)==false or GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)>0.4 or(GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)>0.2 and GenericCondition_IsDotAInvis(GetEnumUnit())==true)then
+local real rate=thirst_level*0.1+0.1
+if IsDead(thirst_source)==true or IsUnitInGroup(GetEnumUnit(),thirst_tempgroup)==false or GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)>rate or(GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)>rate/2 and GenericCondition_IsDotAInvis(GetEnumUnit())==true)then
 call GroupRemoveUnit(thirst_group,GetEnumUnit())
 call UnitShareVision(GetEnumUnit(),GetOwningPlayer(thirst_source),false)
 call UnitRemoveAbility(GetEnumUnit(),thirst_reveal_buffid)
 endif
 endfunction
 function Thirst_AddUnit takes nothing returns nothing
+local real rate
 if IsDead(thirst_source)==false and IsUnitInGroup(GetEnumUnit(),thirst_group)==false and IsUnitIllusion(GetEnumUnit())==false then
-if GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)<0.4 and GenericCondition_IsDotAInvis(GetEnumUnit())==false then
+set rate=thirst_level*0.1+0.1
+if GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)<rate and GenericCondition_IsDotAInvis(GetEnumUnit())==false then
 call GroupAddUnit(thirst_group,GetEnumUnit())
-elseif GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)<0.2 then
+elseif GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)/GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)<rate/2 then
 call GroupAddUnit(thirst_group,GetEnumUnit())
 endif
 endif
 endfunction
 function Thirst_Loop takes nothing returns boolean
@@ -60316,11 +61607,11 @@
 local integer Level=GetUnitAbilityLevel(Source,abilityid_thirst)
 set tt_unit1=Source
 set thirst_source=Source
 set thirst_group=AffectedGroup
 set thirst_level=Level
-call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+1500*Level,Condition(function GenericCondition_EnemyHeroesEx))
+call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+6000,Condition(function GenericCondition_EnemyHeroesEx))
 call ForGroup(g,function Thirst_AddUnit)
 set thirst_tempgroup=g
 call ForGroup(thirst_group,function Thirst_RemoveUnit)
 call ForGroup(thirst_group,function Thirst_RevealUnit)
 if FirstOfGroup(thirst_group)==null then
@@ -60605,63 +61896,74 @@
 function ChaosBolt_Hit takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 local real Damage=(LoadReal(hash_main,(Cache),(20)))
+local integer Duration=(LoadInteger(hash_main,(Cache),(188)))
+local texttag tt
+if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+elseif GetEventDamageSource()==Caster then
+set tt=CreateTextTag()
+call TextTagOnUnitEx(I2S(Duration),Duration,Target,0.03,127,127,255,255)
+call SetTextTagText(tt,"+"+I2S(R2I(Damage)),0.025)
+call SetTextTagPosUnit(tt,Target,10)
+call SetTextTagColor(tt,255,0,0,255)
+call SetTextTagVelocity(tt,0,0.0355)
+call SetTextTagFadepoint(tt,2)
+call SetTextTagPermanent(tt,false)
+call SetTextTagLifespan(tt,2)
+if IsUnitVisible(Target,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
+call SetTextTagVisibility(tt,true)
+else
+call SetTextTagVisibility(tt,false)
+endif
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,Damage)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
+endif
 set t=null
 set Source=null
 set Target=null
+set tt=null
 return false
 endfunction
 function Trig_chaos_bolt_Actions takes nothing returns nothing
-local location PointVar=GetUnitLoc(GetSpellTargetUnit())
 local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),1093678389)
 local integer randomduration=GetRandomInt(1,Level+1)
 local unit UnitVar=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
+local location PointVar=GetUnitLoc(UnitVar)
 local real Damage=GetRandomReal(1,200)
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-local texttag tt=CreateTextTag()
+local unit Caster=CreateUnit(GetOwningPlayer(UnitVar),1697656901,GetUnitX(UnitVar),GetUnitY(UnitVar),0)
 if Level==2 then
 set Damage=GetRandomReal(50,225)
 elseif Level==3 then
 set Damage=GetRandomReal(75,250)
 elseif Level==4 then
 set Damage=GetRandomReal(100,275)
 endif
-call TriggerRegisterTimerEvent(t,DistanceBetweenUnits(UnitVar,Target)/1500,false)
+call TriggerRegisterTimerEvent(t,10,false)
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
 call TriggerAddCondition(t,Condition(function ChaosBolt_Hit))
 call SaveUnitHandle(hash_main,(Cache),(2),(UnitVar))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 call SaveReal(hash_main,(Cache),(20),((Damage)*1.0))
 if(Level==4)then
 set randomduration=GetRandomInt(2,4)
 endif
-call CreateNUnitsAtLoc(1,1697656901,GetOwningPlayer(UnitVar),PointVar,bj_UNIT_FACING)
-call UnitAddAbility2(GetLastCreatedUnit(),1093678165)
-call SetUnitAbilityLevel(GetLastCreatedUnit(),1093678165,randomduration)
-call IssueTargetOrder(GetLastCreatedUnit(),"thunderbolt",Target)
-call TextTagOnUnitEx(I2S(randomduration),randomduration,Target,0.03,127,127,255,255)
-call SetTextTagText(tt,"+"+I2S(R2I(Damage)),0.025)
-call SetTextTagPosUnit(tt,Target,10)
-call SetTextTagColor(tt,255,0,0,255)
-call SetTextTagVelocity(tt,0,0.0355)
-call SetTextTagFadepoint(tt,2)
-call SetTextTagPermanent(tt,false)
-call SetTextTagLifespan(tt,2)
-if IsUnitVisible(Target,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
-call SetTextTagVisibility(tt,true)
-else
-call SetTextTagVisibility(tt,false)
-endif
+call SaveInteger(hash_main,(Cache),(188),(randomduration))
+call UnitAddAbility2(Caster,1093678165)
+call SetUnitAbilityLevel(Caster,1093678165,randomduration)
+call IssueTargetOrder(Caster,"thunderbolt",Target)
 set t=null
-set tt=null
 endfunction
 function Chaos takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Trig_chaos_bolt_Conditions))
@@ -61020,11 +62322,11 @@
 endfunction
 function AstralImprisonment takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_astralimprisonment)
-local integer StolenInt=IMin(GetHeroInt(Target,false),Level*2)
+local integer StolenInt=IMin(GetHeroInt(Target,false),2+Level*2)
 local trigger t
 local integer Cache
 local unit Caster=CreateUnit(GetOwningPlayer(Target),1865429305,GetUnitX(Target),GetUnitY(Target),0)
 call UnitApplyTimedLife(Caster,1112820806,Level+1)
 if(IsUnitEnemy(Target,GetOwningPlayer(Source)))==false or IsBlocked(GetSpellTargetUnit())==false then
@@ -61211,10 +62513,13 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function IonShell))
 set t=null
 endfunction
+function Vacuum_Ignore takes unit u returns boolean
+return GetUnitAbilityLevel(u,songofthesiren_buffid1)>0 or GetUnitAbilityLevel(u,songofthesiren_buffid2)>0 or GetUnitAbilityLevel(u,songofthesiren_buffid3)>0 or IsCycloned(u)
+endfunction
 function Vacuum_Iterate takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local real x=(LoadReal(hash_main,(Cache),(6)))
 local real y=(LoadReal(hash_main,(Cache),(7)))
@@ -61254,35 +62559,39 @@
 endif
 set t=null
 return false
 endfunction
 function Vacuum_Add takes nothing returns nothing
-local trigger t=CreateTrigger()
-local integer Cache=GetHandleId(t)
+local trigger t
+local integer Cache
 local unit Source=GetTriggerUnit()
 local unit Target=GetEnumUnit()
+if Vacuum_Ignore(Target)==false then
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerRegisterTimerEvent(t,0.025,true)
 call TriggerAddCondition(t,Condition(function Vacuum_Iterate))
 call SaveReal(hash_main,(Cache),(6),((vacuum_x)*1.0))
 call SaveReal(hash_main,(Cache),(7),((vacuum_y)*1.0))
 call SaveReal(hash_main,(Cache),(138),((DistanceBetweenXY(vacuum_x,vacuum_y,GetUnitX(Target),GetUnitY(Target)))*1.0))
 call SaveReal(hash_main,(Cache),(137),((Atan2(vacuum_y-GetUnitY(Target),vacuum_x-GetUnitX(Target)))*1.0))
 call SaveInteger(hash_main,(Cache),(5),(vacuum_level))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+endif
 set t=null
 set Source=null
 set Target=null
 endfunction
 function Vacuum_Main takes nothing returns nothing
 local group g=GetAvailableGroup()
 local location l=GetSpellTargetLoc()
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
 local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),abilityid_vacuum)
-local real r=200+100*Level
+local real r=150+100*Level+25
 set tt_unit1=GetTriggerUnit()
 call PlaySoundAtPos(gg_snd_Vacuum,x,y)
 call DestroyEffect(AddSpecialEffect("war3mapImported\\Star Aura.mdx",x,y))
 call GroupEnumUnitsInRange(g,x,y,r,Condition(function GenericCondition_EnemyUnitsNoImmune))
 set vacuum_x=x
@@ -61388,11 +62697,11 @@
 set Target=null
 return false
 endfunction
 function WallOfReplica_Detected takes nothing returns boolean
 local group g
-if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(259)))))and(GetUnitTypeId((GetFilterUnit()))==1211117642)==false then
+if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(259)))))and IsGlobalHeroDummy(GetUnitTypeId(GetFilterUnit()))==false then
 set g=(LoadGroupHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(257)))
 if IsUnitInGroup(GetFilterUnit(),g)==false then
 call GroupAddUnit(g,GetFilterUnit())
 call WallOfReplica_Detected_Main(false)
 endif
@@ -61400,11 +62709,11 @@
 set g=null
 return false
 endfunction
 function WallOfReplica_Detected_Scepter takes nothing returns boolean
 local group g
-if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(259)))))and(GetUnitTypeId((GetFilterUnit()))==1211117642)==false then
+if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(259)))))and IsGlobalHeroDummy(GetUnitTypeId(GetFilterUnit()))==false then
 set g=(LoadGroupHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(257)))
 if IsUnitInGroup(GetFilterUnit(),g)==false then
 call GroupAddUnit(g,GetFilterUnit())
 call WallOfReplica_Detected_Main(true)
 endif
@@ -61532,10 +62841,13 @@
 loop
 exitwhen i>39
 set newx=x+(500-25*i)*Cos((direction-45)*bj_DEGTORAD)
 set newy=y+(500-25*i)*Sin((direction-45)*bj_DEGTORAD)
 set u=CreateUnit(GetOwningPlayer(Hero),abilityid_wallofreplicaunitpath,newx,newy,direction)
+call SetUnitPathing(u,false)
+call SetUnitX(u,newx)
+call SetUnitY(u,newy)
 call GroupAddUnit(g2,u)
 call TriggerRegisterUnitInRange(t,u,17,Condition(function GenericCondition_True))
 set i=i+1
 endloop
 if Scepter then
@@ -61605,17 +62917,17 @@
 local unit Target=GetEnumUnit()
 local integer Lost
 local integer Level=decay_level
 local trigger t
 local integer Cache
-if IsUnitType(Target,UNIT_TYPE_HERO)==true and GetUnitTypeId(Target)!=1211117642 then
+if IsUnitType(Target,UNIT_TYPE_HERO)==true and IsGlobalHeroDummy(GetUnitTypeId(Target))==false then
 set Lost=IMinBJ(GetHeroStr(Target,false)-1,4)
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call SetHeroStr(Source,GetHeroStr(Source,false)+Lost,true)
 call SetHeroStr(Target,GetHeroStr(Target,false)-Lost,true)
-call TriggerRegisterTimerEvent(t,18+3*Level,false)
+call TriggerRegisterTimerEvent(t,20+5*Level,false)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Decay_Expire))
 call SaveBoolean(hash_main,(Cache),(276),(false))
 call SaveBoolean(hash_main,(Cache),(277),(false))
@@ -61642,11 +62954,11 @@
 call DestroyEffect(AddSpecialEffect("effects\\DecayGreen_Groundonly_1.mdx",x,y))
 call RemoveLocation(l)
 set tt_unit1=Source
 set decay_source=Source
 set decay_level=Level
-call GroupEnumUnitsInRange(g,x,y,325,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call GroupEnumUnitsInRange(g,x,y,325+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
 call ForGroup(g,function Decay_Add)
 call KillGroup(g)
 call KillUnit(Caster)
 set Source=null
 set l=null
@@ -61730,10 +63042,12 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local integer TargetIndex=(LoadInteger(hash_main,(Cache),(30)))
 local unit Target=TI_GetUnit(TargetIndex)
 local unit Zombie=(LoadUnitHandle(hash_main,(Cache),(269)))
+local real CurrentLife=GetUnitState(Target,UNIT_STATE_LIFE)
+local real MaxLife=GetUnitState(Target,UNIT_STATE_MAX_LIFE)
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call TI_ClearUnit(TargetIndex)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 if GetTriggerUnit()==Target then
@@ -61746,11 +63060,11 @@
 call PauseUnit(Zombie,true)
 elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
 call DisableTrigger(t)
 call IssueTargetOrder(Zombie,"attack",Target)
 call EnableTrigger(t)
-elseif GetUnitState(Target,UNIT_STATE_LIFE)<(100*tombstone_level)and GetUnitAbilityLevel(Zombie,buffid_tombstonebonus)==0 then
+elseif(CurrentLife<(100*tombstone_level)or CurrentLife/MaxLife<(0.05*tombstone_level))and GetUnitAbilityLevel(Zombie,buffid_tombstonebonus)==0 then
 call IssueTargetOrder(tombstone_caster[GetPlayerId(GetOwningPlayer(Zombie))],"bloodlust",Zombie)
 elseif IsUnitVisible(Target,GetOwningPlayer(Zombie))==false then
 if(LoadBoolean(hash_main,(Cache),(270)))==true then
 if(LoadBoolean(hash_main,(Cache),(271)))==true then
 if(LoadBoolean(hash_main,(Cache),(272)))==true then
@@ -62168,12 +63482,12 @@
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_timewalk)
 if DistanceBetweenXY(x,y,x2,y2)<=timewalk_rate then
 set x=x2
 set y=y2
 else
-set x=LastX+65*Cos(a*bj_DEGTORAD)
-set y=LastY+65*Sin(a*bj_DEGTORAD)
+set x=SafeX(LastX+65*Cos(a*bj_DEGTORAD))
+set y=SafeY(LastY+65*Sin(a*bj_DEGTORAD))
 endif
 if Level==1 then
 set timewalk_slowability=timewalk_slow_1
 elseif Level==2 then
 set timewalk_slowability=timewalk_slow_2
@@ -62235,12 +63549,12 @@
 call SetUnitAnimationByIndex(Hero,0)
 call SetUnitPathing(Hero,false)
 call SetUnitInvulnerable(Hero,true)
 call SetUnitVertexColor(Hero,0,0,0,255)
 call SaveInteger(hash_main,(GetHandleId((Hero))),((4261)),(HERO_STATE_ON))
-call SaveReal(hash_main,(Cache),(66),((x2)*1.0))
-call SaveReal(hash_main,(Cache),(67),((y2)*1.0))
+call SaveReal(hash_main,(Cache),(66),((SafeX(x2))*1.0))
+call SaveReal(hash_main,(Cache),(67),((SafeY(y2))*1.0))
 call SaveReal(hash_main,(Cache),(23),((x1)*1.0))
 call SaveReal(hash_main,(Cache),(24),((y1)*1.0))
 call SaveReal(hash_main,(Cache),(137),((a)*1.0))
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
@@ -62310,27 +63624,31 @@
 call FlushChildHashtable(hash_main,(Cache))
 call DestroyTimer(t)
 endfunction
 function Chronosphere_IsUnitException takes unit whichUnit returns boolean
 local integer ID=GetUnitTypeId(whichUnit)
-return ID==1869836340 or ID==1865429048 or ID==1865429049 or ID==1700946284 or ID==1697657398 or ID==1970107511 or ID==1966092370
+return ID==1869836340 or ID==1865429048 or ID==1865429049 or ID==1700946284 or ID==1697657398 or ID==1970107511 or ID==1966092370 or ID==1162032181
 endfunction
 function Chronosphere_WhichUnits takes nothing returns boolean
 return GetOwningPlayer(GetFilterUnit())!=GetOwningPlayer(udg_TempUnit)and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 or Chronosphere_IsUnitException(GetFilterUnit()))
 endfunction
 function Chronosphere_Pause takes nothing returns nothing
+if GetUnitTypeId(GetEnumUnit())!=1162032181 then
 call PauseUnit(GetEnumUnit(),true)
 call SetUnitTimeScale(GetEnumUnit(),0)
 call UnitRemoveAbility(GetEnumUnit(),1112896364)
 call UnitRemoveAbility(GetEnumUnit(),1112896368)
 call UnitRemoveAbility(GetEnumUnit(),1112896372)
 call SaveInteger(hash_main,(GetHandleId((GetEnumUnit()))),((4306)),(HERO_STATE_ON))
+endif
 endfunction
 function Chronosphere_Unpause takes nothing returns nothing
+if GetUnitTypeId(GetEnumUnit())!=1162032181 then
 call SaveInteger(hash_main,(GetHandleId((GetEnumUnit()))),((4306)),(HERO_STATE_OFF))
 call PauseUnit(GetEnumUnit(),false)
 call SetUnitTimeScale(GetEnumUnit(),1)
+endif
 endfunction
 function Chronosphere_PauseUnits takes nothing returns nothing
 local timer t=GetExpiredTimer()
 local integer Cache=GetHandleId(t)
 local unit Sphere=(LoadUnitHandle(hash_main,(Cache),(19)))
@@ -62420,10 +63738,13 @@
 call SaveInteger(hash_main,(GetHandleId((Source))),((4280)),(HERO_STATE_ON))
 call TriggerRegisterTimerEvent(t,0.1,true)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function TimeLock_FX))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+if((LoadInteger(hash_main,(GetHandleId((Source))),((4306))))==HERO_STATE_ON)==true then
+call DamageTarget(timelock_source,Source,DAMAGE_MAGICAL,30+10*GetUnitAbilityLevel(timelock_source,abilityid_timelock))
+endif
 set t=null
 endfunction
 function TimeLock_FindUnitsToLock takes nothing returns boolean
 if GetUnitAbilityLevel(GetFilterUnit(),buffid_timelock)>0 and((LoadInteger(hash_main,(GetHandleId((GetFilterUnit()))),((4280))))==HERO_STATE_ON)==false then
 call TimeLock_RegisterUnit(GetFilterUnit())
@@ -62445,11 +63766,11 @@
 endfunction
 function TimeLock takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call TriggerRegisterTimerEvent(t,0.25,true)
+call TriggerRegisterTimerEvent(t,0.1,true)
 call TriggerAddCondition(t,Condition(function TimeLock_Loop))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 set t=null
 set Source=null
 endfunction
@@ -62915,11 +64236,11 @@
 call TriggerAddCondition(t,Condition(function Invoke4_Learn))
 call DelayedPreloadAbility(abilityid_invoke4_slow,GetRandomReal(1,25))
 set t=null
 endfunction
 function Invoke5_Effect takes unit Source,unit Target,integer WexLevel returns nothing
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 call UnitAddAbility2(Caster,abilityid_invoke5_effect)
 call SetUnitAbilityLevel(Caster,abilityid_invoke5_effect,WexLevel)
 call IssueTargetOrder(Caster,"drunkenhaze",Target)
 set Caster=null
 endfunction
@@ -64315,14 +65636,14 @@
 endfunction
 function Trap_Condition takes nothing returns boolean
 return GetSpellAbilityId()==(1093684802)
 endfunction
 function Trap_WhichUnits takes nothing returns boolean
-return IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(udg_TempUnit))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(udg_TempUnit))==true and GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>0.5 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and GetUnitTypeId(GetFilterUnit())!=1848651852
+return IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(udg_TempUnit))and(GenericCondition_IsDotAInvis(GetFilterUnit())==false or IsUnitVisible(GetFilterUnit(),GetOwningPlayer(udg_TempUnit))==true)and GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>0.5 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and GetUnitTypeId(GetFilterUnit())!=1848651852
 endfunction
 function Trap_EnsnareCast takes nothing returns nothing
-local unit Caster=CreateUnit(GetOwningPlayer(udg_TempUnit),1697656901,udg_TempReal,udg_TempReal2,0)
+local unit Caster=CreateUnit(GetOwningPlayer(GetEnumUnit()),1697656901,udg_TempReal,udg_TempReal2,0)
 call UnitAddAbility2(Caster,(1093684803))
 call IssueTargetOrder(Caster,"ensnare",GetEnumUnit())
 endfunction
 function Trap_Ensnare takes unit Projectile,real x,real y returns nothing
 local boolexpr CondVar=Condition(function Trap_WhichUnits)
@@ -64457,14 +65778,20 @@
 local integer AgilityBonus=GetHeroAgi(Kobold0,true)-Agility-AbilityBonuses
 local integer Strength=GetHeroStr(Kobold0,false)
 local integer StrengthBonus=GetHeroStr(Kobold0,true)-Strength-AbilityBonuses
 local integer Intelligence=GetHeroInt(Kobold0,false)
 local integer IntelligenceBonus=GetHeroInt(Kobold0,true)-Intelligence-AbilityBonuses
-local real AttributeFactor=0.25
-local integer NewAgility=R2I(Agility+AgilityBonus*AttributeFactor)
-local integer NewStrength=R2I(Strength+StrengthBonus*AttributeFactor)
-local integer NewIntelligence=R2I(Intelligence+IntelligenceBonus*AttributeFactor)
+local real AttributeFactor=0.3
+local integer NewAgility
+local integer NewStrength
+local integer NewIntelligence
+if dividedwestand_usedscepter then
+set AttributeFactor=1.0
+endif
+set NewAgility=R2I(Agility+AgilityBonus*AttributeFactor)
+set NewStrength=R2I(Strength+StrengthBonus*AttributeFactor)
+set NewIntelligence=R2I(Intelligence+IntelligenceBonus*AttributeFactor)
 if GetUnitState(Kobold0,UNIT_STATE_LIFE)>1 then
 if Kobold1!=null then
 call SetHeroAgi(Kobold1,NewAgility,false)
 call SetHeroStr(Kobold1,NewStrength,false)
 call SetHeroInt(Kobold1,NewIntelligence,false)
@@ -65497,35 +66824,44 @@
 endfunction
 function Shapeshift_Expire takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
+if GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call KillUnit(Caster)
+endif
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
 call UnitRemoveAbility(Hero,1093687875)
 call UnitRemoveAbility(Hero,1110454358)
 set t=null
 set Hero=null
+set Caster=null
 return false
 endfunction
 function Shapeshift_Delayed takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerRegisterTimerEvent(t,18-0.1,false)
+call TriggerRegisterDeathEvent(t,Hero)
 call TriggerAddCondition(t,Condition(function Shapeshift_Expire))
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 set t=null
 set Hero=null
+set Caster=null
 return false
 endfunction
 function Shapeshift takes nothing returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
@@ -65536,10 +66872,11 @@
 call UnitApplyTimedLife(Caster,1112820806,Duration)
 call FadeUnitTimed(Hero,Duration,175)
 call TriggerRegisterTimerEvent(t,0.1,false)
 call TriggerAddCondition(t,Condition(function Shapeshift_Delayed))
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 set t=null
 set Hero=null
 endfunction
 function Shapeshift_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_shapeshift and GetUnitTypeId(GetTriggerUnit())==1429221432 then
@@ -65687,12 +67024,13 @@
 function LevelDeath takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_leveldeath)
 local integer TargetLevel=GetHeroLevel(Target)
+local real Damage=GetUnitState(Target,UNIT_STATE_MAX_LIFE)*0.2
 if ModuloInteger(TargetLevel,7-Level)==0 or TargetLevel==25 then
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,275)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,Damage)
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\DemonBoltImpact\\DemonBoltImpact.mdl",Target,"chest"))
 endif
 set Source=null
 set Target=null
 endfunction
@@ -65822,11 +67160,11 @@
 if IsUnitVisible(Hero,GetLocalPlayer())==false and IsObserver(GetLocalPlayer())==false then
 set visible=false
 endif
 call SetTextTagVisibility(tt,visible)
 if NewHP==0 then
-call GiveGoldWithEffect(GetOwningPlayer(Hero),Hero,20+20*Level)
+call GiveGoldWithEffect(GetOwningPlayer(Hero),Hero,25*Level)
 endif
 if NewHP==0 or GetTriggerEventId()==EVENT_UNIT_DEATH then
 call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),abilityid_devour,true)
 call UnitRemoveAbility(Hero,abilityid_devourdisabled)
 call FlushChildHashtable(hash_main,(Cache))
@@ -65881,12 +67219,10 @@
 local unit Hero=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_devour)
 local integer UnitLevel=GetUnitLevel(Target)
 if(GetOwningPlayer(Target)!=udg_SentPlayers[0]and GetOwningPlayer(Target)!=udg_ScourgePlayers[0])and((Level==1 and UnitLevel>2)or(Level==2 and UnitLevel>4)or(Level==3 and UnitLevel>5)or(Level==4 and UnitLevel>6))then
-call InterruptUnit(Hero)
-call Error(GetOwningPlayer(Hero),GetObjectName(MSG_DEVOUR_INVALID))
 endif
 set Hero=null
 set Target=null
 endfunction
 function Devoure_Finalize takes nothing returns boolean
@@ -66093,11 +67429,11 @@
 endfunction
 function Skewer_Hit takes unit Source,unit Target,integer Level returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 call SetUnitPathing(Target,true)
-call TriggerRegisterTimerEvent(t,2,false)
+call TriggerRegisterTimerEvent(t,2.5,false)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Skewer_SlowEnd))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call UnitAddAbility2(Target,skewer_slow)
 call UnitMakeAbilityPermanent(Target,true,skewer_slow)
@@ -66136,11 +67472,11 @@
 call SetUnitAnimationByIndex(Source,3)
 endif
 if U01==null or U02==null or U03==null or U04==null then
 set tt_unit1=Source
 set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,NewX,NewY,120,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,NewX,NewY,125+25,Condition(function GenericCondition_EnemyHeroesEx))
 if FirstOfGroup(g)!=null then
 if U01!=null then
 call GroupRemoveUnit(g,U01)
 endif
 if U02!=null then
@@ -66272,13 +67608,13 @@
 local unit Source=GetTriggerUnit()
 local real SourceX=GetUnitX(Source)
 local real SourceY=GetUnitY(Source)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_skewer)
 local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)*bj_DEGTORAD
-if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>825 then
-set TargetX=SafeX2(SourceX+825*Cos(a))
-set TargetY=SafeY2(SourceY+825*Sin(a))
+if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>1225 then
+set TargetX=SafeX2(SourceX+1225*Cos(a))
+set TargetY=SafeY2(SourceY+1225*Sin(a))
 endif
 call SetUnitPathing(Source,false)
 call SetUnitAnimationByIndex(Source,3)
 call SetUnitTimeScale(Source,1.5)
 call TriggerRegisterTimerEvent(t,0.02,true)
@@ -66323,11 +67659,11 @@
 endfunction
 function MysticSnake_DoNothing takes nothing returns nothing
 endfunction
 function MysticSnake_WhichUnits takes nothing returns boolean
 local real d
-if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(mysticsnake_last))==true and IsUnitInGroup(GetFilterUnit(),mysticsnake_group)==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(mysticsnake_source))==true then
+if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(mysticsnake_last))==true and IsUnitInGroup(GetFilterUnit(),mysticsnake_group)==false and GenericCondition_IsInvisibleToMe(GetFilterUnit(),GetOwningPlayer(mysticsnake_source))==true then
 set d=DistanceBetweenXY(GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()),GetUnitX(mysticsnake_last),GetUnitY(mysticsnake_last))
 if d<mysticsnake_distance then
 set mysticsnake_unit=GetFilterUnit()
 set mysticsnake_distance=d
 endif
@@ -66369,15 +67705,15 @@
 call KillUnit(Caster)
 call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
-if IsUnitVisible(Target,GetOwningPlayer(Caster))==true then
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,(40+40*Level)+0.2*DmgCounter*(40+40*Level))
+if GenericCondition_IsDotAInvis(Target)==false or IsUnitVisible(Target,GetOwningPlayer(Caster))==true then
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,(40+40*Level)+0.25*DmgCounter*(40+40*Level))
 set DmgCounter=DmgCounter+1
 if GetUnitState(Target,UNIT_STATE_MANA)>0 then
-set Mana=RMinBJ(GetUnitState(Target,UNIT_STATE_MANA),(10+10*Level)+0.2*ManaCounter*(10+10*Level))
+set Mana=RMinBJ(GetUnitState(Target,UNIT_STATE_MANA),(10+10*Level)+0.25*ManaCounter*(10+10*Level))
 call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-Mana)
 call PlaySoundAtPos(gg_snd_MysticSnakeHit,GetUnitX(Target),GetUnitY(Target))
 set StolenMana=StolenMana+Mana
 set ManaCounter=ManaCounter+1
 endif
@@ -66699,11 +68035,11 @@
 local integer Cache=GetHandleId(t)
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local unit Hero=(LoadUnitHandle(hash_main,(Cache),(14)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
-if GetTriggerEventId()==EVENT_UNIT_DEATH then
+if GetTriggerEventId()==EVENT_WIDGET_DEATH then
 call UnitShareVision(Target,GetOwningPlayer(Hero),false)
 call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
 call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
 call PauseUnit(Hero,false)
 call ShowUnit(Hero,true)
@@ -66805,11 +68141,11 @@
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(fx2,Target,"overhead")))
 call SaveEffectHandle(hash_main,(Cache),(177),(AddSpecialEffectTarget(fx3,Target,"overhead")))
 call SaveInteger(hash_main,(Cache),(5),(GetUnitAbilityLevel(Hero,abilityid_snatch)))
-call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
+call TriggerRegisterDeathEvent(t,Target)
 call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(Hero),EVENT_PLAYER_UNIT_SELECTED,Condition(function GenericCondition_True))
 call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
 call TriggerRegisterTimerEvent(t,0.2,true)
 call TriggerAddCondition(t,Condition(function Snatch_Execute))
 call SaveInteger(hash_main,(GetHandleId((Hero))),((4310)),(HERO_STATE_ON))
@@ -66870,11 +68206,11 @@
 call SetUnitAbilityLevel(Hero,abilityid_rageias,Level)
 call StickyNapalm_SetSlow(Hero,0,0)
 call SaveUnitHandle(hash_main,(Cache),(14),(Hero))
 call SaveEffectHandle(hash_main,(Cache),(175),(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"right hand")))
 call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"left hand")))
-call TriggerRegisterTimerEvent(t,1.75+0.75*Level,false)
+call TriggerRegisterTimerEvent(t,2+Level,false)
 call TriggerAddCondition(t,Condition(function Rage_Expire))
 set Hero=null
 set t=null
 endfunction
 function Rage_Main takes nothing returns boolean
@@ -66971,11 +68307,11 @@
 function Heartstopper_Damage takes nothing returns nothing
 local unit Target=GetEnumUnit()
 local unit Source=heartstopper_source
 local real CurrentHP=GetUnitState(Target,UNIT_STATE_LIFE)
 local real MaxHP=GetUnitState(Target,UNIT_STATE_MAX_LIFE)
-local real HPLoss=((0.004+0.002*heartstopper_level)*MaxHP)/2
+local real HPLoss=((0.003+0.003*heartstopper_level)*MaxHP)/2
 if CurrentHP<HPLoss then
 call SetUnitState(Target,UNIT_STATE_LIFE,1)
 call DamageTarget(Source,Target,DAMAGE_PURE,100)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,100)
 call DamageTarget(Source,Target,DAMAGE_PHYSICAL,100)
@@ -67022,36 +68358,62 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
 call TriggerAddCondition(t,Condition(function Heartstopper_Main))
 set t=null
 endfunction
-function Trig_Sadist_Conditions takes nothing returns boolean
-if(not(UnitHasBuffBJ(GetKillingUnitBJ(),1110454866)==true))then
-return false
+function Sadist_Restore takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_sadist)
+local real ManaRegen=2*Level
+local real HPRegen=Level
+local integer Factor=(LoadInteger(hash_main,(Cache),(34)))
+if Level==4 then
+set ManaRegen=10
 endif
-return true
+set HPRegen=HPRegen*Factor
+set ManaRegen=ManaRegen*Factor
+call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+ManaRegen)
+call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)+HPRegen)
+if GetTriggerEvalCount(t)>5 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+set t=null
+set Source=null
+return false
 endfunction
-function Trig_Sadist_Actions takes nothing returns nothing
-local real mana
-local integer Level
-call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",GetKillingUnit(),"origin"))
-if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and GetUnitAbilityLevel(GetKillingUnit(),1093678640)==4 then
-call SetUnitState(GetKillingUnit(),UNIT_STATE_MANA,GetUnitState(GetKillingUnit(),UNIT_STATE_MANA)+600)
+function Sadist takes nothing returns nothing
+local unit Source=GetKillingUnit()
+local integer Level=GetUnitAbilityLevel(Source,abilityid_sadist)
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Source,"origin"))
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerRegisterDeathEvent(t,Source)
+call TriggerAddCondition(t,Condition(function Sadist_Restore))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true then
+call SaveInteger(hash_main,(Cache),(34),(10))
 else
-set Level=GetUnitAbilityLevelSwapped(1093678640,GetKillingUnitBJ())
-set mana=12*Level
-if Level==4 then
-set mana=60
+call SaveInteger(hash_main,(Cache),(34),(1))
 endif
-call SetUnitManaBJ(GetKillingUnitBJ(),(GetUnitStateSwap(UNIT_STATE_MANA,GetKillingUnitBJ())+mana))
+set Source=null
+set t=null
+endfunction
+function Sadist_Main takes nothing returns boolean
+if GetUnitAbilityLevel(GetKillingUnit(),buffid_sadist)>0 then
+call Sadist()
 endif
+return false
 endfunction
-function Sadist takes nothing returns nothing
+function Register_Sadist takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
-call TriggerAddCondition(t,Condition(function Trig_Sadist_Conditions))
-call TriggerAddAction(t,function Trig_Sadist_Actions)
+call TriggerAddCondition(t,Condition(function Sadist_Main))
+set t=null
 endfunction
 function DeathPulse_Process takes nothing returns nothing
 local integer Cache=GetHandleId(GetTriggeringTrigger())
 local unit Source=tt_unit1
 local unit Target=tt_unit2
@@ -67084,19 +68446,19 @@
 local real r
 local real Damage
 local real Heal
 if Level==1 then
 set Damage=75
-set Heal=50
+set Heal=70
 set r=500
 elseif Level==2 then
 set Damage=125
-set Heal=75
+set Heal=90
 set r=500
 elseif Level==3 then
 set Damage=200
-set Heal=100
+set Heal=110
 set r=500
 elseif Level==4 then
 set Damage=275
 set Heal=130
 set r=500
@@ -67128,14 +68490,21 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local real Factor=(LoadReal(hash_main,(Cache),(680)))
+local integer AghanimLevel=GetUnitAbilityLevel(Source,abilityid_reapersscythe_upgrade)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call DestroyEffect(AddSpecialEffectTarget(reapersscythe_fx,Target,"origin"))
+if AghanimLevel>0 then
+set reaperscythe_hit=true
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,Factor*(GetUnitState(Target,UNIT_STATE_MAX_LIFE)-GetUnitState(Target,UNIT_STATE_LIFE)))
+set reaperscythe_hit=false
+else
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,Factor*(GetUnitState(Target,UNIT_STATE_MAX_LIFE)-GetUnitState(Target,UNIT_STATE_LIFE)))
+endif
 set t=null
 set Source=null
 set Target=null
 return false
 endfunction
@@ -67234,11 +68603,11 @@
 set t=null
 endfunction
 function ManaBurn_Start takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
-local real r=GetHeroInt(Target,true)*4
+local real r=GetHeroInt(Target,true)*5
 local integer Burn=IMinBJ(R2I(r),R2I(GetUnitState(Target,UNIT_STATE_MANA)))
 call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-Burn)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,Burn)
 call TimedLightningToUnit("MBUR",Source,Target,1,1,1,1,0.5)
 call TextTagOnUnitEx("-"+I2S(Burn),3,Target,0.023,82,82,255,255)
@@ -67296,26 +68665,28 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target
 local integer Level=GetUnitAbilityLevel(Source,abilityid_spikedcarapace)
+local group AlreadyHit=(LoadGroupHandle(hash_main,(Cache),(22)))
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
 if GetEventDamage()>0 and IsPlayerEnemy(GetOwningPlayer(GetEventDamageSource()),GetOwningPlayer(Source))==true then
 if IsRealPlayer(GetOwningPlayer(GetEventDamageSource()))and IsLegitDamage(GetEventDamage())then
-call PreventDamage(Source,GetEventDamage())
 set Target=udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]
-call UnitRemoveAbility(Source,1093815120)
-call FlushChildHashtable(hash_main,(Cache))
-call CleanTrigger(t)
+if IsUnitInGroup(Target,AlreadyHit)==false then
+call GroupAddUnit(AlreadyHit,Target)
+call PreventDamage(Source,GetEventDamage())
 if IsDead(Target)==false then
 call Stun(Source,Target,0.6*Level)
 call DamageTarget(Source,Target,DAMAGE_PURE,GetEventDamage())
 endif
 endif
 endif
+endif
 else
 call UnitRemoveAbility(Source,1093815120)
+call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 set t=null
 set Source=null
@@ -67323,14 +68694,15 @@
 endfunction
 function SpikedCarapace takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call TriggerRegisterTimerEvent(t,4.5,false)
+call TriggerRegisterTimerEvent(t,2.75,false)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
 call TriggerAddCondition(t,Condition(function SpikedCarapace_Think))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveGroupHandle(hash_main,(Cache),(22),(GetAvailableGroup()))
 call UnitAddAbility2(Source,1093815120)
 set Source=null
 set t=null
 endfunction
 function SpikedCarapace_Main takes nothing returns boolean
@@ -67343,128 +68715,10 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function SpikedCarapace_Main))
 set t=null
 endfunction
-function Necromastry_Process takes nothing returns nothing
-local integer Cache=GetHandleId(GetTriggeringTrigger())
-local unit Source=tt_unit2
-local unit Target=tt_unit1
-local integer souls=GetUnitAbilityLevel(Source,abilityid_necromastryhelper)
-local integer maxsouls
-local integer Level=GetUnitAbilityLevel(Source,abilityid_necromastry)
-if Level==1 then
-set maxsouls=12
-elseif Level==2 then
-set maxsouls=20
-elseif Level==3 then
-set maxsouls=28
-else
-set maxsouls=36
-endif
-set maxsouls=maxsouls+1
-if IsUnitType(Target,UNIT_TYPE_HERO)==false then
-set souls=souls+1
-else
-set souls=souls+6
-endif
-set souls=IMinBJ(maxsouls,souls)
-call SetUnitAbilityLevel(Source,abilityid_necromastryhelper,souls)
-call SaveInteger(hash_main,(GetHandleId(Source)),(710),(souls))
-set Source=null
-endfunction
-function Necromastry_Kill takes nothing returns nothing
-local integer souls
-local integer Level
-local integer maxsouls
-local trigger t
-local integer Cache
-local unit Source=GetKillingUnit()
-if GetUnitTypeId(Source)==1697656899 then
-set Source=udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))]
-endif
-set souls=GetUnitAbilityLevel(Source,abilityid_necromastryhelper)
-set Level=GetUnitAbilityLevel(Source,abilityid_necromastry)
-if Level==1 then
-set maxsouls=12
-elseif Level==2 then
-set maxsouls=20
-elseif Level==3 then
-set maxsouls=28
-else
-set maxsouls=36
-endif
-if souls<=maxsouls then
-set t=CreateProjectileToUnit(GetTriggerUnit(),Source,1747993426,"Necromastry_Process",500)
-set Cache=GetHandleId(t)
-set t=null
-call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
-endif
-endfunction
-function Necromastry_Death takes nothing returns nothing
-call SaveInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710),(R2I(GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper)*0.5)+1))
-call SetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper,R2I(GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper)*0.5)+1)
-endfunction
-function Necromastry_Main takes nothing returns boolean
-if GetUnitAbilityLevel(GetKillingUnit(),abilityid_necromastry)>0 and IsUnitIllusion(GetTriggerUnit())==false then
-call Necromastry_Kill()
-elseif GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))],abilityid_necromastry)>0 and GetUnitTypeId(GetKillingUnit())==1697656899 then
-call Necromastry_Kill()
-endif
-if GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastry)>0 and IsUnitIllusion(GetTriggerUnit())==false then
-call Necromastry_Death()
-endif
-return false
-endfunction
-function Necromastry_Command takes nothing returns boolean
-local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
-local integer Souls=GetUnitAbilityLevel(Hero,abilityid_necromastryhelper)-1
-local integer MaxSouls=0
-local integer Level=GetUnitAbilityLevel(Hero,abilityid_necromastry)
-if Level==1 then
-set MaxSouls=12
-elseif Level==2 then
-set MaxSouls=20
-elseif Level==3 then
-set MaxSouls=28
-elseif Level==4 then
-set MaxSouls=36
-endif
-set Souls=IMaxBJ(IMinBJ(Souls,MaxSouls),0)
-if GetUnitTypeId(Hero)==1315334514 then
-call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10.00,GetObjectName(1848658757)+" "+I2S(Souls)+"/"+I2S(MaxSouls))
-endif
-return false
-endfunction
-function RegisterNecromastry takes nothing returns nothing
-local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
-call TriggerAddCondition(t,Condition(function Necromastry_Main))
-set t=CreateTrigger()
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[1],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[2],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[3],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[4],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[5],"-stats",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[1],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[2],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[3],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[4],"-st",true)
-call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[5],"-st",true)
-call TriggerAddCondition(t,Condition(function Necromastry_Command))
-set t=null
-endfunction
 constant function Shadowraze_RawCode1 takes nothing returns integer
 return 1093682521
 endfunction
 constant function Shadowraze_RawCode2 takes nothing returns integer
 return 1093682760
@@ -67549,20 +68803,19 @@
 call TriggerAddAction(t,function Trig_Nevermore_Learn_Actions)
 endfunction
 function Trig_Requiem_of_Souls_Conditions takes nothing returns boolean
 return GetSpellAbilityId()==abilityid_requiemofsouls or GetSpellAbilityId()==abilityid_requiemofsouls_upgrade
 endfunction
-function Trig_Requiem_of_Souls_Actions takes nothing returns nothing
-local integer souls=(LoadInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710)))
+function RequiemOfSouls_Cast takes unit UnitVar,integer CurrentSouls returns nothing
+local integer souls=CurrentSouls
 local integer loopcounter
 local integer loopend
-local unit UnitVar=GetTriggerUnit()
 local location PointVar=GetUnitLoc(GetTriggerUnit())
 local location PointVar2
 local integer Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls,GetTriggerUnit())
 if Level==0 then
-set Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls_upgrade,GetTriggerUnit())+1
+return
 endif
 set souls=souls/2
 set loopcounter=1
 set loopend=souls
 loop
@@ -67579,10 +68832,16 @@
 call RemoveLocation(PointVar2)
 set loopcounter=loopcounter+1
 endloop
 call RemoveLocation(PointVar)
 endfunction
+function Trig_Requiem_of_Souls_Actions takes nothing returns nothing
+local integer souls=(LoadInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710)))
+local unit UnitVar=GetTriggerUnit()
+call RequiemOfSouls_Cast(UnitVar,souls)
+set UnitVar=null
+endfunction
 function Requiem takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Trig_Requiem_of_Souls_Conditions))
 call TriggerAddAction(t,function Trig_Requiem_of_Souls_Actions)
@@ -67619,11 +68878,11 @@
 local location PointVar=GetUnitLoc(UnitVar)
 local integer Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls,GetTriggerUnit())
 if Level==0 then
 set Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls_upgrade,GetTriggerUnit())
 endif
-call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(UnitVar),PointVar,bj_UNIT_FACING)
+call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(GetEnumUnit()),PointVar,bj_UNIT_FACING)
 call UnitAddAbilityBJ(1093683272,GetLastCreatedUnit())
 call SetUnitAbilityLevelSwapped(1093683272,GetLastCreatedUnit(),Level)
 call UnitApplyTimedLifeBJ(2.00,1112820806,GetLastCreatedUnit())
 call IssueTargetOrder(GetLastCreatedUnit(),"cripple",GetEnumUnit())
 call SetUnitPathing(GetLastCreatedUnit(),false)
@@ -67636,11 +68895,11 @@
 local location PointVar=GetUnitLoc(UnitVar)
 local integer Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls,GetTriggerUnit())
 if Level==0 then
 set Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls_upgrade,GetTriggerUnit())
 endif
-call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(UnitVar),PointVar,bj_UNIT_FACING)
+call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(GetEnumUnit()),PointVar,bj_UNIT_FACING)
 call UnitAddAbilityBJ(1093683272,GetLastCreatedUnit())
 call SetUnitAbilityLevelSwapped(1093683272,GetLastCreatedUnit(),Level)
 call UnitApplyTimedLifeBJ(2.00,1112820806,GetLastCreatedUnit())
 call IssueTargetOrder(GetLastCreatedUnit(),"cripple",GetEnumUnit())
 call SetUnitPathing(GetLastCreatedUnit(),false)
@@ -67653,11 +68912,11 @@
 local location PointVar=GetUnitLoc(UnitVar)
 local integer Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls,GetTriggerUnit())
 if Level==0 then
 set Level=GetUnitAbilityLevelSwapped(abilityid_requiemofsouls_upgrade,GetTriggerUnit())
 endif
-call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(UnitVar),PointVar,bj_UNIT_FACING)
+call CreateNUnitsAtLoc(1,1697656899,GetOwningPlayer(GetEnumUnit()),PointVar,bj_UNIT_FACING)
 call UnitAddAbilityBJ(1093683272,GetLastCreatedUnit())
 call SetUnitAbilityLevelSwapped(1093683272,GetLastCreatedUnit(),Level)
 call UnitApplyTimedLifeBJ(2.00,1112820806,GetLastCreatedUnit())
 call IssueTargetOrder(GetLastCreatedUnit(),"cripple",GetEnumUnit())
 call SetUnitPathing(GetLastCreatedUnit(),false)
@@ -67687,71 +68946,191 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Trig_Requiem_of_Souls_Cripple_Conditions))
 call TriggerAddAction(t,function Trig_Requiem_of_Souls_Cripple_Actions)
 endfunction
-function Trig_Void_Conditions takes nothing returns boolean
-return GetSpellAbilityId()==1093677640
-endfunction
-function Trig_Void_Actions takes nothing returns nothing
-local unit Caster
-if(IsDay()==false)then
-set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),1697656901,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
-call UnitAddAbility2(Caster,1093677650)
-call IssueTargetOrder(Caster,"slow",GetSpellTargetUnit())
+function Necromastry_Process takes nothing returns nothing
+local integer Cache=GetHandleId(GetTriggeringTrigger())
+local unit Source=tt_unit2
+local unit Target=tt_unit1
+local integer souls=GetUnitAbilityLevel(Source,abilityid_necromastryhelper)
+local integer maxsouls
+local integer Level=GetUnitAbilityLevel(Source,abilityid_necromastry)
+if Level==1 then
+set maxsouls=12
+elseif Level==2 then
+set maxsouls=20
+elseif Level==3 then
+set maxsouls=28
 else
-set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),1697656901,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
-call UnitAddAbility2(Caster,1093748785)
-call IssueTargetOrder(Caster,"slow",GetSpellTargetUnit())
+set maxsouls=36
 endif
-endfunction
-function NSVoid takes nothing returns nothing
-local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
-call TriggerAddCondition(t,Condition(function Trig_Void_Conditions))
-call TriggerAddAction(t,function Trig_Void_Actions)
-endfunction
-function Fear_End takes nothing returns boolean
-local trigger t=GetTriggeringTrigger()
-local integer Cache=GetHandleId(t)
-local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
-local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
-call ResetUnitAnimation(Source)
-call RemoveUnit(Caster)
-call FlushChildHashtable(hash_main,(Cache))
-call CleanTrigger(t)
-set Source=null
-set Caster=null
-set t=null
-return false
-endfunction
-function Fear_Start takes nothing returns nothing
-local unit Source=GetTriggerUnit()
-local unit Caster=CreateUnit(GetOwningPlayer(Source),unitid_fear,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
-local trigger t=CreateTrigger()
-local integer Cache=GetHandleId(t)
-call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
-call TriggerAddCondition(t,Condition(function Fear_End))
-call SaveUnitHandle(hash_main,(Cache),(2),(Source))
-call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
-call SetUnitVertexColorBJ(Caster,0,0,0,75)
-call SetUnitAnimation(Caster,"spell third")
+set maxsouls=maxsouls+1
+if IsUnitType(Target,UNIT_TYPE_HERO)==false then
+set souls=souls+1
+else
+set souls=souls+12
+endif
+set souls=IMinBJ(maxsouls,souls)
+call SetUnitAbilityLevel(Source,abilityid_necromastryhelper,souls)
+call SaveInteger(hash_main,(GetHandleId(Source)),(710),(souls))
 set Source=null
-set Caster=null
-set t=null
 endfunction
-function Fear_Main takes nothing returns boolean
-if GetSpellAbilityId()==abilityid_fear and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_fear)<5 then
-call Fear_Start()
+function Necromastry_Kill takes nothing returns nothing
+local integer souls
+local integer Level
+local integer maxsouls
+local trigger t
+local integer Cache
+local unit Source=GetKillingUnit()
+if GetUnitTypeId(Source)==1697656899 then
+set Source=udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))]
 endif
-return false
-endfunction
-function Register_Fear takes nothing returns nothing
-local trigger t=CreateTrigger()
-call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
-call TriggerAddCondition(t,Condition(function Fear_Main))
-set t=null
+set souls=GetUnitAbilityLevel(Source,abilityid_necromastryhelper)
+set Level=GetUnitAbilityLevel(Source,abilityid_necromastry)
+if Level==1 then
+set maxsouls=12
+elseif Level==2 then
+set maxsouls=20
+elseif Level==3 then
+set maxsouls=28
+else
+set maxsouls=36
+endif
+if souls<=maxsouls then
+set t=CreateProjectileToUnit(GetTriggerUnit(),Source,1747993426,"Necromastry_Process",500)
+set Cache=GetHandleId(t)
+set t=null
+call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
+endif
+endfunction
+function Necromastry_Death takes nothing returns nothing
+local integer SoulCount=(LoadInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710)))
+call SaveInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710),(R2I(GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper)*0.5)+1))
+call SetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper,R2I(GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastryhelper)*0.5)+1)
+call RequiemOfSouls_Cast(GetTriggerUnit(),SoulCount-(LoadInteger(hash_main,(GetHandleId(GetTriggerUnit())),(710))))
+endfunction
+function Necromastry_Main takes nothing returns boolean
+if GetUnitAbilityLevel(GetKillingUnit(),abilityid_necromastry)>0 and IsUnitIllusion(GetTriggerUnit())==false then
+call Necromastry_Kill()
+elseif GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))],abilityid_necromastry)>0 and GetUnitTypeId(GetKillingUnit())==1697656899 then
+call Necromastry_Kill()
+endif
+if GetUnitAbilityLevel(GetTriggerUnit(),abilityid_necromastry)>0 and IsUnitIllusion(GetTriggerUnit())==false then
+call Necromastry_Death()
+endif
+return false
+endfunction
+function Necromastry_Command takes nothing returns boolean
+local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
+local integer Souls=GetUnitAbilityLevel(Hero,abilityid_necromastryhelper)-1
+local integer MaxSouls=0
+local integer Level=GetUnitAbilityLevel(Hero,abilityid_necromastry)
+if Level==1 then
+set MaxSouls=12
+elseif Level==2 then
+set MaxSouls=20
+elseif Level==3 then
+set MaxSouls=28
+elseif Level==4 then
+set MaxSouls=36
+endif
+set Souls=IMaxBJ(IMinBJ(Souls,MaxSouls),0)
+if GetUnitTypeId(Hero)==1315334514 then
+call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,udg_TextY,10.00,GetObjectName(1848658757)+" "+I2S(Souls)+"/"+I2S(MaxSouls))
+endif
+return false
+endfunction
+function RegisterNecromastry takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
+call TriggerAddCondition(t,Condition(function Necromastry_Main))
+set t=CreateTrigger()
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[1],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[2],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[3],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[4],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[5],"-stats",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[1],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[2],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[3],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[4],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_SentPlayers[5],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[1],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[2],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[3],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[4],"-st",true)
+call TriggerRegisterPlayerChatEvent(t,udg_ScourgePlayers[5],"-st",true)
+call TriggerAddCondition(t,Condition(function Necromastry_Command))
+set t=null
+endfunction
+function Trig_Void_Conditions takes nothing returns boolean
+return GetSpellAbilityId()==1093677640
+endfunction
+function Trig_Void_Actions takes nothing returns nothing
+local unit Caster
+if(IsDay()==false)then
+set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),1697656901,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
+call UnitAddAbility2(Caster,1093677650)
+call IssueTargetOrder(Caster,"slow",GetSpellTargetUnit())
+else
+set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),1697656901,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
+call UnitAddAbility2(Caster,1093748785)
+call IssueTargetOrder(Caster,"slow",GetSpellTargetUnit())
+endif
+endfunction
+function NSVoid takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Trig_Void_Conditions))
+call TriggerAddAction(t,function Trig_Void_Actions)
+endfunction
+function Fear_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+call ResetUnitAnimation(Source)
+call RemoveUnit(Caster)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set Source=null
+set Caster=null
+set t=null
+return false
+endfunction
+function Fear_Start takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local unit Caster=CreateUnit(GetOwningPlayer(Source),unitid_fear,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
+call TriggerAddCondition(t,Condition(function Fear_End))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SetUnitVertexColorBJ(Caster,0,0,0,75)
+call SetUnitAnimation(Caster,"spell third")
+set Source=null
+set Caster=null
+set t=null
+endfunction
+function Fear_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_fear and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_fear)<5 then
+call Fear_Start()
+endif
+return false
+endfunction
+function Register_Fear takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
+call TriggerAddCondition(t,Condition(function Fear_Main))
+set t=null
 endfunction
 function Trig_NS_Learn_Abilities_Conditions takes nothing returns boolean
 return(GetLearnedSkill()==1093679158 or GetLearnedSkill()==1093679173)and IsUnitIllusion(GetTriggerUnit())==false
 endfunction
 function NS_Update takes nothing returns boolean
@@ -68030,11 +69409,11 @@
 endfunction
 function Cage_Ensnare takes nothing returns nothing
 local unit Caster
 if IsUnitInGroup(GetEnumUnit(),tt_group1)==false then
 call GroupAddUnit(tt_group1,GetEnumUnit())
-set Caster=CreateUnit(GetOwningPlayer(cage_source),1697656901,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
+set Caster=CreateUnit(GetOwningPlayer(GetEnumUnit()),1697656901,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
 call UnitAddAbility2(Caster,abilityid_cagehelper)
 call SetUnitAbilityLevel(Caster,abilityid_cagehelper,GetUnitAbilityLevel(cage_source,abilityid_cage))
 call IssueTargetOrder(Caster,"ensnare",GetEnumUnit())
 call DamageTarget(cage_source,GetEnumUnit(),DAMAGE_MAGICAL,100)
 endif
@@ -68082,28 +69461,25 @@
 local integer num=16
 local string fx="Abilities\\Spells\\Undead\\Graveyard\\GraveMarker.mdl"
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local group g=GetAvailableGroup()
-call TimedReveal(GetOwningPlayer(GetTriggerUnit()),settings_cageduration,srcx,srcy,settings_cageradius+500)
 call PlaySoundAtPos(gg_snd_Cage,srcx,srcy)
 call TriggerRegisterTimerEvent(t,0.1,true)
 call TriggerAddCondition(t,Condition(function Cage_Interval))
 call SaveGroupHandle(hash_main,(Cache),(22),(g))
 call SaveUnitHandle(hash_main,(Cache),(221),(GetTriggerUnit()))
 call SaveReal(hash_main,(Cache),(6),((srcx)*1.0))
 call SaveReal(hash_main,(Cache),(7),((srcy)*1.0))
-call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),1969711215,srcx,srcy,0)
 loop
 exitwhen i>num
 set x=srcx+settings_cageradius*Cos(i*360/num*bj_DEGTORAD)
 set y=srcy+settings_cageradius*Sin(i*360/num*bj_DEGTORAD)
 call SaveEffectHandle(hash_main,(Cache),(2700+i),(AddSpecialEffect(fx,x,y)))
 if i==1 or i==5 or i==9 or i==13 then
 set x=srcx+275*Cos(i*360/num*bj_DEGTORAD)
 set y=srcy+275*Sin(i*360/num*bj_DEGTORAD)
-call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),1969711215,x,y,0)
 endif
 set i=i+1
 endloop
 set t=null
 set g=null
@@ -68125,11 +69501,19 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(393)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local integer Max=90
-local integer Count=GetTriggerEvalCount(t)
+local integer Count=(LoadInteger(hash_main,(Cache),(34)))
+if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()==abilityid_portal_disabled then
+call KillUnit(Caster)
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(Cache))
+else
+set Count=Count+1
+call SaveInteger(hash_main,(Cache),(34),(Count))
+endif
 if Level==1 then
 set Max=160
 elseif Level==2 then
 set Max=120
 endif
@@ -68138,11 +69522,13 @@
 if Count>Max then
 call KillUnit(Caster)
 call CleanTrigger(t)
 call FlushChildHashtable(hash_main,(Cache))
 elseif Count>30 then
+call UnitRemoveAbility(Caster,1097625443)
 call ShowUnit(Caster,true)
+call UnitAddAbility2(Caster,1097625443)
 endif
 set t=null
 set Caster=null
 set Source=null
 return false
@@ -68171,14 +69557,37 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 if GetTriggerEventId()==EVENT_UNIT_DEATH or Target==null or IsDead(Target)then
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(Cache))
+call UnitRemoveType(Target,UNIT_TYPE_PEON)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal_disabled,false)
 call Error(GetOwningPlayer(Source),GetObjectName(MSG_PORTAL_1))
 elseif Source==null or IsDead(Source)then
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(Cache))
+call UnitRemoveType(Target,UNIT_TYPE_PEON)
 call Error(GetOwningPlayer(Source),GetObjectName(MSG_PORTAL_2))
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal_disabled,false)
+elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
+if GetSpellAbilityId()==abilityid_portal_disabled then
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(Cache))
+call UnitRemoveType(Target,UNIT_TYPE_PEON)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal_disabled,false)
+endif
 else
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(Cache))
+call UnitRemoveType(Target,UNIT_TYPE_PEON)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal,true)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal_disabled,false)
 call Portal_Action(Source,Target)
 endif
 set t=null
 set Source=null
 set Target=null
@@ -68231,19 +69640,25 @@
 endif
 if Target==null then
 call Error(GetOwningPlayer(Source),GetObjectName(MSG_PORTAL_3))
 return
 endif
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal,false)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_portal_disabled,true)
+call UnitAddAbility2(Source,abilityid_portal_disabled)
 call TriggerRegisterTimerEvent(t,6-GetUnitAbilityLevel(Source,abilityid_portal),false)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Portal_Main))
 call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget("war3mapImported\\DarkHands.mdl",Target,"overhead")))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call UnitAddType(Target,UNIT_TYPE_PEON)
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerRegisterTimerEvent(t,.03,true)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function DarkRift_Effect))
 call SaveInteger(hash_main,(Cache),(5),(GetUnitAbilityLevel(Source,abilityid_portal)))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 set u=CreateUnit(GetOwningPlayer(Source),1747990840,GetUnitX(Source),GetUnitY(Source),0)
 call SaveUnitHandle(hash_main,(Cache),(393),(u))
@@ -68381,16 +69796,24 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Expulsion))
 set t=null
 endfunction
+function Firestorm_Heal takes nothing returns nothing
+endfunction
 function Firestorm_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
-if GetSpellAbilityId()==abilityid_firestorm then
-call KillUnit(Caster)
+local group g=GetAvailableGroup()
+set tt_unit1=Source
+set firestorm_amount=GetUnitAbilityLevel(Source,abilityid_firestorm)*10+10
+call GroupEnumUnitsInRange(g,GetUnitX(Caster),GetUnitY(Caster),475,Condition(function GenericCondition_AlliedUnitsEx))
+call ForGroup(g,function Firestorm_Heal)
+call KillGroup(g)
+if GetTriggerEvalCount(t)==5 then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 set t=null
 set Caster=null
@@ -68402,16 +69825,16 @@
 local unit Source=GetTriggerUnit()
 local real x=GetSpellTargetX()
 local real y=GetSpellTargetY()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_firestorm)
 local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,x,y,0)
-call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
 call TriggerAddCondition(t,Condition(function Firestorm_End))
+call TriggerRegisterTimerEvent(t,1,true)
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
-call UnitAddAbility2(Caster,abilityid_firestormhelper)
-call SetUnitAbilityLevel(Caster,abilityid_firestormhelper,Level)
+call UnitAddAbility2(Caster,abilityid_firestormhelper2)
+call SetUnitAbilityLevel(Caster,abilityid_firestormhelper2,Level)
 call IssuePointOrder(Caster,"rainoffire",x,y)
 set Source=null
 set Caster=null
 endfunction
 function Firestorm takes nothing returns boolean
@@ -68803,10 +70226,179 @@
 set t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
 call TriggerAddCondition(t,Condition(function CorpseCollector_Learn))
 set t=null
 endfunction
+function SummonShade_AI takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local real x=(LoadReal(hash_main,(Cache),(6)))
+local real y=(LoadReal(hash_main,(Cache),(7)))
+local unit Caster2
+if GetTriggerEventId()==EVENT_UNIT_SPELL_FINISH then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call KillUnit(Caster)
+call UnitApplyTimedLife(Caster,1112820806,0.1)
+elseif IsDead(Caster)then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+else
+call SaveReal(hash_main,(Cache),(6),((GetUnitX(Caster))*1.0))
+call SaveReal(hash_main,(Cache),(7),((GetUnitY(Caster))*1.0))
+if x!=GetUnitX(Caster)or y!=GetUnitY(Caster)then
+call UnitRemoveAbility(Caster,1093815348)
+else
+call UnitAddAbility(Caster,1093815348)
+endif
+endif
+return false
+endfunction
+function SummonShade_WhichUnits takes nothing returns boolean
+return GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(summonshade_source)and GetUnitTypeId(GetFilterUnit())==unitid_summonshade
+endfunction
+function SummonShade takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Caster=CreateUnit(GetOwningPlayer(Source),unitid_summonshade,GetUnitX(Source)+100,GetUnitY(Source)+100,0)
+local group g
+local integer Level=GetUnitAbilityLevel(Source,abilityid_summonshade)
+local real Time
+local unit Oldest
+local unit Temp
+call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_FINISH)
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerAddCondition(t,Condition(function SummonShade_AI))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveReal(hash_main,(Cache),(6),((GetUnitX(Caster))*1.0))
+call SaveReal(hash_main,(Cache),(7),((GetUnitY(Caster))*1.0))
+call UnitAddAbility(Caster,1093815348)
+call SetUnitAbilityLevel(Caster,1093815349,GetUnitAbilityLevel(Source,1093815350))
+call SaveReal(hash_main,(GetHandleId(Caster)),(34),(((TimerGetElapsed(udg_GameTimer)))*1.0))
+set summonshade_source=Source
+set g=GetAvailableGroup()
+call GroupEnumUnitsInRange(g,0,0,99999,Condition(function SummonShade_WhichUnits))
+if CountUnitsInGroup(g)>Level+1 then
+set Temp=FirstOfGroup(g)
+set Time=(LoadReal(hash_main,(GetHandleId(Temp)),(34)))
+set Oldest=Temp
+call GroupRemoveUnit(g,Temp)
+loop
+exitwhen Temp==null
+if Time>(LoadReal(hash_main,(GetHandleId(Temp)),(34)))then
+set Time=(LoadReal(hash_main,(GetHandleId(Temp)),(34)))
+set Oldest=Temp
+endif
+set Temp=FirstOfGroup(g)
+call GroupRemoveUnit(g,Temp)
+endloop
+call KillUnit(Oldest)
+endif
+call KillGroup(g)
+set g=null
+set Caster=null
+set Source=null
+set t=null
+endfunction
+function SummonShade_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_summonshade then
+call SummonShade()
+endif
+return false
+endfunction
+function Register_SummonShade takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function SummonShade_Main))
+endfunction
+function DiffusionAura_Decrement takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Bonus=(LoadInteger(hash_main,(Cache),(34)))
+call SaveInteger(hash_main,(GetHandleId(Source)),(783),((LoadInteger(hash_main,(GetHandleId(Source)),(783)))-Bonus))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set Source=null
+set t=null
+return false
+endfunction
+function DiffusionAura_Death takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Dying=GetTriggerUnit()
+local integer Level=GetUnitAbilityLevel(Source,abilityid_diffusionaura)
+local integer Bonus
+local integer Stack
+if IsUnitInRange(Source,Dying,900+25)and IsDead(Source)==false and IsUnitAlly(Source,GetOwningPlayer(Dying))==false and GetUnitTypeId(Dying)!=unitid_tombstone_zombie and IsUnitIllusion(Dying)==false and IsGlobalHeroDummy(GetUnitTypeId(Dying))==false and GetUnitAbilityLevel(Dying,1093678162)==0 then
+set Stack=(LoadInteger(hash_main,(GetHandleId(Source)),(783)))
+if IsUnitType(Dying,UNIT_TYPE_HERO)==true then
+set Bonus=30
+else
+set Bonus=5
+endif
+set Stack=Stack+Bonus
+call SaveInteger(hash_main,(GetHandleId(Source)),(783),(Stack))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,25+Level*5,false)
+call TriggerRegisterDeathEvent(t,Source)
+call TriggerAddCondition(t,Condition(function DiffusionAura_Decrement))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveInteger(hash_main,(Cache),(34),(Bonus))
+endif
+set t=null
+set Source=null
+set Dying=null
+return false
+endfunction
+function DiffusionAura_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local integer Stack=(LoadInteger(hash_main,(GetHandleId(Source)),(783)))
+local integer LastBonus=(LoadInteger(hash_main,(Cache),(238)))
+if LastBonus!=Stack then
+call AddDamageBonus(Source,Stack)
+call SaveInteger(hash_main,(Cache),(238),(Stack))
+endif
+set t=null
+set Source=null
+return false
+endfunction
+function DiffusionAura takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
+call TriggerAddCondition(t,Condition(function DiffusionAura_Death))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.25,true)
+call TriggerAddCondition(t,Condition(function DiffusionAura_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set Source=null
+set t=null
+endfunction
+function DiffusionAura_Main takes nothing returns boolean
+if GetLearnedSkill()==abilityid_diffusionaura and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_diffusionaura)==1 then
+call DiffusionAura()
+endif
+return false
+endfunction
+function Register_DiffusionAura takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function DiffusionAura_Main))
+set t=null
+endfunction
 function Trig_Rot_Conditions takes nothing returns boolean
 return GetUnitAbilityLevel(GetTriggerUnit(),1093678667)>0
 endfunction
 function Trig_Rot_Actions takes nothing returns nothing
 if(GetIssuedOrderId()==String2OrderIdBJ("immolation"))then
@@ -68831,11 +70423,11 @@
 function FleshHeal_IsPudge takes nothing returns boolean
 return GetUnitTypeId(GetFilterUnit())==1429221446 and IsUnitIllusion(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))==true
 endfunction
 function FleshHeap_Tracker takes nothing returns boolean
 local group g
-if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and GetUnitTypeId(GetTriggerUnit())!=1211117642 and IsUnitIllusion(GetTriggerUnit())==false then
+if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsGlobalHeroDummy(GetUnitTypeId(GetTriggerUnit()))==false and IsUnitIllusion(GetTriggerUnit())==false then
 set g=GetAvailableGroup()
 call GroupEnumUnitsInRange(g,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),475,Condition(function FleshHeal_IsPudge))
 if GetUnitTypeId(GetKillingUnit())==1429221446 then
 call GroupAddUnit(g,GetKillingUnit())
 endif
@@ -69197,11 +70789,42 @@
 if(GetUnitTypeId(GetSummonedUnit())==1865429071)then
 return true
 endif
 return false
 endfunction
+function NetherWard_Drain takes nothing returns nothing
+endfunction
+function NetherWard_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local group g
+if GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+else
+set g=GetAvailableGroup()
+set tt_unit1=Caster
+call GroupEnumUnitsInRange(g,GetUnitX(Caster),GetUnitY(Caster),400+300*4+25,Condition(function GenericCondition_EnemyUnitsEx))
+call ForGroup(g,function NetherWard_Drain)
+call KillGroup(g)
+set g=null
+endif
+set t=null
+set Caster=null
+return false
+endfunction
 function Trig_Nether_Ward_Actions takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Caster=GetSummonedUnit()
+call TriggerRegisterDeathEvent(t,Caster)
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerAddCondition(t,Condition(function NetherWard_Loop))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveInteger(hash_main,(Cache),(5),(GetUnitAbilityLevel(GetSummoningUnit(),1093679428)))
 call SetUnitAbilityLevelSwapped(1093679188,GetSummonedUnit(),GetUnitAbilityLevelSwapped(1093679428,GetSummoningUnit()))
 call SetUnitAbilityLevelSwapped(1093681990,GetSummonedUnit(),GetUnitAbilityLevelSwapped(1093679428,GetSummoningUnit()))
 call IssueImmediateOrderBJ(GetSummonedUnit(),"manaflareon")
 endfunction
 function NW takes nothing returns nothing
@@ -69209,13 +70832,13 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
 call TriggerAddCondition(t,Condition(function Trig_Nether_Ward_Conditions))
 call TriggerAddAction(t,function Trig_Nether_Ward_Actions)
 endfunction
 function Voltage_Slow takes unit Source,unit Target returns nothing
-local real min=20+20*voltage_level
-local real max=35+35*voltage_level
-local real damage=min+(max-min)*voltage_distance/700
+local real base=20+40*voltage_level
+local real extra=70+30*voltage_level
+local real damage=(base+extra*voltage_distance/700)*0.5
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,damage)
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",Target,"chest"))
 endfunction
 function Voltage_Damage takes nothing returns nothing
 local unit Target=GetEnumUnit()
@@ -69506,11 +71129,11 @@
 local integer Count=GetTriggerEvalCount(t)
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 call MoveLightning(Light,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
 call SetUnitX(Caster,GetUnitX(Target))
 call SetUnitY(Caster,GetUnitY(Target))
-if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))>700 or GetTriggerEventId()==EVENT_UNIT_DEATH or IsUnitVisible(Target,GetOwningPlayer(Source))==false then
+if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))>700 or GetTriggerEventId()==EVENT_UNIT_DEATH then
 call DestroyLightning(Light)
 call KillUnit(Caster)
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call StaticLink_DelayedRemove(Source,Target,GetTriggerUnit())
 else
@@ -69769,37 +71392,38 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local integer Count=GetTriggerEvalCount(t)
-local integer Interval
+local real Interval
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call EyeOfTheStorm_Clear(Cache)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 if GetTriggerUnit()==Source then
 call KillUnit(Caster)
 endif
 else
 if GetUnitAbilityLevel(Source,abilityid_eyeofthestorm_upgrade)>0 then
 if Level==1 then
-set Interval=14
+set Interval=0.65
 elseif Level==2 then
-set Interval=12
+set Interval=0.55
 else
-set Interval=10
+set Interval=0.45
 endif
 else
 if Level==1 then
-set Interval=17
+set Interval=0.75
 elseif Level==2 then
-set Interval=15
+set Interval=0.65
 else
-set Interval=12
+set Interval=0.55
 endif
 endif
-if ModuloInteger(Count,Interval)==0 or Count==1 then
+set Interval=Interval/eyeofthestorm_tickrate
+if ModuloInteger(Count,R2I(Interval))==0 or Count==1 then
 set eyeofthestorm_cache=Cache
 call EyeOfTheStorm_Hit(Source,Caster,Level)
 endif
 call SetUnitX(Caster,GetUnitX(Source))
 call SetUnitY(Caster,GetUnitY(Source))
@@ -69819,11 +71443,11 @@
 endif
 call UnitApplyTimedLife(Caster,1112820806,15+5*Level)
 call SetUnitAbilityLevel(Caster,1093747786,Level)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_DEATH)
-call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerRegisterTimerEvent(t,eyeofthestorm_tickrate,true)
 call TriggerAddCondition(t,Condition(function EyeOfTheStorm_Move))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveInteger(hash_main,(Cache),(5),(Level))
 set Source=null
@@ -70474,16 +72098,16 @@
 local unit Attacker=GetAttacker()
 local unit Defender=GetTriggerUnit()
 local group GroupVar=GetAvailableGroup()
 local boolexpr CondVar=Condition(function Desolate_AnyNearAlliedUnits)
 local integer Cache
-call GroupEnumUnitsInRange(GroupVar,GetUnitX(Defender),GetUnitY(Defender),350,CondVar)
+call GroupEnumUnitsInRange(GroupVar,GetUnitX(Defender),GetUnitY(Defender),325+25,CondVar)
 call GroupRemoveUnit(GroupVar,Defender)
 if FirstOfGroup(GroupVar)==null then
 set Cache=GetHandleId(Attacker)
 if((LoadInteger(hash_main,(GetHandleId((Attacker))),((4275))))==HERO_STATE_ON)==false then
-call UnitDamageTarget(Attacker,Defender,10+10*GetUnitAbilityLevel(Attacker,(1093682776)),true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_DIVINE,WEAPON_TYPE_WHOKNOWS)
+call UnitDamageTarget(Attacker,Defender,5+15*GetUnitAbilityLevel(Attacker,(1093682776)),true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_DIVINE,WEAPON_TYPE_WHOKNOWS)
 call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl",Defender,"overhead"))
 call AddHeroState(Attacker,4275,0.3)
 endif
 endif
 call KillGroup(GroupVar)
@@ -70750,11 +72374,10 @@
 if Level>0 and IsDead(Source)==false then
 set Bonus=R2I(GetUnitMoveSpeed(Source)*0.04*Level)
 set LastBonus=(LoadInteger(hash_main,(Cache),(238)))
 if Bonus!=LastBonus then
 call SaveInteger(hash_main,(Cache),(238),(Bonus))
-call AddDamageBonus(Source,Bonus)
 endif
 endif
 set t=null
 set Source=null
 return false
@@ -70861,15 +72484,15 @@
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveReal(hash_main,(Cache),(13),((Angle)*1.0))
 call SaveReal(hash_main,(Cache),(193),((2)*1.0))
 call SaveBoolean(hash_main,(Cache),(698),(External))
-call SaveInteger(hash_main,(Cache),(12),(75+20*Level))
+call SaveInteger(hash_main,(Cache),(12),(80+20*Level))
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerRegisterTimerEvent(t,0.01,true)
 call TriggerAddCondition(t,Condition(function Greaterbash_Move))
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,25*Level)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,GetUnitMoveSpeed(Source)*0.1*Level)
 call Spiritbash_AddMS(Source)
 endif
 if External==false then
 call AddHeroState(Source,4276,1.5)
 endif
@@ -70935,11 +72558,11 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
-local real rate=(350+75*Level)*0.02
+local real rate=(550+50*Level)*0.02
 local real LastX=(LoadReal(hash_main,(Cache),(23)))
 local real LastY=(LoadReal(hash_main,(Cache),(24)))
 local real x
 local real y
 local real a
@@ -71056,11 +72679,10 @@
 set charge_level=Level
 call ForGroup(g,function ChargeOfDarkness_Bash)
 call KillGroup(g)
 set g=null
 if d<3000 and GetUnitAbilityLevel(Target,chargeofdarkness_icon)==0 then
-call UnitAddAbility2(Target,chargeofdarkness_icon)
 endif
 endif
 endif
 set t=null
 set Source=null
@@ -71401,30 +73023,21 @@
 set Target=null
 set Source=null
 set Caster=null
 return false
 endfunction
-function Reflection_Add takes nothing returns nothing
+function Reflection takes nothing returns nothing
 local unit Source=GetTriggerUnit()
-local unit Target=GetEnumUnit()
+local unit Target=GetSpellTargetUnit()
 local integer Level=GetUnitAbilityLevel(Source,abilityid_reflection)
 local integer id
 local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Source),GetUnitY(Source),0)
 local trigger t
 local integer Cache
-if Level==1 then
-set id=reflection_slow_1
-elseif Level==2 then
-set id=reflection_slow_2
-elseif Level==3 then
-set id=reflection_slow_3
-elseif Level==4 then
-set id=reflection_slow_4
-endif
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),id,false)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),reflection_slow_4,false)
 if IsRealSummoned(Target)==false then
-call AddTimedAbilityAndRemove(Target,id,1,4,reflection_slow_buffid)
+call AddTimedAbilityAndRemove(Target,reflection_slow_4,1,5,reflection_slow_buffid)
 endif
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
 call TriggerAddCondition(t,Condition(function Reflection_ImageEnters))
@@ -71436,23 +73049,11 @@
 call IssueTargetOrderById(Caster,852274,Target)
 set Source=null
 set Target=null
 set Caster=null
 set t=null
-endfunction
-function Reflection takes nothing returns nothing
-local unit Source=GetTriggerUnit()
-local group g=GetAvailableGroup()
-local real x=GetSpellTargetX()
-local real y=GetSpellTargetY()
-call TimedReveal(GetOwningPlayer(Source),2.5,x,y,400)
-call GroupEnumUnitsInRange(g,x,y,375,Condition(function GenericCondition_EnemyUnits))
-call ForGroup(g,function Reflection_Add)
-call KillGroup(g)
-call DestroyEffect(AddSpecialEffect(reflection_fx,x,y))
-call PlaySoundAtPos(gg_snd_ZigguratUpgrade,x,y)
-set g=null
+call PlaySoundAtPos(gg_snd_ZigguratUpgrade,GetUnitX(Target),GetUnitY(Target))
 set Source=null
 endfunction
 function Reflection_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_reflection then
 call Reflection()
@@ -71467,48 +73068,33 @@
 endfunction
 function MetaMorph_ImageControl takes nothing returns nothing
 local unit Source=GetSummoningUnit()
 local unit Image=GetSummonedUnit()
 call SelectUnitAddForPlayer(Image,GetOwningPlayer(Source))
+call UnitAddAbility(Image,metamorph_in)
+call UnitRemoveAbility(Image,metamorph_in)
+call SetUnitState(Image,UNIT_STATE_LIFE,GetUnitState(Image,UNIT_STATE_MAX_LIFE))
+call SetUnitPosition(Image,GetUnitX(Image),GetUnitY(Image))
 set Source=null
 set Image=null
 endfunction
 function MetaMorph_ImageEnter takes nothing returns boolean
 if GetUnitAbilityLevel(GetSummonedUnit(),metamorph_buffid)>0 then
 call MetaMorph_ImageControl()
 endif
 return false
 endfunction
-function MetaMorph_Delay_Image takes nothing returns boolean
-local trigger t=GetTriggeringTrigger()
-local integer Cache=GetHandleId(t)
-local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+function MetaMorph_Delay takes nothing returns nothing
+local unit Source=GetTriggerUnit()
 local unit Caster
 local integer Level=GetUnitAbilityLevel(Source,abilityid_metamorph)
-if Level>1 then
 set Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Source),GetUnitY(Source),0)
 call UnitAddAbility2(Caster,metamorph_image)
 call SetUnitAbilityLevel(Caster,metamorph_image,Level)
 call IssueTargetOrderById(Caster,852274,Source)
-if Level==4 then
-call IssueTargetOrderById(Caster,852274,Source)
-endif
-endif
-call FlushChildHashtable(hash_main,(Cache))
-call CleanTrigger(t)
-set t=null
 set Source=null
 set Caster=null
-return false
-endfunction
-function MetaMorph_Delay takes nothing returns nothing
-local trigger t=CreateTrigger()
-local integer Cache=GetHandleId(t)
-call TriggerRegisterTimerEvent(t,0.2,false)
-call TriggerAddCondition(t,Condition(function MetaMorph_Delay_Image))
-call SaveUnitHandle(hash_main,(Cache),(2),(GetTriggerUnit()))
-set t=null
 endfunction
 function MetaMorph_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_metamorph and GetUnitTypeId(GetTriggerUnit())==1164277353 then
 call MetaMorph_Delay()
 endif
@@ -71766,23 +73352,23 @@
 local integer Level=GetUnitAbilityLevel(Hero,abilityid_ravage)
 local group g=GetAvailableGroup()
 local real d=500
 if Level==1 then
 set Duration=1.5
-set Damage=250
+set Damage=200
 elseif Level==2 then
 set Duration=1.8
-set Damage=350
+set Damage=325
 elseif Level==3 then
 set Duration=2.25
 set Damage=450
 endif
 loop
 exitwhen i>16
 set x2=x1+(d+Level*100)*Cos(22.5*i*bj_DEGTORAD)
 set y2=y1+(d+Level*100)*Sin(22.5*i*bj_DEGTORAD)
-call Impale(Hero,null,Damage,Duration,0.52,x1,y1,x2,y2,250,g,false,900)
+call Impale(Hero,null,Damage,Duration,0.52,x1,y1,x2,y2,250,g,false,775)
 set i=i+1
 endloop
 call Ravage_KillGroup(g)
 set Hero=null
 set Caster=null
@@ -71903,11 +73489,11 @@
 function Healing_DamageUnitsAround takes unit Source,unit Target,real Damage returns nothing
 local group GroupVar=GetAvailableGroup()
 local boolexpr CondVar=Condition(function Healing_WhichUnitsToDamage)
 set udg_TempUnit=Source
 set udg_TempReal=Damage
-call GroupEnumUnitsInRange(GroupVar,GetUnitX(Target),GetUnitY(Target),195,CondVar)
+call GroupEnumUnitsInRange(GroupVar,GetUnitX(Target),GetUnitY(Target),185+25,CondVar)
 call ForGroup(GroupVar,function Healing_Damage)
 call KillGroup(GroupVar)
 endfunction
 function Healing_WhichUnits takes nothing returns boolean
 return IsUnitInGroup(GetFilterUnit(),udg_TempGroup)==false and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsDead(GetFilterUnit())==false and GetFilterUnit()!=shadowwave_source
@@ -72154,11 +73740,11 @@
 local player p=(LoadPlayerHandle(hash_main,(Cache),(54)))
 local integer Count=GetTriggerEvalCount(t)
 local integer Duration=(LoadInteger(hash_main,(Cache),(188)))
 set tt_player1=p
 set tt_int1=Count
-if Count==Duration then
+if Count>=Duration/weave_interval then
 call ForGroup(g,function Weave_ClearArmor)
 call KillGroup(g)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
@@ -72207,11 +73793,11 @@
 endif
 call ForGroup(g,function Weave_AddFX)
 call SaveGroupHandle(hash_main,(Cache),(22),(g))
 call SavePlayerHandle(hash_main,(Cache),(54),(GetOwningPlayer(Hero)))
 call SaveInteger(hash_main,(Cache),(188),(Duration))
-call TriggerRegisterTimerEvent(t,1,true)
+call TriggerRegisterTimerEvent(t,weave_interval,true)
 call TriggerAddCondition(t,Condition(function Weave_Iterate))
 call TriggerEvaluate(t)
 set Hero=null
 set l=null
 set g=null
@@ -72411,10 +73997,11 @@
 local real x
 local real y
 local real safex
 local real safey
 local real Rate=30
+local unit DummyVision
 set venomousgale_level=Level
 if GetTriggerEvalCount(t)>28 then
 call KillGroup(g)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
@@ -72432,10 +74019,14 @@
 call KillGroup(TempGroup)
 set safex=SafeX(x+Rate*Cos(Angle*bj_DEGTORAD))
 set safey=SafeY(y+Rate*Sin(Angle*bj_DEGTORAD))
 call SetUnitX(Caster,safex)
 call SetUnitY(Caster,safey)
+if ModuloInteger(GetTriggerEvalCount(t),3)==0 then
+set DummyVision=CreateUnit(GetOwningPlayer(Caster),1865429335,safex,safey,0)
+call KillUnit(DummyVision)
+endif
 endif
 set t=null
 set g=null
 set TempGroup=null
 set Caster=null
@@ -72527,30 +74118,31 @@
 set Source=null
 return false
 endfunction
 function Nethertoxin takes unit Attacker,unit Target returns nothing
 local real Percent=100*GetUnitState(Target,UNIT_STATE_LIFE)/GetUnitState(Target,UNIT_STATE_MAX_LIFE)
-local integer Bonus=2*GetUnitAbilityLevel(Attacker,abilityid_nethertoxin)
+local real Bonus=2.5*GetUnitAbilityLevel(Attacker,abilityid_nethertoxin)
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
+local integer FinalBonus
 call SaveInteger(hash_main,(GetHandleId((Attacker))),((4277)),(HERO_STATE_ON))
 call TriggerRegisterTimerEvent(t,0.35,false)
 call TriggerAddCondition(t,Condition(function Nethertoxin_Expire))
 call SaveUnitHandle(hash_main,(Cache),(2),(Attacker))
 if IsUnitType(Target,UNIT_TYPE_HERO)==false then
 set Bonus=Bonus/2
 endif
 if Percent>80 then
-call AddDamageBonus(Attacker,Bonus)
+call AddDamageBonus(Attacker,R2I(Bonus))
 elseif Percent>60 then
-call AddDamageBonus(Attacker,Bonus*2)
+call AddDamageBonus(Attacker,R2I(Bonus*2))
 elseif Percent>40 then
-call AddDamageBonus(Attacker,Bonus*2*2)
+call AddDamageBonus(Attacker,R2I(Bonus*2*2))
 elseif Percent>20 then
-call AddDamageBonus(Attacker,Bonus*2*2*2)
+call AddDamageBonus(Attacker,R2I(Bonus*2*2*2))
 else
-call AddDamageBonus(Attacker,Bonus*2*2*2*2)
+call AddDamageBonus(Attacker,R2I(Bonus*2*2*2*2))
 endif
 set t=null
 endfunction
 function Nethertoxin_Main takes nothing returns boolean
 if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_CAST then
@@ -72601,15 +74193,15 @@
 local unit Source=GetTriggerUnit()
 local unit Target=GetAttacker()
 local real EndTime=(LoadReal(hash_main,(GetHandleId(Target)),(684)))
 local integer Level=GetUnitAbilityLevel(Source,abilityid_corrosiveskin)
 if EndTime>(TimerGetElapsed(udg_GameTimer))then
-call SaveReal(hash_main,(GetHandleId(Target)),(684),(((TimerGetElapsed(udg_GameTimer))+3)*1.0))
+call SaveReal(hash_main,(GetHandleId(Target)),(684),(((TimerGetElapsed(udg_GameTimer))+corrosiveskin_duration)*1.0))
 else
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
-call SaveReal(hash_main,(GetHandleId(Target)),(684),(((TimerGetElapsed(udg_GameTimer))+3)*1.0))
+call SaveReal(hash_main,(GetHandleId(Target)),(684),(((TimerGetElapsed(udg_GameTimer))+corrosiveskin_duration)*1.0))
 call TriggerRegisterTimerEvent(t,1,true)
 call TriggerRegisterDeathEvent(t,Target)
 call TriggerAddCondition(t,Condition(function CorrosiveSkin_Loop))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
@@ -73359,11 +74951,11 @@
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local integer Level=(LoadInteger(hash_main,(GetHandleId((Source))),(450)))
 local trigger t=CreateProjectileToUnit(Source,Target,1747993157,"SoulAssumption_Process",1000)
 local integer Cache=GetHandleId(t)
-call SaveReal(hash_main,(Cache),(20),((20+Level*60)*1.0))
+call SaveReal(hash_main,(Cache),(20),((20+Level*65)*1.0))
 call DestroyEffect(AddSpecialEffectTarget(soulassumption_fx,Source,"chest"))
 call SaveReal(hash_main,(GetHandleId(Source)),(443),((0)*1.0))
 call SoulAssumption_AdjustLevel(Source,0)
 call AddHeroState(Source,2484,4)
 set t=CreateTrigger()
@@ -73657,11 +75249,11 @@
 call UnitRemoveAbility(Target,abilityid_shadowword_damagebuff)
 call UnitRemoveAbility(Target,buffid_shadowword_damage)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,Level*10)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,Level*10+5)
 endif
 set Source=null
 set Target=null
 set t=null
 return false
@@ -73677,11 +75269,11 @@
 call UnitRemoveAbility(Target,abilityid_shadowword_healbuff)
 call UnitRemoveAbility(Target,buffid_shadowword_heal)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
-call UnitAddLife(Target,Level*10)
+call UnitAddLife(Target,Level*10+5)
 endif
 set Source=null
 set Target=null
 set t=null
 return false
@@ -74389,16 +75981,16 @@
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 elseif Count==4 or Count==8 then
 call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(maledict_fx,Target,"origin")))
 endif
-set BonusDamage=Level*0.1*RMax(StartingHP-GetUnitState(Target,UNIT_STATE_LIFE),0)
+set BonusDamage=(0.08+Level*0.08)*RMax(StartingHP-GetUnitState(Target,UNIT_STATE_LIFE),0)
 if BonusDamage>0 then
 call TextTagOnUnitEx("+"+I2S(R2I(BonusDamage)),2,Target,0.023,68,0,187,216)
 endif
 endif
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,Level*5+BonusDamage)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,5*Level+BonusDamage)
 endif
 set t=null
 set Source=null
 set Target=null
 return false
@@ -74503,16 +76095,10 @@
 if Target!=null and GetUnitAbilityLevel(Target,gust_icon_buff)==0 and gust_time[id]>Time then
 set gust_time[id]=0
 endif
 if Target!=null and GetUnitAbilityLevel(Target,gust_icon_buff)>0 then
 if gust_time[id]>Time and IsDead(Target)==false then
-if IsUnitInRegion(Region_Fountains,Target)==true then
-set hp=GetUnitState(Target,UNIT_STATE_LIFE)
-set mp=GetUnitState(Target,UNIT_STATE_MANA)
-set gust_hp[id]=hp
-set gust_mp[id]=mp
-else
 set hp=GetUnitState(Target,UNIT_STATE_LIFE)
 set mp=GetUnitState(Target,UNIT_STATE_MANA)
 if hp<gust_hp[id]then
 set gust_hp[id]=hp
 else
@@ -74520,11 +76106,10 @@
 if mp<gust_mp[id]then
 set gust_mp[id]=mp
 else
 endif
 call SetUnitState(Target,UNIT_STATE_LIFE,gust_hp[id])
-endif
 set gust_dmgcounter[id]=gust_dmgcounter[id]+1
 if gust_dmgcounter[id]==10 then
 set gust_dmgcounter[id]=0
 if gust_level[id]==1 then
 call DamageTarget(gust_source[id],Target,DAMAGE_MAGICAL,12.5)
@@ -74581,11 +76166,11 @@
 function Gust_Register takes unit Source,unit Target returns nothing
 local integer Level=GetUnitAbilityLevel(Source,abilityid_iceblast)
 local integer id=GetPlayerId(GetOwningPlayer(Target))
 local trigger t
 local integer Cache
-if Level>0 and IsUnitType(Target,UNIT_TYPE_HERO)==true and IsUnitIllusion(Target)==false and GetUnitTypeId(Target)!=1211117642 then
+if Level>0 and IsUnitType(Target,UNIT_TYPE_HERO)==true and IsUnitIllusion(Target)==false and IsGlobalHeroDummy(GetUnitTypeId(Target))==false then
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
 call TriggerAddCondition(t,Condition(function Gust_Shatter))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
@@ -74605,11 +76190,11 @@
 local unit Target=GetEnumUnit()
 local integer id=GetPlayerId(GetOwningPlayer(Target))
 local integer Level=GetUnitAbilityLevel(Source,abilityid_iceblast)
 local trigger t
 local integer Cache
-if IsUnitType(Target,UNIT_TYPE_HERO)==true and IsUnitIllusion(Target)==false and GetUnitAbilityLevel(Target,gust_icon_buff)==0 and GetUnitTypeId(Target)!=1211117642 then
+if IsUnitType(Target,UNIT_TYPE_HERO)==true and IsUnitIllusion(Target)==false and GetUnitAbilityLevel(Target,gust_icon_buff)==0 and IsGlobalHeroDummy(GetUnitTypeId(Target))==false then
 set gust_time[id]=(TimerGetElapsed(udg_GameTimer))+7+Level
 call UnitAddAbility2(Target,gust_icon)
 call UnitAddAbility2(Target,gust_fx)
 set gust_hp[id]=GetUnitState(Target,UNIT_STATE_LIFE)
 set gust_mp[id]=GetUnitState(Target,UNIT_STATE_MANA)
@@ -75123,12 +76708,12 @@
 if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
 if GetEventDamageSource()==Source and GetEventDamage()>1 then
 call DisableTrigger(t)
 if ChillingCounter>0 then
 call SaveInteger(hash_main,(GetHandleId(Source)),(449),(ChillingCounter-1))
-call TextTagOnUnitEx("+"+I2S(30+10*Level),1,Source,0.024,100,200,255,255)
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,30+10*Level)
+call TextTagOnUnitEx("+"+I2S(40+10*Level),1,Source,0.024,100,200,255,255)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,40+10*Level)
 endif
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 else
@@ -75152,11 +76737,11 @@
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call UnitRemoveAbility(Source,chillingtouch_icon)
 call UnitRemoveAbility(Source,buffid_chillingtouch)
 call UnitRemoveAbility(Source,chillingtouch_ias)
-elseif GetAttacker()==Source and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and((LoadInteger(hash_main,(GetHandleId((Source))),((4289))))==HERO_STATE_ON)==false then
+elseif GetAttacker()==Source and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and((LoadInteger(hash_main,(GetHandleId((Source))),((4289))))==HERO_STATE_ON)==false then
 call AddHeroState(Source,4289,0.4)
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
 call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
 call TriggerRegisterTimerEvent(t,2.0,false)
@@ -75175,16 +76760,16 @@
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_chillingtouch)
 call UnitAddAbility2(Target,chillingtouch_icon)
 call UnitAddAbility2(Target,chillingtouch_ias)
-call SaveInteger(hash_main,(GetHandleId(Target)),(449),(1+Level))
+call SaveInteger(hash_main,(GetHandleId(Target)),(449),(2+Level))
 call SaveUnitHandle(hash_main,(Cache),(2),(Target))
 call SaveInteger(hash_main,(Cache),(5),(Level))
 call SaveEffectHandle(hash_main,(Cache),(175),(AddSpecialEffectTarget(chillingtouch_fx,Target,"right,hand")))
 call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffectTarget(chillingtouch_fx,Target,"left,hand")))
-call TriggerRegisterTimerEvent(t,40,false)
+call TriggerRegisterTimerEvent(t,30,false)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
 call TriggerAddCondition(t,Condition(function ChillingTouch_Attack))
 set Source=null
 set Target=null
@@ -75196,11 +76781,11 @@
 local location l=GetSpellTargetLoc()
 local real x=GetLocationX(l)
 local real y=GetLocationY(l)
 call RemoveLocation(l)
 call DestroyEffect(AddSpecialEffect("war3mapImported\\IcyWind.mdl",x,y))
-call GroupEnumUnitsInRange(g,x,y,475,Condition(function GenericCondition_AlliedHeroes))
+call GroupEnumUnitsInRange(g,x,y,525+25,Condition(function GenericCondition_AlliedHeroes))
 call ForGroup(g,function ChillingTouch_Register)
 call KillGroup(g)
 set Source=null
 set g=null
 set l=null
@@ -75922,50 +77507,49 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Shackle_Main))
 set t=null
 endfunction
-function Dash_Remove takes nothing returns boolean
+function Dash_Burn takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
-if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>(15+5*Level)or IsMagicImmune(Source)then
-call SaveInteger(hash_main,(GetHandleId((Source))),((4311)),(HERO_STATE_OFF))
+if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)==4 or IsMagicImmune(Target)then
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
-if((LoadInteger(hash_main,(GetHandleId((Source))),((4312))))==HERO_STATE_ON)==false then
-call UnitRemoveAbility(Source,dash_disarm)
-endif
+call UnitRemoveAbility(Target,dash_slow)
+call UnitRemoveAbility(Target,dash_slow_buffid)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
+if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,20*Level-10)
+endif
 set t=null
 set Source=null
+set Target=null
 return false
 endfunction
-function Dash_Add takes unit Source,integer Level returns nothing
+function Dash_Add takes unit Source,unit Target,integer Level returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call UnitAddAbility(Source,dash_disarm)
-call UnitMakeAbilityPermanent(Source,true,dash_disarm)
-call SaveInteger(hash_main,(GetHandleId((Source))),((4311)),(HERO_STATE_ON))
-call TriggerRegisterTimerEvent(t,0.1,true)
-call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
-call TriggerAddCondition(t,Condition(function Dash_Remove))
+call UnitAddAbility2(Target,dash_slow)
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerRegisterDeathEvent(t,Target)
+call TriggerAddCondition(t,Condition(function Dash_Burn))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveInteger(hash_main,(Cache),(5),(Level))
-call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget("Abilities\\Spells\\Other\\TalkToMe\\TalkToMe.mdl",Source,"overhead")))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(overheat_fx,Target,"chest")))
 set t=null
 endfunction
 function Dash_Hit takes nothing returns boolean
 if IsUnitInGroup(GetEnumUnit(),dash_alreadydamaged)==false and IsMagicImmune(GetEnumUnit())==false then
 call GroupAddUnit(dash_alreadydamaged,GetEnumUnit())
 call DestroyEffect(AddSpecialEffectTarget(dash_fx,GetEnumUnit(),"chest"))
-call DamageTarget(dash_source,GetEnumUnit(),DAMAGE_MAGICAL,50+50*dash_level)
-if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
-call Dash_Add(GetEnumUnit(),dash_level)
-endif
+call Dash_Add(dash_source,GetEnumUnit(),dash_level)
 endif
 return false
 endfunction
 function Dash_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
@@ -75983,11 +77567,11 @@
 local real x=SafeX(TargetX+EllipseX*Cos(a)-EllipseY*Sin(a))
 local real y=SafeY(TargetY+EllipseX*Sin(a)+EllipseY*Cos(a))
 local group AlreadyDamaged=(LoadGroupHandle(hash_main,(Cache),(133)))
 local group g
 local integer Level=GetUnitAbilityLevel(Source,abilityid_dash)
-if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and Count>0)or Count>100 or IsReallyStunned(Source)then
+if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and Count>0 and(GetSpellAbilityId()==abilityid_dash_helper or GetSpellAbilityId()==abilityid_supernova))or Count>100 then
 call KillTrees(x,y,300)
 call SetUnitVertexColor(Source,255,255,255,255)
 if(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==0 or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==abilityid_dash then
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_dash,true)
 endif
@@ -76007,11 +77591,11 @@
 set g=GetAvailableGroup()
 set dash_alreadydamaged=AlreadyDamaged
 set tt_unit1=Source
 set dash_source=Source
 set dash_level=GetUnitAbilityLevel(Source,abilityid_dash)
-call GroupEnumUnitsInRange(g,x,y,325,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
 call ForGroup(g,function Dash_Hit)
 call KillGroup(g)
 endif
 set t=null
 set Source=null
@@ -76026,11 +77610,11 @@
 local real SourceX=GetUnitX(Source)
 local real SourceY=GetUnitY(Source)
 local real a=AngleBetweenXY(SourceX,SourceY,GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
 local real TargetX=SourceX+dash_length/2*Cos(a)
 local real TargetY=SourceY+dash_length/2*Sin(a)
-call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.1)
+call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.15)
 call AddHeroState(Source,4301,2)
 call AddHeroState(Source,4415,2)
 call TriggerRegisterTimerEvent(t,0.02,true)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
@@ -76082,11 +77666,11 @@
 else
 set tt_unit1=Source
 set supernova_source=Source
 set supernova_level=Level
 set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1025,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1000+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function Supernova_Hit)
 call KillGroup(g)
 set g=null
 endif
 set t=null
@@ -76098,10 +77682,11 @@
 local integer Cache=GetHandleId(t)
 local unit Sun=(LoadUnitHandle(hash_main,(Cache),(589)))
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local real x=(LoadReal(hash_main,(Cache),(6)))
 local real y=(LoadReal(hash_main,(Cache),(7)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
 if IsUnitIllusion(GetEventDamageSource())==true then
@@ -76112,17 +77697,20 @@
 call SetUnitPosition(Sun,x,y)
 endif
 if GetUnitY(Source)!=x or GetUnitY(Source)!=y then
 call SetUnitPosition(Source,x,y)
 endif
+call SetUnitX(Caster,GetUnitX(Source))
+call SetUnitY(Caster,GetUnitY(Source))
 endif
 if GetTriggerEvalCount(t)==1 then
 call PauseUnit(Source,true)
 endif
 set t=null
 set Sun=null
 set Source=null
+set Caster=null
 return false
 endfunction
 function Supernova_End takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
@@ -76133,17 +77721,19 @@
 local real y=(LoadReal(hash_main,(Cache),(7)))
 local unit Dummy=(LoadUnitHandle(hash_main,(Cache),(239)))
 local integer Level=GetUnitAbilityLevel(Source,abilityid_supernova)
 local group g
 local unit Caster
+local integer TempLevel
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call StopSound(gg_snd_VolcanoLoop,false,false)
 call ShowUnit(Ground,false)
 call ShowUnit(Dummy,false)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call ShowUnit(Source,true)
+call SaveInteger(hash_main,(GetHandleId((Source))),((4326)),(HERO_STATE_OFF))
 call UnitRemoveAbility(Source,1093678162)
 call SetUnitInvulnerable(Source,false)
 call PauseUnit(Source,false)
 if GetLocalPlayer()==GetOwningPlayer(Source)then
 call ClearSelection()
@@ -76165,10 +77755,11 @@
 call StartSound(gg_snd_ThunderClapCaster)
 call DestroyEffect(AddSpecialEffect("war3mapImported\\FireNova2.mdx",GetUnitX(Ground),GetUnitY(Ground)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 call ShowUnit(Source,true)
+call SaveInteger(hash_main,(GetHandleId((Source))),((4326)),(HERO_STATE_OFF))
 call UnitRemoveAbility(Source,1093678162)
 call SetUnitInvulnerable(Source,false)
 call SetUnitAnimationByIndex(Source,8)
 call QueueUnitAnimation(Source,"idle")
 call PauseUnit(Source,false)
@@ -76178,10 +77769,28 @@
 endif
 call ShowUnit(Ground,false)
 call ShowUnit(Dummy,false)
 call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_MAX_LIFE))
 call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MAX_MANA))
+set TempLevel=GetUnitAbilityLevel(Source,abilityid_dash)
+if TempLevel>0 then
+call UnitRemoveAbility(Source,abilityid_dash)
+call UnitAddAbility(Source,abilityid_dash)
+call SetUnitAbilityLevel(Source,abilityid_dash,TempLevel)
+endif
+set TempLevel=GetUnitAbilityLevel(Source,abilityid_firespirits)
+if TempLevel>0 then
+call UnitRemoveAbility(Source,abilityid_firespirits)
+call UnitAddAbility(Source,abilityid_firespirits)
+call SetUnitAbilityLevel(Source,abilityid_firespirits,TempLevel)
+endif
+set TempLevel=GetUnitAbilityLevel(Source,abilityid_sunray)
+if TempLevel>0 then
+call UnitRemoveAbility(Source,abilityid_sunray)
+call UnitAddAbility(Source,abilityid_sunray)
+call SetUnitAbilityLevel(Source,abilityid_sunray,TempLevel)
+endif
 set Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Source),GetUnitY(Source),0)
 call UnitAddAbility2(Caster,supernova_stun)
 call SetUnitAbilityLevel(Caster,supernova_stun,Level)
 call IssueImmediateOrder(Caster,"stomp")
 set Caster=null
@@ -76203,10 +77812,11 @@
 local unit Ground
 local unit Sun
 local unit Dummy=CreateUnit(GetOwningPlayer(Source),1747993420,GetUnitX(Source),GetUnitY(Source),0)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_supernova)
 local unit Caster
+local unit ItemCaster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Source),GetUnitY(Source),0)
 set Ground=CreateUnit(GetOwningPlayer(Source),unitid_fx_ground,x,y,0)
 if Level==1 then
 set Sun=CreateUnit(GetOwningPlayer(Source),unitid_fx_sun_1,x,y,0)
 elseif Level==2 then
 set Sun=CreateUnit(GetOwningPlayer(Source),unitid_fx_sun_2,x,y,0)
@@ -76218,10 +77828,11 @@
 call ClearSelection()
 call SelectUnit(Sun,true)
 endif
 call KillTrees(x,y,400)
 call ShowUnit(Source,false)
+call SaveInteger(hash_main,(GetHandleId((Source))),((4326)),(HERO_STATE_ON))
 call UnitAddAbility2(Source,1093678162)
 call StickyNapalm_SetSlow(Source,0,0)
 call SetUnitInvulnerable(Source,true)
 call UnitRemoveBuffs(Source,true,true)
 call StartSound(gg_snd_VolcanoLoop)
@@ -76253,10 +77864,14 @@
 call TriggerAddCondition(t,Condition(function Supernova_Position))
 call SaveUnitHandle(hash_main,(Cache),(589),(Sun))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(Cache),(6),((GetUnitX(Source))*1.0))
 call SaveReal(hash_main,(Cache),(7),((GetUnitY(Source))*1.0))
+call SaveUnitHandle(hash_main,(Cache),(19),(ItemCaster))
+if UnitHasItemOfType(Source,1227899192)then
+call UnitAddAbility(ItemCaster,1093678153)
+endif
 set t=null
 set Source=null
 set Ground=null
 set Sun=null
 endfunction
@@ -76503,11 +78118,11 @@
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local real Time=(LoadReal(hash_main,(GetHandleId(Source)),(681)))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
-if((TimerGetElapsed(udg_GameTimer))-Time<0.249)==false or GetTriggerEventId()==EVENT_UNIT_DEATH then
+if((TimerGetElapsed(udg_GameTimer))-Time<0.49)==false or GetTriggerEventId()==EVENT_UNIT_DEATH then
 call UnitRemoveAbility(Source,sunray_maim_1)
 call UnitRemoveAbility(Source,sunray_maim_2)
 call UnitRemoveAbility(Source,sunray_maim_3)
 call UnitRemoveAbility(Source,sunray_maim_4)
 call UnitRemoveAbility(Source,buffid_sunray)
@@ -76518,11 +78133,11 @@
 endfunction
 function Sunray_Slow takes unit Source returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local integer slowabil
-call TriggerRegisterTimerEvent(t,0.25,false)
+call TriggerRegisterTimerEvent(t,0.5,false)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Sunray_Slow_End))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveReal(hash_main,(GetHandleId(Source)),(681),(((TimerGetElapsed(udg_GameTimer)))*1.0))
 if sunray_level==1 then
@@ -76550,22 +78165,24 @@
 call UnitMakeAbilityPermanent(Source,true,slowabil)
 set t=null
 endfunction
 function Sunray_Hit takes nothing returns nothing
 local unit Target=GetEnumUnit()
-local real Damage=(15*sunray_level+0.06*GetUnitState(Target,UNIT_STATE_MAX_LIFE))/5
-if sunray_source==Target then
-elseif IsUnitType(Target,UNIT_TYPE_HERO)==false then
-call DamageTarget(sunray_source,Target,DAMAGE_PURE,Damage)
-else
+local real Damage1=sunray_damage1
+local real Damage2=sunray_damage2
+local real Damage=Damage1+Damage2*GetUnitState(Target,UNIT_STATE_MAX_LIFE)
+set Damage=Damage/5
+if IsUnitEnemy(Target,GetOwningPlayer(sunray_source))==true then
 call DamageTarget(sunray_source,Target,DAMAGE_PURE,Damage)
 if IsMagicImmune(Target)==false then
 call Sunray_Slow(Target)
 endif
+else
+call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)+Damage*0.5)
+endif
 call DestroyEffect(AddSpecialEffectTarget(sunray_fx,Target,"origin"))
 call TimedReveal(GetOwningPlayer(Target),2,GetUnitX(sunray_source),GetUnitY(sunray_source),500)
-endif
 set Target=null
 endfunction
 function Sunray_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
@@ -76636,10 +78253,14 @@
 local boolean TurnFast=(LoadBoolean(hash_main,(Cache),(672)))
 local real DriftIncrement
 local ubersplat Splat
 local real LastX=(LoadReal(hash_main,(Cache),(23)))
 local real LastY=(LoadReal(hash_main,(Cache),(24)))
+local real Damage1
+local real Damage2
+local real DurationFactor
+local real DriftAmount=5
 if GetUnitCurrentOrder(Source)==852001 then
 call DisableTrigger(t)
 call InterruptUnit(Source)
 call EnableTrigger(t)
 endif
@@ -76677,11 +78298,11 @@
 set newangle=a_deg-6
 endif
 set TurnAngle=AngleBetweenXY(x,y,SourceX,SourceY)+180
 call SaveReal(hash_main,(Cache),(688),((TurnAngle)*1.0))
 endif
-elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT or GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitState(Source,UNIT_STATE_MANA)<10 or IsStunned(Source)or IsSilenced(Source)or IsUnitPaused(Source)or IsCycloned(Source)or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==-1 then
+elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT or GetTriggerEventId()==EVENT_WIDGET_DEATH or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==-1 or Count>=sunray_max_duration/.02 then
 if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and(GetSpellAbilityId()==abilityid_sunray_off or GetSpellAbilityId()==abilityid_supernova or GetSpellAbilityId()==abilityid_spellsteal))then
 call SaveInteger(hash_main,(GetHandleId((Source))),((4312)),(HERO_STATE_OFF))
 if((LoadInteger(hash_main,(GetHandleId((Source))),((4311))))==HERO_STATE_ON)==false then
 call UnitRemoveAbility(Source,1096971630)
 endif
@@ -76699,12 +78320,10 @@
 call DestroyLightning(Light3)
 call DestroyLightning(Light4)
 call DestroyLightning(Light5)
 call StopSound(gg_snd_Sunray,false,true)
 endif
-if GetUnitState(Source,UNIT_STATE_LIFE)<50 then
-endif
 elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
 if GetIssuedOrderId()==String2OrderIdBJ("immolation")then
 set Drifting=true
 endif
 if GetIssuedOrderId()==String2OrderIdBJ("unimmolation")then
@@ -76738,56 +78357,50 @@
 set Count=Count+1
 call SaveInteger(hash_main,(Cache),(34),(Count))
 set light_distance=sunray_maxdistance
 set SourceX=GetUnitX(Source)+50*Cos(a)
 set SourceY=GetUnitY(Source)+50*Sin(a)
+if Drifting and IsEnsnared(Source)==false and IsStunned(Source)==false then
+if((LoadInteger(hash_main,(GetHandleId((Source))),((4331))))==HERO_STATE_ON)==true then
+set DriftAmount=DriftAmount*2
+endif
+set DriftA=a
+set DriftX=SafeX(GetUnitX(Source)+DriftAmount*Cos(DriftA))
+set DriftY=SafeY(GetUnitY(Source)+DriftAmount*Sin(DriftA))
+call KillTrees(DriftX,DriftY,200)
+call SetUnitX(Source,DriftX)
+call SetUnitY(Source,DriftY)
+endif
+call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.03*0.02)
 call KillTrees(SourceX,SourceY,200)
 set sunray_group=GetAvailableGroup()
 set tt_unit1=Source
 set i=0
 loop
-exitwhen i*50>sunray_maxdistance or NewTarget!=null
+exitwhen i*50>sunray_maxdistance
 set x=SourceX+i*50*Cos(a)
 set y=SourceY+i*50*Sin(a)
 set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,x,y,100,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,x,y,130+25,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupAddGroup(g,sunray_group)
+call GroupEnumUnitsInRange(g,x,y,130+25,Condition(function GenericCondition_AlliedUnitsEx))
 call GroupAddGroup(g,sunray_group)
-call GroupEnumUnitsInRange(g,x,y,100,Condition(function GenericCondition_EnemyHeroesEx))
-set NewTarget=FirstOfGroup(g)
 call KillGroup(g)
 if ModuloInteger(Count,10)==0 then
 if ModuloInteger(i,3)==0 then
 call TimedReveal(GetOwningPlayer(Source),2,x,y,225)
 endif
 endif
 set i=i+1
 endloop
-if Drifting and IsEnsnared(Source)==false then
-set DriftA=a
-set DriftX=SafeX(GetUnitX(Source)+5*Cos(DriftA))
-set DriftY=SafeY(GetUnitY(Source)+5*Sin(DriftA))
-call KillTrees(DriftX,DriftY,200)
-call SetUnitX(Source,DriftX)
-call SetUnitY(Source,DriftY)
-endif
 set sunray_source=Source
 set sunray_level=GetUnitAbilityLevel(Source,abilityid_sunray)
-call RemoveSavedHandle(hash_main,(Cache),(17))
-set Target=NewTarget
-if Target!=null then
-call SaveUnitHandle(hash_main,(Cache),(17),(Target))
-endif
-set sunray_damage=(10+5*sunray_level)+(2+2*sunray_level)*GetHeroLevel(Source)
-set sunray_damage=sunray_damage/5
+set DurationFactor=(I2R(Count)/50.0)/6
+set sunray_damage1=(8*sunray_level+8)+(8*sunray_level+8)*DurationFactor
+set sunray_damage2=(sunray_level+DurationFactor*(sunray_level))/100
 if ModuloInteger(Count,10)==0 then
-call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)-(0.04*GetUnitState(Source,UNIT_STATE_MAX_MANA)/5.0))
-if Target!=null then
-set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),200,Condition(function GenericCondition_EnemyUnitsEx))
-call GroupAddGroup(g,sunray_group)
-call KillGroup(g)
-endif
+call GroupRemoveUnit(sunray_group,Source)
 call ForGroup(sunray_group,function Sunray_Hit)
 endif
 call KillGroup(sunray_group)
 set g=null
 set sunray_group=null
@@ -76875,11 +78488,10 @@
 local lightning Light1=AddLightning("SRAY",false,GetUnitX(Source),GetUnitY(Source),TargetX,TargetY)
 local lightning Light2=AddLightning("SRAY",false,GetUnitX(Source),GetUnitY(Source),TargetX,TargetY)
 local lightning Light3=AddLightning("SRAY",false,GetUnitX(Source),GetUnitY(Source),TargetX,TargetY)
 local lightning Light4=AddLightning("SRAY",false,GetUnitX(Source),GetUnitY(Source),TargetX,TargetY)
 local lightning Light5=AddLightning("SRAY",false,GetUnitX(Source),GetUnitY(Source),TargetX,TargetY)
-call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.20)
 call SetUnitFacing(Source,a*bj_RADTODEG)
 call StartSound(gg_snd_Sunray)
 call SetSoundPosition(gg_snd_Sunray,GetUnitX(Source),GetUnitY(Source),100)
 call TriggerRegisterTimerEvent(t,0.02,true)
 call TriggerRegisterDeathEvent(t,Source)
@@ -76939,56 +78551,65 @@
 call SetAbilityUnavailableToAll(sunray_maim_2)
 call SetAbilityUnavailableToAll(sunray_maim_3)
 call SetAbilityUnavailableToAll(sunray_maim_4)
 set t=null
 endfunction
-function Firespirits_Hit takes nothing returns nothing
-call DamageTarget(firespirits_source,GetEnumUnit(),DAMAGE_MAGICAL,firespirits_damage)
+function Firespirits_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_firespirits)
+if GetTriggerEventId()==EVENT_UNIT_DEATH or(TimerGetElapsed(udg_GameTimer))>=(LoadReal(hash_main,(GetHandleId(Target)),(757)))or IsMagicImmune(Target)==true then
+call UnitRemoveAbility(Target,firespirits_disarm)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(176))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+if ModuloInteger(GetTriggerEvalCount(t),4)==0 then
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,20*Level)
+endif
+set t=null
+set Source=null
+return false
 endfunction
-function Firespirits_Heal takes nothing returns nothing
-call SetUnitState(GetEnumUnit(),UNIT_STATE_LIFE,GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE)+firespirits_damage*0.5)
+function Firespirits_Add takes nothing returns nothing
+local unit Source=firespirits_source
+local unit Target=GetEnumUnit()
+local trigger t
+local integer Cache
+call SaveReal(hash_main,(GetHandleId(Target)),(757),(((TimerGetElapsed(udg_GameTimer))+4)*1.0))
+if GetUnitAbilityLevel(Target,firespirits_disarm)==0 then
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.25,true)
+call TriggerAddCondition(t,Condition(function Firespirits_End))
+call TriggerRegisterDeathEvent(t,Target)
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffectTarget(overheat_fx,Target,"chest")))
+call UnitAddAbility(Target,firespirits_disarm)
+call UnitMakeAbilityPermanent(Target,true,firespirits_disarm)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),overheat_disarm,false)
+endif
+set Source=null
+set Target=null
+set t=null
 endfunction
 function Firespirits_Detonate takes unit Source,unit Projectile,real Percentage,unit Caster,unit Target returns nothing
-local group g=GetAvailableGroup()
-local group g1=GetAvailableGroup()
-local group g2=GetAvailableGroup()
 local real x=GetUnitX(Projectile)
 local real y=GetUnitY(Projectile)
-set firespirits_source=Source
-set firespirits_caster=Caster
-set firespirits_damage=(GetUnitAbilityLevel(Source,abilityid_firespirits)*20+10)*Percentage
-set tt_unit1=Source
-call GroupEnumUnitsInRange(g1,x,y,425,Condition(function GenericCondition_EnemyUnitsEx))
-if Source!=Target then
-call GroupEnumUnitsInRange(g2,GetUnitX(Source),GetUnitY(Source),425,Condition(function GenericCondition_EnemyUnitsEx))
-endif
-call GroupAddGroup(g1,g)
-call GroupAddGroup(g2,g)
-call ForGroup(g,function Firespirits_Hit)
-call GroupClear(g)
-call GroupClear(g1)
-call GroupClear(g2)
+local group g=GetAvailableGroup()
 set tt_unit1=Source
-call GroupEnumUnitsInRange(g1,x,y,425,Condition(function GenericCondition_AlliedUnitsEx))
-if Source!=Target then
-call GroupEnumUnitsInRange(g2,GetUnitX(Source),GetUnitY(Source),425,Condition(function GenericCondition_AlliedUnitsEx))
-endif
-call GroupAddGroup(g1,g)
-call GroupAddGroup(g2,g)
-call ForGroup(g,function Firespirits_Heal)
+set firespirits_source=Source
+call GroupEnumUnitsInRange(g,x,y,175+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call ForGroup(g,function Firespirits_Add)
 call KillGroup(g)
-call KillGroup(g1)
-call KillGroup(g2)
 call DestroyEffect(AddSpecialEffect(firespirits_fx,x,y))
-if Source!=Target then
-call DestroyEffect(AddSpecialEffect(firespirits_fx,GetUnitX(Source),GetUnitY(Source)))
-endif
 call KillUnit(Projectile)
 call ShowUnit(Projectile,false)
 set g=null
-set g1=null
-set g2=null
 endfunction
 function Firespirits_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local integer Count=(LoadInteger(hash_main,(Cache),(34)))
@@ -77039,10 +78660,14 @@
 function Firespirits_Launch takes unit Source,unit Bird,unit Target,real Percentage,unit Caster returns nothing
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local group g
 local unit NewTarget
+if Source==Target then
+call KillUnit(Bird)
+call ShowUnit(Bird,false)
+else
 call SetUnitVertexColor(Bird,255,255,255,255)
 call TriggerRegisterTimerEvent(t,0.02,true)
 call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
 call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
 call TriggerAddCondition(t,Condition(function Firespirits_Move))
@@ -77051,10 +78676,11 @@
 call SaveUnitHandle(hash_main,(Cache),(393),(Bird))
 call SaveReal(hash_main,(Cache),(47),((GetSpellTargetX())*1.0))
 call SaveReal(hash_main,(Cache),(48),((GetSpellTargetY())*1.0))
 call SaveReal(hash_main,(Cache),(685),((Percentage)*1.0))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+endif
 set t=null
 endfunction
 function Firespirits_Loop takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
@@ -77076,26 +78702,32 @@
 local real a2
 local real offset
 local real Percentage=(LoadReal(hash_main,(Cache),(685)))
 local real Scale
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local integer TotalDuration=800
 if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
 if GetSpellAbilityId()==abilityid_firespirits_helper then
+if IsDead(Bird1)==false then
 call Firespirits_Launch(Source,Bird1,GetSpellTargetUnit(),Percentage,Caster)
 call RemoveSavedHandle(hash_main,(Cache),(393))
+elseif IsDead(Bird2)==false then
 call Firespirits_Launch(Source,Bird2,GetSpellTargetUnit(),Percentage,Caster)
 call RemoveSavedHandle(hash_main,(Cache),(394))
+elseif IsDead(Bird3)==false then
 call Firespirits_Launch(Source,Bird3,GetSpellTargetUnit(),Percentage,Caster)
 call RemoveSavedHandle(hash_main,(Cache),(395))
+elseif IsDead(Bird4)==false then
 call Firespirits_Launch(Source,Bird4,GetSpellTargetUnit(),Percentage,Caster)
 call RemoveSavedHandle(hash_main,(Cache),(396))
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_firespirits_helper,false)
 if(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==0 or(LoadInteger(hash_main,(GetHandleId(Source)),(704)))==abilityid_firespirits then
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_firespirits,true)
 endif
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
+endif
 elseif GetSpellAbilityId()==abilityid_supernova then
 if Bird1!=null and IsDead(Bird1)==false then
 call Firespirits_Launch(Source,Bird1,Source,Percentage,Caster)
 endif
 if Bird2!=null and IsDead(Bird2)==false then
@@ -77151,11 +78783,11 @@
 set y=SafeY(SourceY+200*Sin(a2*bj_DEGTORAD))
 call SetUnitFacing(Bird4,a2-90)
 call SetUnitX(Bird4,x)
 call SetUnitY(Bird4,y)
 endif
-if Count>625 or GetTriggerEventId()==EVENT_UNIT_DEATH then
+if Count>TotalDuration or GetTriggerEventId()==EVENT_UNIT_DEATH then
 if Bird1!=null and IsDead(Bird1)==false then
 call Firespirits_Launch(Source,Bird1,Source,Percentage,Caster)
 endif
 if Bird2!=null and IsDead(Bird2)==false then
 call Firespirits_Launch(Source,Bird2,Source,Percentage,Caster)
@@ -77173,19 +78805,19 @@
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 set Percentage=RMinBJ(0.25+0.75*(I2R(Count)/500.0),1)
 call SaveReal(hash_main,(Cache),(685),((Percentage)*1.0))
-set Scale=0.25+(Percentage-0.2)*2.5
+set Scale=0.25+(1-0.2)*2.5
 call SetUnitScale(Bird1,Scale,Scale,Scale)
 call SetUnitScale(Bird2,Scale,Scale,Scale)
 call SetUnitScale(Bird3,Scale,Scale,Scale)
 call SetUnitScale(Bird4,Scale,Scale,Scale)
-if Count==450 then
+if Count==(TotalDuration-175)then
 call PlaySoundForPlayerEx(gg_snd_FireSpiritsReady,GetOwningPlayer(Source))
 endif
-if Count>425 then
+if Count>(TotalDuration-200)then
 if ModuloInteger(Count,10)==0 or ModuloInteger(Count,10)==1 or ModuloInteger(Count,10)==2 or ModuloInteger(Count,10)==3 or ModuloInteger(Count,10)==4 then
 call SetUnitVertexColor(Bird1,255,0,0,255)
 call SetUnitVertexColor(Bird2,255,0,0,255)
 call SetUnitVertexColor(Bird3,255,0,0,255)
 call SetUnitVertexColor(Bird4,255,0,0,255)
@@ -77220,11 +78852,11 @@
 local unit Bird3
 local unit Bird4
 local real a=GetUnitFacing(Source)
 local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,SourceX,SourceY,0)
 call UnitAddAbility(Caster,abilityid_firespirits_slow)
-call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.1)
+call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)-GetUnitState(Source,UNIT_STATE_LIFE)*0.15)
 call UnitAddAbility2(Source,1093753394)
 call UnitMakeAbilityPermanent(Source,true,1093753394)
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_firespirits_helper,true)
 call SetPlayerAbilityAvailable(GetOwningPlayer(Source),abilityid_firespirits,false)
 set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*4/4.0*-1.0)
@@ -77266,10 +78898,71 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Firespirits_Main))
 set t=null
 endfunction
+function Overheat_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_overheat)
+if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>4 then
+call UnitRemoveAbility(Target,overheat_disarm)
+call SaveInteger(hash_main,(GetHandleId((Target))),((4311)),(HERO_STATE_OFF))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(176))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,20*Level)
+set t=null
+set Source=null
+return false
+endfunction
+function Overheat_Add takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local unit Target=GetEnumUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerAddCondition(t,Condition(function Overheat_End))
+call TriggerRegisterDeathEvent(t,Target)
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffectTarget(overheat_fx,Target,"chest")))
+call UnitAddAbility(Target,overheat_disarm)
+call UnitMakeAbilityPermanent(Target,true,overheat_disarm)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),overheat_disarm,false)
+call SaveInteger(hash_main,(GetHandleId((Target))),((4311)),(HERO_STATE_ON))
+set Source=null
+set Target=null
+set t=null
+endfunction
+function Overheat takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local real x=GetSpellTargetX()
+local real y=GetSpellTargetY()
+local group g=GetAvailableGroup()
+call DestroyEffect(AddSpecialEffect(overheat_fx,x,y))
+call GroupEnumUnitsInRange(g,x,y,275+25,Condition(function GenericCondition_EnemyUnits))
+call ForGroup(g,function Overheat_Add)
+call KillGroup(g)
+set g=null
+set Source=null
+endfunction
+function Overheat_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_overheat then
+call Overheat()
+endif
+return false
+endfunction
+function Register_Overheat takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Overheat_Main))
+set t=null
+endfunction
 function ShadowPoison_Expire takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
@@ -77396,11 +79089,11 @@
 set shadowpoison_source=Source
 set shadowpoison_group=AlreadyDamaged
 call SetUnitX(Projectile,x)
 call SetUnitY(Projectile,y)
 set g=GetAvailableGroup()
-call GroupEnumUnitsInRange(g,x,y,175,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call GroupEnumUnitsInRange(g,x,y,180+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
 call ForGroup(g,function ShadowPoison_Process)
 set Target=FirstOfGroup(g)
 call KillGroup(g)
 endif
 set t=null
@@ -77709,10 +79402,11 @@
 local real d
 local real damage
 local real LastX=(LoadReal(hash_main,(Cache),(23)))
 local real LastY=(LoadReal(hash_main,(Cache),(24)))
 local real a=AngleBetweenXY(LastX,LastY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
+local integer Level=GetUnitAbilityLevel(Source,abilityid_seekingmissle)
 if GetTriggerEventId()==EVENT_UNIT_DEATH then
 call UnitShareVision(Projectile,GetOwningPlayer(Target),false)
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
@@ -77732,20 +79426,20 @@
 set y=LastY+(280+seekingmissle_acceleration*Count*seekingmissle_tickrate)*seekingmissle_tickrate*Sin(a)
 call SetUnitPosition(Projectile,x,y)
 call SaveReal(hash_main,(Cache),(23),((x)*1.0))
 call SaveReal(hash_main,(Cache),(24),((y)*1.0))
 if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<20 then
-set d=RMinBJ(DistanceBetweenXY(x,y,(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7)))),2000)
-set damage=d/2000*(110*GetUnitAbilityLevel(Source,abilityid_seekingmissle))
+set d=RMinBJ(DistanceBetweenXY(x,y,(LoadReal(hash_main,(Cache),(6))),(LoadReal(hash_main,(Cache),(7)))),1500)
+set damage=d/1500*(110*GetUnitAbilityLevel(Source,abilityid_seekingmissle))
 set damage=RMaxBJ(damage,50)
 call KillUnit(Projectile)
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 if GenericCondition_IsDotAInvis(Target)==false or IsUnitVisible(Target,GetOwningPlayer(Source))==true then
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,damage)
-call Stun(Source,Target,2.5)
+call Stun(Source,Target,2+0.2*Level)
 endif
 endif
 endif
 set t=null
 set Source=null
@@ -77897,21 +79591,21 @@
 call DestroyEffect(AddSpecialEffect(fx_calldown_down,x,y))
 elseif Count==4 then
 set g=GetAvailableGroup()
 set tt_unit1=Source
 set calldown_source=Source
-call GroupEnumUnitsInRange(g,x,y,425,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,x,y,450+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function CallDown_Hit1)
 call KillGroup(g)
 call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
 elseif Count==5 then
 call DestroyEffect(AddSpecialEffect(fx_calldown_down,x,y))
 elseif Count==6 then
 set g=GetAvailableGroup()
 set tt_unit1=Source
 set calldown_source=Source
-call GroupEnumUnitsInRange(g,x,y,425,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,x,y,450+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function CallDown_Hit2)
 call KillGroup(g)
 call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
 call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 call FogModifierStop(fog)
@@ -78114,10 +79808,13 @@
 local real x
 local real y
 local real a
 local real d
 if(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))then
+if((LoadInteger(hash_main,(GetHandleId((Target))),((4324))))==HERO_STATE_ON)==false then
+call AddHeroState(Target,4324,0.3)
+endif
 set d=DistanceBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))
 set a=AngleBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
 if d>energyfield_range then
 set x=GetUnitX(Target)+11*Cos(a)
 set y=GetUnitY(Target)+11*Sin(a)
@@ -78352,63 +80049,73 @@
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
 local integer Level=(LoadInteger(hash_main,(Cache),(5)))
 local group g
 local integer Count=GetTriggerEvalCount(t)
 local unit Dummy=null
 call SetUnitX(Caster,GetUnitX(Target))
 call SetUnitY(Caster,GetUnitY(Target))
+call SetUnitX(Projectile,GetUnitX(Target))
+call SetUnitY(Projectile,GetUnitY(Target))
 if Count==1 or Count==100 or Count==200 then
 set g=GetAvailableGroup()
 if IsDead(Target)then
 set Dummy=CreateUnit(GetOwningPlayer(Target),1697656899,GetUnitX(Target),GetUnitY(Target),0)
 call UnitApplyTimedLife(Dummy,1112820806,0.2)
 call IssueTargetOrder(Caster,"chainlightning",Dummy)
 else
 call IssueTargetOrder(Caster,"chainlightning",Target)
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,Level*25+25)
 endif
 call TimedLifeUnitEffect("war3mapImported\\ThunderStorm_Groundeffect.mdx",Target,"origin",0.6)
 set tt_unit1=Source
 set thundersurge_source=Source
 set thundersurge_target=Target
 set thundersurge_level=Level
-call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),225,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),200+25,Condition(function GenericCondition_EnemyUnitsEx))
 call ForGroup(g,function ThunderSurge_Hit)
 call KillGroup(g)
 if GetTriggerEvalCount(t)==200 then
 call KillUnit(Caster)
+call KillUnit(Projectile)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 endif
 set t=null
 set Source=null
 set Target=null
 set Caster=null
+set Projectile=null
 return false
 endfunction
 function ThunderSurge takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
 local integer Level=GetUnitAbilityLevel(Source,abilityid_thundersurge)
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697657424,GetUnitX(Target),GetUnitY(Target),0)
+local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+local unit Projectile=CreateUnit(GetOwningPlayer(Source),1697657424,GetUnitX(Target),GetUnitY(Target),0)
+call UnitAddAbility2(Projectile,1097625443)
 call UnitAddAbility2(Caster,thundersurge_lightning)
 call SetUnitAbilityLevel(Caster,thundersurge_lightning,Level)
 call UnitAddAbility2(Caster,1097625443)
 call TriggerRegisterTimerEvent(t,0.02,true)
 call TriggerAddCondition(t,Condition(function ThunderSurge_Iterate))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveUnitHandle(hash_main,(Cache),(45),(Projectile))
 call SaveInteger(hash_main,(Cache),(5),(Level))
 set Source=null
 set Target=null
+set Projectile=null
 set t=null
 endfunction
 function ThunderSurge_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_thundersurge and IsBlocked(GetSpellTargetUnit())==false then
 call ThunderSurge()
@@ -78443,11 +80150,11 @@
 call CleanTrigger(t)
 else
 set g=GetAvailableGroup()
 set tt_unit1=Source
 set staticstorm_source=Source
-set staticstorm_damage=0.25*(130+40*Level)*(Count/20.0)
+set staticstorm_damage=0.25*(120+50*Level)*(Count/20.0)
 set staticstorm_show=false
 if ModuloInteger(Count,4)==0 then
 set staticstorm_show=true
 endif
 call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),400,Condition(function GenericCondition_EnemyUnitsWithAncientsEx))
@@ -78931,12 +80638,12 @@
 local integer Count=(LoadInteger(hash_main,(Cache),(34)))
 local integer Level=GetUnitAbilityLevel(Source,abilityid_overcharge)
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
 local unit Tethered=(LoadUnitHandle(hash_main,(GetHandleId(Source)),(652)))
 local boolean Active=false
-local real LifeDrain=0.2*(GetUnitState(Source,UNIT_STATE_LIFE)*0.025)
-local real ManaDrain=0.2*(GetUnitState(Source,UNIT_STATE_MANA)*0.025)
+local real LifeDrain=0.2*(GetUnitState(Source,UNIT_STATE_LIFE)*0.035)
+local real ManaDrain=0.2*(GetUnitState(Source,UNIT_STATE_MANA)*0.035)
 if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
 if GetIssuedOrderId()==String2OrderIdBJ("manashieldon")then
 call Overcharge_Add(Source,Level)
 elseif GetIssuedOrderId()==String2OrderIdBJ("manashieldoff")then
 call Overcharge_Remove(Source)
@@ -79094,10 +80801,11 @@
 local real CurrentMana=GetUnitState(Source,UNIT_STATE_MANA)
 local real PercentageHealth=(LoadReal(hash_main,(Cache),(670)))
 local real PercentageMana=(LoadReal(hash_main,(Cache),(667)))
 local real NewPercentageHealth
 local real NewPercentageMana
+local real BonusFactor=1.5
 if Target==null or Source==null or IsDead(Source)==true or(Count>600 and Tether_IsRelocating(Source,Target)==false and((LoadInteger(hash_main,(GetHandleId((Source))),((4295))))==HERO_STATE_ON)==false)or(d>925 and((LoadInteger(hash_main,(GetHandleId((Source))),((4295))))==HERO_STATE_ON)==false)or GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()==abilityid_tether_helper)then
 call KillGroup(AlreadyDamaged)
 call DestroyLightning(Light)
 call UnitRemoveAbility(Target,tether_ms_1)
 call UnitRemoveAbility(Target,tether_ms_2)
@@ -79119,15 +80827,15 @@
 else
 set NewPercentageHealth=CurrentHealth/GetUnitState(Source,UNIT_STATE_MAX_LIFE)
 set NewPercentageMana=CurrentMana/GetUnitState(Source,UNIT_STATE_MAX_MANA)
 if NewPercentageHealth-PercentageHealth>0 and(NewPercentageHealth-PercentageHealth)<0.5 then
 if((LoadInteger(hash_main,(GetHandleId((Source))),((4298))))==HERO_STATE_ON)==false then
-call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)+(NewPercentageHealth-PercentageHealth)*GetUnitState(Source,UNIT_STATE_MAX_LIFE))
+call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)+BonusFactor*(NewPercentageHealth-PercentageHealth)*GetUnitState(Source,UNIT_STATE_MAX_LIFE))
 endif
 endif
 if NewPercentageMana-PercentageMana>0 and(NewPercentageHealth-PercentageHealth)<0.5 then
-call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+(NewPercentageMana-PercentageMana)*GetUnitState(Source,UNIT_STATE_MAX_MANA))
+call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+BonusFactor*(NewPercentageMana-PercentageMana)*GetUnitState(Source,UNIT_STATE_MAX_MANA))
 endif
 call SaveReal(hash_main,(Cache),(670),((GetUnitState(Source,UNIT_STATE_LIFE)/GetUnitState(Source,UNIT_STATE_MAX_LIFE))*1.0))
 call SaveReal(hash_main,(Cache),(667),((GetUnitState(Source,UNIT_STATE_MANA)/GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.0))
 call MoveLightning(Light,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
 call Tether_Search(Source,Target,AlreadyDamaged)
@@ -79873,11 +81581,11 @@
 if snowball_source!=GetEnumUnit()then
 set snowball_count=snowball_count+1
 endif
 endfunction
 function Snowball_WhichUnits takes nothing returns boolean
-return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))and((LoadBoolean(hash_main,(GetHandleId(GetOwningPlayer(GetFilterUnit()))),(139)))==false or snowball_source==GetFilterUnit())
+return((IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))or(GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit()))))and((LoadBoolean(hash_main,(GetHandleId(GetOwningPlayer(GetFilterUnit()))),(139)))==false or snowball_source==GetFilterUnit())
 endfunction
 function Snowball takes nothing returns nothing
 local unit Source=GetTriggerUnit()
 local unit Target=GetSpellTargetUnit()
 local trigger t=CreateTrigger()
@@ -79964,22 +81672,10 @@
 function Register_FrozenSigil takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
 call TriggerAddCondition(t,Condition(function FrozenSigil_Main))
 endfunction
-function PrimalSplit_IsPanda takes integer uid returns boolean
-if uid==1852862003 or uid==1852862006 or uid==1848652080 or uid==1848657754 then
-return true
-endif
-if uid==1852862002 or uid==1852862006 or uid==1848652082 or uid==1848657969 then
-return true
-endif
-if uid==1852862001 or uid==1852862004 or uid==1848652081 or uid==1848657968 then
-return true
-endif
-return false
-endfunction
 function PrimalSplit_Loop takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
 local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
@@ -80319,11 +82015,11 @@
 set tt_unit1=Source
 set fadebolt_newtarget=null
 set fadebolt_projectile=Target
 set fadebolt_group=AlreadyHit
 set fadebolt_d=999999
-call GroupEnumUnitsInRange(g,x,y,525,Condition(function GenericCondition_EnemyUnitsExNoImmuneNoInvis))
+call GroupEnumUnitsInRange(g,x,y,440+25,Condition(function GenericCondition_EnemyUnitsExNoImmuneNoInvis))
 call ForGroup(g,function FadeBolt_WhichUnit)
 call KillGroup(g)
 if fadebolt_newtarget==null or GetTriggerEvalCount(t)>26 then
 call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
@@ -80406,11 +82102,11 @@
 endif
 return false
 endfunction
 function SpellSteal_RemoveAll takes unit u returns nothing
 call UnitRemoveAbility(u,1093743428)
-call UnitRemoveAbility(u,1093808458)
+call UnitRemoveAbility(u,abilityid_ancestralcharge_end)
 call UnitRemoveAbility(u,1093751126)
 call UnitRemoveAbility(u,1093751893)
 call UnitRemoveAbility(u,1093809217)
 call UnitRemoveAbility(u,1093809218)
 call UnitRemoveAbility(u,1093750344)
@@ -80432,10 +82128,11 @@
 call UnitRemoveAbility(u,1093808456)
 call UnitRemoveAbility(u,1093750094)
 call UnitRemoveAbility(u,1093678667)
 call UnitRemoveAbility(u,1093684805)
 call UnitRemoveAbility(u,1093684560)
+call UnitRemoveAbility(u,1093815618)
 endfunction
 function SpellSteal_DelayRemove_Process takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
@@ -80624,12 +82321,13 @@
 call SpellSteal_RegisterIgnoredSpell(1093808697)
 call SpellSteal_RegisterIgnoredSpell(1093751369)
 call SpellSteal_RegisterIgnoredSpell(1093747504)
 call SpellSteal_RegisterIgnoredSpell(1093742932)
 call SpellSteal_RegisterIgnoredSpell(1093744986)
+call SpellSteal_RegisterIgnoredSpell(1093815877)
 call SpellSteal_RegisterIgnoredSpell(1093743428)
-call SpellSteal_RegisterIgnoredSpell(1093808458)
+call SpellSteal_RegisterIgnoredSpell(abilityid_ancestralcharge_end)
 call SpellSteal_RegisterIgnoredSpell(1093751126)
 call SpellSteal_RegisterIgnoredSpell(1093751893)
 call SpellSteal_RegisterIgnoredSpell(1093809217)
 call SpellSteal_RegisterIgnoredSpell(1093809218)
 call SpellSteal_RegisterIgnoredSpell(1093750344)
@@ -80659,10 +82357,14 @@
 call SpellSteal_RegisterIgnoredSpell(1093808470)
 call SpellSteal_RegisterIgnoredSpell(1093808473)
 call SpellSteal_RegisterIgnoredSpell(1093748565)
 call SpellSteal_RegisterIgnoredSpell(1093752392)
 call SpellSteal_RegisterIgnoredSpell(1093752391)
+call SpellSteal_RegisterIgnoredSpell(1093815600)
+call SpellSteal_RegisterIgnoredSpell(1093815618)
+call SpellSteal_RegisterIgnoredSpell(abilityid_trueshotaura)
+call SpellSteal_RegisterIgnoredSpell(abilityid_nightmare_helper)
 call SpellSteal_RegisterIgnoredSpell(1093685582)
 call SpellSteal_RegisterIgnoredSpell(1093677622)
 call SpellSteal_RegisterIgnoredSpell(1095263841)
 call SpellSteal_RegisterIgnoredSpell(1093679446)
 call SpellSteal_RegisterIgnoredSpell(1093682265)
@@ -80762,10 +82464,11 @@
 call SpellSteal_RegisterIgnoredSpell(1093743681)
 call SpellSteal_RegisterIgnoredSpell(1093751096)
 call SpellSteal_RegisterIgnoredSpell(1093810265)
 call SpellSteal_RegisterIgnoredSpell(1093810244)
 call SpellSteal_RegisterIgnoredSpell(veilofdiscord)
+call SpellSteal_RegisterIgnoredSpell(1093815857)
 call SpellSteal_RegisterIgnoredSpell(1093814863)
 call SpellSteal_RegisterIgnoredSpell(1093814865)
 call SpellSteal_RegisterIgnoredSpell(1093814864)
 call SpellSteal_RegisterIgnoredSpell(1093814866)
 call SpellSteal_RegisterIgnoredSpell(1093814860)
@@ -81515,11 +83218,11 @@
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
 set Source=null
 set t=null
 endfunction
 function FireRemnant_Hit takes nothing returns nothing
-call DamageTarget(fireremnant_source,GetEnumUnit(),DAMAGE_MAGICAL,80+fireremnant_level*40)
+call DamageTarget(fireremnant_source,GetEnumUnit(),DAMAGE_MAGICAL,50+fireremnant_level*50)
 call DestroyEffect(AddSpecialEffectTarget(fireremnant_fx_impact,GetEnumUnit(),"origin"))
 endfunction
 function FireRemnant_Explode takes unit Source,unit Remnant,real x,real y returns nothing
 local group g
 call KillUnit(Remnant)
@@ -81835,11 +83538,11 @@
 if Charges<3 then
 set Count=Count-1
 call SaveInteger(hash_main,(Cache),(34),(Count))
 if Count==0 then
 call UnitRemoveAbility(Source,abilityid_fireremnant_place[Charges])
-set Count=30
+set Count=35
 call SaveInteger(hash_main,(Cache),(34),(Count))
 set Charges=Charges+1
 call SaveInteger(hash_main,(GetHandleId(Source)),(747),(Charges))
 call UnitAddAbility2(Source,abilityid_fireremnant_place[Charges])
 endif
@@ -82264,17 +83967,20 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Wraith_Main))
 set t=null
 endfunction
 function Blackjack_RegisterTarget takes unit Source,unit Creature,unit Target,integer Level returns nothing
+call GroupAddUnit(blackjack_alreadyhit,Target)
 call Stun(Source,Target,1.25+0.25*Level)
 call DamageTarget(Source,Target,DAMAGE_MAGICAL,40*Level)
 call KillUnit(Creature)
-call AddHeroState(Target,4314,3)
 endfunction
 function Blackjack_Find takes nothing returns boolean
-return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))and((LoadInteger(hash_main,(GetHandleId((GetFilterUnit()))),((4314))))==HERO_STATE_ON)==false and(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))==true or GenericCondition_IsDotAInvis(GetFilterUnit())==false)
+if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),1093678162)==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or GenericCondition_IsBear(GetFilterUnit())))and(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))==true or GenericCondition_IsDotAInvis(GetFilterUnit())==false)then
+return IsUnitInGroup(GetFilterUnit(),blackjack_alreadyhit)==false
+endif
+return false
 endfunction
 function Blackjack_Move takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local group g
@@ -82285,20 +83991,23 @@
 local real a=(LoadReal(hash_main,(Cache),(137)))
 local unit Creature
 local unit Target
 local real TargetX=(LoadReal(hash_main,(Cache),(47)))
 local real TargetY=(LoadReal(hash_main,(Cache),(48)))
-set x=SafeX(x+18*Cos(a))
-set y=SafeY(y+18*Sin(a))
+local group AlreadyHit=(LoadGroupHandle(hash_main,(Cache),(187)))
+set blackjack_alreadyhit=AlreadyHit
+set x=SafeX(x+12*Cos(a))
+set y=SafeY(y+12*Sin(a))
 call SaveReal(hash_main,(Cache),(6),((x)*1.0))
 call SaveReal(hash_main,(Cache),(7),((y)*1.0))
 if GetTriggerEvalCount(t)>39 then
 loop
 exitwhen i>3
 call KillUnit((LoadUnitHandle(hash_main,(Cache),(393+i-1))))
 set i=i+1
 endloop
+call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 else
 set g=GetAvailableGroup()
 set tt_unit1=Source
@@ -82307,17 +84016,17 @@
 exitwhen i>3
 if(LoadBoolean(hash_main,(Cache),(511+i-1)))==false then
 set Creature=(LoadUnitHandle(hash_main,(Cache),(393+i-1)))
 set x=(LoadReal(hash_main,(Cache),(549+i-1)))
 set y=(LoadReal(hash_main,(Cache),(567+i-1)))
-set x=SafeX(x+18*Cos(a))
-set y=SafeY(y+18*Sin(a))
+set x=SafeX(x+12*Cos(a))
+set y=SafeY(y+12*Sin(a))
 call SaveReal(hash_main,(Cache),(549+i-1),((x)*1.0))
 call SaveReal(hash_main,(Cache),(567+i-1),((y)*1.0))
 call SetUnitX(Creature,x)
 call SetUnitY(Creature,y)
-set Target=FirstOfGroup(g)
+set Target=GroupPickRandomUnit(g)
 if Target!=null then
 call GroupRemoveUnit(g,Target)
 call SaveInteger(hash_main,(GetHandleId((Target))),((4314)),(HERO_STATE_ON))
 call SaveBoolean(hash_main,(Cache),(511+i-1),(true))
 call Blackjack_RegisterTarget(Source,Creature,Target,GetUnitAbilityLevel(Source,abilityid_blackjack))
@@ -82385,10 +84094,11 @@
 call SaveReal(hash_main,(Cache),(6),((x)*1.0))
 call SaveReal(hash_main,(Cache),(7),((y)*1.0))
 call SaveReal(hash_main,(Cache),(137),((a)*1.0))
 call SaveReal(hash_main,(Cache),(47),((NewX)*1.0))
 call SaveReal(hash_main,(Cache),(48),((NewY)*1.0))
+call SaveGroupHandle(hash_main,(Cache),(187),(GetAvailableGroup()))
 set Source=null
 set Caster=null
 set t=null
 endfunction
 function Blackjack_Main takes nothing returns boolean
@@ -82992,11 +84702,11 @@
 call IssueTargetOrder(Caster,"bloodlust",Source)
 set Caster=null
 endfunction
 function Cleanse_Hit takes nothing returns nothing
 if IsUnitType(GetEnumUnit(),UNIT_TYPE_SUMMONED)==true or IsUnitIllusion(GetEnumUnit())==true then
-call DamageTarget(GetTriggerUnit(),GetEnumUnit(),DAMAGE_MAGICAL,GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*0.5)
+call DamageTarget(GetTriggerUnit(),GetEnumUnit(),DAMAGE_MAGICAL,GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*0.25)
 endif
 call DamageTarget(GetTriggerUnit(),GetEnumUnit(),DAMAGE_MAGICAL,60*cleanse_level+10*(cleanse_heroes+cleanse_creeps))
 endfunction
 function Cleanse_Count takes nothing returns nothing
 if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
@@ -83017,11 +84727,11 @@
 set cleanse_heroes=0
 set cleanse_level=Level
 call ForGroup(g,function Cleanse_Count)
 call ForGroup(g,function Cleanse_Hit)
 call KillGroup(g)
-call Cleanse_AddMS(Source,6*cleanse_heroes+3*cleanse_creeps)
+call Cleanse_AddMS(Source,9*cleanse_heroes+3*cleanse_creeps)
 set Source=null
 set g=null
 endfunction
 function Cleanse_Main takes nothing returns boolean
 if GetSpellAbilityId()==abilityid_cleanse then
@@ -84136,11 +85846,11 @@
 set t=null
 set Source=null
 return false
 endfunction
 function Chakram_SetSlow takes unit Source,unit Target returns nothing
-local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
 local integer LifePercent=R2I(100*GetUnitState(Target,UNIT_STATE_LIFE)/GetUnitState(Target,UNIT_STATE_MAX_LIFE))
 local integer Level=IMax(IMin(R2I(100-LifePercent)/5,20),1)
 call UnitAddAbility(Caster,chakram_slow)
 call SetUnitAbilityLevel(Caster,chakram_slow,Level)
 call IssueTargetOrder(Caster,"slow",Target)
@@ -84201,12 +85911,12 @@
 call KillGroup(AlreadyHit)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 elseif state==0 then
 set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),TargetX,TargetY)*bj_DEGTORAD
-set x=GetUnitX(Projectile)+20*Cos(a)
-set y=GetUnitY(Projectile)+20*Sin(a)
+set x=GetUnitX(Projectile)+16*Cos(a)
+set y=GetUnitY(Projectile)+16*Sin(a)
 call KillTrees(x,y,175)
 if DistanceBetweenXY(x,y,TargetX,TargetY)<40 then
 set x=TargetX
 set y=TargetY
 endif
@@ -84250,12 +85960,12 @@
 endif
 endif
 call SaveInteger(hash_main,(Cache),(34),(Count))
 elseif state==2 then
 set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Source),GetUnitY(Source))*bj_DEGTORAD
-set x=GetUnitX(Projectile)+20*Cos(a)
-set y=GetUnitY(Projectile)+20*Sin(a)
+set x=GetUnitX(Projectile)+16*Cos(a)
+set y=GetUnitY(Projectile)+16*Sin(a)
 call KillTrees(x,y,175)
 call SetUnitX(Projectile,x)
 call SetUnitY(Projectile,y)
 set tt_unit1=Source
 set chakram_source=Source
@@ -84321,228 +86031,733 @@
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Chakram_Main))
 call PreloadAbility(chakram_slow)
 set t=null
 endfunction
-function Breeze_Hit takes unit Source,unit Projectile,unit Target returns nothing
-local real d=RAbsBJ(GetUnitFacing(Target)-GetUnitFacing(Projectile))
-local real duration=3
-local integer Level=GetUnitAbilityLevel(Source,abilityid_breeze)
-local integer slowid=breeze_slow_1
-if Level==2 then
-set slowid=breeze_slow_2
-elseif Level==3 then
-set slowid=breeze_slow_3
-elseif Level==4 then
-set slowid=breeze_slow_4
+function Trap_RemoveBonus takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+if((LoadInteger(hash_main,(GetHandleId(Source)),(754)))==(LoadInteger(hash_main,(Cache),(754))))then
+call AddDamageBonus((Source),(0))
 endif
-if d>180 then
-set d=360-d
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+set Source=null
+return false
+endfunction
+function Trap_RemoveBuffs takes nothing returns nothing
+if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
+set trap_bonuscount=trap_bonuscount+60
+else
+set trap_bonuscount=trap_bonuscount+20
+endif
+call UnitRemoveAbility(GetEnumUnit(),trap_marker)
+call UnitRemoveAbility(GetEnumUnit(),trap_marker_buffid)
+endfunction
+function Trap_Count takes nothing returns nothing
+if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
+set trap_bonuscount=trap_bonuscount+60
+else
+set trap_bonuscount=trap_bonuscount+20
+endif
+endfunction
+function Trap_DoEffect takes nothing returns nothing
+call Stun(trap_source,GetEnumUnit(),0.5+trap_level*0.5)
+call DamageTarget(trap_source,GetEnumUnit(),DAMAGE_MAGICAL,trap_bonuscount)
+endfunction
+function Trap_FindUnits takes nothing returns boolean
+return GetUnitAbilityLevel(GetFilterUnit(),trap_marker_buffid)>0
+endfunction
+function Trap takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local group g=GetAvailableGroup()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+set trap_source=Source
+set trap_level=GetUnitAbilityLevel(Source,abilityid_trap)
+set trap_bonuscount=0
+call GroupEnumUnitsInRange(g,0,0,9999,Condition(function Trap_FindUnits))
+call ForGroup(g,function Trap_RemoveBuffs)
+call ForGroup(g,function Trap_DoEffect)
+call KillGroup(g)
+set g=null
+set Source=null
+endfunction
+function Trap_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_trap then
+call Trap()
+endif
+return false
+endfunction
+function Trap_TextTag takes string text,unit Target,unit Hero returns nothing
+local texttag tt=CreateTextTag()
+call SetTextTagText(tt,text,0.033)
+call SetTextTagPosUnit(tt,Target,64)
+call SetTextTagColor(tt,0,75,255,255)
+call SetTextTagVelocity(tt,0,0.0355)
+call SetTextTagFadepoint(tt,0.15)
+call SetTextTagPermanent(tt,false)
+call SetTextTagLifespan(tt,1.0)
+if IsUnitAlly(Hero,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
+call SetTextTagVisibility(tt,true)
+else
+call SetTextTagVisibility(tt,false)
 endif
-if d<=105 then
-call Stun(Source,Target,1.5)
-set duration=4
-endif
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),slowid,false)
-call AddTimedAbilityAndRemove(Target,slowid,1,duration,breeze_slow_buffid)
-call DamageTarget(Source,Target,DAMAGE_MAGICAL,80+20*Level)
-call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostDamage\\FrostDamage.mdl",Target,"chest"))
-endfunction
-function Breeze_Process takes nothing returns nothing
-if IsUnitInGroup(GetEnumUnit(),breeze_group)==false then
-call GroupAddUnit(breeze_group,GetEnumUnit())
-call Breeze_Hit(breeze_source,breeze_projectile,GetEnumUnit())
+set tt=null
+endfunction
+function Trap_Attack_End takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local real LastTime=(LoadReal(hash_main,(GetHandleId(Target)),(753)))
+if GetTriggerEventId()==EVENT_WIDGET_DEATH or LastTime<(TimerGetElapsed(udg_GameTimer))then
+call UnitRemoveAbility(Target,trap_marker)
+call UnitRemoveAbility(Target,trap_marker_buffid)
+call SaveReal(hash_main,(GetHandleId(Target)),(753),((0)*1.0))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
 endif
+set t=null
+set Target=null
+return false
+endfunction
+function Trap_Attack_SuccessfulHit takes unit Source,unit Target returns nothing
+local trigger t
+local integer Cache
+local group g=GetAvailableGroup()
+call SaveReal(hash_main,(GetHandleId(Target)),(753),(((TimerGetElapsed(udg_GameTimer))+trap_duration)*1.0))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.25,true)
+call TriggerRegisterDeathEvent(t,Target)
+call TriggerAddCondition(t,Condition(function Trap_Attack_End))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call UnitAddAbility2(Target,trap_marker)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),trap_marker,false)
+set trap_source=Source
+set trap_level=GetUnitAbilityLevel(Source,abilityid_trap)
+set trap_bonuscount=0
+call GroupEnumUnitsInRange(g,0,0,9999,Condition(function Trap_FindUnits))
+call ForGroup(g,function Trap_Count)
+call KillGroup(g)
+call Trap_TextTag(I2S(trap_bonuscount),Target,Source)
+set t=null
 endfunction
-function Breeze_Move takes nothing returns boolean
+function Trap_Attack_Hit takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
-local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
-local group AlreadyHit=(LoadGroupHandle(hash_main,(Cache),(187)))
-local real a=(LoadReal(hash_main,(Cache),(137)))
-local real x=GetUnitX(Projectile)
-local real y=GetUnitY(Projectile)
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+else
+if GetEventDamageSource()==Source and GetEventDamage()>0 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+if IsRealSummoned(Target)==false then
+call Trap_Attack_SuccessfulHit(Source,Target)
+endif
+endif
+endif
+set t=null
+set Source=null
+set Target=null
+return false
+endfunction
+function Trap_Attack_Child takes nothing returns nothing
+local unit Source=GetAttacker()
+local unit Target=GetTriggerUnit()
+local trigger t
+local integer Cache
+if((LoadInteger(hash_main,(GetHandleId((Source))),((4325))))==HERO_STATE_ON)==false then
+call AddHeroState(Source,4325,0.2)
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
+call TriggerRegisterTimerEvent(t,2.5,false)
+call TriggerAddCondition(t,Condition(function Trap_Attack_Hit))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+endif
+set Source=null
+set Target=null
+endfunction
+function Trap_Attack takes nothing returns boolean
+if GetUnitAbilityLevel(GetAttacker(),abilityid_trap)>0 and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(GetTriggerUnit())!=1848651852 and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetAttacker()))then
+call Trap_Attack_Child()
+endif
+return false
+endfunction
+function Register_Trap takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Trap_Main))
+set t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
+call TriggerAddCondition(t,Condition(function Trap_Attack))
+set t=null
+endfunction
+function Split_SecondaryImpact takes nothing returns nothing
+local integer Cache=GetHandleId(GetTriggeringTrigger())
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit OriginalTarget=tt_unit1
+local unit Target=tt_unit2
+local integer Level=GetUnitAbilityLevel(Source,abilityid_split)
+if IsMagicImmune(Target)==false then
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,20+80*Level)
+call AddTimedAbilityAndRemove(Target,split_slow,1,4,split_slow_buffid)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),split_slow,false)
+call UnitMakeAbilityPermanent(Target,true,1093815626)
+endif
+set Source=null
+set Target=null
+set OriginalTarget=null
+endfunction
+function Split_Process takes nothing returns nothing
+local unit Source=split_source
+local unit Target=GetEnumUnit()
+local trigger t=CreateProjectileToUnit(split_target,Target,1747993925,"Split_SecondaryImpact",600)
+local integer Cache=GetHandleId(t)
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set Source=null
+set Target=null
+set t=null
+endfunction
+function Split_InitialImpact takes unit Source,unit Target returns nothing
+local integer Level=GetUnitAbilityLevel(Source,abilityid_split)
 local group g=GetAvailableGroup()
-set x=SafeX(x+28*Cos(a))
-set y=SafeY(y+28*Sin(a))
-call SetUnitX(Projectile,x)
-call SetUnitY(Projectile,y)
 set tt_unit1=Source
-set breeze_source=Source
-set breeze_projectile=Projectile
-set breeze_group=AlreadyHit
-call GroupEnumUnitsInRange(g,x,y,325,Condition(function GenericCondition_EnemyUnitsEx))
-call ForGroup(g,function Breeze_Process)
+set split_source=Source
+set split_target=Target
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),500+25,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupRemoveUnit(g,Target)
+call ForGroup(g,function Split_Process)
 call KillGroup(g)
-if GetTriggerEvalCount(t)>50 then
+set Source=null
+set Target=null
+set g=null
+endfunction
+function Split_Move takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
+local real x=GetUnitX(Projectile)
+local real y=GetUnitY(Projectile)
+local real TargetX=GetUnitX(Target)
+local real TargetY=GetUnitY(Target)
+local real Dist=GetDist(TargetX,TargetY,x,y)
+local integer Count=GetTriggerEvalCount(t)
+local real NewAngle=AngleBetweenXY(x,y,TargetX,TargetY)
+local real NewX
+local real NewY
+local real MoveRate=Dist/((split_time/.02)-Count)
+if MoveRate<split_minspeed*0.02 then
+set MoveRate=split_minspeed*0.02
+endif
+set NewX=x+MoveRate*Cos(NewAngle*bj_DEGTORAD)
+set NewY=y+MoveRate*Sin(NewAngle*bj_DEGTORAD)
+call SetUnitX(Projectile,NewX)
+call SetUnitY(Projectile,NewY)
+call SetUnitFacing(Projectile,NewAngle)
+if GetDist(TargetX,TargetY,NewX,NewY)<=MoveRate then
+call KillUnit(Projectile)
+call Split_InitialImpact(Source,Target)
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
-call KillUnit(Projectile)
-call KillGroup(AlreadyHit)
 endif
 set t=null
+set Target=null
 set Source=null
 set Projectile=null
-set AlreadyHit=null
-set g=null
 return false
 endfunction
-function Breeze takes nothing returns nothing
+function Split takes nothing returns nothing
 local unit Source=GetTriggerUnit()
-local real x=GetUnitX(Source)
-local real y=GetUnitY(Source)
-local real a=AngleBetweenXY(x,y,GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
-local unit Projectile=CreateUnit(GetOwningPlayer(Source),unitid_breeze,x,y,a*bj_RADTODEG)
+local unit Target=GetSpellTargetUnit()
 local trigger t=CreateTrigger()
 local integer Cache=GetHandleId(t)
-call TriggerRegisterTimerEvent(t,0.025,true)
-call TriggerAddCondition(t,Condition(function Breeze_Move))
+local unit Projectile=CreateUnit(GetOwningPlayer(Source),1747993930,GetUnitX(Source),GetUnitY(Source),0)
+call TriggerRegisterTimerEvent(t,0.02,true)
+call TriggerAddCondition(t,Condition(function Split_Move))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
 call SaveUnitHandle(hash_main,(Cache),(45),(Projectile))
-call SaveReal(hash_main,(Cache),(137),((a)*1.0))
-call SaveGroupHandle(hash_main,(Cache),(187),(GetAvailableGroup()))
 set Source=null
+set Target=null
 set Projectile=null
 set t=null
 endfunction
-function Breeze_Main takes nothing returns boolean
-if GetSpellAbilityId()==abilityid_breeze then
-call Breeze()
+function Split_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_split then
+call Split()
 endif
 return false
 endfunction
-function Register_Breeze takes nothing returns nothing
+function Register_Split takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
-call TriggerAddCondition(t,Condition(function Breeze_Main))
+call TriggerAddCondition(t,Condition(function Split_Main))
 set t=null
 endfunction
-function FrostSkin_Clear takes unit Target returns nothing
-call UnitRemoveAbility(Target,frostskin_reduction_1)
-call UnitRemoveAbility(Target,frostskin_reduction_2)
-call UnitRemoveAbility(Target,frostskin_reduction_3)
-call UnitRemoveAbility(Target,frostskin_reduction_4)
+function Shield_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_shield)
+call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)+0.1*(20+GetUnitState(Target,UNIT_STATE_MAX_LIFE)*(0.02+0.01*Level)))
+if GetTriggerEvalCount(t)>39 or(GetTriggerEvalCount(t)==1 and IsUnitHidden(Target))then
+call UnitRemoveAbility(Target,shield_armor)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(609))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(610))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(611))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(612))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(613))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(614))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(615))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(616))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(617))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+set t=null
+set Source=null
+set Target=null
+return false
 endfunction
-function FrostSkin_Add takes unit Source,unit Target returns nothing
-local integer Level=GetUnitAbilityLevel(Source,abilityid_frostskin)
-if Level==1 then
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),frostskin_reduction_1,false)
-call UnitAddAbility2(Target,frostskin_reduction_1)
-elseif Level==2 then
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),frostskin_reduction_2,false)
-call UnitAddAbility2(Target,frostskin_reduction_2)
-elseif Level==3 then
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),frostskin_reduction_3,false)
-call UnitAddAbility2(Target,frostskin_reduction_3)
-elseif Level==4 then
-call SetPlayerAbilityAvailable(GetOwningPlayer(Target),frostskin_reduction_4,false)
-call UnitAddAbility2(Target,frostskin_reduction_4)
+function Shield takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local unit Target=GetSpellTargetUnit()
+local trigger t
+local integer Cache
+local unit Caster=CreateUnit(GetOwningPlayer(Target),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+call UnitAddAbility(Caster,1093815367)
+if IssueTargetOrder(Caster,"thunderbolt",Target)==true then
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call UnitAddAbility2(Target,shield_armor)
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerRegisterTimerEvent(t,0,false)
+call TriggerAddCondition(t,Condition(function Shield_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveEffectHandle(hash_main,(Cache),(609),(AddSpecialEffectTarget(shield_fx,Target,"hand right")))
+call SaveEffectHandle(hash_main,(Cache),(610),(AddSpecialEffectTarget(shield_fx,Target,"hand left")))
+call SaveEffectHandle(hash_main,(Cache),(611),(AddSpecialEffectTarget(shield_fx,Target,"foot right")))
+call SaveEffectHandle(hash_main,(Cache),(612),(AddSpecialEffectTarget(shield_fx,Target,"foot left")))
+call SaveEffectHandle(hash_main,(Cache),(613),(AddSpecialEffectTarget(shield_fx,Target,"foot right mount rear")))
+call SaveEffectHandle(hash_main,(Cache),(614),(AddSpecialEffectTarget(shield_fx,Target,"foot left mount rear")))
+call SaveEffectHandle(hash_main,(Cache),(615),(AddSpecialEffectTarget(shield_fx,Target,"head")))
+call SaveEffectHandle(hash_main,(Cache),(616),(AddSpecialEffectTarget(shield_fx,Target,"chest")))
+call SaveEffectHandle(hash_main,(Cache),(617),(AddSpecialEffectTarget(shield_fx,Target,"weapon")))
+endif
+set Source=null
+set Target=null
+set t=null
+endfunction
+function Shield_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_shield then
+call Shield()
+endif
+return false
+endfunction
+function Register_Shield takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Shield_Main))
+set t=null
+endfunction
+function Curse_AdjustControl takes nothing returns nothing
+local unit Target=GetEnumUnit()
+call DisableTrigger(curse_trigger)
+call UnitWakeUp(Target)
+call IssueTargetOrder(Target,"attack",curse_target)
+call EnableTrigger(curse_trigger)
+set Target=null
+endfunction
+function Curse_Unregister takes nothing returns nothing
+call AddHeroState(GetEnumUnit(),4328,0.75)
+endfunction
+function Curse_RegisterNewUnit takes nothing returns nothing
+local unit Target=GetEnumUnit()
+if IsUnitInGroup(Target,curse_group)==false then
+call GroupAddUnit(curse_group,Target)
+call TriggerRegisterUnitEvent(curse_trigger,Target,EVENT_UNIT_ISSUED_TARGET_ORDER)
+call TriggerRegisterUnitEvent(curse_trigger,Target,EVENT_UNIT_ISSUED_POINT_ORDER)
+call TriggerRegisterUnitEvent(curse_trigger,Target,EVENT_UNIT_ISSUED_TARGET_ORDER)
+call SaveInteger(hash_main,(GetHandleId((Target))),((4328)),(HERO_STATE_ON))
 endif
+set Target=null
 endfunction
-function FrostSkin_Attacked takes nothing returns boolean
+function Curse_Force takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
-local unit Source=GetTriggerUnit()
-local unit Attacker=GetAttacker()
-if IsUnitType(Attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
-if GetUnitAbilityLevel(Source,abilityid_frostskin)>0 then
-call FrostSkin_Add(Source,Attacker)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local integer Count=(LoadInteger(hash_main,(Cache),(34)))
+local group AlreadyHit=(LoadGroupHandle(hash_main,(Cache),(22)))
+local group g
+if GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_POINT_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER then
+set Count=Count+1
+call SaveInteger(hash_main,(Cache),(34),(Count))
+set curse_group=AlreadyHit
+set curse_trigger=t
+set g=GetAvailableGroup()
+set tt_unit1=Source
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
+call GroupRemoveUnit(g,Target)
+call ForGroup(g,function Curse_RegisterNewUnit)
+call KillGroup(g)
+if Count==(2.25+0.25*Level)*20 or IsDead(Target)then
+call ForGroup(AlreadyHit,function Curse_Unregister)
+call KillGroup(AlreadyHit)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(176))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
 else
-call FrostSkin_Clear(Attacker)
+set curse_trigger=t
+set curse_target=Target
+call ForGroup(AlreadyHit,function Curse_AdjustControl)
+if ModuloInteger(Count,20)==0 or Count==0 then
+endif
+endif
+else
+if UnitIsSleeping(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),1110454328)==0 and GetIssuedOrderId()!=851973 and borrowedtime_bypass_axe==false then
+call DisableTrigger(t)
+call ClearSelectionForPlayer(GetOwningPlayer(GetTriggerUnit()))
+call IssueTargetOrder(GetTriggerUnit(),"attack",Target)
+call EnableTrigger(t)
 endif
 endif
 set t=null
 set Source=null
-set Attacker=null
+set Target=null
 return false
 endfunction
-function FrostSkin_Learned takes nothing returns nothing
+function Curse takes nothing returns nothing
 local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local integer Level=GetUnitAbilityLevel(Source,abilityid_curse)
+local unit Target=GetSpellTargetUnit()
+local unit Caster=CreateUnit(GetOwningPlayer(Source),1697656901,GetUnitX(Target),GetUnitY(Target),0)
+call UnitAddAbility(Caster,1093815882)
+call SetUnitAbilityLevel(Caster,1093815882,Level)
+call IssueTargetOrder(Caster,"thunderbolt",Target)
+set curse_source=Source
+call TriggerRegisterTimerEvent(t,0.05,true)
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveGroupHandle(hash_main,(Cache),(22),(GetAvailableGroup()))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(curse_fx,Target,"overhead")))
+call SaveEffectHandle(hash_main,(Cache),(176),(AddSpecialEffect(curse_ground_fx,GetUnitX(Target),GetUnitY(Target))))
+call TriggerAddCondition(t,Condition(function Curse_Force))
+set Source=null
+set Target=null
+set t=null
+endfunction
+function Curse_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_curse and IsBlocked(GetSpellTargetUnit())==false then
+call Curse()
+endif
+return false
+endfunction
+function Register_Curse takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function Curse_Main))
+set t=null
+endfunction
+function Touch_DPS takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_touch)
+call DamageTarget(Source,Target,DAMAGE_PURE,(0.032+0.002*Level)*GetUnitState(Target,UNIT_STATE_MAX_LIFE))
+if(TimerGetElapsed(udg_GameTimer))>=(LoadReal(hash_main,(GetHandleId(Source)),(782)))then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+set t=null
+set Source=null
+set Target=null
+return false
+endfunction
+function Touch_FireBlast takes unit Source,unit Target returns nothing
 local trigger t
 local integer Cache
-local integer Level=GetUnitAbilityLevel(Source,abilityid_frostskin)
-if Level==1 then
-call UnitAddAbility2(Source,frostskin_mana_1)
+call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)*0.8)
+if(LoadReal(hash_main,(GetHandleId(Source)),(782)))>(TimerGetElapsed(udg_GameTimer))then
+call SaveReal(hash_main,(GetHandleId(Source)),(782),(((TimerGetElapsed(udg_GameTimer))+touch_burnduration)*1.0))
+else
 set t=CreateTrigger()
 set Cache=GetHandleId(t)
-call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_ATTACKED)
-call TriggerAddCondition(t,Condition(function FrostSkin_Attacked))
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerAddCondition(t,Condition(function Touch_DPS))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
-elseif Level==2 then
-call UnitRemoveAbility(Source,frostskin_mana_1)
-call UnitAddAbility2(Source,frostskin_mana_2)
-elseif Level==3 then
-call UnitRemoveAbility(Source,frostskin_mana_1)
-call UnitRemoveAbility(Source,frostskin_mana_2)
-call UnitAddAbility2(Source,frostskin_mana_3)
-elseif Level==4 then
-call UnitRemoveAbility(Source,frostskin_mana_1)
-call UnitRemoveAbility(Source,frostskin_mana_2)
-call UnitRemoveAbility(Source,frostskin_mana_3)
-call UnitAddAbility2(Source,frostskin_mana_4)
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(touch_burnfx,Target,"chest")))
+call SaveReal(hash_main,(GetHandleId(Source)),(782),(((TimerGetElapsed(udg_GameTimer))+touch_burnduration)*1.0))
 endif
+set t=null
+endfunction
+function Touch_Attack_Damage takes nothing returns boolean
+local real d
+local real LastTime
+local integer Count
+local unit Source
+local unit Target
+if GetUnitAbilityLevel(GetTriggerUnit(),buffid_touch)>0 and GetUnitAbilityLevel(GetEventDamageSource(),abilityid_touch)>0 and(LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(2)))==GetEventDamageSource()then
+set Source=GetEventDamageSource()
+set Target=GetTriggerUnit()
+set Count=(LoadInteger(hash_main,(GetHandleId(Source)),(780)))
+set LastTime=(LoadReal(hash_main,(GetHandleId(Source)),(781)))
+if LastTime+touch_burnduration<(TimerGetElapsed(udg_GameTimer))then
+set Count=1
+set LastTime=(TimerGetElapsed(udg_GameTimer))
+call SaveInteger(hash_main,(GetHandleId(Source)),(780),(Count))
+call SaveReal(hash_main,(GetHandleId(Source)),(781),((LastTime)*1.0))
+else
+set Count=Count+1
+set LastTime=(TimerGetElapsed(udg_GameTimer))
+call SaveInteger(hash_main,(GetHandleId(Source)),(780),(Count))
+call SaveReal(hash_main,(GetHandleId(Source)),(781),((LastTime)*1.0))
+endif
+if Count==4 then
+set Count=0
+call SaveInteger(hash_main,(GetHandleId(Source)),(780),(Count))
+call Touch_FireBlast(Source,Target)
+endif
+call FlushChildHashtable(hash_main,(GetHandleId(GetTriggeringTrigger())))
+call CleanTrigger(GetTriggeringTrigger())
+endif
+return false
+endfunction
+function Touch_Attack_Child takes nothing returns nothing
+local trigger t
+local unit Target
+local unit Source
+if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
+set Target=GetSpellTargetUnit()
+set Source=GetTriggerUnit()
+else
+set Target=GetTriggerUnit()
+set Source=GetAttacker()
+endif
+if IsUnitIllusion(Source)==false then
+set t=CreateTrigger()
+if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
+call SaveBoolean(hash_main,(GetHandleId(t)),(264),(true))
+else
+call SaveBoolean(hash_main,(GetHandleId(t)),(264),(false))
+endif
+call SaveUnitHandle(hash_main,(GetHandleId(t)),(2),(Source))
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
+call TriggerAddCondition(t,Condition(function Touch_Attack_Damage))
+endif
+set t=null
+set Target=null
 set Source=null
+endfunction
+function Touch_Attack takes nothing returns boolean
+if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
+if GetUnitAbilityLevel(GetAttacker(),abilityid_touch)>0 and(LoadBoolean(hash_main,(GetHandleId(GetTriggeringTrigger())),(263)))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetAttacker()==(LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(14)))then
+call Touch_Attack_Child()
+endif
+elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
+if(GetIssuedOrderId()==OrderId("poisonarrows"))then
+call SaveBoolean(hash_main,(GetHandleId(GetTriggeringTrigger())),(263),(true))
+elseif(GetIssuedOrderId()==OrderId("unpoisonarrows"))then
+call SaveBoolean(hash_main,(GetHandleId(GetTriggeringTrigger())),(263),(false))
+endif
+elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()==abilityid_touch then
+call Touch_Attack_Child()
+endif
+return false
+endfunction
+function Touch_Learned takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
+call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_SPELL_EFFECT)
+call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_ISSUED_ORDER)
+call TriggerAddCondition(t,Condition(function Touch_Attack))
+call SaveUnitHandle(hash_main,(GetHandleId(t)),(14),(GetTriggerUnit()))
 set t=null
 endfunction
-function FrostSkin_Main takes nothing returns boolean
-if GetLearnedSkill()==abilityid_frostskin and IsUnitIllusion(GetTriggerUnit())==false then
-call FrostSkin_Learned()
+function Touch takes nothing returns boolean
+if GetLearnedSkill()==abilityid_touch and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_touch)==1 then
+call Touch_Learned()
 endif
 return false
 endfunction
-function Register_FrostSkin takes nothing returns nothing
+function Register_Touch takes nothing returns nothing
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
-call TriggerAddCondition(t,Condition(function FrostSkin_Main))
+call TriggerAddCondition(t,Condition(function Touch))
 set t=null
 endfunction
-function FrostGiant_Loop takes nothing returns boolean
+function ArcticSiege_Burn takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer Cache=GetHandleId(t)
 local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
-local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
-call SetUnitX(Caster,GetUnitX(Source))
-call SetUnitY(Caster,GetUnitY(Source))
-if GetTriggerEventId()==EVENT_WIDGET_DEATH then
-if GetTriggerUnit()!=Caster then
-call KillUnit(Caster)
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+if IsDead(Target)==false then
+call SetUnitState(Target,UNIT_STATE_LIFE,GetUnitState(Target,UNIT_STATE_LIFE)*0.94)
 endif
+if GetTriggerEvalCount(t)==5 then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
 call FlushChildHashtable(hash_main,(Cache))
 call CleanTrigger(t)
 endif
 set t=null
 set Source=null
-set Caster=null
+set Target=null
 return false
 endfunction
-function FrostGiant takes nothing returns nothing
-local unit Source=GetTriggerUnit()
-local unit Caster=CreateUnit(GetOwningPlayer(Source),unitid_frostgiant,GetUnitX(Source),GetUnitY(Source),0)
+function ArcticSiege_SuccessfulAttack takes unit Source,unit Target returns nothing
+local trigger t
+local integer Cache
+local integer Level
+local integer ability1
+local integer ability2
+if((LoadInteger(hash_main,(GetHandleId((Target))),((4329))))==HERO_STATE_ON)==false and IsMagicImmune(Target)==false then
+call AddHeroState(Target,4329,arcticsiege_duration)
+set Level=GetUnitAbilityLevel(Source,abilityid_arcticsiege)
+if Level==1 then
+set ability1=arcticsiege_slow_1
+set ability2=arcticsiege_slow_1_real
+elseif Level==2 then
+set ability1=arcticsiege_slow_2
+set ability2=arcticsiege_slow_2_real
+elseif Level==3 then
+set ability1=arcticsiege_slow_3
+set ability2=arcticsiege_slow_3_real
+elseif Level==4 then
+set ability1=arcticsiege_slow_4
+set ability2=arcticsiege_slow_4_real
+endif
+call AddTimedAbilityAndRemove(Target,ability1,1,4,arcticsiege_slow_buffid)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),ability1,false)
+call UnitMakeAbilityPermanent(Target,true,ability2)
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,1,true)
+call TriggerAddCondition(t,Condition(function ArcticSiege_Burn))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostDamage\\FrostDamage.mdl",Target,"chest")))
+endif
+endfunction
+function ArcticSiege_UnitDamaged takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
+if GetEventDamageSource()==Source then
+call DisableTrigger(t)
+call ArcticSiege_SuccessfulAttack(Source,Target)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+else
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+endif
+set t=null
+set Target=null
+set Source=null
+return false
+endfunction
+function ArcticSiege_Attack_Child takes nothing returns nothing
 local trigger t=CreateTrigger()
+local unit Target=GetTriggerUnit()
+local unit Source=GetAttacker()
 local integer Cache=GetHandleId(t)
-call UnitApplyTimedLifeBJ(15,1112820806,Caster)
-call TriggerRegisterTimerEvent(t,0.02,true)
-call TriggerRegisterDeathEvent(t,Source)
-call TriggerRegisterDeathEvent(t,Caster)
-call TriggerAddCondition(t,Condition(function FrostGiant_Loop))
+call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
+call TriggerRegisterTimerEvent(t,2.5,false)
+call TriggerAddCondition(t,Condition(function ArcticSiege_UnitDamaged))
 call SaveUnitHandle(hash_main,(Cache),(2),(Source))
-call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+set t=null
+set Target=null
+set Source=null
+endfunction
+function ArcticSiege_Attack takes nothing returns boolean
+if GetAttacker()==(LoadUnitHandle(hash_main,(GetHandleId(GetTriggeringTrigger())),(2)))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false then
+if GetUnitTypeId(GetAttacker())==1311788354 or GetUnitTypeId(GetAttacker())==1311788355 or GetUnitTypeId(GetAttacker())==1311788367 or GetUnitTypeId(GetAttacker())==1311788353 then
+call ArcticSiege_Attack_Child()
+endif
+endif
+return false
+endfunction
+function ArcticSiege_Learned takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
+call TriggerAddCondition(t,Condition(function ArcticSiege_Attack))
+call SaveUnitHandle(hash_main,(GetHandleId(t)),(2),(Source))
+set Source=null
+set t=null
+endfunction
+function ArcticSiege_Fix_Finish takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local real x=(LoadReal(hash_main,(Cache),(6)))
+local real y=(LoadReal(hash_main,(Cache),(7)))
+call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,false)
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=null
+return false
+endfunction
+function ArcticSiege_Fix takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=GetTriggerUnit()
+local real x=GetUnitX(Source)
+local real y=GetUnitY(Source)
+call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
+call TriggerRegisterTimerEvent(t,0,false)
+call TriggerAddCondition(t,Condition(function ArcticSiege_Fix_Finish))
+call SaveReal(hash_main,(Cache),(6),((x)*1.0))
+call SaveReal(hash_main,(Cache),(7),((y)*1.0))
 set Source=null
-set Caster=null
 set t=null
 endfunction
-function FrostGiant_Main takes nothing returns boolean
-if GetSpellAbilityId()==abilityid_frostgiant and GetUnitTypeId(GetTriggerUnit())==frostgiant_sourceid then
-call FrostGiant()
+function ArcticSiege_Learn takes nothing returns boolean
+if GetTriggerEventId()==EVENT_PLAYER_HERO_SKILL then
+if GetLearnedSkill()==abilityid_arcticsiege and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_arcticsiege)==1 and IsUnitIllusion(GetTriggerUnit())==false then
+call ArcticSiege_Learned()
+endif
+else
+if GetSpellAbilityId()==abilityid_arcticsiege then
+if GetUnitTypeId(GetTriggerUnit())!=1311788343 then
+call KillTrees(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),150)
+if IsTerrainPathable(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),PATHING_TYPE_WALKABILITY)then
+call ArcticSiege_Fix()
+endif
+endif
+endif
 endif
 return false
 endfunction
-function Register_FrostGiant takes nothing returns nothing
+function Register_ArcticSiege takes nothing returns nothing
 local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
-call TriggerAddCondition(t,Condition(function FrostGiant_Main))
+call TriggerAddCondition(t,Condition(function ArcticSiege_Learn))
 set t=null
 endfunction
 function SonicBoom_Process takes nothing returns nothing
 call Stun(sonicboom_source,GetEnumUnit(),1.5)
 call DamageTarget(sonicboom_source,GetEnumUnit(),DAMAGE_PHYSICAL,50+50*sonicboom_level)
@@ -85060,10 +87275,648 @@
 local trigger t=CreateTrigger()
 call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
 call TriggerAddCondition(t,Condition(function Chill_Main))
 set t=null
 endfunction
+function LightningSeeker_Follow takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local real x
+local real y
+local real a
+if GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call KillUnit(Projectile)
+else
+set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Target),GetUnitY(Target))
+set x=GetUnitX(Projectile)+20*Cos(a*bj_DEGTORAD)
+set y=GetUnitY(Projectile)+20*Sin(a*bj_DEGTORAD)
+call SetUnitX(Projectile,x)
+call SetUnitY(Projectile,y)
+call SetUnitFacing(Projectile,a)
+if DistanceBetweenUnits(Projectile,Target)<30 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call DamageTarget(Projectile,Target,DAMAGE_MAGICAL,100+50*Level)
+call KillUnit(Projectile)
+call SetUnitAnimationByIndex(Projectile,3)
+endif
+endif
+set t=null
+set Target=null
+set Projectile=null
+return false
+endfunction
+function LightningSeeker_Seek takes integer Level,unit Projectile,unit Target returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+call SetUnitAnimationByIndex(Projectile,2)
+call SetUnitVertexColor(Projectile,255,255,255,150)
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerRegisterDeathEvent(t,Target)
+call TriggerAddCondition(t,Condition(function LightningSeeker_Follow))
+call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveUnitHandle(hash_main,(Cache),(45),(Projectile))
+call SetUnitAnimationByIndex(Projectile,2)
+set t=null
+endfunction
+function LightningSeeker_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
+local group g
+local unit Target
+if GetTriggerEvalCount(t)>lightningseeker_duration/0.05 then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call KillUnit(Projectile)
+else
+set tt_unit1=Projectile
+set g=GetAvailableGroup()
+call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),375+25,Condition(function GenericCondition_EnemyUnitsNoImmune))
+set Target=GroupPickClosestUnit(g,GetUnitX(Projectile),GetUnitY(Projectile))
+call KillGroup(g)
+if Target!=null then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call LightningSeeker_Seek(Level,Projectile,Target)
+endif
+set g=null
+set Target=null
+endif
+set t=null
+set Projectile=null
+return false
+endfunction
+function LightningSeeker_Start takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local integer Level=(LoadInteger(hash_main,(Cache),(5)))
+local unit Projectile=(LoadUnitHandle(hash_main,(Cache),(45)))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerAddCondition(t,Condition(function LightningSeeker_Loop))
+call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveUnitHandle(hash_main,(Cache),(45),(Projectile))
+call SetUnitAnimationByIndex(Projectile,1)
+set t=null
+set Projectile=null
+return false
+endfunction
+function LightningSeeker takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local real x=GetSpellTargetX()
+local real y=GetSpellTargetY()
+local unit Projectile=CreateUnit(GetOwningPlayer(Source),lightningseeker_unitid,x,y,270)
+local integer Level=GetUnitAbilityLevel(Source,abilityid_lightningseeker)
+call SetUnitAnimationByIndex(Projectile,0)
+call TriggerRegisterTimerEvent(t,3,false)
+call TriggerAddCondition(t,Condition(function LightningSeeker_Start))
+call SaveInteger(hash_main,(Cache),(5),(Level))
+call SaveUnitHandle(hash_main,(Cache),(45),(Projectile))
+set Source=null
+set Projectile=null
+set t=null
+endfunction
+function LightningSeeker_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_lightningseeker then
+call LightningSeeker()
+endif
+return false
+endfunction
+function Register_LightningSeeker takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function LightningSeeker_Main))
+set t=null
+endfunction
+function MagneticField_Remove takes nothing returns nothing
+if IsRealSummoned(GetEnumUnit())then
+return
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion1)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion1)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion2)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion2)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion3)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion3)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion4)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion4)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion1_basic)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion1_basic)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion2_basic)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion2_basic)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion3_basic)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion3_basic)
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_evasion4_basic)>0 then
+call UnitRemoveAbility(GetEnumUnit(),magneticfield_evasion4_basic)
+endif
+endfunction
+function MagneticField_Add takes nothing returns nothing
+if IsRealSummoned(GetEnumUnit())then
+return
+endif
+if magneticfield_level==1 then
+set magneticfield_desiredbuff=magneticfield_evasion1
+elseif magneticfield_level==2 then
+set magneticfield_desiredbuff=magneticfield_evasion2
+elseif magneticfield_level==3 then
+set magneticfield_desiredbuff=magneticfield_evasion3
+elseif magneticfield_level==4 then
+set magneticfield_desiredbuff=magneticfield_evasion4
+endif
+if GetUnitAbilityLevel(GetEnumUnit(),magneticfield_desiredbuff)==0 then
+call UnitAddAbility2(GetEnumUnit(),magneticfield_desiredbuff)
+call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),magneticfield_desiredbuff,false)
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1094935923)
+if magneticfield_desiredbuff==magneticfield_evasion1 then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815604)
+elseif magneticfield_desiredbuff==magneticfield_evasion2 then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815605)
+elseif magneticfield_desiredbuff==magneticfield_evasion3 then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815606)
+elseif magneticfield_desiredbuff==magneticfield_evasion4 then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815607)
+elseif magneticfield_desiredbuff==magneticfield_evasion1_basic then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815885)
+elseif magneticfield_desiredbuff==magneticfield_evasion2_basic then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815884)
+elseif magneticfield_desiredbuff==magneticfield_evasion3_basic then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815886)
+elseif magneticfield_desiredbuff==magneticfield_evasion4_basic then
+call UnitMakeAbilityPermanent(GetEnumUnit(),true,1093815887)
+endif
+endif
+endfunction
+function MagneticField_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local real x=(LoadReal(hash_main,(Cache),(6)))
+local real y=(LoadReal(hash_main,(Cache),(7)))
+local real EndTime=(LoadReal(hash_main,(Cache),(442)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_magneticfield)
+local group ActiveGroup=(LoadGroupHandle(hash_main,(Cache),(340)))
+local group g=GetAvailableGroup()
+local group g1=GetAvailableGroup()
+local group g2=GetAvailableGroup()
+set magneticfield_level=Level
+if(TimerGetElapsed(udg_GameTimer))>EndTime then
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call ForGroup(ActiveGroup,function MagneticField_Remove)
+call KillGroup(ActiveGroup)
+call KillGroup(g)
+call KillGroup(g1)
+call KillGroup(g2)
+return false
+endif
+set tt_unit1=Source
+call GroupEnumUnitsInRange(g1,x,y,325+25,Condition(function GenericCondition_AlliedHeroesEx))
+call GroupEnumUnitsInRange(g2,x,y,325+144,Condition(function GenericCondition_AlliedStructureEx))
+call GroupAddGroup(g1,g)
+call GroupAddGroup(g2,g)
+call KillGroup(g1)
+call KillGroup(g2)
+call GroupRemoveGroup(g,ActiveGroup)
+call ForGroup(ActiveGroup,function MagneticField_Remove)
+call ForGroup(g,function MagneticField_Add)
+call SaveGroupHandle(hash_main,(Cache),(340),(g))
+call KillGroup(ActiveGroup)
+set t=null
+set Source=null
+set ActiveGroup=null
+set g=null
+return false
+endfunction
+function MagneticField takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local real TargetX=GetSpellTargetX()
+local real TargetY=GetSpellTargetY()
+local integer i
+local integer Level=GetUnitAbilityLevel(Source,abilityid_magneticfield)
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerAddCondition(t,Condition(function MagneticField_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveGroupHandle(hash_main,(Cache),(340),(GetAvailableGroup()))
+call SaveReal(hash_main,(Cache),(6),((TargetX)*1.0))
+call SaveReal(hash_main,(Cache),(7),((TargetY)*1.0))
+call SaveReal(hash_main,(Cache),(442),(((TimerGetElapsed(udg_GameTimer))+3+0.5*Level)*1.0))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffect(magneticfield_fx,TargetX,TargetY)))
+set i=0
+loop
+exitwhen i>5
+call SetPlayerAbilityAvailable(udg_SentPlayers[i],magneticfield_evasion1,false)
+call SetPlayerAbilityAvailable(udg_ScourgePlayers[i],magneticfield_evasion1,false)
+call SetPlayerAbilityAvailable(udg_SentPlayers[i],magneticfield_evasion2,false)
+call SetPlayerAbilityAvailable(udg_ScourgePlayers[i],magneticfield_evasion2,false)
+call SetPlayerAbilityAvailable(udg_SentPlayers[i],magneticfield_evasion2,false)
+call SetPlayerAbilityAvailable(udg_ScourgePlayers[i],magneticfield_evasion3,false)
+call SetPlayerAbilityAvailable(udg_SentPlayers[i],magneticfield_evasion4,false)
+call SetPlayerAbilityAvailable(udg_ScourgePlayers[i],magneticfield_evasion4,false)
+set i=i+1
+endloop
+set Source=null
+set t=null
+endfunction
+function MagneticField_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_magneticfield then
+call MagneticField()
+endif
+return false
+endfunction
+function Register_MagneticField takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function MagneticField_Main))
+set t=null
+endfunction
+function NuralShock_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Target=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_nuralshock)
+local integer abilid=(LoadInteger(hash_main,(Cache),(758)))
+local integer Count=(LoadInteger(hash_main,(Cache),(34)))
+local group g
+if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count>120 or IsMagicImmune(Target)then
+call UnitRemoveAbility(Target,nuralshock_slow_1)
+call UnitRemoveAbility(Target,nuralshock_slow_2)
+call UnitRemoveAbility(Target,nuralshock_slow_1_buffid)
+call UnitRemoveAbility(Target,nuralshock_slow_2_buffid)
+call DestroyEffect((LoadEffectHandle(hash_main,(Cache),(32))))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+else
+set Count=Count+1
+call SaveInteger(hash_main,(Cache),(34),(Count))
+set tt_unit1=Source
+set g=GetAvailableGroup()
+call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),225+25,Condition(function GenericCondition_EnemyUnitsEx))
+call GroupRemoveUnit(g,Target)
+if FirstOfGroup(g)==null then
+if abilid==nuralshock_slow_1 then
+if GetUnitAbilityLevel(Target,nuralshock_slow_1)==0 then
+call UnitAddAbility2(Target,nuralshock_slow_1)
+call UnitMakeAbilityPermanent(Target,true,1093815381)
+call UnitMakeAbilityPermanent(Target,true,1093815621)
+endif
+else
+if GetUnitAbilityLevel(Target,nuralshock_slow_2)==0 then
+call UnitAddAbility2(Target,nuralshock_slow_2)
+call UnitMakeAbilityPermanent(Target,true,1093815380)
+call UnitMakeAbilityPermanent(Target,true,1093815621)
+endif
+endif
+if ModuloInteger(Count,10)==0 then
+call DamageTarget(Source,Target,DAMAGE_MAGICAL,Level*15*0.5)
+endif
+else
+if abilid==nuralshock_slow_1 then
+if GetUnitAbilityLevel(Target,nuralshock_slow_1)>0 then
+call UnitRemoveAbility(Target,nuralshock_slow_1)
+call UnitRemoveAbility(Target,nuralshock_slow_1_buffid)
+endif
+else
+if GetUnitAbilityLevel(Target,nuralshock_slow_2)>0 then
+call UnitRemoveAbility(Target,nuralshock_slow_2)
+call UnitRemoveAbility(Target,nuralshock_slow_2_buffid)
+endif
+endif
+endif
+call KillGroup(g)
+set g=null
+endif
+set t=null
+set Source=null
+set Target=null
+return false
+endfunction
+function NuralShock takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local unit Target=GetSpellTargetUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local integer abilid=nuralshock_slow_1
+if GetUnitTypeId(Source)==1311788365 then
+set abilid=nuralshock_slow_2
+endif
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),nuralshock_slow_1,false)
+call SetPlayerAbilityAvailable(GetOwningPlayer(Target),nuralshock_slow_2,false)
+call TriggerRegisterTimerEvent(t,0.05,true)
+call TriggerRegisterDeathEvent(t,Target)
+call TriggerAddCondition(t,Condition(function NuralShock_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Target))
+call SaveInteger(hash_main,(Cache),(758),(abilid))
+call SaveEffectHandle(hash_main,(Cache),(32),(AddSpecialEffectTarget(nuralshock_fx,Target,"origin")))
+call TriggerEvaluate(t)
+set Source=null
+set Target=null
+set t=null
+endfunction
+function NuralShock_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_nuralshock and IsBlocked(GetSpellTargetUnit())==false then
+call NuralShock()
+endif
+return false
+endfunction
+function Register_NuralShock takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function NuralShock_Main))
+set t=null
+endfunction
+function TempestDouble_Remove takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Clone=(LoadUnitHandle(hash_main,(Cache),(17)))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(GetHandleId(Clone)))
+call RemoveUnit(Clone)
+set t=null
+set Clone=null
+return false
+endfunction
+function TempestDouble_DelayHide takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Clone=(LoadUnitHandle(hash_main,(Cache),(2)))
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call FlushChildHashtable(hash_main,(GetHandleId(Clone)))
+call ShowUnit(Clone,false)
+set t=null
+set Clone=null
+return false
+endfunction
+function TempestDouble_Loop takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Clone=(LoadUnitHandle(hash_main,(Cache),(17)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_tempestdouble)
+if GetTriggerEvalCount(t)==200 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
+call FlushChildHashtable(hash_main,(Cache))
+call CleanTrigger(t)
+call KillUnit(Clone)
+call DestroyEffect(AddSpecialEffect(tempestdouble_fx,GetUnitX(Clone),GetUnitX(Clone)))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call SaveUnitHandle(hash_main,(Cache),(2),(Clone))
+call TriggerRegisterTimerEvent(t,0,false)
+call TriggerAddCondition(t,Condition(function TempestDouble_DelayHide))
+set t=CreateTrigger()
+set Cache=GetHandleId(t)
+call TriggerRegisterTimerEvent(t,3,false)
+call TriggerAddCondition(t,Condition(function TempestDouble_Remove))
+call SaveUnitHandle(hash_main,(Cache),(17),(Clone))
+else
+call SuspendHeroXP(Clone,true)
+call UnitModifySkillPoints(Clone,-25)
+endif
+set t=null
+set Source=null
+set Clone=null
+return false
+endfunction
+function TempestDouble takes nothing returns nothing
+local unit Source=GetTriggerUnit()
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Clone=CreateUnit(GetOwningPlayer(Source),unitid_tempestdouble,GetUnitX(Source),GetUnitY(Source),0)
+local integer Level=GetUnitAbilityLevel(Source,abilityid_tempestdouble)
+local integer i=0
+local item Item
+local integer dummyitemid=1227895373
+call DestroyEffect(AddSpecialEffectTarget(tempestdouble_fx,Clone,"chest"))
+if IsSent(GetOwningPlayer(Clone))==false then
+set dummyitemid=1227903043
+endif
+if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source))==true or IsPlayerObserver(GetLocalPlayer())==true then
+call SetUnitVertexColor(Clone,75,75,75,100)
+endif
+call SelectUnitAddForPlayer(Clone,GetOwningPlayer(Source))
+call DisableTrigger(t_manipulateitem)
+loop
+exitwhen i>5
+if UnitItemInSlot(Source,i)!=null and GetItemTypeId(UnitItemInSlot(Source,i))!=Item_Real[indexid_aegis]and GetItemTypeId(UnitItemInSlot(Source,i))!=Item_Real[indexid_refresherorb]and GetItemTypeId(UnitItemInSlot(Source,i))!=Item_Real[indexid_observerwards]and GetItemTypeId(UnitItemInSlot(Source,i))!=Item_Real[indexid_sentrywards]and GetItemTypeId(UnitItemInSlot(Source,i))!=Item_Real[indexid_smokeofdeceit]then
+set Item=CreateItem(GetItemTypeId(UnitItemInSlot(Source,i)),0,0)
+if GetItemCharges(UnitItemInSlot(Source,i))>0 then
+call SetItemCharges(Item,GetItemCharges(UnitItemInSlot(Source,i)))
+endif
+call UnitAddItem(Clone,Item)
+call SetItemPlayer(Item,GetOwningPlayer(Clone),false)
+if GetItemTypeId(Item)==Item_Real[indexid_divinerapier]or GetItemTypeId(Item)==Item_Real[indexid_divinerapierfree]or GetItemTypeId(Item)==Item_Real[indexid_gemoftruesight]then
+call SetItemDropOnDeath(Item,false)
+endif
+else
+call UnitAddItem(Clone,CreateItem(dummyitemid,0,0))
+endif
+set i=i+1
+endloop
+call EnableTrigger(t_manipulateitem)
+call SetHeroLevel(Clone,GetHeroLevel(Source),false)
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,1096904043)
+call SelectHeroSkill(Clone,1096904043)
+set i=i+1
+endloop
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,abilityid_lightningseeker)
+call SelectHeroSkill(Clone,abilityid_lightningseeker)
+set i=i+1
+endloop
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,abilityid_magneticfield)
+call SelectHeroSkill(Clone,abilityid_magneticfield)
+set i=i+1
+endloop
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,abilityid_nuralshock)
+call SelectHeroSkill(Clone,abilityid_nuralshock)
+set i=i+1
+endloop
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,abilityid_blackjack)
+call SelectHeroSkill(Clone,abilityid_blackjack)
+set i=i+1
+endloop
+set i=1
+loop
+exitwhen i>GetUnitAbilityLevel(Source,abilityid_tempestdouble)
+call SelectHeroSkill(Clone,abilityid_tempestdouble)
+set i=i+1
+endloop
+call UnitRemoveAbility(Clone,abilityid_tempestdouble)
+call UnitModifySkillPoints(Clone,-25)
+call SuspendHeroXP(Clone,true)
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerRegisterDeathEvent(t,Clone)
+call TriggerAddCondition(t,Condition(function TempestDouble_Loop))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(17),(Clone))
+call SetUnitState(Source,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE)*(1-(0.45-0.15*Level)))
+call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)*(1-(0.45-0.15*Level)))
+call SetUnitState(Clone,UNIT_STATE_LIFE,GetUnitState(Source,UNIT_STATE_LIFE))
+call SetUnitState(Clone,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA))
+set Source=null
+set Clone=null
+set t=null
+endfunction
+function TempestDouble_Main takes nothing returns boolean
+if GetSpellAbilityId()==abilityid_tempestdouble then
+call TempestDouble()
+endif
+return false
+endfunction
+function Register_TempestDouble takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
+call TriggerAddCondition(t,Condition(function TempestDouble_Main))
+set t=null
+endfunction
+function Marksmanship_Think takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local group g=GetAvailableGroup()
+local integer Level=GetUnitAbilityLevel(Source,abilityid_marksmanship)
+set tt_unit1=Source
+call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),400+25,Condition(function GenericCondition_EnemyHeroesEx))
+if FirstOfGroup(g)==null then
+if GetUnitAbilityLevel(Source,abilityid_marksmanship_double)!=Level then
+call UnitAddAbility2(Source,abilityid_marksmanship_double)
+call SetUnitAbilityLevel(Source,abilityid_marksmanship_double,Level)
+endif
+else
+if GetUnitAbilityLevel(Source,abilityid_marksmanship_double)>0 then
+call UnitRemoveAbility(Source,abilityid_marksmanship_double)
+endif
+endif
+call KillGroup(g)
+set Source=null
+set t=null
+set g=null
+return false
+endfunction
+function Marksmanship takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=GetTriggerUnit()
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerAddCondition(t,Condition(function Marksmanship_Think))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+set t=null
+set Source=null
+endfunction
+function Marksmanship_Main takes nothing returns boolean
+if GetLearnedSkill()==abilityid_marksmanship and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_marksmanship)==1 then
+call Marksmanship()
+endif
+return false
+endfunction
+function Register_Marksmanship takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function Marksmanship_Main))
+set t=null
+endfunction
+function TrueshotAura_Think takes nothing returns boolean
+local trigger t=GetTriggeringTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=(LoadUnitHandle(hash_main,(Cache),(2)))
+local unit Caster=(LoadUnitHandle(hash_main,(Cache),(19)))
+local integer Level=GetUnitAbilityLevel(Source,abilityid_trueshotaura)
+local integer Agility=GetHeroAgi(Source,true)
+local real DesiredDamage=Agility*(0.1+0.04*Level)
+local integer CasterLevel=R2I(DesiredDamage/2.0+0.5)
+local integer GlobalBehavior=(LoadInteger(hash_main,(Cache),(34)))
+if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()==abilityid_trueshotaura then
+if GlobalBehavior==TRUESHOT_CREEPS_GLOBAL_ON then
+set GlobalBehavior=TRUESHOT_CREEPS_GLOBAL_OFF
+else
+set GlobalBehavior=TRUESHOT_CREEPS_GLOBAL_ON
+endif
+call SaveInteger(hash_main,(Cache),(34),(GlobalBehavior))
+call UnitRemoveAbility(Caster,abilityid_trueshotaura_aura)
+call UnitRemoveAbility(Caster,abilityid_trueshotaura_aura_creeps_global)
+endif
+if IsDead(Source)==true then
+call UnitRemoveAbility(Caster,abilityid_trueshotaura_aura)
+call UnitRemoveAbility(Caster,abilityid_trueshotaura_aura_creeps_global)
+else
+if GetUnitAbilityLevel(Caster,abilityid_trueshotaura_aura)==0 then
+call UnitAddAbility2(Caster,abilityid_trueshotaura_aura)
+if GlobalBehavior==TRUESHOT_CREEPS_GLOBAL_ON then
+call UnitAddAbility2(Caster,abilityid_trueshotaura_aura_creeps_global)
+endif
+endif
+call SetUnitAbilityLevel(Caster,abilityid_trueshotaura_aura,CasterLevel)
+call SetUnitAbilityLevel(Caster,abilityid_trueshotaura_aura_creeps_global,CasterLevel)
+endif
+set Source=null
+set t=null
+return false
+endfunction
+function TrueshotAura takes nothing returns nothing
+local trigger t=CreateTrigger()
+local integer Cache=GetHandleId(t)
+local unit Source=GetTriggerUnit()
+local unit Caster=CreateUnit(GetOwningPlayer(Source),1697657174,0,0,0)
+call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
+call TriggerRegisterTimerEvent(t,0.1,true)
+call TriggerAddCondition(t,Condition(function TrueshotAura_Think))
+call SaveUnitHandle(hash_main,(Cache),(2),(Source))
+call SaveUnitHandle(hash_main,(Cache),(19),(Caster))
+call SaveInteger(hash_main,(Cache),(34),(TRUESHOT_CREEPS_GLOBAL_OFF))
+call UnitAddAbility2(Caster,abilityid_trueshotaura_aura)
+set t=null
+set Source=null
+endfunction
+function TrueshotAura_Main takes nothing returns boolean
+if GetLearnedSkill()==abilityid_trueshotaura and IsUnitIllusion(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),abilityid_trueshotaura)==1 then
+call TrueshotAura()
+endif
+return false
+endfunction
+function Register_TrueshotAura takes nothing returns nothing
+local trigger t=CreateTrigger()
+call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
+call TriggerAddCondition(t,Condition(function TrueshotAura_Main))
+call PreloadAbility(abilityid_trueshotaura_aura)
+call PreloadAbility(abilityid_trueshotaura_aura_creeps_global)
+set t=null
+endfunction
 function InitTrig_Invoker_Core takes nothing returns nothing
 local trigger t=CreateTrigger()
 local region rectRegion=CreateRegion()
 call RegionAddRect(rectRegion,GetWorldBounds())
 call TriggerRegisterEnterRegion(t,rectRegion,Condition(function GenericCondition_True))
